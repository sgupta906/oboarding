# Plan: user-service-fixes

## Metadata
- **Feature:** user-service-fixes
- **Created:** 2026-02-16T23:30
- **Status:** plan-complete
- **Based On:** `.claude/features/user-service-fixes/2026-02-16T23:30_research.md`

## Bugs Addressed

| Bug | Priority | Title | Summary |
|-----|----------|-------|---------|
| #40 | P0 CRITICAL | `user-create-fk-violation` | `createUser()` validates UUID format but not existence, causing FK violation |
| #44 | P1 HIGH | `delete-user-cascades-instances` | `deleteUser()` destructively cascade-deletes onboarding instances |

## Architecture Overview

### Bug #40: FK Existence Check

The current code path for setting `created_by` in all four create functions:

```
createdBy (string)
    |
    v
isValidUUID(createdBy)  <-- format check only
    |
    v
safeCreatedBy = createdBy   (if format valid)
safeCreatedBy = null         (if format invalid)
    |
    v
INSERT ... created_by = safeCreatedBy
    |
    v
PostgreSQL FK CHECK: users(id) = safeCreatedBy
    |
    v
FAILS if safeCreatedBy is a valid UUID but no matching row exists
```

**Fixed flow:**

```
createdBy (string)
    |
    v
isValidUUID(createdBy)  <-- format check
    |
    v
creatorExists(createdBy)  <-- NEW: existence check via SELECT
    |
    v
safeCreatedBy = createdBy   (if format valid AND row exists)
safeCreatedBy = null         (if format invalid OR row missing)
    |
    v
INSERT ... created_by = safeCreatedBy
    |
    v
PostgreSQL FK CHECK: passes (null is allowed, existing UUID passes)
```

**Helper function design:**

```typescript
// In userService.ts, exported for sibling services to import
export async function creatorExists(userId: string): Promise<boolean> {
  const { data, error } = await supabase
    .from('users')
    .select('id')
    .eq('id', userId)
    .limit(1);

  if (error) return false;  // Fail safe: treat as non-existent
  return (data ?? []).length > 0;
}
```

This is a lightweight query (`SELECT id FROM users WHERE id = ? LIMIT 1`) that adds negligible latency to admin-only create operations.

### Bug #44: Remove Instance Cascade from deleteUser

**Current deleteUser flow (WRONG):**

```
deleteUser(userId)
    |
    v
getUser(userId) --> user.email
    |
    v
SELECT id FROM onboarding_instances WHERE employee_email ILIKE user.email  <-- REMOVE
    |
    v
DELETE FROM onboarding_instances WHERE id IN (...)  <-- REMOVE
    |
    v
DELETE FROM users WHERE id = userId
    |
    v
removeUserFromAuthCredentials(user.email)
```

**Fixed deleteUser flow (CORRECT):**

```
deleteUser(userId)
    |
    v
getUser(userId) --> user.email
    |
    v
DELETE FROM users WHERE id = userId
    |                          |
    v                          v
(CASCADE handles)         removeUserFromAuthCredentials(user.email)
 - user_roles
 - user_profiles
```

Users and onboarding instances (hires) are **separate entities**:
- A `user` is a system account (manager/admin/employee login)
- An `onboarding_instance` is an employee's onboarding journey
- Deleting a user should NOT destroy onboarding records

The database schema already handles proper cascading via FK constraints:
- `user_roles.user_id REFERENCES users(id) ON DELETE CASCADE`
- `user_profiles.user_id REFERENCES users(id) ON DELETE CASCADE`
- `users.created_by REFERENCES users(id) ON DELETE SET NULL`

No onboarding instance has an FK to `users(id)` -- the email match in the current code is a hand-coded cascade that should never have been added.

### Entity Relationship (Corrected)

```
users ----< user_roles        (CASCADE DELETE - correct)
  |
  +----< user_profiles       (CASCADE DELETE - correct)
  |
  +---(self) created_by      (SET NULL - correct)

onboarding_instances          (SEPARATE ENTITY - no FK to users)
  |
  +----< instance_steps       (CASCADE DELETE)
  +----< instance_profiles    (CASCADE DELETE)
  +----< instance_template_refs (CASCADE DELETE)
  +----< suggestions          (SET NULL on instance_id)
```

## Tech Stack

No changes to tech stack. All fixes are code-only modifications to existing TypeScript files.

- **Runtime:** Existing Supabase queries
- **Testing:** Vitest + existing mock patterns
- **No new packages**
- **No database migrations**

## File Structure

### New Files

None. All changes are modifications to existing files.

### Modified Files

| File | Change | Lines Affected |
|------|--------|----------------|
| `src/services/supabase/userService.ts` | Add `creatorExists()` helper function | Insert after line 201 (after `userEmailExists`) |
| `src/services/supabase/userService.ts` | Update `createUser()` to call `creatorExists()` | Line 224 (`safeCreatedBy` logic) |
| `src/services/supabase/userService.ts` | Remove instance cascade from `deleteUser()` | Lines 386-418 (JSDoc + instance block) |
| `src/services/supabase/userService.test.ts` | Rewrite entire file: remove cascade tests, add existence check tests, add simplified deleteUser tests | Entire file (194 lines) |
| `src/services/supabase/roleService.ts` | Update `createRole()` to call `creatorExists()` | Line 94 (`safeCreatedBy` logic) |
| `src/services/supabase/profileService.ts` | Update `createProfile()` to call `creatorExists()` | Line 52 (`safeCreatedBy` logic) |
| `src/services/supabase/profileTemplateService.ts` | Update `createProfileTemplate()` to call `creatorExists()` | Line 78 (`safeCreatedBy` logic) |
| `src/services/supabase/index.ts` | Add `creatorExists` to barrel export | Line 93 (add to export list) |
| `src/components/manager/UsersPanel.tsx` | Update delete confirmation message | Line 336 |

## Data Model Changes

None. The database schema is correct. Both bugs are code-level issues.

## Component Architecture

No component changes beyond the delete confirmation message text in `UsersPanel.tsx`.

## Testing Strategy

### Unit Tests (userService.test.ts rewrite)

The existing test file (194 lines, 6 tests) tests ONLY the cascade behavior being removed. The rewrite will:

1. **Remove** all 6 cascade-related tests
2. **Add** tests for `creatorExists()`:
   - Returns true when user row exists
   - Returns false when user row does not exist
   - Returns false on query error (fail-safe)
3. **Add** tests for `createUser()` with existence check:
   - Sets `created_by` to null when creator UUID does not exist in users table
   - Sets `created_by` to the UUID when creator exists
   - Sets `created_by` to null when UUID format is invalid (existing behavior preserved)
4. **Keep/adapt** the `deleteUser` idempotent test:
   - Returns early when user not found (still valid)
5. **Add** simplified `deleteUser` tests:
   - Deletes user row and removes auth credentials (no instance cascade)
   - Does NOT query or delete onboarding_instances

**Expected test counts:**
- Remove: 6 cascade tests
- Add: ~8 new tests (3 creatorExists + 3 createUser existence + 2 deleteUser simplified)
- Net: +2 tests (from 508 to ~510)

### Integration Tests

No additional integration tests needed. The existing `roleClient.test.ts` and `roleOperations.test.ts` cover role operations and will continue to pass since `creatorExists` returns false in mock environments (where supabase queries return no data).

### E2E Tests

Not in scope for this pipeline run. The functional verification will be done by the test agent via Playwright:
- Create a user with dev-auth manager (Bug #40 verification)
- Delete a user, then verify onboarding instances still exist (Bug #44 verification)

## Implementation Notes

### Decisions

1. **`creatorExists` lives in `userService.ts`** rather than a shared utility file. Rationale: it queries the `users` table, which is userService's domain. The sibling services import it directly from `userService`. There is no circular dependency risk since `roleService`, `profileService`, and `profileTemplateService` do not export anything that `userService` imports.

2. **`creatorExists` returns `false` on query error** rather than throwing. Rationale: the `created_by` field is informational, not critical. If we cannot verify the creator exists, it is safer to set `created_by = null` than to fail the entire create operation.

3. **`createUser()` becomes async for the existence check.** It already is async (awaits `userEmailExists`), so no signature change needed.

4. **The delete confirmation message in UsersPanel.tsx** will be simplified from "This will also delete any associated onboarding data. This action cannot be undone." to "This action cannot be undone." since instances are no longer deleted.

### Patterns

- Follow existing `safeCreatedBy` pattern -- extend the guard, don't restructure
- Follow existing mock pattern in `userService.test.ts` -- mock `supabase.from()` chains
- The sibling services already import `isValidUUID` from `../../utils/uuid.ts`. They will additionally import `creatorExists` from `./userService`.

### Trade-offs

- **Extra query per create operation:** One additional `SELECT id LIMIT 1` query per create call. This is acceptable since create operations are infrequent admin actions, not hot paths.
- **Fail-safe vs fail-loud for existence check:** We chose fail-safe (return false on error) because `created_by` is metadata, not business-critical. The alternative (throwing on query error) would make user creation fail for a non-essential field.

## Non-Goals

- **Bug #38 (`create-hire-creates-user`):** Out of scope. This is the inverse bug where `instanceService.ts` creates users when creating hires. Separate pipeline run.
- **Seeding dev-auth users into the database:** Unnecessary given the null fallback approach.
- **Bug #39 (`profiles-table-unused`):** Dead code cleanup is a separate task.
- **Database migration changes:** The FK constraints are correct; the bugs are code-level.
- **Changing the `ON DELETE SET NULL` behavior on `created_by`:** This is already correct.
