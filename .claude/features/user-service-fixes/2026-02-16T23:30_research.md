# Research: user-service-fixes

## Metadata
- **Feature:** user-service-fixes
- **Created:** 2026-02-16T23:30
- **Status:** research-complete
- **Researcher:** research-agent

## Feature Context

This feature combines two bugs that both affect `src/services/supabase/userService.ts`:

- **Bug #40 (`user-create-fk-violation`)** -- P0 CRITICAL: Creating users fails with a foreign key constraint violation on `users.created_by`.
- **Bug #44 (`delete-user-cascades-instances`)** -- P1 HIGH: Deleting a user destructively cascade-deletes their onboarding instances.

Both bugs are in `userService.ts` and can be fixed together in a single pipeline run.

### Dependencies
- No prerequisite features needed. The Zustand migration is complete (5/5 slices done).
- The `devauth-uuid-invalid` fix (commit 846f7d4) already created `src/utils/uuid.ts` with `isValidUUID()` and deterministic dev-auth UUIDs. This fix addressed UUID format validation but NOT FK existence checks.

## Requirements

### Functional Requirements
- FR1: `createUser()` must not fail with FK violation when `createdBy` UUID is valid-format but references a non-existent `users` row (Bug #40)
- FR2: `deleteUser()` must NOT delete onboarding instances belonging to the user (Bug #44)
- FR3: The DeleteConfirmationDialog message in UsersPanel should be updated to NOT mention "associated onboarding data" since instances will no longer be deleted
- FR4: Existing tests for `deleteUser` instance cleanup must be updated/removed to reflect the new behavior

### Technical Requirements
- TR1: The fix for Bug #40 must handle the case where `createdBy` is a valid UUID that does not exist in the `users` table -- set `created_by` to null
- TR2: The fix for Bug #44 must remove lines 398-418 of `userService.ts` (the instance lookup and deletion block)
- TR3: The same `created_by` FK pattern exists in 3 other tables (`roles`, `profiles`, `profile_templates`) -- verify those are also affected and fix if so
- TR4: All existing tests (508 total) must continue passing

### Constraints
- No database migration needed -- both fixes are code-only changes to `userService.ts`
- The `ON DELETE SET NULL` FK constraint on `created_by` is correct and should NOT be changed

## Existing Code Analysis

### Project State
- Project exists: YES
- 508 tests passing across 30 test files
- Zustand migration complete (5/5 slices)

### Bug #40: `user-create-fk-violation` -- Root Cause Confirmed

**Database constraint (line 19 of `00001_create_core_tables.sql`):**
```sql
created_by UUID REFERENCES users(id) ON DELETE SET NULL
```

**Code path:**
1. `UsersPanel.tsx:60-61` -- `const currentUserId = authUser?.uid ?? '';` then `await createNewUser(data, currentUserId);`
2. `useUsers.ts:41` -- `useOnboardingStore.getState()._createUser(data, createdBy)`
3. `useOnboardingStore.ts:462` -- `const newUser = await createUser({ ...data, createdBy }, createdBy);`
4. `userService.ts:224` -- `const safeCreatedBy = createdBy && isValidUUID(createdBy) ? createdBy : null;`
5. `userService.ts:232` -- `created_by: safeCreatedBy` passed to Supabase INSERT

**The problem:** Line 224 only checks UUID **format** via `isValidUUID()`. The dev-auth manager UUID `00000000-0000-4000-a000-000000000002` passes format validation but may not exist as a row in the `users` table. PostgreSQL enforces the FK constraint and rejects the INSERT.

**Affected services (same pattern):**
| Service | File | Line | FK Target |
|---------|------|------|-----------|
| `userService.ts` | `createUser()` | 224 | `users.created_by -> users(id)` |
| `roleService.ts` | `createRole()` | 94 | `roles.created_by -> users(id)` |
| `profileService.ts` | `createProfile()` | 52 | `profiles.created_by -> users(id)` |
| `profileTemplateService.ts` | `createProfileTemplate()` | 78 | `profile_templates.created_by -> users(id)` |

All four services use the identical pattern: `const safeCreatedBy = createdBy && isValidUUID(createdBy) ? createdBy : null;` -- this only checks format, not existence.

**Fix approach:**
The simplest and most correct fix is to add an existence check: before setting `created_by`, query the `users` table to see if a row with that UUID exists. If not, set `created_by` to null. This can be extracted into a shared helper function to avoid duplicating the logic in 4 services.

Alternative: Just always set `created_by` to null for dev-auth UUIDs (those matching the `DEV_AUTH_UUIDS` pattern). But this is fragile -- the real issue is that FK validation requires existence, not just format.

**Recommended fix:** Add a `userExists(id)` helper to `userService.ts` and call it from `createUser()` to validate `createdBy` before INSERT. For the other 3 services, either:
- (a) Import and call the same helper (risk: circular dependency for `userService` calling itself)
- (b) Use a direct Supabase query inline
- (c) Since `userService.createUser()` is the self-referencing case, just fix it there and note that `roleService`, `profileService`, and `profileTemplateService` will fail the same way if the creator UUID doesn't exist in `users`. However, those services are less commonly called and the same fix pattern applies.

**Simplest approach:** In `userService.ts:createUser()`, after `isValidUUID()` check, add a query `SELECT id FROM users WHERE id = safeCreatedBy LIMIT 1`. If no row found, set `safeCreatedBy = null`. For the other 3 services, apply the same fix or extract into a shared utility.

### Bug #44: `delete-user-cascades-instances` -- Root Cause Confirmed

**Code (`userService.ts:393-432`):**
```typescript
export async function deleteUser(userId: string): Promise<void> {
  const user = await getUser(userId);
  if (!user) return;

  // DELETE associated onboarding instances (by email)  <-- THIS IS THE BUG
  const { data: instances } = await supabase
    .from('onboarding_instances')
    .select('id')
    .ilike('employee_email', user.email);

  if (instances && instances.length > 0) {
    const instanceIds = instances.map((i: { id: string }) => i.id);
    const { error: instanceError } = await supabase
      .from('onboarding_instances')
      .delete()
      .in('id', instanceIds);
    // ...error handling...
  }

  // Delete user row
  const { error } = await supabase.from('users').delete().eq('id', userId);
  // ...
}
```

**Why it's wrong:** Users and onboarding instances (hires) are separate entities. A user record represents a system account (manager/admin/contractor). An onboarding instance represents an employee's onboarding journey. Deleting a user should NOT destroy onboarding records.

**The instance service also has the inverse problem (Bug #38):** `instanceService.ts:356-377` calls `createUser()` when creating an onboarding instance. But that's a separate bug not in scope here.

**Fix:** Remove lines 398-418 (the instance lookup and deletion block). The function becomes:
1. Fetch user to get email for auth cleanup
2. Delete user row (CASCADE handles `user_roles`, `user_profiles`)
3. Clean up auth credentials

**Impact on existing tests:** The file `userService.test.ts` (194 lines) has 6 tests specifically testing the instance cascade behavior. ALL of these tests must be updated since the cascade is being removed:
- `queries onboarding_instances by employee email before deleting user` -- remove or update
- `deletes found instances then deletes user row` -- remove
- `handles user with no onboarding instances` -- simplify
- `handles user with multiple instances` -- remove
- `returns early (idempotent) when user not found` -- keep (still valid)
- `throws when instance deletion fails` -- remove

**Impact on UI:** `UsersPanel.tsx:334-337` shows delete confirmation message: `"Are you sure you want to delete "${userToDelete.name}"? This will also delete any associated onboarding data. This action cannot be undone."` -- The "associated onboarding data" part is now incorrect and should be removed.

### Code to Modify

| File | What Changes | Lines |
|------|-------------|-------|
| `src/services/supabase/userService.ts` | (Bug #40) Add existence check for `createdBy` in `createUser()` | ~224 |
| `src/services/supabase/userService.ts` | (Bug #44) Remove instance cascade from `deleteUser()` | 398-418 |
| `src/services/supabase/userService.ts` | Update JSDoc for `deleteUser()` to remove cascade mention | 386-392 |
| `src/services/supabase/userService.test.ts` | Rewrite tests to reflect no-cascade behavior | entire file |
| `src/components/manager/UsersPanel.tsx` | Update delete confirmation message | 334-337 |
| `src/services/supabase/roleService.ts` | (Bug #40 sibling) Add existence check for `createdBy` | ~94 |
| `src/services/supabase/profileService.ts` | (Bug #40 sibling) Add existence check for `createdBy` | ~52 |
| `src/services/supabase/profileTemplateService.ts` | (Bug #40 sibling) Add existence check for `createdBy` | ~78 |

### Code to Reuse
- `isValidUUID()` from `src/utils/uuid.ts` -- already imported in all affected services
- `getUser()` from the CRUD factory -- can be used for existence check in `userService.ts`
- Supabase client pattern `supabase.from('users').select('id').eq('id', uuid).limit(1)` for existence check

### Patterns to Follow
- The `safeCreatedBy` pattern is already established; we're extending it with an existence check
- Server-first delete pattern (used in Zustand store) -- delete from server, then update local state
- Fire-and-forget activity logging pattern

## Constraints

### Performance
- The existence check for `createdBy` adds one extra query per `createUser()`/`createRole()`/`createProfile()`/`createProfileTemplate()` call. This is acceptable since these are infrequent admin operations.

### Platform
- No migration needed -- purely code changes
- The `ON DELETE SET NULL` FK constraint on `created_by` is correct and handles the case where a creator user is later deleted

### Dependencies
- No new packages needed
- No circular dependency risk for `userService.ts` since it's checking its own table

## Risk Assessment

### Technical Risks
| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Existence check adds latency to create operations | Low | Low | These are admin-only operations, one extra SELECT is negligible |
| Removing instance cascade could leave orphaned auth credentials if instances have separate auth entries | Low | Low | Auth credentials for instances are managed by `instanceService`, not `userService` |
| Other services (role, profile, profileTemplate) have same FK issue but are less commonly tested | Med | Med | Fix all 4 services in the same PR |
| Test file rewrite could miss edge cases | Med | Low | Keep the "user not found" idempotent test, add new tests for the existence check |

### Complexity
- **Level:** Simple
- **Rationale:** Both bugs have clear, confirmed root causes with straightforward fixes. Bug #40 requires adding an existence check (a few lines). Bug #44 requires removing code (deleting ~20 lines). The test updates are mechanical.

## Open Questions

All questions are resolved based on the scouting agent's confirmed root causes:

- [x] Q1: Should `created_by` be set to null or should dev-auth users be seeded into the DB?
  - Resolution: Set to null. Seeding dev-auth users into the DB is a larger change and the `created_by` field is informational, not critical. `ON DELETE SET NULL` already handles the case where a creator is deleted.

- [x] Q2: Should the other 3 services (role, profile, profileTemplate) be fixed too?
  - Resolution: Yes, fix all 4 services. They all have the same FK constraint to `users(id)` and the same `isValidUUID()`-only check.

- [x] Q3: Should we extract the existence check into a shared utility?
  - Resolution: Yes, add a `creatorExists(id)` function to `userService.ts` (or a shared utility) that does `SELECT id FROM users WHERE id = ? LIMIT 1`. Export it for the other 3 services to import.

- [x] Q4: What about Bug #38 (`create-hire-creates-user`) which is the inverse issue?
  - Resolution: Out of scope for this feature. Bug #38 is a separate P1 bug about `instanceService.ts` creating users when creating hires. It should be its own pipeline run.

## Recommended Approach

### Implementation Strategy

**Bug #40 fix:**
1. Add a helper function `creatorExists(userId: string): Promise<boolean>` in `userService.ts` that queries `SELECT id FROM users WHERE id = ? LIMIT 1`
2. Export it so other services can import it
3. In `userService.ts:createUser()`, after the `isValidUUID()` check, call `creatorExists()` and set `safeCreatedBy = null` if the creator doesn't exist
4. Apply the same fix in `roleService.ts`, `profileService.ts`, `profileTemplateService.ts`

**Bug #44 fix:**
1. Remove lines 398-418 in `userService.ts:deleteUser()` (the instance lookup and delete block)
2. Update the JSDoc comment to remove the cascade mention
3. Simplify `deleteUser()` to: fetch user for email, delete user row, clean up auth credentials
4. Update delete confirmation message in `UsersPanel.tsx`

### Order of Work
1. Add `creatorExists()` helper to `userService.ts`
2. Fix `createUser()` to use existence check (Bug #40)
3. Fix `deleteUser()` to remove instance cascade (Bug #44)
4. Update `userService.test.ts` tests
5. Fix the other 3 services (roleService, profileService, profileTemplateService)
6. Update `UsersPanel.tsx` delete confirmation message
7. Run full test suite

### What to Defer
- Bug #38 (`create-hire-creates-user`) -- separate pipeline run
- Seeding dev-auth users into the database -- unnecessary given the null fallback

## Files Summary

### Primary files to modify:
- `/home/sanjay/Workspace/onboarding/src/services/supabase/userService.ts` (both bugs)
- `/home/sanjay/Workspace/onboarding/src/services/supabase/userService.test.ts` (test updates)
- `/home/sanjay/Workspace/onboarding/src/components/manager/UsersPanel.tsx` (delete message)
- `/home/sanjay/Workspace/onboarding/src/services/supabase/roleService.ts` (Bug #40 sibling)
- `/home/sanjay/Workspace/onboarding/src/services/supabase/profileService.ts` (Bug #40 sibling)
- `/home/sanjay/Workspace/onboarding/src/services/supabase/profileTemplateService.ts` (Bug #40 sibling)

### Reference files (read-only):
- `/home/sanjay/Workspace/onboarding/src/utils/uuid.ts` (isValidUUID, DEV_AUTH_UUIDS)
- `/home/sanjay/Workspace/onboarding/supabase/migrations/00001_create_core_tables.sql` (FK definitions)
- `/home/sanjay/Workspace/onboarding/src/types/database.types.ts` (table types)
- `/home/sanjay/Workspace/onboarding/src/store/useOnboardingStore.ts` (_createUser, _removeUser actions)

## Next Step

**All questions resolved.** Run `/plan user-service-fixes` to create implementation plan.
