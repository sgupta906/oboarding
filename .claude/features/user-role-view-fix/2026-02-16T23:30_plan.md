# Plan: user-role-view-fix

## Metadata
- **Feature:** user-role-view-fix
- **Created:** 2026-02-16T23:30
- **Status:** plan-complete
- **Based On:** 2026-02-16T23:30_research.md

## Problem

Users created via the Users panel with custom role names (e.g., "team-lead", "hr-admin") see Employee View instead of Manager Dashboard. The UI checks for exact strings `'manager'` or `'admin'` in 5 locations. Any role name that does not match those two strings falls through to employee view, even though the user was created as a non-employee system user.

## Architecture

### Current: Allowlist Pattern (broken)

```
role === 'manager' || role === 'admin'  -->  manager view
everything else                          -->  employee view
```

Custom roles like "team-lead" fall through to "everything else" -- bug.

### Fixed: Exclusion Pattern

```
role != null && role !== 'employee'  -->  manager view
role === null || role === 'employee' -->  employee view
```

Any non-employee role gets manager access. This matches the DB schema where `roles` table allows arbitrary role names, and any role created through the Users panel implies non-employee access.

### Helper Function: `hasManagerAccess()`

A single centralized function in `src/config/authTypes.ts` replaces the repeated inline check across 5 call sites:

```typescript
export function hasManagerAccess(role: UserRole | null): boolean {
  return role != null && role !== 'employee';
}
```

#### Call sites (all 5 use `hasManagerAccess(role)`)

```
src/config/authTypes.ts         -- defines the function
     |
     +--> src/App.tsx                     -- line 21: getInitialView()
     |                                    -- line 33: useEffect role handler
     |                                    -- line 88: canAccessTemplates
     |
     +--> src/components/OnboardingHub.tsx -- line 39: isManager
     |
     +--> src/components/ui/NavBar.tsx     -- line 40: canAccessManagerView
```

### Type Change: `UserRole`

```
BEFORE:  export type UserRole = 'employee' | 'manager' | 'admin';
AFTER:   export type UserRole = string;
```

The DB `user_roles.role_name` column is already unconstrained `string`. The TypeScript type should match reality. The three-string union was aspirational -- it was never enforced at the database level and custom roles already break it.

## Tech Stack

No new dependencies. No new components. No new hooks. No data flow changes.

## File Structure

### New Files
| File | Purpose |
|------|---------|
| `src/config/authTypes.test.ts` | Unit tests for `hasManagerAccess()` helper |

### Modified Files
| File | Lines | Change |
|------|-------|--------|
| `src/config/authTypes.ts` | 9, new lines after 9 | Broaden `UserRole` to `string`; add `hasManagerAccess()` |
| `src/App.tsx` | 21, 33, 88 | Replace 3 inline role checks with `hasManagerAccess(role)` |
| `src/components/OnboardingHub.tsx` | 39 | Replace `isManager` check with `hasManagerAccess(role)` |
| `src/components/ui/NavBar.tsx` | 40 | Replace `canAccessManagerView` check with `hasManagerAccess(role)` |
| `src/config/authContext.tsx` | 284 | Update JSDoc comment |
| `src/services/authService.test.ts` | 244 | Update hardcoded type annotation |

### No Changes Needed
- `src/services/authService.ts` -- already handles arbitrary role strings
- `src/services/supabase/userService.ts` -- role storage is correct
- `src/services/supabase/mappers.ts` -- already maps to `string[]`
- `src/config/authContext.tsx` (execution code) -- works with `UserRole` as `string`
- `src/views/SignInView.tsx` -- test accounts still valid

## Testing Strategy

### Unit Tests (new: ~8 tests)
- `hasManagerAccess(null)` returns `false`
- `hasManagerAccess('employee')` returns `false`
- `hasManagerAccess('manager')` returns `true`
- `hasManagerAccess('admin')` returns `true`
- `hasManagerAccess('team-lead')` returns `true` (custom role)
- `hasManagerAccess('hr-admin')` returns `true` (custom role)
- `hasManagerAccess('')` returns `true` (edge: empty string is non-null, non-employee)

### Existing Tests (must still pass)
- All 520 existing tests must pass after changes
- `authService.test.ts` line 244 type annotation fixed to avoid TypeScript error

## Implementation Notes

- **DRY principle:** The `hasManagerAccess()` helper eliminates 5 copies of the same logic. Future access rule changes need only update one function.
- **Null safety:** The `&&` short-circuit in `role != null && role !== 'employee'` prevents null roles from getting manager access.
- **Backward compatibility:** Existing roles `'manager'` and `'admin'` both satisfy `!== 'employee'`, so no behavior change for existing users.
- **Edge case -- empty string:** An empty string role (`''`) would get manager access. This is acceptable because the DB and auth flow never produce empty string roles; they produce `null` for missing roles.

## Non-Goals

- NOT adding a roles permission system or fine-grained access control
- NOT changing the database schema or adding role validation
- NOT adding UI for role management beyond what already exists
- NOT changing the auth flow or how roles are stored in localStorage
