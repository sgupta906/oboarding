# Research: users-error-handling

## Metadata
- **Feature:** users-error-handling (Bugs #8, #10, #12)
- **Created:** 2026-02-16T23:00
- **Status:** research-complete
- **Researcher:** research-agent

## Feature Context
- **Description:** Three interrelated error handling bugs in the Users CRUD feature. They share a common root cause: a dual-channel error mechanism where both the Zustand store (`usersError`) and local component state (`modalError`) set error strings independently, with no coordination between them.
- **Where it fits:** These bugs were discovered during Playwright scouting of the Users tab after the Zustand migration. They are now unblocked by Bug #7 fix (devauth-uuid-invalid), which fixed UUID generation so user creation can proceed far enough to trigger these error handling issues.
- **Dependencies:** Bug #7 (devauth-uuid-invalid) -- FIXED in commit 846f7d4.

## Requirements

### Functional Requirements
- [ ] FR1: When user creation fails, the form must retain all user-entered data (email, name, roles, profiles) so the user can correct and retry (Bug #8)
- [ ] FR2: When the create/edit modal is closed (X, Cancel, Escape, backdrop click), the store-level error (`usersError`) must be cleared along with local `modalError` (Bug #10)
- [ ] FR3: Error messages must display in exactly ONE location: inside the modal while the modal is open, and in the panel if the error occurred outside a modal context (Bug #12)
- [ ] FR4: Edit user errors must also follow the same single-channel error pattern (consistency)
- [ ] FR5: Delete user errors should continue working as they are (delete doesn't use a modal form, so no dual-channel issue)

### Technical Requirements
- [ ] TR1: `handleCreateSubmit` must re-throw the caught error so `UserModal.handleSubmit` knows the operation failed and skips `resetForm()`
- [ ] TR2: Modal `onClose` handlers must call `_resetUsersError()` (via the `reset()` function from `useUsers()`)
- [ ] TR3: While the modal is open, suppress the store-level error banner in `UsersPanel` OR prevent `_createUser`/`_editUser` from setting `usersError` when the error will be surfaced via `modalError`
- [ ] TR4: Existing tests (474 total) must continue passing
- [ ] TR5: New unit tests must cover: form-retains-data-on-error, error-clears-on-modal-close, no-duplicate-error-display

### Constraints
- Must not change the Zustand store's public interface (other consumers depend on `usersError`)
- Must not break the edit or delete flows while fixing create
- The `ModalWrapper` returns `null` when `isOpen=false`, so form state is destroyed on close; this is fine since `resetForm()` should only run on success anyway

## Existing Code Analysis

### Project State
- Project exists: YES
- Branch: `zustand-migration-bugfixes`
- Test count: 474 tests across multiple files

### Affected Files

| File | Role | Lines of Interest |
|------|------|-------------------|
| `src/components/manager/UsersPanel.tsx` | Parent component, owns modals + error state | Lines 56-76 (handleCreateSubmit), 79-99 (handleEditSubmit), 179-183 (error banner), 296-308 (create modal), 311-324 (edit modal) |
| `src/components/modals/UserModal.tsx` | Modal form, owns form state + resetForm | Lines 94-108 (resetForm), 129-150 (handleSubmit), 212-216 (error banner) |
| `src/store/useOnboardingStore.ts` | Zustand store, owns `usersError` | Lines 459-471 (_createUser), 473-491 (_editUser), 519-521 (_resetUsersError) |
| `src/hooks/useUsers.ts` | Hook wrapper, exposes `reset()` | Lines 61-63 (reset -> _resetUsersError) |
| `src/components/modals/UserModal.test.tsx` | Existing tests | 346 lines, 10 test cases |

### Code to Reuse
- `_resetUsersError()` already exists in the store (line 519-521)
- `reset()` already exposed by `useUsers()` hook (line 61-63)
- `UsersPanel` already imports `useUsers()` destructuring `reset` -- wait, let me verify...

Actually, looking at `UsersPanel.tsx` line 24:
```typescript
const { users, isLoading, error, createNewUser, editUser, removeUser } = useUsers();
```
It does NOT destructure `reset`. This needs to be added.

### Code to Modify

#### 1. `UsersPanel.tsx` -- 3 changes needed

**Change A: Destructure `reset` from `useUsers()`**
```typescript
// Line 24 -- add `reset`
const { users, isLoading, error, createNewUser, editUser, removeUser, reset } = useUsers();
```

**Change B: Add `throw err` in `handleCreateSubmit` catch block**
```typescript
// Line 71-73 -- re-throw after setting modalError
catch (err) {
  setModalError(err instanceof Error ? err.message : 'Failed to create user');
  throw err;  // ADD THIS -- lets UserModal know the operation failed
}
```

**Change C: Add `throw err` in `handleEditSubmit` catch block**
```typescript
// Line 94-96 -- re-throw after setting modalError
catch (err) {
  setModalError(err instanceof Error ? err.message : 'Failed to update user');
  throw err;  // ADD THIS -- lets UserModal know the operation failed
}
```

**Change D: Clear store error on modal close**
```typescript
// Line 299-302 -- create modal onClose
onClose={() => {
  setShowCreateModal(false);
  setModalError(null);
  reset();  // ADD THIS -- clears usersError in store
}}
```
```typescript
// Line 314-317 -- edit modal onClose
onClose={() => {
  setEditingUser(null);
  setModalError(null);
  reset();  // ADD THIS -- clears usersError in store
}}
```

**Change E: Suppress store error banner while modal is open**
```typescript
// Line 179 -- only show store error when no modal is open
{error && !showCreateModal && editingUser === null && (
  <div className="p-4 bg-red-50 ...">
    <p ...>{error}</p>
  </div>
)}
```

#### 2. `UserModal.tsx` -- No changes needed

The `handleSubmit` function already has a `try/catch` structure:
```typescript
try {
  await onSubmit(formData);
  resetForm();  // Only runs if onSubmit resolves
} catch {
  // Error handling is done by parent component
}
```

Once `handleCreateSubmit` re-throws, `onSubmit(formData)` will reject, `resetForm()` will be skipped, and the `catch` block will execute. No changes needed in UserModal.

### Error Flow After Fix

**Create user fails (server error):**
1. `_createUser` in store: sets `usersError`, throws Error
2. `handleCreateSubmit` catch: sets `modalError`, re-throws
3. `UserModal.handleSubmit` catch: error caught, `resetForm()` skipped
4. User sees error inside modal only (store error suppressed by `!showCreateModal`)
5. Form fields retained -- user can correct and retry

**User closes modal after error:**
1. `handleClose` in UserModal: calls `resetForm()` + `onClose()`
2. `onClose` in UsersPanel: sets `showCreateModal(false)`, clears `modalError`, calls `reset()` (clears `usersError`)
3. All error state cleaned up in both channels

**Successful create:**
1. `handleCreateSubmit`: success path runs, calls `setShowCreateModal(false)`
2. `UserModal.handleSubmit`: `onSubmit` resolves, `resetForm()` runs, form cleared
3. No error state set anywhere

### Patterns to Follow
- Store actions that fail: set store error AND throw (existing pattern in `_createUser`, `_editUser`, `_removeUser`)
- Component catch blocks: set local error state, re-throw for consumer awareness
- Modal close: clear all error channels (both local and store)
- Error display: single channel at a time (modal owns errors while open, panel owns errors otherwise)

## Risk Assessment

### Technical Risks
| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Re-throwing in `handleCreateSubmit` changes the resolved/rejected semantics of the promise | Low | Low | UserModal already has try/catch to handle rejected promises |
| Clearing `usersError` on modal close might hide legitimate subscription errors | Low | Low | Subscription errors set `usersError` outside of CRUD operations; they will re-appear on next subscription cycle |
| The `finally` block in `handleCreateSubmit` still runs after re-throw | None | Certain | This is expected -- `setIsSubmitting(false)` should run regardless |

### Complexity
- **Level:** Simple
- **Rationale:** All three bugs share the same root cause (dual-channel error with no coordination). The fix is 5 surgical changes across 1 file (`UsersPanel.tsx`), with zero changes to UserModal, the store, or the hook. No new APIs, no refactoring needed.

## Open Questions

All questions are resolved -- no blockers.

- [x] Q1: Should the store's `_createUser` stop setting `usersError` if we're handling errors in the component?
  - Resolution: NO -- keep the store setting `usersError` for consumers that don't use a modal (e.g., programmatic calls). Instead, suppress the store error display in UsersPanel while a modal is open.

- [x] Q2: Does `handleEditSubmit` have the same re-throw problem as `handleCreateSubmit`?
  - Resolution: YES -- `handleEditSubmit` (line 94-96) also catches without re-throwing. Same fix needed. However, the edit modal won't reset form fields on error because it pre-fills from `user` prop via useEffect, so the UX impact is less severe. Still should fix for consistency.

- [x] Q3: Could clearing `usersError` on modal close race with a new error being set?
  - Resolution: No race condition. `reset()` calls `set({ usersError: null })` synchronously in Zustand. If a new CRUD operation is in flight, it will set `usersError` when it completes, after the modal close has already cleared it. This is correct behavior.

- [x] Q4: Does `ModalWrapper` conditionally render (return null when closed) or stay mounted?
  - Resolution: It returns `null` when `isOpen=false` (line 60 of ModalWrapper.tsx). This means UserModal's useState hooks are destroyed on close and re-initialized on next open. This is fine -- `resetForm()` doesn't need to run on close since the state is destroyed anyway.

## Recommended Approach

### Implementation Strategy

**Single holistic fix** -- all 3 bugs are symptoms of one problem (dual error channel with no coordination). Fix them together in one pass:

1. **Re-throw errors** in `handleCreateSubmit` and `handleEditSubmit` catch blocks so `UserModal.handleSubmit` knows the operation failed and skips `resetForm()`. This fixes Bug #8.

2. **Clear store error on modal close** by calling `reset()` in both create and edit modal `onClose` handlers. This fixes Bug #10.

3. **Suppress store error banner while modal is open** by adding `!showCreateModal && editingUser === null` guard to the error banner render condition. This fixes Bug #12.

### Order of Work
1. Add `reset` to destructured `useUsers()` return in `UsersPanel.tsx`
2. Add `throw err` to `handleCreateSubmit` and `handleEditSubmit` catch blocks
3. Add `reset()` to both modal `onClose` handlers
4. Add modal-open guard to error banner render condition
5. Write tests for all 3 bug fixes
6. Run full test suite to verify no regressions

### What to Defer
- Nothing to defer -- all 3 bugs are simple, related, and can be fixed in one pass

### Estimated Changes
- **Files modified:** 1 (`src/components/manager/UsersPanel.tsx`)
- **Lines changed:** ~10 lines modified/added
- **New tests:** ~5-8 tests covering error retention, error clearing, and single-channel display
- **Risk:** Very low -- surgical changes with clear before/after semantics

## Playwright Reproduction Evidence

Screenshots saved in `.claude/features/users-error-handling/screenshots/`:

1. `01-form-filled.png` -- Form filled with "test-error@example.com", "Error Test User", role "talker" checked. Shows modal over Users panel with 1 existing user.

2. `02-after-submit.png` -- After submitting, shows:
   - **Bug #8 confirmed:** All form fields are empty (email, name, roles all cleared) despite the error
   - **Bug #12 confirmed:** Error banner visible INSIDE the modal ("Failed to create user: insert or update on table "users" violates foreign key constraint "users_created_by_fkey"") AND BEHIND the modal (red banner visible through the modal overlay)
   - **Bug #10 confirmed by code analysis:** The `onClose` handler does not call `reset()`, so `usersError` persists after modal close

## Next Step

**All questions resolved.** Run `/plan users-error-handling` to create implementation plan.
