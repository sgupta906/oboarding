# Plan: users-error-handling

## Metadata
- **Feature:** users-error-handling (Bugs #8, #10, #12)
- **Created:** 2026-02-16T23:00
- **Status:** plan-complete
- **Based On:** `2026-02-16T23:00_research.md`

## Architecture Overview

All three bugs share one root cause: a dual-channel error mechanism with no coordination between the Zustand store (`usersError`) and the local component state (`modalError`).

```
Current (broken):
                                         +---> modalError --> modal banner  (shows)
  _createUser fails --> usersError ---+
                                      +---> store error --> panel banner  (also shows!)
  Modal close --> clears modalError only  (usersError persists)
  onSubmit resolves (no re-throw) --> UserModal thinks success --> resetForm() clears fields

Fixed:
                                         +---> modalError --> modal banner  (shows)
  _createUser fails --> usersError ---+
                                      +---> panel banner SUPPRESSED (modal is open)
  Modal close --> clears modalError AND usersError (via reset())
  onSubmit rejects (re-throw) --> UserModal catches --> skips resetForm()
```

## Tech Stack
- React 18 (useState, component props)
- Zustand store (usersError, _resetUsersError)
- Vitest + React Testing Library (unit tests)

## File Structure

### Files to Modify (1 file)

| File | Changes | Lines of Interest |
|------|---------|-------------------|
| `src/components/manager/UsersPanel.tsx` | 5 surgical edits, ~10 lines | L24, L71-73, L94-96, L179, L299-302, L314-317 |

### Files to Add Tests To (1 file)

| File | New Tests |
|------|-----------|
| `src/components/manager/UsersPanel.test.tsx` | 5 new test cases for error handling |

### Files NOT Modified

- `src/components/modals/UserModal.tsx` -- already has try/catch that skips resetForm() on rejection
- `src/hooks/useUsers.ts` -- already exposes `reset()` function
- `src/store/useOnboardingStore.ts` -- already has `_resetUsersError()` action

## Changes Detail

### Change A: Destructure `reset` from `useUsers()` (Line 24)

```typescript
// Before
const { users, isLoading, error, createNewUser, editUser, removeUser } = useUsers();
// After
const { users, isLoading, error, createNewUser, editUser, removeUser, reset } = useUsers();
```

### Change B: Re-throw in `handleCreateSubmit` catch block (Line 72)

```typescript
catch (err) {
  setModalError(err instanceof Error ? err.message : 'Failed to create user');
  throw err;  // <-- ADD: lets UserModal know the operation failed
}
```

### Change C: Re-throw in `handleEditSubmit` catch block (Line 95)

```typescript
catch (err) {
  setModalError(err instanceof Error ? err.message : 'Failed to update user');
  throw err;  // <-- ADD: lets UserModal know the operation failed
}
```

### Change D: Clear store error on modal close (Lines 299-302, 314-317)

```typescript
// Create modal onClose
onClose={() => {
  setShowCreateModal(false);
  setModalError(null);
  reset();  // <-- ADD: clears usersError in store
}}

// Edit modal onClose
onClose={() => {
  setEditingUser(null);
  setModalError(null);
  reset();  // <-- ADD: clears usersError in store
}}
```

### Change E: Suppress store error banner while modal is open (Line 179)

```typescript
// Before
{error && (
// After
{error && !showCreateModal && editingUser === null && (
```

## Testing Strategy

### Unit Tests (5 new, in UsersPanel.test.tsx)

The existing test file already mocks `useUsers`, `UserModal`, and `DeleteConfirmationDialog` as stubs. The mock `UserModal` stub exposes `onSubmit` and `onClose` via buttons. The mock `useUsers` return includes `reset: vi.fn()`.

New tests needed:

1. **Bug #8 -- form retains data on create error:** Configure `mockCreateNewUser` to reject. Click "Submit Modal". Verify `createNewUser` was called (error path exercised). Verify modal remains open (not dismissed).

2. **Bug #8 -- form retains data on edit error:** Configure `mockEditUser` to reject. Open edit modal, click "Submit Modal". Verify modal remains open.

3. **Bug #10 -- store error cleared on create modal close:** Set `error` in `mockUseUsersReturn`. Open create modal, click "Close Modal". Verify `reset` was called.

4. **Bug #10 -- store error cleared on edit modal close:** Open edit modal, click "Close Modal". Verify `reset` was called.

5. **Bug #12 -- store error suppressed while modal open:** Set `error` in `mockUseUsersReturn`. Verify error banner visible. Open create modal. Verify error banner no longer visible (suppressed by modal-open guard).

### Existing Tests (no changes needed)

- The existing "shows error message when error is present" test still passes because it renders without any modal open.
- All 474 existing tests continue passing.

## Implementation Notes

### Decisions
- Keep the store setting `usersError` on CRUD failures (other consumers depend on it). Suppress the display in UsersPanel when a modal is open rather than preventing the store write.
- The `finally` block in `handleCreateSubmit`/`handleEditSubmit` (which calls `setIsSubmitting(false)`) still runs correctly after re-throw -- this is expected JavaScript behavior.

### Error Flow After Fix

**Create user fails:**
1. `_createUser` in store: sets `usersError`, throws Error
2. `handleCreateSubmit` catch: sets `modalError`, re-throws
3. `UserModal.handleSubmit` catch: error caught, `resetForm()` skipped
4. User sees error inside modal only (store banner suppressed)
5. Form fields retained

**User closes modal after error:**
1. `onClose` callback: sets modal closed, clears `modalError`, calls `reset()` (clears `usersError`)
2. All error state cleaned up

### Non-Goals
- Not changing `UserModal.tsx` (already handles rejected promises correctly)
- Not changing the Zustand store's public interface
- Not refactoring the dual-channel error mechanism itself (it works fine once coordinated)
- Not adding error handling for delete (delete uses a different dialog, no dual-channel issue)
