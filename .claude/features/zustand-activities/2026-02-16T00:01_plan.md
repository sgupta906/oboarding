# Plan: zustand-activities

## Metadata
- **Feature:** zustand-activities
- **Created:** 2026-02-16T00:01
- **Status:** plan-complete
- **Based on:** 2026-02-16T00:00_research.md
- **Slice:** 4 of 5 (instances, steps, users complete)

## Architecture Overview

This slice adds two new slices (`ActivitiesSlice` and `SuggestionsSlice`) to the existing Zustand store, then rewrites `useActivities` and `useSuggestions` as thin wrappers that read from the store instead of managing their own `useState` + subscription.

### Data Flow: Before (current)

```
OnboardingHub
  |
  useManagerData
  |   |
  |   useActivities          useSuggestions
  |   |-- useState(data)     |-- useState(data)
  |   |-- useState(loading)  |-- useState(loading)
  |   |-- useState(error)    |-- useState(error)
  |   |-- useEffect           |-- useEffect
  |   |   subscribe...        |   subscribe...
  |   |-- (read-only)        |-- useCallback: optimisticUpdateStatus
  |                           |-- useCallback: optimisticRemove
  |                           |-- useCallback: rollback
  v
  ManagerView (props: activities, suggestions, suggestionsOptimistic)
    |
    +-- ActivitySection -> ActivityFeed
    +-- KPISection
    +-- SuggestionsSection -> SuggestionCard
```

### Data Flow: After (this slice)

```
Zustand Store (useOnboardingStore)
  |-- ActivitiesSlice
  |   |-- activities: Activity[]
  |   |-- activitiesLoading: boolean
  |   |-- activitiesError: Error | null
  |   |-- _startActivitiesSubscription() -> cleanup
  |
  |-- SuggestionsSlice
  |   |-- suggestions: Suggestion[]
  |   |-- suggestionsLoading: boolean
  |   |-- suggestionsError: Error | null
  |   |-- _startSuggestionsSubscription() -> cleanup
  |   |-- _optimisticUpdateSuggestionStatus(id, status) -> snapshot
  |   |-- _optimisticRemoveSuggestion(id) -> snapshot
  |   |-- _rollbackSuggestions(snapshot)
  |
OnboardingHub
  |
  useManagerData (UNCHANGED)
  |   |
  |   useActivities (thin wrapper -> store selectors + useEffect)
  |   useSuggestions (thin wrapper -> store selectors + useEffect + useCallback wrappers)
  v
  ManagerView (props: UNCHANGED)
    ...same prop drilling, removed in slice 5
```

### Store Extension Pattern

```
OnboardingStore = InstancesSlice      (existing)
               & StepsSlice           (existing)
               & UsersSlice           (existing)
               & ActivitiesSlice      (NEW)
               & SuggestionsSlice     (NEW)
```

## Tech Stack Summary

No new dependencies. Uses existing:
- Zustand 5.x (installed in slice 1)
- React 18 hooks (`useEffect`, `useCallback`)
- Supabase service functions (`subscribeToActivities`, `subscribeToSuggestions`)

## File Structure

### New Files

None. All changes are modifications to existing files.

### Modified Files

| # | File | Lines (current) | What Changes |
|---|------|----------------|-------------|
| 1 | `src/store/useOnboardingStore.ts` | 418 | Add `ActivitiesSlice` and `SuggestionsSlice` interfaces, update `OnboardingStore` type, add 4 module-level ref-counting vars, add subscription + optimistic actions, extend `resetStoreInternals()`, add imports |
| 2 | `src/store/index.ts` | 14 | Export `ActivitiesSlice` and `SuggestionsSlice` types |
| 3 | `src/hooks/useActivities.ts` | 63 | Rewrite internals: replace `useState`/`useEffect`/`subscribeToActivities` with store selectors + `_startActivitiesSubscription` |
| 4 | `src/hooks/useSuggestions.ts` | 93 | Rewrite internals: replace `useState`/`useEffect`/`subscribeToSuggestions` with store selectors + `_startSuggestionsSubscription` + `useCallback` wrappers for optimistic ops |
| 5 | `src/store/useOnboardingStore.test.ts` | 773 | Add ~14 tests: ActivitiesSlice (7 tests) + SuggestionsSlice (7 tests including optimistic operations) |

### Files NOT Modified (verified no-change)

| File | Reason |
|------|--------|
| `src/services/supabase/activityService.ts` | Service layer consumed as-is |
| `src/services/supabase/suggestionService.ts` | Service layer consumed as-is |
| `src/hooks/useManagerData.ts` | Calls `useActivities` + `useSuggestions` -- works via unchanged APIs |
| `src/components/OnboardingHub.tsx` | Calls `useManagerData` -- unchanged |
| `src/views/ManagerView.tsx` | Receives data via props -- unchanged |
| `src/components/manager/*.tsx` | Receive data via props -- unchanged |
| `src/hooks/useSuggestions.test.ts` | Existing tests should pass -- mocks same service module |
| All other hooks and components | Not part of this migration slice |

## Data Model Changes

None. No database, migration, or schema changes. Both slices consume existing Supabase services as-is.

## Component Architecture

### ActivitiesSlice Interface

```typescript
export interface ActivitiesSlice {
  /** All activities from the realtime subscription */
  activities: Activity[];
  /** Whether the initial data load is in progress */
  activitiesLoading: boolean;
  /** Error from subscription setup */
  activitiesError: Error | null;
  /**
   * Starts the ref-counted activities subscription.
   * Returns a cleanup function that decrements the ref count
   * and unsubscribes when no consumers remain.
   */
  _startActivitiesSubscription: () => () => void;
}
```

**Ref-counting variables (module-level):**
```typescript
let activitiesRefCount = 0;
let activitiesCleanup: (() => void) | null = null;
```

**Behavior:**
- Read-only slice. No CRUD actions.
- `_startActivitiesSubscription`: increments ref, starts subscription on first consumer (sets loading=true, calls `subscribeToActivities`, callback sets data + loading=false), returns cleanup function.
- Cleanup: decrements ref, on last consumer unsubscribes + resets state to defaults.
- Double-invoke guard (`let cleaned = false`) on cleanup.

### SuggestionsSlice Interface

```typescript
export interface SuggestionsSlice {
  /** All suggestions from the realtime subscription */
  suggestions: Suggestion[];
  /** Whether the initial data load is in progress */
  suggestionsLoading: boolean;
  /** Error from subscription setup */
  suggestionsError: Error | null;
  /**
   * Starts the ref-counted suggestions subscription.
   * Returns a cleanup function that decrements the ref count
   * and unsubscribes when no consumers remain.
   */
  _startSuggestionsSubscription: () => () => void;
  /**
   * Optimistically updates a suggestion's status.
   * Returns the pre-mutation snapshot for rollback.
   */
  _optimisticUpdateSuggestionStatus: (id: number | string, status: SuggestionStatus) => Suggestion[];
  /**
   * Optimistically removes a suggestion.
   * Returns the pre-mutation snapshot for rollback.
   */
  _optimisticRemoveSuggestion: (id: number | string) => Suggestion[];
  /**
   * Restores suggestions from a snapshot.
   */
  _rollbackSuggestions: (snapshot: Suggestion[]) => void;
}
```

**Ref-counting variables (module-level):**
```typescript
let suggestionsRefCount = 0;
let suggestionsCleanup: (() => void) | null = null;
```

**Behavior:**
- Subscription management identical to ActivitiesSlice.
- Optimistic operations are pure synchronous state mutations:
  - `_optimisticUpdateSuggestionStatus(id, status)`: captures `get().suggestions` as snapshot, maps to update status, calls `set()`, returns snapshot.
  - `_optimisticRemoveSuggestion(id)`: captures snapshot, filters out by id, calls `set()`, returns snapshot.
  - `_rollbackSuggestions(snapshot)`: calls `set({ suggestions: snapshot })`.
- Server calls (`updateSuggestionStatus`, `deleteSuggestion`) remain in `OnboardingHub` -- NOT wrapped in store.

### Hook Migration: useActivities

```typescript
// AFTER: thin wrapper over store
export function useActivities(enabled: boolean = true): UseActivitiesReturn {
  const data = useOnboardingStore((s) => s.activities);
  const isLoading = useOnboardingStore((s) => s.activitiesLoading);
  const error = useOnboardingStore((s) => s.activitiesError);
  const startSubscription = useOnboardingStore((s) => s._startActivitiesSubscription);

  useEffect(() => {
    if (!enabled) return;
    const cleanup = startSubscription();
    return cleanup;
  }, [enabled, startSubscription]);

  // When disabled, return defaults (store may still have data from other consumers)
  if (!enabled) {
    return { data: [], isLoading: false, error: null };
  }
  return { data, isLoading, error };
}
```

### Hook Migration: useSuggestions

```typescript
// AFTER: thin wrapper over store
export function useSuggestions(enabled: boolean = true): UseSuggestionsReturn {
  const data = useOnboardingStore((s) => s.suggestions);
  const isLoading = useOnboardingStore((s) => s.suggestionsLoading);
  const error = useOnboardingStore((s) => s.suggestionsError);
  const startSubscription = useOnboardingStore((s) => s._startSuggestionsSubscription);
  const storeOptimisticUpdate = useOnboardingStore((s) => s._optimisticUpdateSuggestionStatus);
  const storeOptimisticRemove = useOnboardingStore((s) => s._optimisticRemoveSuggestion);
  const storeRollback = useOnboardingStore((s) => s._rollbackSuggestions);

  useEffect(() => {
    if (!enabled) return;
    const cleanup = startSubscription();
    return cleanup;
  }, [enabled, startSubscription]);

  const optimisticUpdateStatus = useCallback(
    (id: number | string, status: SuggestionStatus) => storeOptimisticUpdate(id, status),
    [storeOptimisticUpdate]
  );

  const optimisticRemove = useCallback(
    (id: number | string) => storeOptimisticRemove(id),
    [storeOptimisticRemove]
  );

  const rollback = useCallback(
    (snapshot: Suggestion[]) => storeRollback(snapshot),
    [storeRollback]
  );

  if (!enabled) {
    return { data: [], isLoading: false, error: null, optimisticUpdateStatus, optimisticRemove, rollback };
  }
  return { data, isLoading, error, optimisticUpdateStatus, optimisticRemove, rollback };
}
```

### State Management

- Activities: Zustand store state, updated by realtime subscription callback. No local React state.
- Suggestions: Zustand store state, updated by realtime subscription callback. Optimistic mutations via `set()`. No local React state.
- Both hooks return the `enabled=false` defaults (`[]`, `false`, `null`) directly without touching the store, so the store retains data for other active consumers.

## Testing Strategy

### New Store Tests (~14 tests in `src/store/useOnboardingStore.test.ts`)

**ActivitiesSlice (7 tests):**
1. Initial state: empty array, loading false, error null
2. `_startActivitiesSubscription` calls `subscribeToActivities`
3. Subscription callback updates `activities` and clears loading
4. Subscription error sets error and clears loading
5. Second start is no-op (ref-counting)
6. Last cleanup unsubscribes and resets state
7. Double cleanup is safe (idempotent)

**SuggestionsSlice (7 tests):**
1. Initial state: empty array, loading false, error null
2. `_startSuggestionsSubscription` calls `subscribeToSuggestions`
3. Subscription callback updates `suggestions` and clears loading
4. `_optimisticUpdateSuggestionStatus` changes status and returns snapshot
5. `_optimisticRemoveSuggestion` removes suggestion and returns snapshot
6. `_rollbackSuggestions` restores previous state
7. Last cleanup unsubscribes and resets state

### Existing Tests (must continue passing)

- `src/hooks/useSuggestions.test.ts` (3 tests): Verifies optimistic operations via `renderHook`. These mock `subscribeToSuggestions` from the same service module the store uses, so the mock should intercept correctly.
- All 398 existing tests across 28 files.

### Test Mocking Pattern

Same pattern as existing tests:
```typescript
const mockActivitiesUnsubscribe = vi.fn();
const mockSubscribeToActivities = vi.fn();
const mockSuggestionsUnsubscribe = vi.fn();
const mockSubscribeToSuggestions = vi.fn();

// Added to existing vi.mock('../services/supabase', ...)
subscribeToActivities: (...args) => mockSubscribeToActivities(...args),
subscribeToSuggestions: (...args) => mockSubscribeToSuggestions(...args),
```

The `beforeEach` block must extend `useOnboardingStore.setState()` to include:
```typescript
activities: [],
activitiesLoading: false,
activitiesError: null,
suggestions: [],
suggestionsLoading: false,
suggestionsError: null,
```

## Implementation Notes

### Design Decisions

1. **Two slices in one PR:** Both `ActivitiesSlice` and `SuggestionsSlice` are structurally simpler than any previous slice. Activities is read-only. Suggestions has optimistic operations but no async server call wrapping. The combined complexity is less than the `UsersSlice` alone.

2. **Optimistic operations as pure state mutations:** The store provides `_optimisticUpdateSuggestionStatus`, `_optimisticRemoveSuggestion`, and `_rollbackSuggestions` as pure synchronous state operations. The actual server calls (`updateSuggestionStatus`, `deleteSuggestion`) remain in `OnboardingHub`. This mirrors the existing hook API exactly.

3. **`enabled` parameter handled in hooks, not store:** The hooks return defaults (`[]`, `false`, `null`) when `enabled=false` and skip calling `_startSubscription`. The store itself has no concept of "enabled" -- it just manages data and subscriptions.

4. **Error type is `Error | null`:** Both slices use `Error | null`, matching instances and steps slices. Only `UsersSlice` uses `string | null` (historical pattern from the users hook).

5. **Stale closure improvement:** The current `useSuggestions` hook uses `useCallback([data])` which captures `data` at render time. The store's `get().suggestions` captures at call time, which is actually better (no stale closure risk). Functionally equivalent for the callers.

### Patterns Followed

- Slice interfaces with prefixed state names
- Module-level scalar ref-counting
- Double-invoke guard on cleanup functions
- `resetStoreInternals()` extended for test isolation
- TSDoc comments on all exports
- Barrel exports via `src/store/index.ts`
- Internal actions prefixed with `_`

### Trade-offs

- **Not wrapping server calls:** The store could wrap `updateSuggestionStatus` and `deleteSuggestion` (like `_editUser`/`_removeUser` in UsersSlice). Deferred to slice 5 to minimize behavioral changes and risk in this slice.
- **Not eliminating prop drilling:** Components could read from the store directly. Deferred to slice 5 to keep this slice focused on data migration.

## Non-Goals

- Removing prop drilling (slice 5)
- Modifying `useManagerData` (slice 5)
- Wrapping suggestion server calls in store actions (slice 5 or beyond)
- Modifying `OnboardingHub` or any component (no changes needed)
- Adding devtools middleware (deferred)
- Modifying service layer (`activityService.ts`, `suggestionService.ts`)
