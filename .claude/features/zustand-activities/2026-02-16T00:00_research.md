# Research: zustand-activities

## Metadata
- **Feature:** zustand-activities
- **Created:** 2026-02-16T00:00
- **Status:** research-complete
- **Researcher:** research-agent

## Feature Context

This is slice 4 of 5 in the incremental Zustand migration. Slices 1-3 (instances, steps, users) are complete and committed. The existing store at `src/store/useOnboardingStore.ts` contains `InstancesSlice`, `StepsSlice`, and `UsersSlice` with ref-counted subscriptions and optimistic updates.

**This slice adds an `ActivitiesSlice` and a `SuggestionsSlice` to the existing Zustand store, then migrates the `useActivities` and `useSuggestions` hooks.** It eliminates prop drilling for suggestions (currently threaded through OnboardingHub -> ManagerView -> KPISection/SuggestionsSection) and consolidates activities into shared state.

### Where it fits in the project

| # | Feature | Status |
|---|---------|--------|
| 1 | `zustand-store` | **Complete** -- store + instances slice |
| 2 | `zustand-steps` | **Complete** -- steps slice |
| 3 | `zustand-users` | **Complete** -- users slice |
| 4 | `zustand-activities` | **THIS** -- activities + suggestions slices |
| 5 | `zustand-cleanup` | Queued |

### Dependencies on other features
- **Depends on:** Slices 1-3 complete. The Zustand store at `src/store/useOnboardingStore.ts` must exist with `InstancesSlice`, `StepsSlice`, `UsersSlice`, and the established ref-counting patterns. **All complete.**

### What depends on this feature
- Slice 5 (`zustand-cleanup`) will remove old hooks, slim OnboardingHub to a thin router. This slice must be complete first so all data streams are in the store.

## Requirements

### Functional Requirements

The feature adds `ActivitiesSlice` and `SuggestionsSlice` to the existing Zustand store, managing `Activity[]` and `Suggestion[]` data from realtime subscriptions. The activities slice subscribes via `subscribeToActivities()` (channel `activities-all`), and the suggestions slice subscribes via `subscribeToSuggestions()` (channel `suggestions-all`).

The `useActivities` and `useSuggestions` hooks are migrated to read from the store instead of maintaining independent `useState` + subscription patterns. Both hooks preserve their exact return types and APIs:
- `useActivities`: Returns `{ data: Activity[], isLoading: boolean, error: Error | null }` with `enabled` parameter
- `useSuggestions`: Returns `{ data: Suggestion[], isLoading: boolean, error: Error | null, optimisticUpdateStatus, optimisticRemove, rollback }` with `enabled` parameter

The suggestions slice provides optimistic operations: `_updateSuggestionStatus` and `_removeSuggestion` with rollback support. Both subscriptions use ref-counting to start on first consumer mount and stop when no consumers remain.

The `useManagerData` hook continues aggregating `useActivities` + `useSuggestions` + `useOnboardingInstances`, and `OnboardingHub` continues consuming `useManagerData` to pass data to `ManagerView`. Existing hooks that are not migrated (`useTemplates`, `useRoles`, `useCreateOnboarding`, etc.) remain untouched. All 398 existing tests continue passing after migration.

### Technical Requirements

The store file is extended (not replaced) by adding `ActivitiesSlice` and `SuggestionsSlice` alongside existing slices using intersection types. New unit tests are added for both slices in `src/store/useOnboardingStore.test.ts`. TypeScript types (`Activity`, `Suggestion`, `SuggestionStatus`) are imported from `src/types/index.ts`. The implementation follows patterns established in slices 1-3: TSDoc comments, module-level ref-counting, barrel exports, and Supabase service mocking in tests.

### Constraints
- The app must be fully functional after this slice -- no half-broken state
- No changes to the Supabase service layer (`activityService.ts`, `suggestionService.ts`) -- the store consumes them as-is
- Old hooks that are NOT being migrated in this slice must remain untouched
- The `useManagerData` hook should NOT be removed in this slice (that is for slice 5, `zustand-cleanup`)

## Existing Code Analysis

### Project State
- Project exists: YES (18 features completed through `zustand-users`)
- Test baseline: **398 tests** across 28 test files, all passing
- Build: Clean
- Zustand: Already installed (^5.x) from slice 1

### Current Data Flow (Activities)

```
OnboardingHub mounts (manager view active)
    |
    v
useManagerData({ enableDashboardData: true, enableInstances: true })
    |
    v
useActivities(enabled = enableDashboardData)
    |
    v
useState: data (Activity[]), isLoading, error
    |
    v
useEffect([enabled]): subscribeToActivities(callback)
    |  callback: setData(activities), setIsLoading(false)
    |
    v (subscription fires)
subscribeToActivities (from crudFactory):
  1. Immediate fetch: listActivities().then(callback)
  2. Channel 'activities-all' listens on: activities table
  3. On any change: debounced (300ms) re-fetch -> callback
    |
    v
useManagerData returns:
  activities: Activity[]  -->  passed to ManagerView as prop
    |
    v
OnboardingHub passes to ManagerView
    |
    v
ManagerView passes to ActivitySection
    |
    v
ActivitySection passes to ActivityFeed
    |
    v
ActivityFeed renders activity entries (max 10)
```

### Current Data Flow (Suggestions)

```
OnboardingHub mounts (manager view active)
    |
    v
useManagerData({ enableDashboardData: true, enableInstances: true })
    |
    v
useSuggestions(enabled = enableDashboardData)
    |
    v
useState: data (Suggestion[]), isLoading, error
    |
    v
useEffect([enabled]): subscribeToSuggestions(callback)
    |  callback: setData(suggestions), setIsLoading(false)
    |
    v (subscription fires)
subscribeToSuggestions (from crudFactory):
  1. Immediate fetch: listSuggestions().then(callback)
  2. Channel 'suggestions-all' listens on: suggestions table
  3. On any change: debounced (300ms) re-fetch -> callback
    |
    v
useSuggestions also returns:
  optimisticUpdateStatus(id, status) -> patches local state, returns snapshot
  optimisticRemove(id) -> removes from local state, returns snapshot
  rollback(snapshot) -> restores previous state
    |
    v
useManagerData returns:
  suggestions: Suggestion[]
  suggestionsOptimistic: { optimisticUpdateStatus, optimisticRemove, rollback }
    |
    v
OnboardingHub:
  - passes suggestions to ManagerView as prop
  - uses suggestionsOptimistic for handleApproveSuggestion / handleRejectSuggestion
  - calls updateSuggestionStatus / deleteSuggestion services directly
  - calls logActivity for audit trail
    |
    v
ManagerView passes suggestions to:
  1. KPISection (counts pending suggestions for "Doc Feedback" KPI)
  2. SuggestionsSection (renders pending suggestions with approve/reject)
     +-- SuggestionCard (individual card with approve/reject buttons)
```

### The Prop Drilling Problem (What This Slice Fixes)

Currently, suggestions flow through **4 levels of prop drilling**:

```
OnboardingHub (data source via useManagerData)
  |-- suggestions, onApproveSuggestion, onRejectSuggestion, loadingSuggestionIds
  v
ManagerView (passes through)
  |-- suggestions, onApprove, onReject, loadingSuggestionIds
  v
SuggestionsSection (filters & renders)
  |-- suggestions filtered to pending, onApprove, onReject, loadingSuggestionIds
  v
SuggestionCard (renders individual card)
```

Activities flow through **3 levels**:

```
OnboardingHub (data source via useManagerData)
  |-- activities
  v
ManagerView (passes through)
  |-- activities
  v
ActivitySection -> ActivityFeed (renders)
```

**After this slice:** Components could read `activities` and `suggestions` directly from the store. However, the actual wiring changes (removing prop drilling) will happen in slice 5 (`zustand-cleanup`). This slice focuses on getting the data into the store and migrating the hooks.

### Important Behavioral Note: `enabled` Parameter

Both `useActivities` and `useSuggestions` accept an `enabled` parameter (default: `true`). When `enabled` is `false`:
- Data is set to `[]`
- Loading is set to `false`
- Error is set to `null`
- No subscription is started

This is used by `useManagerData` to conditionally load dashboard data only when the manager tab is active. The store subscription actions must support this pattern. The hooks will handle the `enabled` logic by conditionally calling `_startActivitiesSubscription` / `_startSuggestionsSubscription`.

### Detailed Analysis: useActivities Hook (current)

**File:** `src/hooks/useActivities.ts` (63 lines)

**State managed:**
- `data: Activity[]` -- local `useState`, updated by subscription callback
- `isLoading: boolean` -- local `useState`, starts with `enabled` value
- `error: Error | null` -- local `useState`, stores Error objects (NOT strings)

**Subscription lifecycle:**
- `useEffect` with `[enabled]` dependency
- When enabled: calls `subscribeToActivities(callback)` and returns cleanup
- When disabled: resets all state to defaults

**Return type:**
```typescript
interface UseActivitiesReturn {
  data: Activity[];
  isLoading: boolean;
  error: Error | null;     // NOTE: Error, not string (unlike UsersSlice)
}
```

**No CRUD operations.** Activities are read-only from this hook. Activity creation happens via `logActivity()` called directly from `OnboardingHub` event handlers (fire-and-forget pattern, not through the hook).

**No existing tests.** There is no `useActivities.test.ts` file.

### Detailed Analysis: useSuggestions Hook (current)

**File:** `src/hooks/useSuggestions.ts` (93 lines)

**State managed:**
- `data: Suggestion[]` -- local `useState`, updated by subscription callback
- `isLoading: boolean` -- local `useState`, starts with `enabled` value
- `error: Error | null` -- local `useState`, stores Error objects (NOT strings)

**Subscription lifecycle:**
- `useEffect` with `[enabled]` dependency
- When enabled: calls `subscribeToSuggestions(callback)` and returns cleanup
- When disabled: resets all state to defaults

**Optimistic operations (defined as `useCallback`):**
- `optimisticUpdateStatus(id, status)` -- patches suggestion in local `data` array via `setData`, returns snapshot of `data` before patch
- `optimisticRemove(id)` -- removes suggestion from local `data` array via `setData`, returns snapshot
- `rollback(snapshot)` -- restores `data` from provided snapshot

**Return type:**
```typescript
interface UseSuggestionsReturn {
  data: Suggestion[];
  isLoading: boolean;
  error: Error | null;     // NOTE: Error, not string (unlike UsersSlice)
  optimisticUpdateStatus: (id: number | string, status: SuggestionStatus) => Suggestion[];
  optimisticRemove: (id: number | string) => Suggestion[];
  rollback: (snapshot: Suggestion[]) => void;
}
```

**Existing test file:** `src/hooks/useSuggestions.test.ts` (80 lines, 3 tests)

Tests cover:
1. `optimisticUpdateStatus` changes suggestion status in data
2. `optimisticRemove` removes suggestion from data
3. `rollback` restores original data on error

These tests mock `subscribeToSuggestions` which the store will also use.

### Detailed Analysis: useManagerData Hook (aggregator)

**File:** `src/hooks/useManagerData.ts` (95 lines)

**How it consumes the hooks being migrated:**
```typescript
const suggestionsResult = useSuggestions(enableDashboardData);
const activitiesResult = useActivities(enableDashboardData);
const instancesResult = useOnboardingInstances(enableInstances);
```

**What it returns:**
```typescript
interface UseManagerDataResult {
  suggestions: Suggestion[];
  activities: Activity[];
  onboardingInstances: OnboardingInstance[];
  isDashboardLoading: boolean;
  areInstancesLoading: boolean;
  suggestionsOptimistic: SuggestionsOptimistic;
}
```

**Key behavior:**
- Manages a timeout fallback (`timedOut` state) so the UI never sticks on a spinner for more than 3 seconds
- `isDashboardLoading` is true while suggestions OR activities are loading (AND not timed out)
- Passes through optimistic operations from `useSuggestions`

**After migration:** `useManagerData` continues to call `useActivities` and `useSuggestions` -- it does not need to know about the store. The hooks are thin wrappers. No changes to `useManagerData` in this slice.

### Detailed Analysis: OnboardingHub (suggestion actions)

**File:** `src/components/OnboardingHub.tsx` (343 lines)

**Suggestion-related state and handlers:**
- `loadingSuggestionIds: Set<number | string>` -- tracks in-flight suggestion operations
- `handleApproveSuggestion(id)` -- calls `suggestionsOptimistic.optimisticUpdateStatus`, then `updateSuggestionStatus` service, with rollback on error
- `handleRejectSuggestion(id)` -- calls `suggestionsOptimistic.optimisticRemove`, then `deleteSuggestion` service, with rollback on error

**IMPORTANT:** `OnboardingHub` calls `updateSuggestionStatus()` and `deleteSuggestion()` directly from the Supabase service layer, NOT through the hook. The hook only provides the optimistic state operations. The actual server calls remain in `OnboardingHub`.

This means the store's suggestions slice only needs to handle:
1. Subscription management (read-only data stream)
2. Optimistic state mutations (for UI responsiveness)
3. Rollback capability

It does NOT need to wrap `updateSuggestionStatus` or `deleteSuggestion` as store actions (unlike users which wraps all CRUD). The service calls stay in `OnboardingHub`.

### Detailed Analysis: Service Functions

**Activities Service (`activityService.ts`):**
```typescript
const crud = createCrudService<Activity>({
  table: 'activities',
  selectClause: '*',
  mapRow: (row) => toActivity(row as ActivityRow),
  entityName: 'activity',
  listLimit: 50,
  listOrder: { column: 'timestamp', ascending: false },
  subscription: {
    channelName: 'activities-all',
    tables: [{ table: 'activities' }],
  },
});
export const listActivities = crud.list;
export const subscribeToActivities = crud.subscribe;
```

Exports `logActivity()` separately -- not part of the subscription/CRUD factory.

**Suggestions Service (`suggestionService.ts`):**
```typescript
const crud = createCrudService<Suggestion>({
  table: 'suggestions',
  selectClause: '*',
  mapRow: (row) => toSuggestion(row as SuggestionRow),
  entityName: 'suggestion',
  subscription: {
    channelName: 'suggestions-all',
    tables: [{ table: 'suggestions' }],
  },
});
export const listSuggestions = crud.list;
export const deleteSuggestion = crud.remove;
export const subscribeToSuggestions = crud.subscribe;
```

Exports `createSuggestion()` and `updateSuggestionStatus()` separately.

**Key detail:** Neither subscription uses `shared: true`. Each call to `subscribeToActivities` / `subscribeToSuggestions` creates its own Supabase channel. The Zustand store's ref-counting will ensure only one subscription exists.

### Existing Zustand Store Patterns (from slices 1-3)

**File:** `src/store/useOnboardingStore.ts` (418 lines)

**Patterns established:**
1. **Slice interfaces** with prefixed state names
2. **Combined type:** `OnboardingStore = InstancesSlice & StepsSlice & UsersSlice` (extend with `& ActivitiesSlice & SuggestionsSlice`)
3. **Module-level scalar ref-counting** for global subscriptions (instances, users)
4. **`resetStoreInternals()`** for test isolation
5. **Double-invoke guard** on cleanup functions (`let cleaned = false`)
6. **State reset on last cleanup**

### Key Types

```typescript
interface Activity {
  id: string;
  userInitials: string;
  action: string;
  timeAgo: string;
  timestamp?: number;
  userId?: string;
  resourceType?: string;
  resourceId?: string;
}

interface Suggestion {
  id: number | string;
  stepId: number;
  user: string;
  text: string;
  status: SuggestionStatus;
  createdAt?: number;
  instanceId?: string;
}

type SuggestionStatus = 'pending' | 'reviewed' | 'implemented';
```

## Store Design

### ActivitiesSlice

Activities is the simplest possible slice: read-only flat array with a global subscription.

```typescript
interface ActivitiesSlice {
  activities: Activity[];
  activitiesLoading: boolean;
  activitiesError: Error | null;
  _startActivitiesSubscription: () => () => void;
}
```

No CRUD actions needed. Activity logging is a fire-and-forget call to `logActivity()` from event handlers, not managed through the store.

**Ref-counting:** Scalar, like instances and users.

```typescript
let activitiesRefCount = 0;
let activitiesCleanup: (() => void) | null = null;
```

### SuggestionsSlice

Suggestions is slightly more complex due to optimistic operations.

```typescript
interface SuggestionsSlice {
  suggestions: Suggestion[];
  suggestionsLoading: boolean;
  suggestionsError: Error | null;
  _startSuggestionsSubscription: () => () => void;
  _optimisticUpdateSuggestionStatus: (id: number | string, status: SuggestionStatus) => Suggestion[];
  _optimisticRemoveSuggestion: (id: number | string) => Suggestion[];
  _rollbackSuggestions: (snapshot: Suggestion[]) => void;
}
```

**Key design decision:** The optimistic operations (`_optimisticUpdateSuggestionStatus`, `_optimisticRemoveSuggestion`, `_rollbackSuggestions`) are NOT async server calls. They are pure state mutations that return a snapshot for the caller to use for rollback. The actual server calls (`updateSuggestionStatus`, `deleteSuggestion`) remain in `OnboardingHub`.

This mirrors the existing `useSuggestions` hook API where:
- `optimisticUpdateStatus(id, status)` returns the pre-mutation snapshot
- `optimisticRemove(id)` returns the pre-mutation snapshot
- `rollback(snapshot)` restores state from a snapshot

**Ref-counting:** Scalar, like instances and users.

```typescript
let suggestionsRefCount = 0;
let suggestionsCleanup: (() => void) | null = null;
```

### Error Type Consistency

Both `useActivities` and `useSuggestions` currently use `Error | null` for their error state (unlike `useUsers` which uses `string | null`). The store slices should match: `activitiesError: Error | null` and `suggestionsError: Error | null`. This is consistent with the instances and steps slices.

## Code to Reuse

| File | What can be reused |
|------|-------------------|
| `src/store/useOnboardingStore.ts` | Extend with `ActivitiesSlice` + `SuggestionsSlice` -- all existing patterns reused |
| `src/store/index.ts` | Add new slice types to barrel exports |
| `src/services/supabase/activityService.ts` | `subscribeToActivities()` consumed as-is |
| `src/services/supabase/suggestionService.ts` | `subscribeToSuggestions()` consumed as-is |
| `src/store/useOnboardingStore.test.ts` | Test patterns: mock setup, `setState()` + `resetStoreInternals()` in `beforeEach` |
| `src/hooks/useSuggestions.test.ts` | Existing tests verify optimistic operations -- must continue passing |

## Code to Modify

| File | What Changes | Current Lines |
|------|-------------|--------------|
| `src/store/useOnboardingStore.ts` | Add `ActivitiesSlice` and `SuggestionsSlice` interfaces, update `OnboardingStore` type, add scalar ref-counting for activities and suggestions, add subscription actions and optimistic operations, extend `resetStoreInternals()`, import service functions | 418 |
| `src/store/index.ts` | Export `ActivitiesSlice` and `SuggestionsSlice` types | 14 |
| `src/hooks/useActivities.ts` | Rewrite internals to read from store, preserve return type API | 63 |
| `src/hooks/useSuggestions.ts` | Rewrite internals to read from store, preserve return type API including optimistic operations | 93 |
| `src/store/useOnboardingStore.test.ts` | Add tests for activities and suggestions slices | ~773 |

## Code NOT to Modify

| File | Reason |
|------|--------|
| `src/services/supabase/activityService.ts` | Service layer stays as-is |
| `src/services/supabase/suggestionService.ts` | Service layer stays as-is |
| `src/hooks/useManagerData.ts` | Continues to call `useActivities` and `useSuggestions` which are thin wrappers |
| `src/components/OnboardingHub.tsx` | Continues to consume `useManagerData` -- no changes needed |
| `src/views/ManagerView.tsx` | Receives suggestions/activities via props from OnboardingHub -- no changes |
| `src/components/manager/SuggestionsSection.tsx` | Receives suggestions via props -- no changes |
| `src/components/manager/ActivitySection.tsx` | Receives activities via props -- no changes |
| `src/components/manager/ActivityFeed.tsx` | Receives activities via props -- no changes |
| `src/components/manager/KPISection.tsx` | Receives suggestions via props -- no changes |
| All other hooks | Not migrated in this slice |
| All other components | No direct dependency on `useActivities` or `useSuggestions` |

## Patterns to Follow

1. **Slice interface with prefixed state names:** `activities`/`activitiesLoading`/`activitiesError` and `suggestions`/`suggestionsLoading`/`suggestionsError`.

2. **Module-level scalar ref-counting:** Like instances and users slices. Four new module-level variables: `activitiesRefCount`, `activitiesCleanup`, `suggestionsRefCount`, `suggestionsCleanup`.

3. **`resetStoreInternals()` must reset activities and suggestions state too:** Extend the existing function to clear all four new variables.

4. **Action naming:** Internal actions prefixed with `_` (e.g., `_startActivitiesSubscription`, `_startSuggestionsSubscription`, `_optimisticUpdateSuggestionStatus`, `_optimisticRemoveSuggestion`, `_rollbackSuggestions`).

5. **Hook as thin wrapper:** Migrated hooks use selectors to read state, `useEffect` for subscription lifecycle, and `useCallback` wrappers for optimistic operations.

6. **Error as `Error | null`:** Both slices use `Error | null` (matching instances and steps, unlike users which uses `string | null`).

7. **Supabase mocking pattern:** Tests mock `../services/supabase` at module level with `vi.mock()`.

8. **TSDoc comments on all exports.**

9. **Barrel exports via `src/store/index.ts` and `src/hooks/index.ts`.**

10. **Double-invoke guard on cleanup functions:** `let cleaned = false` pattern.

## Constraints

### Performance
- Activities are capped at 50 rows by `listLimit: 50` in the service config. No performance concerns.
- Suggestions are unbounded by default (uses crudFactory default `listLimit: 200`). Not a concern for typical usage.
- Both subscriptions use 300ms debounce on realtime re-fetches (from crudFactory).
- Optimistic updates are synchronous `set()` calls -- instant UI feedback.

### Platform
- React 18 + Zustand 5.x: fully compatible, same as slices 1-3.
- No SSR concerns (client-only SPA).

### Dependencies
- `subscribeToActivities` from `activityService.ts` -- consumed as-is
- `subscribeToSuggestions` from `suggestionService.ts` -- consumed as-is
- Zustand already installed from slice 1.

## Risk Assessment

### Technical Risks

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Stale closure in `optimisticUpdateStatus` / `optimisticRemove`: Current `useSuggestions` uses `useCallback` with `[data]` dependency, capturing the current `data` array. The store approach uses `get().suggestions` which always reads current state. This is actually an improvement but is a subtle behavioral change. | Low | Low | The `get()` approach is better -- it captures the snapshot at call time, not at render time. The existing tests verify the behavior works correctly. |
| `useSuggestions.test.ts` mocks `subscribeToSuggestions` to call callback synchronously. After migration, the hook's `useEffect` starts the store subscription. The mock's synchronous callback delivery during subscription setup should work with the store's `set()`. | Medium | Medium | The `crudFactory.subscribe` calls `list().then(callback)` which is async in production. But test mocks call callback synchronously. The store's `set()` in the subscription callback will update state. Verify all tests pass; adjust mock timing if needed. |
| Two new slices in one PR: Adding both `ActivitiesSlice` and `SuggestionsSlice` is more work than previous slices which added one each. | Low | Low | Both slices are simple. Activities is read-only (simplest possible slice). Suggestions adds optimistic operations but no server-side CRUD wrapping. Total complexity is less than the users slice. |
| `useManagerData` timeout logic interacts with loading states from migrated hooks. If the store's loading state behaves differently from the hook's `useState`, the timeout could fire incorrectly. | Medium | Low | The store sets `loading: true` when subscription starts and `loading: false` when callback fires. This matches the existing hook behavior exactly. |

### Complexity
- **Level:** Simple-Medium
- **Rationale:** This slice adds two slices but both are structurally simpler than any previous slice. Activities is read-only (no CRUD, no optimistic updates). Suggestions has optimistic operations but they are pure state mutations (not async server calls). Neither slice introduces per-key subscriptions or race conditions. The patterns are well-established from slices 1-3.

## Open Questions

- [x] Q1: Should the suggestions store actions wrap `updateSuggestionStatus` and `deleteSuggestion` server calls (like `_editUser`/`_removeUser` in UsersSlice)?
  - Resolution: **No.** The current architecture has `OnboardingHub` calling the service functions directly, with the hook only providing optimistic state mutations. The store should mirror this pattern: provide `_optimisticUpdateSuggestionStatus`, `_optimisticRemoveSuggestion`, and `_rollbackSuggestions` as pure state operations. Server calls remain in `OnboardingHub`. Wrapping them in the store would be a behavioral change that belongs in slice 5 (cleanup) if desired.

- [x] Q2: Should `useManagerData` be modified in this slice?
  - Resolution: **No.** `useManagerData` calls `useActivities` and `useSuggestions` which will now be thin wrappers over the store. It does not need to know about the store. Any simplification of `useManagerData` (or its removal) belongs in slice 5 (cleanup).

- [x] Q3: Should the prop drilling be eliminated in this slice (having `SuggestionsSection`/`ActivitySection` read from the store directly)?
  - Resolution: **No.** This slice focuses on getting the data into the store and migrating the hooks. The prop drilling elimination is a component-level change that belongs in slice 5 (cleanup). Making both changes at once increases risk.

- [x] Q4: Should `activitiesError` and `suggestionsError` be `Error | null` or `string | null`?
  - Resolution: `Error | null`. Both existing hooks use `Error | null`. This matches instances and steps slices. Only the users slice uses `string | null` (due to how `UsersPanel` renders the error directly as text).

- [x] Q5: Does `resetStoreInternals()` need to be extended?
  - Resolution: Yes. Add activities and suggestions ref-count reset alongside instances, steps, and users resets.

- [x] Q6: Will `useSuggestions.test.ts` still pass after migration?
  - Resolution: The tests mock `../services/supabase` which is the same module the store imports from. The mock will intercept both direct hook usage and store-mediated usage. The tests use `renderHook` + `act` which should handle the `useEffect` timing correctly. Verify by running tests after migration.

## Recommended Approach

### Implementation Strategy

**Extend the existing store with `ActivitiesSlice` and `SuggestionsSlice`, then rewrite `useActivities` and `useSuggestions` as thin wrappers, following the exact patterns from slices 1-3.**

This is the most straightforward of all slices because:
1. Activities is read-only (no CRUD wrapping at all)
2. Suggestions optimistic operations are pure state mutations (no async server call wrapping)
3. There are only 2 direct consumers: `useManagerData` calls both hooks, and `useManagerData` is called from `OnboardingHub`
4. No race condition bugs to fix
5. No per-key subscriptions (unlike steps)

### Order of Work

1. **Extend `src/store/useOnboardingStore.ts`:**
   - Add `ActivitiesSlice` interface
   - Add `SuggestionsSlice` interface
   - Update `OnboardingStore = InstancesSlice & StepsSlice & UsersSlice & ActivitiesSlice & SuggestionsSlice`
   - Add scalar ref-counting for activities (`activitiesRefCount`, `activitiesCleanup`)
   - Add scalar ref-counting for suggestions (`suggestionsRefCount`, `suggestionsCleanup`)
   - Add `_startActivitiesSubscription` action
   - Add `_startSuggestionsSubscription` action
   - Add `_optimisticUpdateSuggestionStatus`, `_optimisticRemoveSuggestion`, `_rollbackSuggestions` actions
   - Extend `resetStoreInternals()` to clear activities and suggestions ref-counting
   - Add new state fields: `activities: []`, `activitiesLoading: false`, `activitiesError: null`, `suggestions: []`, `suggestionsLoading: false`, `suggestionsError: null`
   - Import service functions: `subscribeToActivities`, `subscribeToSuggestions`

2. **Update `src/store/index.ts`:**
   - Export `ActivitiesSlice` and `SuggestionsSlice` types

3. **Add store tests for both slices in `src/store/useOnboardingStore.test.ts`:**
   - ActivitiesSlice:
     - Initial state (empty array, loading false, error null)
     - `_startActivitiesSubscription` starts subscription
     - Subscription callback updates `activities` and clears loading
     - Error handling on subscription setup
     - Ref-counting: second start is no-op, cleanup decrements, last cleanup unsubscribes + resets state, double cleanup is safe, re-subscribe after cleanup works
   - SuggestionsSlice:
     - Initial state (empty array, loading false, error null)
     - `_startSuggestionsSubscription` starts subscription
     - Subscription callback updates `suggestions` and clears loading
     - Error handling on subscription setup
     - Ref-counting: full suite (same as activities)
     - `_optimisticUpdateSuggestionStatus` changes status in suggestions array
     - `_optimisticRemoveSuggestion` removes suggestion from array
     - `_rollbackSuggestions` restores previous state
     - Optimistic operations return snapshot of previous state

4. **Rewrite `src/hooks/useActivities.ts`:**
   - Import from store instead of local useState
   - `useEffect` conditionally calls `_startActivitiesSubscription()` based on `enabled`
   - Return type unchanged: `{ data, isLoading, error }`

5. **Rewrite `src/hooks/useSuggestions.ts`:**
   - Import from store instead of local useState
   - `useEffect` conditionally calls `_startSuggestionsSubscription()` based on `enabled`
   - `useCallback` wrappers call store actions for optimistic operations
   - Return type unchanged: `{ data, isLoading, error, optimisticUpdateStatus, optimisticRemove, rollback }`

6. **Verify `src/hooks/useSuggestions.test.ts`:**
   - Run existing tests -- they should pass since they mock the same service module
   - Adjust if timing differences cause issues

7. **Run full test suite** -- all 398+ tests must pass

### What to Defer

- **Removing prop drilling** -- slice 5 (`zustand-cleanup`) -- components could read from store directly
- **Removing `useManagerData`** -- slice 5 -- it may be unnecessary after components read from store
- **Wrapping `updateSuggestionStatus` / `deleteSuggestion` as store actions** -- slice 5 or beyond
- **Devtools middleware** -- deferred from slice 1, still deferred
- **Changes to OnboardingHub / ManagerView** -- they continue working via unchanged hook APIs

## Next Step

**All questions resolved.**
Run `/plan zustand-activities` to create the implementation plan.
