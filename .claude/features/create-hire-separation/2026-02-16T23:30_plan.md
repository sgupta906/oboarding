# Plan: create-hire-separation

## Metadata
- **Feature:** create-hire-separation (Bug #38: `create-hire-creates-user`)
- **Created:** 2026-02-16T23:30
- **Status:** plan-complete
- **Based On:** `2026-02-16T23:30_research.md`
- **Complexity:** Simple (pure deletion, 1 file, ~22 lines removed)

## Architecture Overview

### Entity Separation: Hires vs Users

```
  HIRES (onboarding_instances)          USERS (users table)
  ================================      ================================
  Created by: Manager via               Created by: Admin via
    "Add New Employee Onboarding"         Users panel "Create User"
  Purpose: Track onboarding progress    Purpose: System account for sign-in
  Linked by: employee_email (TEXT)      Linked by: email (TEXT)
  No FK to users table                  No FK to onboarding_instances

  These are INDEPENDENT entities that MAY share an email address.
  Creating one must NOT auto-create the other.
```

### Current (Buggy) Flow

```
  Manager clicks "Add New Employee Onboarding"
    |
    v
  useCreateOnboarding.mutate(data)
    |
    v
  createOnboardingRunFromTemplate(data)
    |
    +---> Step 1: Validate employee data         [KEEP]
    +---> Step 2: Fetch template                  [KEEP]
    +---> Step 3: Create onboarding instance      [KEEP]
    +---> Step 4: addUserToAuthCredentials()       [BUG - REMOVE]
    +---> Step 4: createUser() if not exists       [BUG - REMOVE]
    +---> Return instance                         [KEEP]
```

### Fixed Flow

```
  Manager clicks "Add New Employee Onboarding"
    |
    v
  useCreateOnboarding.mutate(data)
    |
    v
  createOnboardingRunFromTemplate(data)
    |
    +---> Step 1: Validate employee data         [KEEP]
    +---> Step 2: Fetch template                  [KEEP]
    +---> Step 3: Create onboarding instance      [KEEP]
    +---> Return instance                         [KEEP]
```

## Tech Stack Summary

No new dependencies. No schema changes. Pure code deletion.

## File Structure

### Modified Files

| File | Change | Lines |
|------|--------|-------|
| `src/services/supabase/instanceService.ts` | Remove lines 355-377 (Step 4 block: auth credentials + user creation) | -23 lines |
| `src/services/supabase/instanceService.test.ts` | Add test verifying no userService import/call during instance creation | +30 lines |

### Files NOT Changed

| File | Why |
|------|-----|
| `src/hooks/useCreateOnboarding.ts` | Black-box consumer of `createOnboardingRunFromTemplate` |
| `src/services/supabase/userService.ts` | Functions remain exported for Users panel workflow |
| `src/services/supabase/index.ts` | Barrel export unchanged |
| `src/store/useOnboardingStore.ts` | Store actions unchanged |
| Any component files | No UI changes needed |

## Data Model Changes

None. The `onboarding_instances` table has no FK to `users`. The relationship is by email (TEXT) only. This fix enforces that separation at the service layer.

## Testing Strategy

### Unit Tests (1 new test, ~3 assertions)

1. **`createOnboardingRunFromTemplate` does not call userService** - Mock the dynamic `import('./userService')` and verify it is never called when creating an onboarding run. This is a regression test ensuring the hire/user separation is maintained.

### Existing Tests (must pass, no changes)

- `instanceService.test.ts` - 3 existing tests for `updateStepStatus` (unrelated to the change)
- All 508 tests in the suite - none test the internals of `createOnboardingRunFromTemplate`

### Integration / E2E Tests

None needed. The deletion removes a side effect. The existing `useCreateOnboarding` hook tests mock the entire service layer. Functional verification via Playwright during `/test` phase will confirm:
- Manager can still create a hire via the modal
- No user record appears in the Users tab after creating a hire

## Implementation Notes

### Decision: Pure Deletion vs Refactor

This is a pure deletion. The offending code (lines 355-377) is a self-contained block with no dependencies from the surrounding code. The variable `instanceId` (line 354) flows directly to the return statement (line 379). Removing the block leaves clean, working code with no gaps.

### Decision: Add Regression Test

Although the research notes this as optional, we add a regression test to prevent the coupling from being reintroduced. The test verifies that `createOnboardingRunFromTemplate` does NOT dynamically import `userService`. This is cheap to write and provides lasting value.

### Pattern: Dynamic Import Mocking

The offending code uses `await import('./userService')` (dynamic import). To test that this import does NOT happen, we can mock the `templateService` dynamic import (which IS needed) and verify the function completes without touching `userService`. The test structure:

1. Mock `../../config/supabase` (for `createOnboardingInstance` call)
2. Mock `./templateService` dynamic import (for `getTemplate` call)
3. Do NOT mock `./userService` -- if it gets called, the test will fail or we can spy on the import

### Non-Goals

- **NOT fixing Bug #44** (`delete-user-cascades-instances`) -- separate pipeline run
- **NOT changing the Users panel** -- `createUser()` in the Users panel workflow is correct behavior
- **NOT changing the auth flow** -- `addUserToAuthCredentials()` in `userService.ts:createUser()` is correct behavior
- **NOT adding UI feedback** -- no user-facing change needed; the modal behavior is identical
