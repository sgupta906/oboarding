# Research: create-hire-separation

## Metadata
- **Feature:** create-hire-separation (Bug #38: `create-hire-creates-user`)
- **Created:** 2026-02-16T23:30
- **Status:** research-complete
- **Researcher:** research-agent

## Feature Context

### Description
When a manager creates a new hire (onboarding instance) via the "Add New Employee Onboarding" modal, the system also creates a `users` table record and adds auth credentials to localStorage. **Hires and users should be separate entities.** Hires (onboarding instances) represent someone going through an onboarding checklist. Users are system accounts that can sign in with credentials.

### Where it fits
This is Bug #38 (P1 HIGH) in the Data Model & Persistence Bugs category. It is closely related to Bug #44 (`delete-user-cascades-instances`) which has the inverse problem: deleting a user also deletes their onboarding instances. Both bugs stem from the same conceptual conflation of "hire" and "user".

### Dependencies
- No prerequisite features needed. This is a standalone bug fix.
- Related bug #44 can be fixed independently but shares the same root cause philosophy.

## Requirements

### Functional Requirements
- [x] FR1: Creating an onboarding instance (hire) must NOT create a `users` table record (source: bug report)
- [x] FR2: Creating an onboarding instance must NOT add auth credentials to localStorage (source: bug report)
- [x] FR3: The onboarding instance creation itself must remain intact -- only the user/auth side effects should be removed (source: bug report)
- [x] FR4: Existing users created through the Users panel must continue to work (their `createUser` and `addUserToAuthCredentials` calls are separate and unaffected)

### Technical Requirements
- [x] TR1: Remove lines 356-377 from `instanceService.ts` (the `addUserToAuthCredentials` + `userEmailExists` + `createUser` block) inside `createOnboardingRunFromTemplate()`
- [x] TR2: The unused import of `userService` functions at line 358 can be fully removed since nothing else in `createOnboardingRunFromTemplate` uses them
- [x] TR3: Tests that mock `createOnboardingRunFromTemplate` should not break since they mock the function itself, not its internals
- [x] TR4: No changes needed to `useCreateOnboarding.ts`, `CreateOnboardingModal.tsx`, or the Zustand store -- they consume `createOnboardingRunFromTemplate` as a black box

### Constraints
- None. This is a pure removal of unwanted side effects.

## Existing Code Analysis

### The Bug: Exact Lines to Remove

**File:** `/home/sanjay/Workspace/onboarding/src/services/supabase/instanceService.ts`

Lines 356-377 inside `createOnboardingRunFromTemplate()`:

```typescript
  // Step 4: Add auth credentials and ensure user record
  // Lazy import to avoid circular dep
  const { addUserToAuthCredentials, userEmailExists, createUser } = await import('./userService');
  addUserToAuthCredentials(normalizedEmail, 'employee', instanceId);

  try {
    const exists = await userEmailExists(normalizedEmail);
    if (!exists) {
      await createUser(
        {
          email: normalizedEmail,
          name: employeeData.employeeName,
          roles: ['employee'],
          profiles: employeeData.department ? [employeeData.department] : [],
          createdBy: 'system',
        },
        'system'
      );
    }
  } catch (err) {
    console.warn('Failed to ensure user record for onboarding:', err);
  }
```

This entire block should be removed. Here is what each line does:

| Line | Code | Problem |
|------|------|---------|
| 356 | Comment: "Step 4: Add auth credentials and ensure user record" | Misleading -- hires should not get user records |
| 358 | `const { addUserToAuthCredentials, userEmailExists, createUser } = await import('./userService')` | Dynamic import of user service functions that should not be called here |
| 359 | `addUserToAuthCredentials(normalizedEmail, 'employee', instanceId)` | Adds localStorage auth credentials so the hire can sign in -- this couples hires to auth |
| 361-377 | `try { ... createUser(...) ... } catch { ... }` | Creates a `users` table row for the hire, conflating hires with system users |

### What Happens After Removal

After removing lines 356-377, `createOnboardingRunFromTemplate()` will:
1. Validate employee data (lines 328)
2. Fetch the template (lines 331-337)
3. Create the onboarding instance with steps (lines 340-354)
4. Return the instance (lines 379-382)

This is the correct, clean flow. The function creates a hire (onboarding instance) and nothing more.

### Impact on Sign-In Flow

**Key question:** Will removing `addUserToAuthCredentials` break the ability for new hires to sign in?

**Answer:** Yes, but that is the *intended behavior*. The current design conflates two separate workflows:

1. **Creating a hire** = creating an onboarding instance (New Hires tab, manager action)
2. **Creating a user** = creating a system account with sign-in credentials (Users tab, admin action)

After this fix:
- A manager creates a hire via the CreateOnboardingModal. This creates an `onboarding_instances` row.
- If the hire needs to sign in (as an employee user), an admin must ALSO create a user account via the Users panel. The Users panel's `createUser()` independently calls `addUserToAuthCredentials()`.
- The employee view looks up the onboarding instance by `employee_email` (line 42 of `OnboardingHub.tsx`), not by user ID. So the employee view works as long as both the user record (for sign-in) and the onboarding instance (for data) exist with the same email.

This is the correct separation of concerns. The two actions (create hire, create user) can be done independently or together, but one should not implicitly trigger the other.

### Callers of `createOnboardingRunFromTemplate`

Only 1 caller in the app code:
- `/home/sanjay/Workspace/onboarding/src/hooks/useCreateOnboarding.ts` line 41

This hook wraps the function and adds it to the Zustand store. No changes needed to this caller -- it is a black-box consumer.

### Callers of the Functions Being Removed

The functions removed from `createOnboardingRunFromTemplate` are still used elsewhere (and should remain exported):

| Function | Other Callers | Impact of Removal from instanceService |
|----------|--------------|----------------------------------------|
| `addUserToAuthCredentials` | `userService.ts:281` (inside `createUser()`), `authService.ts` (via `getAuthCredential`) | None -- only the instanceService call is removed |
| `userEmailExists` | `userService.ts:211` (inside `createUser()`), `userService.ts:306` (inside `updateUser()`) | None -- only the instanceService call is removed |
| `createUser` | `useOnboardingStore.ts:462` (via `_createUser` action), Users panel workflow | None -- only the instanceService call is removed |

### Test Impact

Searched all test files for `createOnboardingRunFromTemplate`:
- **No test files directly test the internals** of `createOnboardingRunFromTemplate`. Tests that reference it mock the entire function.
- `/home/sanjay/Workspace/onboarding/src/hooks/useCreateOnboarding.ts` is consumed via mock in tests -- the mock replaces the whole service layer.
- The Zustand store tests mock `createOnboardingRunFromTemplate` via `vi.mock('./supabase')`.

**Conclusion:** Removing the user-creation side effect from `createOnboardingRunFromTemplate` will not break any existing tests.

### Database Schema Confirmation

The `onboarding_instances` table has NO foreign key to `users`:

```sql
CREATE TABLE IF NOT EXISTS onboarding_instances (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  employee_name TEXT NOT NULL,
  employee_email TEXT NOT NULL,  -- TEXT, not FK to users
  role TEXT NOT NULL,
  department TEXT NOT NULL,
  template_id UUID REFERENCES templates(id) ON DELETE SET NULL,
  ...
);
```

The relationship between hires and users is purely by email (TEXT), not by FK. This confirms they are designed as separate entities that CAN be linked but are not required to be.

### Related Bug #44 Analysis

Bug #44 (`delete-user-cascades-instances`) is the inverse problem in `userService.ts:393-418`:

```typescript
// Delete associated onboarding instances (by email, since no FK to users)
const { data: instances } = await supabase
  .from('onboarding_instances')
  .select('id')
  .ilike('employee_email', user.email);

if (instances && instances.length > 0) {
  // ... deletes all onboarding instances matching the user's email
}
```

This is a separate bug that should be fixed in its own pipeline run. It is documented here for context but is NOT in scope for this fix.

## Risk Assessment

### Technical Risks
| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Removing user creation breaks sign-in for newly created hires | Low -- this is the intended behavior change | Very Low | Hires and users are separate. Admins create users via Users panel. |
| Some test depends on user being created during instance creation | Low | Very Low | Searched all test files -- no test tests this internal behavior |
| Removing the dynamic import breaks the lazy-load pattern | None | None | The entire block using the import is removed; no dangling references |

### Complexity
- **Level:** Simple
- **Rationale:** This is a pure deletion of 22 lines (lines 356-377) from one function in one file. No new code is added. No interfaces change. No callers are affected. No tests break.

## Open Questions

None. All questions are resolved.

- [x] Q1: Should `addUserToAuthCredentials` at line 359 also be removed?
  - Resolution: YES. The entire block (lines 356-377) should be removed. `addUserToAuthCredentials` adds sign-in credentials for the hire, which conflates hires with users.

- [x] Q2: Will removing these lines break the employee sign-in flow?
  - Resolution: No. The employee sign-in flow (`authService.ts:signInWithEmailLink`) checks `getAuthCredential` (localStorage) first, then falls back to mock email mapping. Users created via the Users panel get their own `addUserToAuthCredentials` call in `userService.ts:281`. Hires should NOT automatically get sign-in credentials.

- [x] Q3: Are there other callers of `createOnboardingRunFromTemplate` that depend on user creation?
  - Resolution: No. Only `useCreateOnboarding.ts:41` calls it, and it treats it as a black box.

- [x] Q4: Does the employee view require a `users` table record to function?
  - Resolution: No. The employee view (`OnboardingHub.tsx:42-46`) uses `useEmployeeOnboarding(employeeEmail)` which queries `onboarding_instances` by `employee_email`. It does NOT query the `users` table. The `users` table is only needed for the sign-in flow (auth), not for viewing the onboarding.

- [x] Q5: Should bug #44 (`delete-user-cascades-instances`) be fixed in the same PR?
  - Resolution: No. Bug #44 is a separate fix in `userService.ts:deleteUser()`. It should have its own pipeline run. Both bugs share the same philosophy (hires != users) but touch different files and different code paths.

## Recommended Approach

### Implementation Strategy

**Pure deletion.** Remove lines 356-377 from `createOnboardingRunFromTemplate()` in `/home/sanjay/Workspace/onboarding/src/services/supabase/instanceService.ts`. No new code needed.

### Exact Change

Remove this block (lines 355-377, including the blank line before the comment):

```typescript
  // Step 4: Add auth credentials and ensure user record
  // Lazy import to avoid circular dep
  const { addUserToAuthCredentials, userEmailExists, createUser } = await import('./userService');
  addUserToAuthCredentials(normalizedEmail, 'employee', instanceId);

  try {
    const exists = await userEmailExists(normalizedEmail);
    if (!exists) {
      await createUser(
        {
          email: normalizedEmail,
          name: employeeData.employeeName,
          roles: ['employee'],
          profiles: employeeData.department ? [employeeData.department] : [],
          createdBy: 'system',
        },
        'system'
      );
    }
  } catch (err) {
    console.warn('Failed to ensure user record for onboarding:', err);
  }
```

After removal, line 354 (`const instanceId = await createOnboardingInstance(newInstanceData);`) will be directly followed by the return statement (currently line 379):

```typescript
  return {
    id: instanceId,
    ...newInstanceData,
  };
```

### Order of Work
1. Remove the offending code block (lines 356-377) from `instanceService.ts`
2. Run `npx vitest run` to confirm no tests break
3. Optionally add a test that verifies `createOnboardingRunFromTemplate` does NOT call `createUser`

### What to Defer
- Bug #44 (`delete-user-cascades-instances`) -- separate pipeline run
- Adding an explicit test for the separation -- low priority since this is a deletion, not a feature

## Next Step

**All questions resolved.** Run `/plan create-hire-separation` to create implementation plan.
