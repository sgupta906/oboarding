# Research: slim-tests

## Metadata
- **Feature:** slim-tests
- **Created:** 2026-02-14T16:00
- **Status:** research-complete
- **Researcher:** research-agent

## Feature Context

This is the 3rd and final "fat-trim" feature in the codebase reduction roadmap. The OnboardingHub project has ~13,000 lines of source code and ~13,400 lines of tests for what is essentially a CRUD app with 5 entities. The goal is to remove low-value mocked tests while keeping meaningful ones, targeting ~5,000+ lines of test code reduction.

### Dependencies
- **slim-modals** (complete): Unified 6 modals into 3, some modal test files were updated
- **slim-services** (complete): Added `crudFactory.test.ts` (559 lines) -- this is NEW and HIGH value, keep it

### Where It Fits
After this trim, the codebase should be lean enough for a final audit. The fat-trim roadmap will be complete.

---

## Test File Inventory

**32 test files, 13,429 lines total**

| # | File | Lines | Value | Action | Est. Savings |
|---|------|-------|-------|--------|-------------|
| 1 | `src/components/manager/KPISection.test.tsx` | 958 | LOW | REMOVE | 958 |
| 2 | `src/components/modals/RoleModal.test.tsx` | 1,316 | MEDIUM | TRIM | ~600 |
| 3 | `src/components/modals/CreateOnboardingModal.test.tsx` | 836 | MEDIUM | TRIM | ~400 |
| 4 | `src/services/roleOperations.test.ts` | 789 | LOW | REMOVE | 789 |
| 5 | `src/components/templates/TemplateModal.test.tsx` | 728 | MEDIUM | TRIM | ~300 |
| 6 | `src/services/roleClient.test.ts` | 608 | HIGH | KEEP | 0 |
| 7 | `src/views/AuthFlow.integration.test.tsx` | 595 | LOW | REMOVE | 595 |
| 8 | `src/services/supabase/crudFactory.test.ts` | 559 | HIGH | KEEP | 0 |
| 9 | `src/config/authContext.test.tsx` | 528 | HIGH | KEEP | 0 |
| 10 | `src/components/modals/UserModal.test.tsx` | 519 | MEDIUM | TRIM | ~150 |
| 11 | `src/components/manager/RoleManagementPanel.test.tsx` | 490 | MEDIUM | TRIM | ~200 |
| 12 | `src/services/authService.test.ts` | 437 | HIGH | KEEP | 0 |
| 13 | `src/views/ManagerView.test.tsx` | 431 | LOW | REMOVE | 431 |
| 14 | `src/services/supabase/mappers.test.ts` | 378 | HIGH | KEEP | 0 |
| 15 | `src/views/NavigationFlow.integration.test.tsx` | 356 | LOW | REMOVE | 356 |
| 16 | `src/components/templates/ModalScrolling.test.tsx` | 347 | LOW | REMOVE | 347 |
| 17 | `src/utils/filterUtils.test.ts` | 343 | HIGH | KEEP | 0 |
| 18 | `src/views/EmployeeView.test.tsx` | 322 | MEDIUM | TRIM | ~150 |
| 19 | `src/views/TemplatesView.test.tsx` | 314 | LOW | REMOVE | 314 |
| 20 | `src/hooks/useUsers.test.ts` | 311 | MEDIUM | TRIM | ~150 |
| 21 | `src/components/manager/KPICard.test.tsx` | 305 | LOW | REMOVE | 305 |
| 22 | `src/components/manager/UsersPanel.test.tsx` | 296 | LOW | REMOVE | 296 |
| 23 | `src/views/SignInView.integration.test.tsx` | 254 | LOW | REMOVE | 254 |
| 24 | `src/services/supabase/subscriptionManager.test.ts` | 198 | HIGH | KEEP | 0 |
| 25 | `src/components/templates/DeleteConfirmDialog.test.tsx` | 198 | MEDIUM | TRIM | ~80 |
| 26 | `src/hooks/useTemplates.test.ts` | 194 | LOW | REMOVE | 194 |
| 27 | `src/hooks/useActivities.test.ts` | 180 | LOW | REMOVE | 180 |
| 28 | `src/hooks/useSteps.test.ts` | 169 | LOW | REMOVE | 169 |
| 29 | `src/hooks/useSuggestions.test.ts` | 168 | LOW | REMOVE | 168 |
| 30 | `src/utils/debounce.test.ts` | 167 | HIGH | KEEP | 0 |
| 31 | `src/config/supabase.test.ts` | 80 | LOW | REMOVE | 80 |
| 32 | `src/utils/timeUtils.test.ts` | 55 | HIGH | KEEP | 0 |

---

## Classification Details

### HIGH VALUE -- KEEP AS-IS (9 files, 3,273 lines)

These files test pure logic, data transformations, or essential business rules with real assertions.

**1. `src/utils/filterUtils.test.ts` (343 lines)**
- Tests `filterStepsByProfile`, `filterStepsByProfileAndStatus`, `countStepsByProfileAndStatus`, `getUniqueRoleTags`
- Pure logic with real assertions on filtering behavior
- Edge cases: case sensitivity, empty arrays, non-existent roles
- Zero mocking needed

**2. `src/utils/timeUtils.test.ts` (55 lines)**
- Tests `formatTimeAgo` utility
- Pure function, all edge cases (undefined, 0, future timestamps, minutes/hours/days)
- Zero mocking needed

**3. `src/utils/debounce.test.ts` (167 lines)**
- Tests debounce utility with fake timers
- Timing behavior, cancellation, argument passing, independent instances
- Behavioral tests with real timer manipulation

**4. `src/services/supabase/mappers.test.ts` (378 lines)**
- Tests all mapper functions (toStep, toTemplate, toInstance, toSuggestion, toActivity, toRole, toProfile, toProfileTemplate, toUser, timestamp helpers)
- Pure data transformations: snake_case DB rows to camelCase app types
- Null handling, default values, timestamp conversion

**5. `src/services/roleClient.test.ts` (608 lines)**
- Tests validateRoleName, validateRoleNameUniqueness, validateRoleDescription
- Tests createCustomRole, updateCustomRole, deleteCustomRole, seedDefaultRoles, hasDefaultRoles
- Real validation logic with business rules (name length, character restrictions, duplicates)
- Mocks Supabase layer but tests real validation

**6. `src/services/supabase/crudFactory.test.ts` (559 lines)**
- Tests createCrudService factory: list(), get(), remove(), subscribe()
- Tests selectClause, default/custom limits, ordering, error handling, null data
- Tests shared subscription wrapping with createSharedSubscription
- Added by slim-services -- NEW and valuable

**7. `src/services/supabase/subscriptionManager.test.ts` (198 lines)**
- Tests createSharedSubscription: reference counting, data broadcasting, cleanup, isolation
- Pure behavioral tests for subscription lifecycle management

**8. `src/services/authService.test.ts` (437 lines)**
- Tests signInWithEmailLink validation (email format, unrecognized emails)
- Tests setUserRole (upsert + role insert), getUserRole, signOut
- Real business logic for auth operations

**9. `src/config/authContext.test.tsx` (528 lines)**
- Tests AuthProvider/useAuth: loading state, authenticated/unauthenticated states
- Role fetch errors, localStorage fallback, storage event listeners, cleanup on unmount
- Complex state management with real assertions

### LOW VALUE -- REMOVE ENTIRELY (14 files, 4,647 lines)

These files test CSS classes, window.location.hash manipulation, trivial mocking patterns, or are redundant with other tests.

**1. `src/components/manager/KPISection.test.tsx` (958 lines) -- LARGEST LOW-VALUE FILE**
- ~400 lines testing CSS grid classes (`grid-cols-1`, `md:grid-cols-3`, `auto-rows-fr`, `gap-6`)
- Tests "equal height" by checking for `h-full` class at 3 "breakpoints" (identical tests repeated)
- "Responsive QA Checklist" section that is just CSS class assertions
- Some KPI calculation tests exist but are duplicated in ManagerView.test.tsx
- Anti-pattern: testing Tailwind implementation details that change with any UI refactor

**2. `src/components/manager/KPICard.test.tsx` (305 lines)**
- Tests CSS classes: `h-full`, `hover:shadow-md`, `bg-emerald-50`, `border-l-emerald-500`
- Tests tooltip `pointer-events-none` class, hover scale classes
- Tests trend arrow direction by checking SVG transform classes
- Anti-pattern: brittle CSS class assertions

**3. `src/components/templates/ModalScrolling.test.tsx` (347 lines)**
- Tests `overflow-y-auto` class presence, `max-height: calc(90vh - 180px)` inline style
- Tests `p-6` padding class, `w-full` class, absence of `overflow-x-auto`
- Tests "scrollability" by checking CSS classes, not actual scrolling behavior
- Anti-pattern: all implementation detail tests that provide zero confidence

**4. `src/views/NavigationFlow.integration.test.tsx` (356 lines)**
- Many tests just manipulate `window.location.hash` directly without rendering components
- Tests like "support countdown timer" with `expect(true).toBe(true)` (literal no-op)
- Mock function call verification without actual component interaction
- Anti-pattern: testing hash routing by setting/getting `window.location.hash`

**5. `src/views/AuthFlow.integration.test.tsx` (595 lines)**
- RBAC tests are just localStorage set/get operations
- Token refresh tests set localStorage and read it back
- Session persistence tests = localStorage roundtrip
- Significant overlap with `authContext.test.tsx` and `authService.test.ts`
- Anti-pattern: testing localStorage as if it were auth infrastructure

**6. `src/views/SignInView.integration.test.tsx` (254 lines)**
- Overlaps heavily with AuthFlow.integration.test.tsx
- Form rendering tests duplicate what AuthFlow already covers
- Some keyboard accessibility tests are minor

**7. `src/views/ManagerView.test.tsx` (431 lines)**
- Renders ManagerView with mock props, checks element presence
- KPI count display tests: just "does text X appear on screen"
- Suggestions display: just "does text appear"
- Activity feed: just "does text appear"
- Low confidence: all tests pass with any component that renders text

**8. `src/views/TemplatesView.test.tsx` (314 lines)**
- Each test re-mocks useTemplates with different return values (verbose)
- Tests loading spinner text, empty state text, error message text
- Template card rendering: just checks for template name text
- Anti-pattern: heavy mock setup for trivial text assertions

**9. `src/components/manager/UsersPanel.test.tsx` (296 lines)**
- Several tests just check `toBeDefined()` without meaningful assertions
- "verify the hook was called" instead of testing actual form submission
- Modal open/close tests are testing React state, not business logic

**10. `src/hooks/useActivities.test.ts` (180 lines) -- COOKIE-CUTTER #1**
- Pattern: mock `subscribeToActivities`, test loading/data/error/unmount/empty/updates
- Identical testing pattern to useSteps, useSuggestions, useTemplates
- Tests mock behavior, not hook behavior (mock returns X, hook returns X)
- The crudFactory.test.ts already tests the underlying subscription mechanism

**11. `src/hooks/useSteps.test.ts` (169 lines) -- COOKIE-CUTTER #2**
- Same pattern as useActivities: mock subscribe, check callback propagation
- No unique business logic being tested

**12. `src/hooks/useSuggestions.test.ts` (168 lines) -- COOKIE-CUTTER #3**
- Same pattern as useActivities and useSteps
- No unique business logic being tested

**13. `src/hooks/useTemplates.test.ts` (194 lines) -- COOKIE-CUTTER #4**
- Same cookie-cutter pattern plus a refetch test
- All subscription behavior is already covered by crudFactory.test.ts + subscriptionManager.test.ts

**14. `src/config/supabase.test.ts` (80 lines)**
- Tests that the Supabase SDK is importable and client has expected methods
- Tests env var validation with console.warn
- Trivial: if the SDK import breaks, every other test in the suite will also fail

### MEDIUM VALUE -- TRIM (keep valuable tests, remove boilerplate) (9 files, 5,509 lines -> ~3,479 after trim)

**1. `src/components/modals/RoleModal.test.tsx` (1,316 lines -> ~716 lines, save ~600)**
- KEEP: Validation tests (empty name, short name, long name, special chars, duplicate names)
- KEEP: Character count display and limits
- KEEP: Edit mode pre-fill, read-only system role name field
- KEEP: Successful create/edit submission with correct data shape
- REMOVE: Multiple "renders X when open" tests (covered by "can submit" tests)
- REMOVE: Redundant "description" field tests (same pattern as name, just different field)
- REMOVE: isSubmitting button state tests (trivial disabled check)
- REMOVE: "calls onClose" tests (trivial callback check)

**2. `src/components/modals/CreateOnboardingModal.test.tsx` (836 lines -> ~436 lines, save ~400)**
- KEEP: Form validation (missing name, email format, role required, department required, template required)
- KEEP: Template preview rendering with steps
- KEEP: Successful submission with correct data shape
- REMOVE: Basic rendering tests ("renders modal when open", "not when closed")
- REMOVE: Individual field label presence tests
- REMOVE: Loading state tests (trivial disabled button check)
- REMOVE: Cancel button tests (trivial callback)
- REMOVE: Template selection dropdown basic rendering

**3. `src/components/templates/TemplateModal.test.tsx` (728 lines -> ~428 lines, save ~300)**
- KEEP: Form validation (empty name, missing roles)
- KEEP: Step add/remove/reorder functionality
- KEEP: Edit mode pre-fill with existing template data
- KEEP: Successful submission with steps array
- REMOVE: Basic rendering tests
- REMOVE: Status toggle rendering
- REMOVE: Cancel/close callback tests
- REMOVE: Loading state tests

**4. `src/components/modals/UserModal.test.tsx` (519 lines -> ~369 lines, save ~150)**
- KEEP: Email validation (required, format), name validation (min length)
- KEEP: Role selection (single, multiple), profile selection
- KEEP: Edit mode pre-fill, submit with valid data
- KEEP: Whitespace trimming
- REMOVE: "renders when open" / "not when closed" tests
- REMOVE: "shows intro section" / "not in edit mode" (UI detail)
- REMOVE: isSubmitting disabled button test
- REMOVE: Cancel button callback test
- REMOVE: Server error display test

**5. `src/components/manager/RoleManagementPanel.test.tsx` (490 lines -> ~290 lines, save ~200)**
- KEEP: Search/filter functionality (user types, results filter)
- KEEP: Create role flow (click add, modal appears)
- KEEP: Edit role flow (click edit, modal appears with data)
- KEEP: Delete role flow (click delete, confirmation, execute)
- REMOVE: Basic rendering tests ("renders panel title")
- REMOVE: Accessibility attribute tests (aria-label checks)
- REMOVE: Empty state rendering
- REMOVE: Loading state rendering

**6. `src/views/EmployeeView.test.tsx` (322 lines -> ~172 lines, save ~150)**
- KEEP: Progress calculation tests (25%, 50%, 100%)
- KEEP: Completion footer regression test
- KEEP: Step status display
- REMOVE: Basic rendering ("renders employee name")
- REMOVE: "shows welcome message" tests
- REMOVE: Profile badge rendering
- REMOVE: Dark mode class tests

**7. `src/hooks/useUsers.test.ts` (311 lines -> ~161 lines, save ~150)**
- KEEP: CRUD operations (create user, update user, delete user)
- KEEP: Duplicate email handling
- KEEP: Error state reset
- REMOVE: Cookie-cutter subscription pattern (loading/data/unmount)
- REMOVE: Empty state test
- REMOVE: Basic callback propagation tests

**8. `src/components/templates/DeleteConfirmDialog.test.tsx` (198 lines -> ~118 lines, save ~80)**
- KEEP: Confirm delete calls onConfirm callback
- KEEP: Cancel calls onCancel callback
- KEEP: Shows template name in confirmation message
- REMOVE: "renders when open" / "not when closed"
- REMOVE: Loading state tests
- REMOVE: Accessibility attribute tests

**9. `src/services/roleOperations.test.ts` (789 lines -> REMOVE ENTIRELY, save 789)**
- This file tests role CRUD operations using a localStorage-backed mock
- It overlaps almost completely with `roleClient.test.ts` which tests the same operations against Supabase mocks
- `roleClient.test.ts` is more current (updated during slim-services) and tests the actual code path
- Keeping both provides no additional confidence
- **Reclassified to REMOVE** -- moving 789 lines from MEDIUM to LOW/REMOVE

---

## Estimated Line Savings

| Category | Files | Current Lines | After Trim | Savings |
|----------|-------|---------------|------------|---------|
| HIGH (keep) | 9 | 3,273 | 3,273 | 0 |
| LOW (remove) | 14 | 4,647 | 0 | 4,647 |
| MEDIUM (trim) | 8 | 4,720 | 2,690 | 2,030 |
| roleOperations (remove) | 1 | 789 | 0 | 789 |
| **TOTAL** | **32** | **13,429** | **5,963** | **7,466** |

**Estimated total savings: ~7,466 lines (55.6% reduction)**

This exceeds the original ~5,000+ line target by a significant margin.

### Post-Trim Test Suite
- **Files remaining:** 17 files (9 HIGH + 8 trimmed MEDIUM)
- **Lines remaining:** ~5,963 lines
- **Files removed:** 15 files (14 LOW + roleOperations)

---

## Anti-Patterns Found

### 1. CSS Class Assertions (worst offender)
```typescript
// Example from KPISection.test.tsx
expect(gridContainer).toHaveClass('grid-cols-1');
expect(gridContainer).toHaveClass('md:grid-cols-3');
expect(card).toHaveClass('h-full');
```
These break on any Tailwind refactor and provide zero confidence that the UI works.

### 2. Cookie-Cutter Hook Tests
```typescript
// Identical pattern in useActivities, useSteps, useSuggestions, useTemplates:
it('returns data from subscription', () => {
  mockSubscribe.mockImplementation((cb) => { cb(mockData); return vi.fn(); });
  const { result } = renderHook(() => useXxx());
  expect(result.current.items).toEqual(mockData);
});
```
Tests that the mock returns what you told it to return. The actual subscription mechanism is already tested in `crudFactory.test.ts` and `subscriptionManager.test.ts`.

### 3. localStorage Round-Trip Tests
```typescript
// Example from AuthFlow.integration.test.tsx
localStorage.setItem('user_role', 'admin');
expect(localStorage.getItem('user_role')).toBe('admin');
```
Tests localStorage itself, not the application.

### 4. Trivial Presence Assertions
```typescript
// Example from ManagerView.test.tsx
expect(screen.getByText('Pending Steps')).toBeInTheDocument();
expect(screen.getByText('Overdue')).toBeInTheDocument();
```
Any component that renders the word "Pending Steps" would pass. No behavioral assertion.

### 5. No-Op Tests
```typescript
// Example from NavigationFlow.integration.test.tsx
it('support countdown timer', () => {
  expect(true).toBe(true);
});
```
Literally does nothing.

---

## Existing Code Analysis

### Project State
- Project exists: YES
- Test framework: Vitest 4.0.13 + React Testing Library + jsdom
- Coverage thresholds in vitest.config.ts: 80% lines/functions/statements, 75% branches
- Current test count: ~650 tests across 32 files

### Coverage Threshold Impact
The vitest.config.ts has coverage thresholds:
```
lines: 80, functions: 80, statements: 80, branches: 75
```
Removing test files will reduce the number of tests but also reduces the covered code surface. Since we are NOT removing source code in this trim (unlike slim-modals and slim-services), we need to verify that remaining tests still meet coverage thresholds. The HIGH-value tests cover the core logic paths. The MEDIUM-trimmed tests will keep the validation and CRUD flow coverage.

### Files Added by Previous Trims
- `crudFactory.test.ts` (559 lines) -- added by slim-services (commit f511dbb) -- HIGH value, KEEP
- Modal test files (RoleModal.test.tsx, UserModal.test.tsx, TemplateModal.test.tsx) were updated to test unified modals after slim-modals

### Patterns to Follow
- Keep tests that test pure functions with real inputs/outputs
- Keep tests that verify business logic (validation rules, data transformations)
- Keep tests that exercise error handling paths
- Remove tests that only verify mock wiring or CSS implementation details

---

## Constraints

### Performance
- No specific performance targets for tests
- Removing ~7,400 lines of tests should speed up test execution

### Coverage Thresholds
- Must maintain 80% line/function/statement coverage and 75% branch coverage
- May need to adjust thresholds if removing tests drops coverage below these levels
- Alternatively, the source code these tests cover may already be covered by remaining tests

### Backward Compatibility
- No behavioral changes to the application
- Only test files are being modified/removed
- Playwright E2E tests (separate) provide safety net for regressions

---

## Risk Assessment

### Technical Risks
| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Coverage drops below thresholds | Medium | Medium | Run coverage after each batch of removals, adjust thresholds if needed |
| Remove a test that catches a real bug later | Low | Low | Keep all validation/business logic tests; rely on Playwright E2E for UI |
| roleOperations.test.ts removal loses unique coverage | Low | Low | Verified overlap with roleClient.test.ts -- same operations tested |
| MEDIUM file trimming introduces syntax errors | Low | Medium | Run `npx vitest run` after each file edit |

### Complexity
- **Level:** Simple
- **Rationale:** This is purely a deletion/trimming task. No source code changes. No new code. The main risk is coverage thresholds, which can be checked incrementally. Each file can be handled independently.

---

## Open Questions

- [x] Q1: Should roleOperations.test.ts be kept alongside roleClient.test.ts?
  - Resolution: No. They test the same operations with different mock strategies. roleClient.test.ts is more current and tests the actual Supabase code path. roleOperations.test.ts uses a localStorage-backed mock that doesn't match production. Remove roleOperations.test.ts.

- [x] Q2: Should coverage thresholds be lowered?
  - Resolution: Check coverage after removals. If it drops below 80%/75%, lower thresholds to match the new reality. The remaining tests are higher quality, so lower quantity with same quality is acceptable.

- [x] Q3: Should any hook tests be kept?
  - Resolution: No for the 4 cookie-cutter hooks (useActivities, useSteps, useSuggestions, useTemplates). Yes for useUsers which has unique CRUD operation tests. The underlying subscription mechanism is thoroughly tested in crudFactory.test.ts and subscriptionManager.test.ts.

- [x] Q4: What about the Playwright E2E tests?
  - Resolution: Playwright tests are separate and unaffected. They serve as the safety net that makes removing low-value unit tests safe.

---

## Recommended Approach

### Implementation Strategy

**Batch removal in 3 phases, running tests after each phase:**

1. **Phase 1: Remove LOW-value files entirely (15 files, ~5,436 lines)**
   - Delete all 14 LOW files + roleOperations.test.ts
   - Run `npx vitest run` to verify remaining tests still pass
   - Check coverage with `npx vitest run --coverage`

2. **Phase 2: Trim MEDIUM-value files (8 files, ~2,030 lines saved)**
   - For each file, remove the identified low-value tests while keeping validation/business logic tests
   - Run tests after each file to catch issues early

3. **Phase 3: Verify and adjust**
   - Run full test suite
   - Check coverage thresholds
   - Adjust vitest.config.ts coverage thresholds if needed
   - Run Playwright E2E to confirm no regressions

### Order of Work
1. Delete the 15 LOW-value files (biggest impact, lowest risk)
2. Trim RoleModal.test.tsx (largest MEDIUM file, ~600 lines saved)
3. Trim CreateOnboardingModal.test.tsx (~400 lines saved)
4. Trim TemplateModal.test.tsx (~300 lines saved)
5. Trim remaining MEDIUM files (RoleManagementPanel, EmployeeView, UserModal, useUsers, DeleteConfirmDialog)
6. Run full test suite + coverage check
7. Adjust coverage thresholds if needed

### What to Defer
- No need to write new tests -- the remaining HIGH-value tests provide sufficient coverage
- Coverage threshold adjustment can be done at the end based on actual numbers
- Any source code cleanup discovered during trimming should be noted but deferred to a separate feature

---

## Next Step

**All questions resolved. Status: research-complete.**

Run `/plan slim-tests` to create the implementation plan.
