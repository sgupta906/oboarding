# Research: Google OAuth Role Assignment Bug

**Feature:** `google-auth-role-bug`
**Date:** 2026-02-18
**Status:** research-complete

---

## Bug Description

When a user signs in with Google OAuth:
1. They're registered as an "unassigned" user (correct)
2. Manager assigns a role + template via AssignRoleModal
3. When the Google user signs in again, they see MANAGER view instead of EMPLOYEE view
4. The hire appears in BOTH New Hires AND Users tables
5. Manually entering the same email shows the correct Employee view

## Root Cause Analysis

### Root Cause 1: `setUserRole()` stores custom role name instead of "employee"

**File:** `src/components/manager/NewHiresPanel.tsx:113`

```typescript
await setUserRole(userToAssign.id, userToAssign.email, assignRole);
// assignRole = "Software Engineer" (custom role from dropdown)
// Should be: 'employee' (access control role)
```

The `AssignRoleModal` dropdown shows business roles (job titles like "Software Engineer"). `handleAssignSubmit()` passes this business role to `setUserRole()`, which stores it in `user_roles.role_name`. The custom role is already correctly stored in `onboarding_instances.role` via `createOnboardingRunFromTemplate()`.

### Root Cause 2: `hasManagerAccess()` treats any non-"employee" role as manager

**File:** `src/config/authTypes.ts:17-19`

```typescript
export function hasManagerAccess(role: UserRole | null): boolean {
  return role != null && role !== '' && role !== 'employee';
}
```

On re-sign-in, `getUserRole()` returns "Software Engineer" from `user_roles`. Since `"Software Engineer" !== 'employee'`, the user gets manager access.

### Root Cause 3: Google OAuth flow lacks onboarding instance check

**File:** `src/config/authContext.tsx:160-189`

The `onAuthStateChange` handler reads role from `user_roles` without checking if the user has an onboarding instance. The email sign-in flow (`signInWithEmailLink`) does check for instances and forces `role: 'employee'`.

### Why Manual Email Works

`signInWithEmailLink()` in `authService.ts:200-225` calls `getInstanceByEmployeeEmail(email)` first. If an instance exists, it hardcodes `role: 'employee'` in localStorage. Google OAuth path skips this check entirely.

## Fixes Required

### Fix 1 (Primary): Store "employee" role in handleAssignSubmit

**File:** `src/components/manager/NewHiresPanel.tsx:113`
**Change:** `setUserRole(userToAssign.id, userToAssign.email, assignRole)` → `setUserRole(userToAssign.id, userToAssign.email, 'employee')`

### Fix 2 (Defense-in-depth): Add instance check in onAuthStateChange

**File:** `src/config/authContext.tsx:163-169`
**Change:** After `getUserRole()` returns, check `getInstanceByEmployeeEmail(session.user.email)`. If instance exists, override role to `'employee'`.

### Fix 3 (Data cleanup): Fix existing bad data

Users who were already assigned via the bug have wrong roles in `user_roles`. Need to check if any existing users with custom role names in `user_roles` also have onboarding instances, and fix their role to `'employee'`.

## Files to Modify

1. `src/components/manager/NewHiresPanel.tsx` — Fix `handleAssignSubmit` (1-line change)
2. `src/config/authContext.tsx` — Add instance check in `onAuthStateChange` (5-10 lines)
3. `src/components/manager/NewHiresPanel.test.tsx` — Update/add test for role assignment
4. `src/config/authContext.test.tsx` or `src/config/authTypes.test.ts` — Add test for instance-based role override

## Constraints

- Must not break existing email sign-in flow
- Must not break dev-auth quick-login buttons
- Must not affect manager/admin access (only Google OAuth hires)
- All 668 tests must pass
- Backward compatible with existing onboarding instances

## Open Questions

All resolved — root cause fully identified.
