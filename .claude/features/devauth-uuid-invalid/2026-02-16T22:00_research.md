# Research: devauth-uuid-invalid

## Metadata
- **Feature:** devauth-uuid-invalid (Bug #7)
- **Created:** 2026-02-16T22:00
- **Status:** research-complete
- **Researcher:** research-agent
- **Priority:** P0 CRITICAL

## Feature Context

### Description
When using dev-auth mode (`VITE_USE_DEV_AUTH=true`), the quick-login buttons generate non-UUID user IDs of the form `test-${email.split('@')[0]}` (e.g., `test-test-manager` for `test-manager@example.com`). These non-UUID strings are then passed as `created_by` to the `users` table, which has a `created_by UUID REFERENCES users(id)` column. PostgreSQL rejects the insert with: `invalid input syntax for type uuid: "test-test-manager"`.

This bug:
1. **Blocks ALL user creation** in dev-auth mode (Bug #7)
2. **Causes the Users table to always appear empty** (Bug #9) because the `listUsers` query on the `users` table also fails with 400 errors
3. **Potentially causes silent failures** in activity logging (`activities.user_id` is also `UUID REFERENCES users(id)`)

### Where It Fits
This is the highest priority bug remaining in the post-Zustand-migration bugfix round. It blocks the entire Users CRUD feature in development mode. Fixing this unblocks Bug #9 (users-table-always-empty) automatically.

### Dependencies
- No dependencies on other features
- This bug was introduced when the database schema was created with strict UUID typing, but the dev-auth impersonation code predates the Supabase migration and uses arbitrary string IDs

## Visual Evidence

### Screenshot: Users Tab Empty (Bug #9)
- **File:** `/home/sanjay/Workspace/onboarding/.claude/features/devauth-uuid-invalid/screenshot-users-tab-empty.png`
- Shows Users tab with "No users - Create your first system user to get started" even though active onboarding instances exist in the system

### Screenshot: Create User UUID Error (Bug #7)
- **File:** `/home/sanjay/Workspace/onboarding/.claude/features/devauth-uuid-invalid/screenshot-create-user-error.png`
- Shows modal with red error: `Failed to create user: invalid input syntax for type uuid: "test-test-manager"`
- Also visible: form fields cleared after error (Bug #8), error banner behind modal (Bug #12)

### Console Errors
```
[ERROR] Failed to load resource: the server responded with a status of 400 ()
  @ https://ecnshfhpgwjxvuybewth.supabase.co/rest/v1/users?select=*
```

## Requirements

### Functional Requirements
- [x] FR1: Dev-auth quick-login must generate valid UUID user IDs that pass PostgreSQL UUID column validation
- [x] FR2: The `created_by` field on user creation must be a valid UUID or null
- [x] FR3: Activity logging `user_id` must be a valid UUID or null
- [x] FR4: The `setUserRole` function in authService must work with valid UUIDs
- [x] FR5: Existing Supabase Auth sign-in flow (which already generates real UUIDs) must not be broken
- [x] FR6: Dev-auth IDs should be deterministic per email (same email = same UUID) for consistency across sessions

### Technical Requirements
- [x] TR1: UUID generation must be deterministic from email address (so the same test user always gets the same ID)
- [x] TR2: All code paths that pass user IDs to UUID columns must validate or sanitize the ID
- [x] TR3: Fix must work in both browser and test environments
- [x] TR4: Existing unit tests (443 total) must continue to pass

### Constraints
- Database schema uses `UUID` type for `id` and `created_by` columns across 5 tables (users, roles, profiles, profile_templates, activities)
- Cannot change database column types (would break existing data and other services)
- Must maintain backward compatibility with existing localStorage mock auth data

## Root Cause Analysis

### The Offending Code

**Primary source (line 48 in `src/config/authContext.tsx`):**
```typescript
export function impersonateUserForQA(options: ImpersonateUserOptions): void {
  localStorage.setItem(
    'mockAuthUser',
    JSON.stringify({
      uid: `test-${options.email.split('@')[0]}`,  // <-- GENERATES NON-UUID
      email: options.email,
      role: options.role,
    })
  );
}
```

This generates UIDs like:
- `test-test-manager` for `test-manager@example.com`
- `test-test-employee` for `test-employee@example.com`
- `test-test-admin` for `test-admin@example.com`

**Secondary source (line 165 in `src/services/authService.ts`):**
```typescript
const emailHash = btoa(trimmedEmail).replace(/[^a-zA-Z0-9]/g, '').substring(0, 16);
// ...
uid = emailHash;  // <-- ALSO NON-UUID (used as fallback)
```

This generates UIDs like `dGVzdC1lbXBsb3ll` (base64 of email, alphanumeric only).

### The Failing Insert

**In `src/services/supabase/userService.ts` (line 226):**
```typescript
const row: UserInsert = {
  email: trimmedEmail,
  name: trimmedName,
  created_at: now,
  updated_at: now,
  created_by: createdBy,  // <-- NON-UUID VALUE "test-test-manager" PASSED HERE
};
```

PostgreSQL rejects this because:
```sql
CREATE TABLE users (
  ...
  created_by UUID REFERENCES users(id) ON DELETE SET NULL  -- MUST be valid UUID
);
```

### The Query Failure (Bug #9)

**In `src/services/supabase/userService.ts` (lines 154-168):**
```typescript
const crud = createCrudService<User>({
  table: 'users',
  selectClause: '*, user_roles(*), user_profiles(*)',
  // ...
});
```

The `listUsers` call queries `users?select=*,user_roles(*),user_profiles(*)`. This returns HTTP 400 because the `users` table may contain rows with invalid UUID references (from a previous partial insert), or the REST query fails due to the junction table joins hitting data integrity issues.

### Partial Fix Already Exists

The `roleService.ts` already has a guard for this exact problem:
```typescript
// src/services/supabase/roleService.ts:99-102
const UUID_REGEX = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
function isValidUUID(value: string): boolean {
  return UUID_REGEX.test(value);
}

// Only pass createdBy if it's a valid UUID; otherwise use null.
// Dev auth generates non-UUID identifiers like "test-test-manager"
// which would cause a Postgres type error on the UUID column.
const safeCreatedBy = createdBy && isValidUUID(createdBy) ? createdBy : null;
```

This fix was NOT applied to `userService.ts`, `profileService.ts`, `profileTemplateService.ts`, or `activityService.ts`.

## Existing Code Analysis

### Project State
- Project exists: YES
- Branch: `zustand-migration-bugfixes`
- Test count: 443 tests passing

### Affected Files (need changes)

| File | Issue | Fix Needed |
|------|-------|------------|
| `src/config/authContext.tsx:48` | `impersonateUserForQA` generates non-UUID IDs | Generate deterministic UUIDs from email |
| `src/services/authService.ts:165` | `emailHash` fallback generates non-UUID IDs | Generate deterministic UUIDs from email |
| `src/services/supabase/userService.ts:226` | `createUser` passes `createdBy` without UUID validation | Add `isValidUUID` guard (like roleService) |
| `src/services/supabase/profileService.ts:54` | `createProfile` passes `createdBy` without UUID validation | Add `isValidUUID` guard |
| `src/services/supabase/profileTemplateService.ts:82` | `createProfileTemplate` passes `createdBy` without UUID validation | Add `isValidUUID` guard |
| `src/services/supabase/activityService.ts:47` | `logActivity` passes `user_id` without UUID validation | Add `isValidUUID` guard |
| `src/services/authService.ts:37` | `setUserRole` upserts user row with non-UUID id | Use valid UUID for user id |

### Secondary Affected Files (pass non-UUID userId, but currently caught silently)

| File | Code Pattern | Issue |
|------|-------------|-------|
| `src/components/manager/UsersPanel.tsx:60,86,109` | `authUser?.uid ?? 'unknown'` | `'unknown'` is also not UUID; `authUser?.uid` is non-UUID from dev-auth |
| `src/components/manager/NewHiresPanel.tsx:102` | `authUser?.uid ?? 'unknown'` | Same issue |

### Code to Reuse
- `roleService.ts` already has `isValidUUID` function and the guard pattern - extract to shared utility
- The `crypto.randomUUID()` API is available in all modern browsers and Node.js

### Patterns to Follow
- The roleService guard pattern: `const safeCreatedBy = createdBy && isValidUUID(createdBy) ? createdBy : null;`
- Service-level validation (don't rely on callers to pass valid data)

## All UUID Columns in the Schema

From `supabase/migrations/00001_create_core_tables.sql`:

| Table | Column | Type | Constraint |
|-------|--------|------|------------|
| `users` | `id` | `UUID PRIMARY KEY` | `DEFAULT gen_random_uuid()` |
| `users` | `created_by` | `UUID` | `REFERENCES users(id) ON DELETE SET NULL` |
| `roles` | `id` | `UUID PRIMARY KEY` | `DEFAULT gen_random_uuid()` |
| `roles` | `created_by` | `UUID` | `REFERENCES users(id) ON DELETE SET NULL` |
| `profiles` | `id` | `UUID PRIMARY KEY` | `DEFAULT gen_random_uuid()` |
| `profiles` | `created_by` | `UUID` | `REFERENCES users(id) ON DELETE SET NULL` |
| `profile_templates` | `created_by` | `UUID` | `REFERENCES users(id) ON DELETE SET NULL` |
| `activities` | `user_id` | `UUID` | `REFERENCES users(id) ON DELETE SET NULL` |
| `user_roles` | `user_id` | `UUID` | `REFERENCES users(id) ON DELETE CASCADE` |
| `user_profiles` | `user_id` | `UUID` | `REFERENCES users(id) ON DELETE CASCADE` |

## Fix Strategy Analysis

### Option A: Generate Deterministic UUIDs in Dev-Auth (RECOMMENDED)

Convert the email to a deterministic UUID v5-like format using a simple hash-to-UUID approach:

```typescript
function emailToUUID(email: string): string {
  // Generate a deterministic UUID from email
  // Use a simple approach: hash the email, format as UUID
  const encoder = new TextEncoder();
  const data = encoder.encode(email.toLowerCase());

  // Use SubtleCrypto for SHA-256 hash, then format first 16 bytes as UUID v4
  // OR simpler: use a deterministic mapping from email to UUID format
}
```

**Pros:**
- Same email always produces same UUID (deterministic)
- Valid UUID format accepted by PostgreSQL
- `setUserRole` can actually insert/upsert user rows in the `users` table
- Dev-auth users appear in the Users table (fixes Bug #9)
- Minimal code changes

**Cons:**
- Requires `crypto.subtle` (async) or a simple string-based UUID generator
- Need to handle the async nature if using SubtleCrypto

### Option B: Validate and Null-ify at Service Layer

Apply the roleService guard pattern to all services:

```typescript
const safeCreatedBy = createdBy && isValidUUID(createdBy) ? createdBy : null;
```

**Pros:**
- Defensive - protects against any non-UUID value
- Already proven pattern in roleService

**Cons:**
- Does NOT fix Bug #9 (users table still empty because dev-auth users can't be inserted into `users` table at all)
- `setUserRole` in authService still fails (tries to upsert with non-UUID `id`)
- Only a partial fix

### Option C: Combined Approach (BEST)

1. Generate deterministic UUIDs in dev-auth (Option A) - fixes the ROOT CAUSE
2. Add UUID validation guards at the service layer (Option B) - adds DEFENSE IN DEPTH

**This is the recommended approach** because:
- Option A alone fixes the root cause but leaves services vulnerable to other bad inputs
- Option B alone doesn't fix the root cause
- Combined approach fixes the root cause AND makes services robust

### Implementation Detail: Deterministic UUID Generation

Since `crypto.subtle.digest` is async and the `impersonateUserForQA` function is sync, use a simple deterministic approach:

```typescript
/**
 * Generate a deterministic UUID v4-format string from an email address.
 * Uses a simple hash approach that works synchronously in both browser and Node.
 */
function deterministicUUID(email: string): string {
  const normalized = email.toLowerCase().trim();
  // Simple string hash to 32 hex chars, formatted as UUID
  let hash = 0;
  for (let i = 0; i < normalized.length; i++) {
    const char = normalized.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // Convert to 32-bit integer
  }
  // ... format as UUID
}
```

OR simpler: use `crypto.randomUUID()` but seed it (not possible with the native API).

**Simplest viable approach:** Use a namespace + email to create a fixed UUID mapping:

```typescript
// Hardcoded deterministic UUIDs for the 3 test accounts
const TEST_UUIDS: Record<string, string> = {
  'test-employee@example.com': '00000000-0000-4000-a000-000000000001',
  'test-manager@example.com':  '00000000-0000-4000-a000-000000000002',
  'test-admin@example.com':    '00000000-0000-4000-a000-000000000003',
};
```

This is the simplest, most reliable approach for the 3 known test accounts. For dynamically created users (via Users panel), the `addUserToAuthCredentials` function already stores the real Supabase-generated UUID.

## Constraints

### Performance
- No performance concerns - UUID generation is O(1)

### Platform
- `crypto.randomUUID()` available in all target browsers (Chrome 92+, Firefox 95+, Safari 15.4+)
- Test environment (Vitest/jsdom) may need a polyfill or mock for `crypto.randomUUID()`

### Dependencies
- No new dependencies needed
- The fix is entirely within existing code

## Risk Assessment

### Technical Risks
| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Breaking existing localStorage auth data | Medium | Low | Check for existing `mockAuthUser` with old format and migrate |
| Test failures from UUID format change | Medium | Medium | Update test mocks that check for specific UID values |
| `setUserRole` still fails if user doesn't exist in `users` table | High | Medium | Ensure dev-auth sign-in creates user row with valid UUID before using it |
| Activity logging silently fails with non-UUID user_id | Low | High | Add UUID validation guard (already happening via `.catch(() => {})`) |

### Complexity
- **Level:** Medium
- **Rationale:** The fix itself is simple (generate valid UUIDs + add validation guards), but there are multiple files to touch and the dev-auth flow has several code paths (impersonateUserForQA, signInWithEmailLink with Supabase Auth, signInWithEmailLink fallback). All paths must be consistent.

## Open Questions

- [x] Q1: Should we use hardcoded UUIDs for the 3 test accounts or generate them dynamically?
  - Resolution: Use hardcoded deterministic UUIDs for the 3 known test accounts. This is simplest and most reliable. Dynamic users from the Users panel already get real Supabase-generated UUIDs.

- [x] Q2: Should we also fix the `signInWithEmailLink` fallback path (`emailHash`)?
  - Resolution: Yes. The `emailHash` fallback also generates non-UUID strings. It should generate a valid UUID. However, this path is only hit when Supabase Auth is completely unavailable, which is less common.

- [x] Q3: Should the UUID validation guard be a shared utility or duplicated per service?
  - Resolution: Extract to a shared utility (`src/utils/uuid.ts` or `src/services/supabase/utils.ts`). Currently `isValidUUID` is duplicated in `roleService.ts` and needs to be in 4 more services.

- [x] Q4: Does the `setUserRole` function in `authService.ts` need to handle non-UUID IDs?
  - Resolution: After the fix, `setUserRole` will always receive valid UUIDs. But adding a guard is still good defense in depth.

## Recommended Approach

### Implementation Strategy

**Two-pronged fix:**

1. **Fix the source:** Generate valid deterministic UUIDs in dev-auth
   - Hardcode UUIDs for the 3 test accounts in `impersonateUserForQA`
   - Generate valid UUIDs in the `signInWithEmailLink` fallback path

2. **Add defense in depth:** UUID validation guards in all services
   - Extract `isValidUUID` to a shared utility
   - Add guards in `userService.ts`, `profileService.ts`, `profileTemplateService.ts`, `activityService.ts`
   - Guard already exists in `roleService.ts`

### Order of Work
1. Create shared UUID utility (`isValidUUID` function)
2. Fix `impersonateUserForQA` in `authContext.tsx` to use deterministic UUIDs
3. Fix `signInWithEmailLink` fallback in `authService.ts` to use deterministic UUIDs
4. Add UUID validation guard to `userService.ts` `createUser`
5. Add UUID validation guard to `profileService.ts` `createProfile`
6. Add UUID validation guard to `profileTemplateService.ts` `createProfileTemplate`
7. Add UUID validation guard to `activityService.ts` `logActivity`
8. Refactor `roleService.ts` to use the shared utility
9. Update tests to use valid UUID format for test user IDs

### Files to Change (ordered)

1. **NEW** `src/utils/uuid.ts` - Shared UUID validation + deterministic generation
2. `src/config/authContext.tsx` - Fix `impersonateUserForQA` UID generation
3. `src/services/authService.ts` - Fix fallback UID generation
4. `src/services/supabase/userService.ts` - Add `created_by` UUID guard
5. `src/services/supabase/profileService.ts` - Add `created_by` UUID guard
6. `src/services/supabase/profileTemplateService.ts` - Add `created_by` UUID guard
7. `src/services/supabase/activityService.ts` - Add `user_id` UUID guard
8. `src/services/supabase/roleService.ts` - Refactor to use shared utility

### What to Defer
- Fixing Bug #8 (user-form-clears-on-error) - separate bug, separate pipeline run
- Fixing Bug #10 (users-error-persists) - separate bug
- Fixing Bug #11 (users-tab-hmr-bounce) - separate bug, related to Vite HMR
- Fixing Bug #12 (users-duplicate-error-display) - separate bug

## Next Step

**All questions resolved. Ready for planning.**

Run `/plan devauth-uuid-invalid` to create implementation plan.
