# Plan: bug-fixing

## Metadata
- **Feature:** bug-fixing
- **Created:** 2026-02-14T21:00
- **Status:** plan-complete
- **Based-on:** 2026-02-14T20:00_research.md, playwright-audit.md
- **Estimated Files Modified:** ~25
- **New Files:** 1 (timeUtils.ts)

---

## Problem Statement

The webapp is "choppy and slow." Root cause analysis reveals two compounding issues:

1. **Supabase Realtime WebSocket silently fails** -- CRUD operations succeed but the UI never receives the callback to update local state. Users see modal close, but data does not appear until page reload.
2. **Even when Realtime works, the architecture creates cascading re-fetches** -- each subscription re-fetches the entire table on ANY change, multiple components create duplicate subscriptions, and step updates do 4+ DB round-trips.

The fix strategy is: **add optimistic local state updates to every mutation so the UI responds instantly, regardless of whether Realtime is working.** Then optimize the inefficient queries as a secondary pass.

---

## Architecture Overview

```
CURRENT FLOW (Broken):
  User clicks "Create Role"
  --> createCustomRole() [validates + INSERT]
  --> Modal closes
  --> subscribeToRoles callback should fire... but WebSocket is dead
  --> UI never updates
  --> User confused

FIXED FLOW (Optimistic):
  User clicks "Create Role"
  --> createCustomRole() [validates + INSERT]
  --> IMMEDIATELY: setRoles(prev => [...prev, newRole])
  --> Modal closes
  --> UI updates INSTANTLY
  --> Realtime callback fires later (if working): setRoles(serverData)
  --> UI reconciles silently
```

### Key Architectural Decisions

1. **Optimistic updates in hooks, NOT in components** -- The useRoles, useTemplates hooks already wrap CRUD operations. Add `setRoles(prev => ...)` right after the successful await in each CRUD function. This way ALL consumers of the hook get instant updates.

2. **Remove redundant refetch() calls** -- TemplatesView calls `refetch()` after every mutation AND relies on Realtime. Remove the `refetch()` calls. The optimistic update handles immediate feedback; Realtime (if working) reconciles in background.

3. **Direct UPDATE for step status** -- Replace the 4-query fetch-rebuild-delete-insert pattern with a single `UPDATE instance_steps SET status = $1 WHERE instance_id = $2 AND position = $3`, followed by a single `UPDATE onboarding_instances SET progress = $1 WHERE id = $2`.

4. **Fix EditTemplateModal to use DB roles** -- Replace hardcoded `AVAILABLE_ROLES` array with dynamic roles from `useRoles()` hook, matching what CreateTemplateModal already does.

5. **Compute relative timestamps at render time** -- Add a `timeAgo(timestamp)` utility that computes "5 minutes ago", "2 hours ago" etc. from the stored `timestamp` field. Stop storing `timeAgo` as a static string.

6. **Dark mode via class additions only** -- Add `dark:` Tailwind variants to existing classes. No structural changes to components.

---

## Tech Stack (No Changes)

- React 18 + TypeScript
- Vite 7
- Tailwind CSS 3 (class-based dark mode)
- Supabase (Postgres, Auth, Realtime)
- Vitest + React Testing Library

---

## File Structure

### New Files

| File | Purpose |
|------|---------|
| `src/utils/timeUtils.ts` | `formatTimeAgo(timestamp)` utility for relative time display |
| `src/utils/timeUtils.test.ts` | Unit tests for timeUtils |

### Modified Files

| File | Changes | Bugs Fixed |
|------|---------|------------|
| **Phase 1: Optimistic Updates + Performance** |
| `src/hooks/useRoles.ts` | Add optimistic local state updates to createRole, updateRole, deleteRole | BUG-02, BUG-03, BUG-10 (Playwright), BUG-10 (Research) |
| `src/hooks/useTemplates.ts` | Add optimistic local state updates to hook; expose CRUD wrappers | BUG-11 |
| `src/views/TemplatesView.tsx` | Remove `refetch()` calls after mutations; use hook CRUD wrappers; fix delete button handler | BUG-11, BUG-19, BUG-26 |
| `src/services/supabase/instanceService.ts` | Rewrite `updateStepStatus` to use direct UPDATE queries instead of fetch-rebuild-delete-insert | BUG-04 |
| `src/services/roleClient.ts` | Remove redundant `roleNameExists` check in `createCustomRole` (DB unique constraint handles it); parallelize `seedDefaultRoles` | BUG-07, BUG-27 |
| `src/services/supabase/roleService.ts` | Parallelize `isRoleInUse` queries with `Promise.all` | BUG-06 |
| `src/services/supabase/templateService.ts` | Fix `syncTemplateStepsToInstances` to use filtered query instead of fetching all instances | BUG-05 |
| **Phase 2: Functional Bug Fixes** |
| `src/components/templates/EditTemplateModal.tsx` | Replace hardcoded `AVAILABLE_ROLES` with `useRoles()` hook; pre-select current roles; add dark mode classes | BUG-05, BUG-06 (Playwright), BUG-004 |
| `src/components/manager/UsersPanel.tsx` | Replace `window.confirm` with `DeleteConfirmationDialog` | BUG-13 |
| `src/context/DarkModeContext.tsx` | Always wrap children in Provider, even before initialization | BUG-20 |
| `src/utils/timeUtils.ts` | NEW: Create `formatTimeAgo` utility | BUG-22 |
| `src/services/supabase/activityService.ts` | Sort activities by timestamp DESC in `listActivities` | BUG-22 |
| `src/services/supabase/mappers.ts` | Change `created_by` fallback from `'system'` to `'Unknown'` in `toRole` | BUG-07 (Playwright) |
| `src/components/OnboardingHub.tsx` | Use `formatTimeAgo` for activity logging instead of static `'just now'` | BUG-22 |
| **Phase 3: Dark Mode Fixes** |
| `src/components/onboarding/StepCard.tsx` | Add `dark:` variants for text colors and status boxes | BUG-21 |
| `src/components/modals/CreateRoleModal.tsx` | Add `dark:` variants for form inputs, labels, hint boxes, error/success backgrounds | BUG-24 |
| `src/components/modals/CreateOnboardingModal.tsx` | Add `dark:` variants for form inputs, labels, info boxes, error backgrounds | BUG-23 |
| `src/components/templates/CreateTemplateModal.tsx` | Add `dark:` variants for form inputs, labels, step cards, error backgrounds | BUG-25 |
| **Phase 4: Minor Fixes + Cleanup** |
| `src/services/supabase/instanceService.ts` | Add filter to `subscribeToEmployeeInstance` channel | BUG-14 |
| `src/services/supabase/userService.ts` | Remove dead `areUsersEqual` function | BUG-29 |
| `src/views/SignInView.tsx` | Remove duplicate `authStorageChange` event dispatch | BUG-28 |

---

## Data Model Changes

**No database schema changes required.** All fixes are in application code.

The `updateStepStatus` refactor changes the query pattern but not the schema:
- OLD: `SELECT * FROM onboarding_instances`, then `UPDATE onboarding_instances`, then `DELETE FROM instance_steps`, then `INSERT INTO instance_steps`
- NEW: `UPDATE instance_steps SET status = $1 WHERE instance_id = $2 AND position = $3`, then `UPDATE onboarding_instances SET progress = $1 WHERE id = $2`

---

## Component Architecture

### Hook Changes (Core of the fix)

```
useRoles (BEFORE):
  createRole() --> await createCustomRole() --> return newRole
  // Relies on subscribeToRoles callback to update state

useRoles (AFTER):
  createRole() --> await createCustomRole() --> setRoles(prev => [...prev, newRole]) --> return newRole
  updateRole() --> await updateCustomRole() --> setRoles(prev => prev.map(...)) --> return
  deleteRole() --> await deleteCustomRole() --> setRoles(prev => prev.filter(...)) --> return
  // Instant UI update, Realtime reconciles in background
```

```
useTemplates (BEFORE):
  // No CRUD wrappers, TemplatesView calls service directly + refetch()

useTemplates (AFTER):
  createTemplate() --> await createTemplate() --> setData(prev => [...prev, newTemplate]) --> return
  updateTemplate() --> await updateTemplate() --> setData(prev => prev.map(...)) --> return
  deleteTemplate() --> await deleteTemplate() --> setData(prev => prev.filter(...)) --> return
  // TemplatesView uses hook wrappers, no more refetch()
```

### Modal Fix Flow (EditTemplateModal)

```
BEFORE:
  const AVAILABLE_ROLES = ['Engineering', 'Sales', ...]; // Hardcoded
  selectedRoles = [template.role]; // Does not match hardcoded list if DB roles differ

AFTER:
  const { roles } = useRoles(); // Dynamic from DB
  selectedRoles = [template.role]; // Now matches DB roles, checkbox works
```

---

## Testing Strategy

### Unit Tests (write BEFORE implementation)

| Test File | Description | Count |
|-----------|-------------|-------|
| `src/utils/timeUtils.test.ts` | formatTimeAgo: "just now", "5 min ago", "2 hours ago", "yesterday", "3 days ago", edge cases | ~8 tests |
| `src/hooks/useRoles.test.ts` (modify) | Verify optimistic update: createRole adds to state immediately; deleteRole removes from state immediately | ~4 new tests |
| `src/hooks/useTemplates.test.ts` (modify) | Verify optimistic update: create/update/delete update state immediately | ~4 new tests |

### Integration Tests (verify with existing suite)

- Run `npx vitest run` after each phase to ensure no regressions
- Existing 650 tests use mocked Supabase so they will not break from service-layer changes
- But tests that check hook behavior may need mock adjustments for new CRUD wrappers

### Browser Verification (Playwright MCP)

After each phase, verify via Playwright:
- Phase 1: Create a role -> appears immediately in table (no page reload)
- Phase 2: Edit Template shows correct roles from DB; delete button deletes
- Phase 3: Toggle dark mode -> all modals, StepCard render correctly
- Phase 4: Activity timestamps show relative time, not "just now"

---

## Implementation Notes

### Optimistic Update Pattern

The key pattern for all hooks:

```typescript
const createRole = useCallback(async (name, description, createdBy) => {
  const newRole = await createCustomRole(name, description, createdBy ?? userId ?? null);
  // OPTIMISTIC: update local state immediately
  setRoles(prev => [...prev, newRole]);
  return newRole;
}, [userId]);
```

This works because:
- `createCustomRole` returns the full created object from Supabase (`.select().single()`)
- We add it to local state AFTER the server confirms creation (not truly optimistic -- more like "eager confirmation")
- If Realtime works, the subscription callback will fire later with the full list, replacing our optimistic state with server truth
- If Realtime does NOT work, our local state is already correct

For delete:
```typescript
const deleteRole = useCallback(async (roleId) => {
  await deleteCustomRole(roleId);
  // OPTIMISTIC: remove from local state immediately
  setRoles(prev => prev.filter(r => r.id !== roleId));
}, []);
```

### useTemplates CRUD Wrappers

Currently `useTemplates` only exposes `data`, `isLoading`, `error`, `refetch`. We need to add CRUD wrappers so that TemplatesView can call `templates.create(...)` instead of calling the service directly + `refetch()`.

The template service `createTemplate` returns only the ID, not the full template. So after creation, we need to construct the optimistic Template object:

```typescript
const create = useCallback(async (template: Omit<Template, 'id' | 'createdAt'>) => {
  const id = await createTemplate(template);
  const optimistic: Template = { ...template, id, createdAt: Date.now() };
  setData(prev => [...prev, optimistic]);
  return id;
}, []);
```

### Direct Step Status Update

The new `updateStepStatus` in instanceService.ts:

```typescript
export async function updateStepStatus(instanceId: string, stepId: number, status: StepStatus): Promise<void> {
  // Step 1: Update the specific step row directly
  const { error: stepError } = await supabase
    .from('instance_steps')
    .update({ status })
    .eq('instance_id', instanceId)
    .eq('position', stepId);

  if (stepError) throw new Error(...);

  // Step 2: Recalculate progress
  const { data: allSteps, error: fetchError } = await supabase
    .from('instance_steps')
    .select('status')
    .eq('instance_id', instanceId);

  if (fetchError) throw new Error(...);

  const completedCount = (allSteps ?? []).filter(s => s.status === 'completed').length;
  const progress = allSteps.length === 0 ? 0 : Math.round((completedCount / allSteps.length) * 100);

  // Step 3: Update instance progress
  const { error: progressError } = await supabase
    .from('onboarding_instances')
    .update({ progress })
    .eq('id', instanceId);

  if (progressError) throw new Error(...);
}
```

This is 3 queries instead of 4, and each query is targeted (no DELETE + INSERT).

### formatTimeAgo Utility

```typescript
export function formatTimeAgo(timestamp: number | undefined): string {
  if (!timestamp) return '';
  const seconds = Math.floor((Date.now() - timestamp) / 1000);
  if (seconds < 60) return 'just now';
  if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
  if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
  if (seconds < 172800) return 'yesterday';
  return `${Math.floor(seconds / 86400)}d ago`;
}
```

---

## Non-Goals (Explicitly NOT Doing)

1. **Global state management** (Zustand, Redux, shared Context for data) -- Too large a refactor. Optimistic updates in hooks are sufficient.
2. **Deduplicating useRoles() instances** across components -- The duplicate subscriptions are a minor issue compared to the Realtime failure. With optimistic updates, duplicate subscriptions are harmless.
3. **Pagination** on list queries -- Not needed at current data volumes.
4. **RLS policy hardening** -- Separate security concern, separate pipeline pass.
5. **Error boundary component** -- Nice to have, not a bug fix.
6. **Connection status indicator** -- Nice to have, not a bug fix.
7. **Admin vs Manager differentiation** -- Feature request, not a bug fix.
8. **Role name editing** -- Deliberate design choice (prevents breaking references), not a bug.
9. **Loading skeletons** -- Polish, not needed for "smooth and working."
10. **Toast notification system** -- Would require a new component + context. The existing inline success/error messages work. Defer.
11. **Delete button in Edit Role modal** -- Currently disabled. Enabling it requires careful UX decisions (confirm dialog inside modal). Users can delete from the table's trash icon. Defer.

---

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| Optimistic update shows stale data if server rejects mutation | Low | We only update local state AFTER `await` succeeds. The server has already confirmed. |
| Removing `refetch()` in TemplatesView means no way to manually sync | Low | The Realtime subscription still works as a background sync. And we can add refetch back if needed. |
| Changing `updateStepStatus` breaks step validation | Low | The new code still validates via the WHERE clause -- if the step does not exist, 0 rows are updated. |
| Dark mode class additions break existing light mode | Very Low | `dark:` prefixed classes only apply when `class="dark"` is on `<html>`. Zero impact on light mode. |
| Existing tests break from hook signature changes | Medium | The useTemplates hook gains new return values (create, update, delete). Existing tests that destructure `{ data, isLoading, error, refetch }` still work. New values are additive. |

---

## Phase Execution Summary

| Phase | Focus | Files Changed | User-Perceived Impact |
|-------|-------|---------------|----------------------|
| 1 | Optimistic updates + query optimization | 7 files | **HUGE** -- "it's instant now" |
| 2 | Functional bug fixes | 7 files | **HIGH** -- things that were broken now work |
| 3 | Dark mode | 5 files | **MEDIUM** -- visual consistency |
| 4 | Minor fixes + cleanup | 4 files | **LOW** -- polish |
