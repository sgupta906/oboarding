# Research: supabase-data-layer

## Metadata
- **Feature:** supabase-data-layer
- **Created:** 2026-02-14T04:00
- **Status:** research-complete
- **Researcher:** research-agent
- **Migration Step:** 2 of 5 (Firebase -> Supabase)

## Feature Context

Replace the monolithic Firebase/Firestore data access layer (`dataClient.ts` at 2,084 lines, plus `roleClient.ts` at 352 lines and `userOperations.ts` at 1,025 lines) with clean, modular Supabase-backed service files. This is the core data migration step.

### Where It Fits
- **Prerequisite:** `supabase-setup` (COMPLETE) -- Supabase client, database types, SQL migrations (16 tables), RLS, indexes, triggers all exist.
- **This step:** Replace all Firestore CRUD + localStorage fallback with Supabase queries.
- **Subsequent steps:** `supabase-auth` (step 3), `supabase-realtime` (step 3 -- realtime subscriptions), `cleanup` (step 4 -- remove Firebase deps).

### Dependencies on Other Features
- Supabase client at `src/config/supabase.ts` (done)
- Database types at `src/types/database.types.ts` (done, 16 tables)
- SQL migrations in `supabase/migrations/` (done, 6 files)
- Auth service (`src/services/authService.ts`) is NOT being replaced in this step

---

## Complete Function Map

### File: `src/services/dataClient.ts` (2,084 lines)

#### Collection Constants (lines 37-43)
| Constant | Value | Supabase Table |
|----------|-------|----------------|
| `TEMPLATES_COLLECTION` | `'templates'` | `templates` + `template_steps` |
| `ONBOARDING_INSTANCES_COLLECTION` | `'onboarding_instances'` | `onboarding_instances` + `instance_steps` |
| `SUGGESTIONS_COLLECTION` | `'suggestions'` | `suggestions` |
| `ACTIVITIES_COLLECTION` | `'activities'` | `activities` |
| `ROLES_COLLECTION` | `'roles'` | `roles` |
| `PROFILES_COLLECTION` | `'profiles'` | `profiles` + `profile_role_tags` |
| `PROFILE_TEMPLATES_COLLECTION` | `'profileTemplates'` | `profile_templates` + `profile_template_steps` |

#### localStorage Helper Functions (WILL BE REMOVED)
| Function | Lines | Purpose |
|----------|-------|---------|
| `getLocalRoles()` | 77-89 | Read roles from localStorage |
| `saveLocalRoles()` | 94-102 | Write roles + dispatch event |
| `getLocalProfiles()` | 107-119 | Read profiles from localStorage |
| `saveLocalProfiles()` | 124-132 | Write profiles + dispatch event |
| `getLocalProfileTemplates()` | 137-147 | Read profile templates |
| `saveLocalProfileTemplates()` | 152-162 | Write profile templates + dispatch event |
| `isFirestoreAvailable()` | 167-176 | Check if Firestore is configured |
| `getLocalOnboardingInstances()` | 181-191 | Read onboarding instances |
| `saveLocalOnboardingInstances()` | 196-203 | Write instances + dispatch event |
| `getLocalTemplates()` | 208-218 | Read templates |

**All localStorage helpers and the `isFirestoreAvailable()` check are removed. Supabase handles connectivity/caching differently.**

#### Exported CRUD Functions -- Templates Domain
| Function | Lines | Firestore Ops | Supabase Equivalent |
|----------|-------|---------------|---------------------|
| `listTemplates()` | 228-241 | `getDocs(collection)` | `supabase.from('templates').select('*, template_steps(*)')` |
| `getTemplate(id)` | 249-270 | `getDoc(doc)` + localStorage fallback | `supabase.from('templates').select('*, template_steps(*)').eq('id', id).single()` |
| `createTemplate(template)` | 277-293 | `addDoc` | `supabase.from('templates').insert().select().single()` + insert steps |
| `updateTemplate(id, updates)` | 301-323 | `updateDoc` + `syncTemplateStepsToInstances` | `supabase.from('templates').update()` + upsert steps + sync |
| `deleteTemplate(id)` | 427-436 | `deleteDoc` | `supabase.from('templates').delete().eq('id', id)` (CASCADE deletes steps) |
| `syncTemplateStepsToInstances(templateId, newSteps)` | 346-420 | Query instances by templateId, merge steps | Same logic but with Supabase queries |

#### Exported CRUD Functions -- OnboardingInstance Domain
| Function | Lines | Firestore Ops | Supabase Equivalent |
|----------|-------|---------------|---------------------|
| `listOnboardingInstances()` | 446-459 | `getDocs(collection)` | `supabase.from('onboarding_instances').select('*, instance_steps(*)')` |
| `getOnboardingInstance(id)` | 466-486 | `getDoc(doc)` | `.select('*, instance_steps(*)').eq('id', id).single()` |
| `createOnboardingInstance(instance)` | 493-508 | `addDoc` | `.insert()` + insert instance_steps |
| `updateOnboardingInstance(id, updates)` | 516-530 | `updateDoc` | `.update().eq('id', id)` + upsert steps if present |
| `updateStepStatus(instanceId, stepId, status)` | 551-587 | Read-modify-write (getDoc + updateDoc) | `supabase.from('instance_steps').update({status}).eq('id', stepId)` + recalc progress |
| `createOnboardingRunFromTemplate(employeeData)` | 632-706 | Validates, fetches template, creates instance + localStorage fallback + creates auth user | Same flow but Supabase-only |
| `OnboardingValidationError` (class) | 596-601 | N/A (validation) | Keep as-is |
| `CreateOnboardingRunInput` (interface) | 607-614 | N/A (type) | Keep as-is |
| `validateEmployeeData(data)` | 747-799 | N/A (validation) | Keep as-is |
| `ensureUserRecordForOnboarding(input)` | 714-734 | Calls userOperations | Keep, update to use Supabase user service |

#### Exported CRUD Functions -- Suggestions Domain
| Function | Lines | Firestore Ops | Supabase Equivalent |
|----------|-------|---------------|---------------------|
| `listSuggestions()` | 809-822 | `getDocs(collection)` | `supabase.from('suggestions').select('*')` |
| `createSuggestion(suggestion)` | 829-844 | `addDoc` | `.insert().select().single()` |
| `updateSuggestionStatus(id, status)` | 852-864 | `updateDoc` | `.update({status}).eq('id', id)` |
| `deleteSuggestion(id)` | 869-878 | `deleteDoc` | `.delete().eq('id', id)` |

#### Exported CRUD Functions -- Activities Domain
| Function | Lines | Firestore Ops | Supabase Equivalent |
|----------|-------|---------------|---------------------|
| `listActivities()` | 888-901 | `getDocs(collection)` | `supabase.from('activities').select('*')` |
| `logActivity(activity)` | 908-923 | `addDoc` | `.insert().select().single()` |

#### Exported Real-time Subscriptions (9 functions)
| Function | Lines | Firestore Ops | Supabase Equivalent |
|----------|-------|---------------|---------------------|
| `subscribeToTemplates(callback)` | 934-951 | `onSnapshot(collection)` | `supabase.channel().on('postgres_changes', ...)` |
| `subscribeToOnboardingInstance(instanceId, callback)` | 959-980 | `onSnapshot(doc)` | Channel filter on single row |
| `subscribeToSteps(instanceId, callback)` | 989-1008 | `onSnapshot(doc)` -> reads `.steps` | Channel on `instance_steps` filtered by instance_id |
| `subscribeToActivities(callback)` | 1015-1032 | `onSnapshot(collection)` | Channel on `activities` |
| `subscribeToOnboardingInstances(callback)` | 1037-1054 | `onSnapshot(collection)` | Channel on `onboarding_instances` |
| `subscribeToEmployeeInstance(email, callback)` | 1060-1130 | `onSnapshot(query(where))` + localStorage listener | Channel filtered by employee_email |
| `subscribeToRoles(callback)` | 1418-1471 | `onSnapshot(collection)` + localStorage fallback | Channel on `roles` |
| `subscribeToProfiles(callback)` | 1683-1736 | `onSnapshot(collection)` + localStorage fallback | Channel on `profiles` |
| `subscribeToProfileTemplates(profileId, callback)` | 2005-2083 | `onSnapshot(query(where))` + localStorage fallback | Channel filtered by profile_id |

#### Exported CRUD Functions -- Roles Domain
| Function | Lines | Firestore Ops | Supabase Equivalent |
|----------|-------|---------------|---------------------|
| `listRoles()` | 1141-1163 | `getDocs` + localStorage fallback | `supabase.from('roles').select('*')` |
| `getRole(id)` | 1171-1192 | `getDoc` + localStorage fallback | `.select('*').eq('id', id).single()` |
| `roleNameExists(name)` | 1200-1224 | `getDocs(query)` + localStorage check | `.select('id').ilike('name', name).limit(1)` |
| `isRoleInUse(roleId)` | 1232-1263 | Query templates + instances by role name | Query templates + instances by role name |
| `createRole(name, desc, createdBy)` | 1274-1320 | `addDoc` + localStorage fallback | `.insert().select().single()` |
| `updateRole(roleId, updates)` | 1330-1376 | `updateDoc` + localStorage fallback | `.update().eq('id', roleId)` |
| `deleteRole(roleId)` | 1386-1410 | `deleteDoc` + localStorage fallback | `.delete().eq('id', roleId)` |

#### Exported CRUD Functions -- Profiles Domain
| Function | Lines | Firestore Ops | Supabase Equivalent |
|----------|-------|---------------|---------------------|
| `listProfiles()` | 1482-1504 | `getDocs` + localStorage fallback | `supabase.from('profiles').select('*, profile_role_tags(*)')` |
| `getProfile(id)` | 1512-1533 | `getDoc` + localStorage fallback | `.select('*, profile_role_tags(*)').eq('id', id).single()` |
| `createProfile(name, desc, roleTags, createdBy)` | 1545-1592 | `addDoc` + localStorage fallback | `.insert()` + insert profile_role_tags |
| `updateProfile(profileId, updates)` | 1601-1651 | `updateDoc` + localStorage fallback | `.update()` + upsert role_tags |
| `deleteProfile(profileId)` | 1659-1675 | `deleteDoc` + localStorage fallback | `.delete()` (CASCADE deletes role_tags) |

#### Exported CRUD Functions -- ProfileTemplates Domain
| Function | Lines | Firestore Ops | Supabase Equivalent |
|----------|-------|---------------|---------------------|
| `listProfileTemplates(profileId?)` | 1748-1791 | `getDocs(query)` + localStorage fallback | `.select('*, profile_template_steps(*)').eq(...)` |
| `getProfileTemplate(id)` | 1799-1829 | `getDoc` + localStorage fallback | `.select('*, profile_template_steps(*)').eq('id', id).single()` |
| `createProfileTemplate(profileId, name, desc, steps, createdBy)` | 1841-1901 | `addDoc` + localStorage fallback | `.insert()` + insert steps |
| `updateProfileTemplate(templateId, updates)` | 1910-1972 | `updateDoc` + localStorage fallback | `.update()` + upsert steps |
| `deleteProfileTemplate(templateId)` | 1980-1996 | `deleteDoc` + localStorage fallback | `.delete()` (CASCADE deletes steps) |

### File: `src/services/roleClient.ts` (352 lines)

| Function | Lines | Purpose | Change Needed |
|----------|-------|---------|---------------|
| `validateRoleName(name)` | 55-100 | Validates role name format | Keep as-is (pure validation) |
| `validateRoleNameUniqueness(name)` | 109-127 | Checks for duplicate names | Calls dataClient.roleNameExists -- will use Supabase |
| `validateRoleDescription(desc)` | 138-161 | Validates description length | Keep as-is (pure validation) |
| `createCustomRole(name, desc, createdBy)` | 180-210 | Validates + creates role | Calls dataClient.createRole -- delegates |
| `updateCustomRole(roleId, updates)` | 224-264 | Validates + updates role | Calls dataClient.updateRole -- delegates |
| `deleteCustomRole(roleId)` | 276-289 | Validates + deletes role | Calls dataClient.deleteRole -- delegates |
| `seedDefaultRoles(userId)` | 306-335 | Seeds default roles | Calls dataClient.listRoles + createRole -- delegates |
| `hasDefaultRoles()` | 341-351 | Checks if roles exist | Calls dataClient.listRoles -- delegates |

**Note:** `roleClient.ts` is a validation/orchestration layer on top of `dataClient.ts`. It imports from `dataClient` and does NOT directly use Firestore. It will need import path updates but NO logic changes if we preserve the same function signatures from the new Supabase services.

### File: `src/services/userOperations.ts` (1,025 lines)

| Function | Lines | Firestore Ops | Supabase Equivalent |
|----------|-------|---------------|---------------------|
| `normalizeUserData(raw, id)` | 24-47 | N/A (transform) | Keep but adapt for Supabase row shape |
| `getLocalUsers()` | 99-122 | localStorage read + default seeding | Remove (Supabase handles persistence) |
| `saveLocalUsers(users)` | 128-135 | localStorage write + event dispatch | Remove |
| `userEmailExists(email, excludeUserId?)` | 141-165 | `getDocs` + localStorage fallback | `.select('id').ilike('email', email)` |
| `listUsers()` | 170-188 | `getDocs` + localStorage fallback | `supabase.from('users').select('*, user_roles(*), user_profiles(*)')` |
| `getUser(id)` | 193-209 | `getDoc` + localStorage fallback | `.select('*, user_roles(*), user_profiles(*)').eq('id', id).single()` |
| `createUser(userData, createdBy)` | 218-288 | `addDoc` + localStorage fallback + auth credentials | `.insert()` + insert user_roles + user_profiles |
| `addUserToAuthCredentials(email, role, userId)` | 303-331 | localStorage only | Keep for now (auth migration is step 3) |
| `getAuthCredential(email)` | 337-349 | localStorage only | Keep for now (auth migration is step 3) |
| `removeUserFromAuthCredentials(email)` | 367-400 | localStorage only | Keep for now (auth migration is step 3) |
| `updateUser(userId, updates)` | 406-460 | `updateDoc` + localStorage fallback | `.update()` + manage user_roles/user_profiles junction |
| `deleteUser(userId)` | 735-779 | `deleteDoc` + cascade cleanup via localStorage | `.delete()` (CASCADE handles cleanup via FK constraints) |
| `deleteOnboardingInstancesForUser(email)` | 469-487 | localStorage cascade | Remove (DB CASCADE handles this) |
| `deleteSuggestionsForUser(email)` | 496-514 | localStorage cascade | Remove (or handle via DB) |
| `deleteActivitiesForUser(userId)` | 523-541 | localStorage cascade | Remove (DB SET NULL via FK) |
| `deleteExpertAssignmentsForUser(email)` | 550-568 | localStorage cascade | Remove |
| `clearTemplateCreatedByReferences(userId)` | 578-602 | localStorage cascade | Remove (DB SET NULL via FK) |
| `clearRoleCreatedByReferences(userId)` | 612-636 | localStorage cascade | Remove (DB SET NULL via FK) |
| `clearProfileCreatedByReferences(userId)` | 646-670 | localStorage cascade | Remove (DB SET NULL via FK) |
| `clearProfileTemplateCreatedByReferences(userId)` | 680-704 | localStorage cascade | Remove (DB SET NULL via FK) |
| `areUsersEqual(users1, users2)` | 793-818 | N/A (comparison) | Keep (used by subscribeToUsers) |
| `subscribeToUsers(callback)` | 835-948 | `onSnapshot` + localStorage listener + merge logic | Supabase realtime channel |
| `setDisableDefaultUserSeeding(disable)` | 957-963 | Test helper | Remove (no localStorage seeding) |
| `clearAllUsersForTesting()` | 975-985 | Test helper | Replace with Supabase test cleanup |
| `logActivity(activity)` | 991-1024 | `addDoc` + localStorage fallback | Use shared activity service |

---

## Hook Analysis (All 10 Hooks)

### Hooks that use real-time subscriptions (return `Unsubscribe`)
| Hook | Service Import | Subscription Function | Firebase Import |
|------|---------------|----------------------|-----------------|
| `useActivities.ts` | `dataClient` | `subscribeToActivities` | `Unsubscribe from firebase/firestore` |
| `useEmployeeOnboarding.ts` | `dataClient` | `subscribeToEmployeeInstance` | None (uses `() => void` type) |
| `useOnboardingInstances.ts` | `dataClient` | `subscribeToOnboardingInstances` | None (uses `() => void` type) |
| `useRoles.ts` | `dataClient` + `roleClient` | `subscribeToRoles` | `Unsubscribe from firebase/firestore` |
| `useSteps.ts` | `dataClient` | `subscribeToSteps` | `Unsubscribe from firebase/firestore` |
| `useTemplates.ts` | `dataClient` | `subscribeToTemplates` | `Unsubscribe from firebase/firestore` |
| `useUsers.ts` | `userOperations` | `subscribeToUsers` | None (uses `() => void` type) |

### Hooks that use polling (no subscription)
| Hook | Service Import | Functions Called |
|------|---------------|-----------------|
| `useSuggestions.ts` | `dataClient` | `listSuggestions` (polls every 5s) |

### Hooks that use one-shot async calls
| Hook | Service Import | Functions Called |
|------|---------------|-----------------|
| `useCreateOnboarding.ts` | `dataClient` | `createOnboardingRunFromTemplate` |

### Composite hooks (use other hooks)
| Hook | Hooks Composed |
|------|---------------|
| `useManagerData.ts` | `useActivities`, `useOnboardingInstances`, `useSuggestions` |

### Hooks importing `Unsubscribe` from Firebase (MUST change)
4 hooks import `Unsubscribe` type from `firebase/firestore`:
1. `useActivities.ts` (line 9)
2. `useRoles.ts` (line 11)
3. `useSteps.ts` (line 7)
4. `useTemplates.ts` (line 10)

**Fix:** Replace `Unsubscribe` type with `() => void` (same runtime shape).

---

## Components Directly Importing Services

### `src/views/TemplatesView.tsx`
```typescript
import { createTemplate, updateTemplate, deleteTemplate } from '../services/dataClient';
```
Needs import path updated to new template service module.

### `src/components/OnboardingHub.tsx`
```typescript
import {
  createSuggestion,
  deleteSuggestion,
  logActivity,
  updateStepStatus,
  updateSuggestionStatus,
} from '../services/dataClient';
```
Needs import path updated. These come from suggestions, activities, and instances domains.

### `src/components/manager/UsersPanel.tsx`
```typescript
import { logActivity } from '../../services/userOperations';
```
Needs import path updated to new activity service or user service module.

---

## Firestore -> Supabase Operation Translation Map

| Firestore Operation | Supabase Equivalent | Notes |
|---------------------|---------------------|-------|
| `collection(firestore, name)` | `supabase.from(name)` | Table reference |
| `getDocs(collectionRef)` | `.select('*')` | Returns `{ data, error }` |
| `getDoc(docRef)` | `.select('*').eq('id', id).single()` | Returns `{ data, error }` |
| `addDoc(ref, data)` | `.insert(data).select().single()` | Returns the inserted row |
| `updateDoc(docRef, data)` | `.update(data).eq('id', id)` | Partial update |
| `deleteDoc(docRef)` | `.delete().eq('id', id)` | Hard delete |
| `query(ref, where('field', '==', val))` | `.select('*').eq('field', val)` | Equality filter |
| `onSnapshot(ref, callback)` | `supabase.channel().on('postgres_changes', ...).subscribe()` | Realtime subscription |
| `onSnapshot(docRef, callback)` | Channel filter on specific row | Single-document subscription |
| `doc(firestore, collection, id)` | `.from(table).eq('id', id)` | Document reference |
| `Unsubscribe` (type) | `() => void` / `RealtimeChannel.unsubscribe()` | Cleanup function |

---

## Schema Differences: Embedded Arrays vs. Relational Tables

This is the **most significant architectural change** in the migration.

### Current Firestore Model (Embedded Arrays)
```
Template { steps: Step[] }          -- Steps embedded as array in document
OnboardingInstance { steps: Step[] } -- Steps embedded as array in document
ProfileTemplate { steps: Step[] }    -- Steps embedded as array in document
User { roles: string[], profiles: string[] } -- Arrays embedded in document
Profile { roleTags: string[] }       -- Array embedded in document
```

### New Supabase Model (Relational Tables)
```
templates -> template_steps (1:N via template_id)
onboarding_instances -> instance_steps (1:N via instance_id)
profile_templates -> profile_template_steps (1:N via profile_template_id)
users -> user_roles (1:N via user_id, stores role_name TEXT)
users -> user_profiles (1:N via user_id, stores profile_name TEXT)
profiles -> profile_role_tags (1:N via profile_id, stores role_tag TEXT)
```

### Impact on Service Layer

**Every function that reads parent+children must JOIN:**
- `listTemplates()` must `.select('*, template_steps(*)')` and then map `template_steps` -> `steps` array
- `getUser(id)` must `.select('*, user_roles(*), user_profiles(*)')` and then map junction rows -> `roles[]` and `profiles[]`

**Every function that writes parent+children must use transactions or multi-step:**
- `createTemplate(template)` must: (1) insert template row, (2) insert template_steps rows
- `createUser(userData)` must: (1) insert user row, (2) insert user_roles rows, (3) insert user_profiles rows
- `updateTemplate(id, updates)` must: (1) update template row, (2) delete old steps, (3) insert new steps (if steps changed)

**Data mapping layers are needed:**
- Supabase returns `snake_case` columns; app types use `camelCase`
- Step `id` in Firestore was a `number`; in Supabase `template_steps.id` is a UUID, but there is a `position` field (integer) that maps to the old `id`
- Timestamps: Firestore used `number` (Unix ms); Supabase uses `TIMESTAMPTZ` (ISO string)

---

## Key Type Mapping Concerns

### Step ID: `number` vs `UUID`
- **App type:** `Step.id` is `number` (from `src/types/index.ts` line 118)
- **Database:** `template_steps.id` is `UUID`, `position` is `INTEGER`
- **Resolution:** Use `position` as the logical step ID in the app layer. The UUID is the database primary key. When reading steps from Supabase, map `position` -> `Step.id`.

### Timestamps: `number` (Unix ms) vs `TIMESTAMPTZ`
- **App types:** All timestamps are `number` (Unix milliseconds)
- **Database:** All timestamps are `TIMESTAMPTZ` (ISO 8601 strings)
- **Resolution:** Convert on read: `new Date(row.created_at).getTime()`. Convert on write: `new Date(timestamp).toISOString()`. Create shared helper functions.

### Suggestion ID: `number | string` vs `UUID`
- **App type:** `Suggestion.id` is `number | string`
- **Database:** `suggestions.id` is `UUID` (string)
- **Resolution:** UUIDs are strings, so this is compatible with the `string` variant.

### Suggestion field mapping
- **App type:** `Suggestion.user` (string, the user's name)
- **Database:** `suggestions.user_name` (text)
- **App type:** `Suggestion.stepId` (number)
- **Database:** `suggestions.step_id` (integer)

### Activity field mapping
- **App type:** `Activity.userInitials`, `Activity.timeAgo`, `Activity.userId`
- **Database:** `activities.user_initials`, `activities.time_ago`, `activities.user_id`

### OnboardingInstance field mapping
- **App type:** `employeeName`, `employeeEmail`, `templateId`, `startDate` (number), `completedAt` (number)
- **Database:** `employee_name`, `employee_email`, `template_id`, `start_date` (timestamptz), `completed_at` (timestamptz)

---

## Proposed Modular Service Split

Replace the 2,084-line `dataClient.ts` with 7 focused service modules:

```
src/services/supabase/
  index.ts                      -- Re-exports all services (barrel file)
  templateService.ts            -- Templates CRUD (~120 lines)
  instanceService.ts            -- OnboardingInstances CRUD + step status (~200 lines)
  suggestionService.ts          -- Suggestions CRUD (~60 lines)
  activityService.ts            -- Activities CRUD (~40 lines)
  roleService.ts                -- Roles CRUD (~120 lines)
  profileService.ts             -- Profiles CRUD + profile_role_tags (~120 lines)
  profileTemplateService.ts     -- Profile Templates CRUD (~120 lines)
  userService.ts                -- Users CRUD (replaces userOperations.ts) (~200 lines)
  mappers.ts                    -- snake_case->camelCase mappers, timestamp converters (~100 lines)
```

**Total: ~1,080 lines** (vs. current ~3,461 across 3 files) -- roughly 70% reduction.

### Barrel File Strategy
`src/services/supabase/index.ts` will export all functions with the **same names** as the current `dataClient.ts` exports. This means hooks and components can update their import paths with minimal changes:

```typescript
// Before:
import { listTemplates, createTemplate } from '../services/dataClient';

// After:
import { listTemplates, createTemplate } from '../services/supabase';
```

### What happens to existing files?
| Current File | Disposition |
|-------------|-------------|
| `src/services/dataClient.ts` | Replaced by `src/services/supabase/*.ts` modules |
| `src/services/roleClient.ts` | KEEP -- update imports from `./dataClient` to `./supabase` |
| `src/services/userOperations.ts` | Replaced by `src/services/supabase/userService.ts` |
| `src/services/authService.ts` | KEEP (not in scope for this step) |

---

## Real-time Subscription Strategy

### Current Pattern (Firestore `onSnapshot`)
- Firestore `onSnapshot` returns an `Unsubscribe` function
- Callback fires immediately with current data, then on every change
- Some hooks use localStorage event listeners as fallback

### Supabase Realtime Pattern
```typescript
const channel = supabase.channel('templates-changes')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'templates' }, (payload) => {
    // Re-fetch full data on any change
    callback(await listTemplates());
  })
  .subscribe();

// Cleanup:
return () => { supabase.removeChannel(channel); };
```

### Key Differences
1. **No initial data:** Supabase Realtime does NOT send current data on subscribe. Must fetch initial data separately.
2. **Payload is delta:** Supabase sends the changed row, not the full collection. For simplicity, we re-fetch on any change event.
3. **Return type:** Return `() => void` (call `supabase.removeChannel(channel)`).
4. **Channel naming:** Each subscription needs a unique channel name.

### Recommended Pattern for Each Subscription
```typescript
export function subscribeToTemplates(callback: (templates: Template[]) => void): () => void {
  // 1. Fetch initial data
  listTemplates().then(callback).catch(console.error);

  // 2. Subscribe to changes
  const channel = supabase.channel('templates-all')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'templates' }, () => {
      listTemplates().then(callback).catch(console.error);
    })
    .subscribe();

  // 3. Return cleanup
  return () => { supabase.removeChannel(channel); };
}
```

---

## Requirements

### Functional Requirements
- [ ] FR1: Replace all Firestore read operations with Supabase `.select()` queries
- [ ] FR2: Replace all Firestore write operations (addDoc/updateDoc/deleteDoc) with Supabase `.insert()/.update()/.delete()`
- [ ] FR3: Handle embedded array -> relational table mapping for steps, roles, profiles, roleTags
- [ ] FR4: Convert between camelCase app types and snake_case database columns
- [ ] FR5: Convert between Unix millisecond timestamps and ISO 8601 TIMESTAMPTZ strings
- [ ] FR6: Replace Firestore `onSnapshot` with Supabase Realtime channels for all 9 subscription functions
- [ ] FR7: Maintain identical public API signatures so hooks/components need only import path changes
- [ ] FR8: Remove all localStorage fallback patterns (7 get/save pairs + isFirestoreAvailable + custom events)
- [ ] FR9: Create modular service files (one per domain) instead of one monolithic file
- [ ] FR10: Update all 10 hooks to import from new service modules
- [ ] FR11: Update 3 components that directly import from services (TemplatesView, OnboardingHub, UsersPanel)
- [ ] FR12: Remove `firebase/firestore` imports from 4 hooks that import the `Unsubscribe` type
- [ ] FR13: Preserve `OnboardingValidationError` class and validation functions
- [ ] FR14: Preserve auth credential localStorage functions (addUserToAuthCredentials, getAuthCredential, removeUserFromAuthCredentials) -- these are needed until step 3 (supabase-auth)
- [ ] FR15: Handle Step.id (number) -> position (integer) mapping correctly in all step-related operations
- [ ] FR16: Update `roleClient.ts` imports to use new Supabase service modules
- [ ] FR17: Ensure cascading deletes work via database FK constraints (replacing manual localStorage cascade cleanup)

### Technical Requirements
- [ ] TR1: All new service files must import from `src/config/supabase.ts` (typed client)
- [ ] TR2: All new service files must use types from `src/types/database.types.ts` for database operations
- [ ] TR3: All new service files must return app-level types from `src/types/index.ts`
- [ ] TR4: Error handling must wrap Supabase errors in descriptive Error messages (matching current pattern)
- [ ] TR5: Tests must be updated to mock `@supabase/supabase-js` instead of `firebase/firestore`
- [ ] TR6: No Firebase imports should remain in service or hook files (except authService.ts which is out of scope)
- [ ] TR7: Build must pass (`tsc -b && vite build`)
- [ ] TR8: All existing tests must pass or be updated to work with new Supabase mocks

### Constraints
- Must NOT modify `src/services/authService.ts` (that is step 3)
- Must NOT modify `src/config/firebase.ts` (still needed for auth until step 3)
- Must keep auth credential localStorage functions until step 3
- Must NOT change component render logic -- only imports and service calls
- Must NOT change app-level TypeScript types in `src/types/index.ts`

---

## Existing Code Analysis

### Project State
- **Project exists:** YES -- mature codebase with ~60+ files
- **Test framework:** Vitest with jsdom, React Testing Library
- **Build system:** Vite + TypeScript
- **Supabase client:** Installed and configured (`@supabase/supabase-js@^2.95.3`)

### Code to Reuse
| File | What Can Be Reused |
|------|-------------------|
| `src/config/supabase.ts` | Typed Supabase client (import directly) |
| `src/types/database.types.ts` | Database row types for all 16 tables |
| `src/types/index.ts` | App-level types (no changes needed) |
| `src/services/roleClient.ts` | Validation logic (keep, update imports) |
| `src/services/authService.ts` | Auth flow (keep entirely, out of scope) |

### Code to Replace
| File | Lines | Replaced By |
|------|-------|-------------|
| `src/services/dataClient.ts` | 2,084 | `src/services/supabase/` (7 service modules + mappers + index) |
| `src/services/userOperations.ts` | 1,025 | `src/services/supabase/userService.ts` |

### Code to Modify (Import Path Updates Only)
| File | Change |
|------|--------|
| `src/hooks/useActivities.ts` | Import from `../services/supabase` |
| `src/hooks/useCreateOnboarding.ts` | Import from `../services/supabase` |
| `src/hooks/useEmployeeOnboarding.ts` | Import from `../services/supabase` |
| `src/hooks/useOnboardingInstances.ts` | Import from `../services/supabase` |
| `src/hooks/useRoles.ts` | Import from `../services/supabase` + remove firebase/firestore |
| `src/hooks/useSteps.ts` | Import from `../services/supabase` + remove firebase/firestore |
| `src/hooks/useSuggestions.ts` | Import from `../services/supabase` |
| `src/hooks/useTemplates.ts` | Import from `../services/supabase` + remove firebase/firestore |
| `src/hooks/useUsers.ts` | Import from `../services/supabase` |
| `src/hooks/useManagerData.ts` | No change (only imports hooks) |
| `src/views/TemplatesView.tsx` | Import from `../services/supabase` |
| `src/components/OnboardingHub.tsx` | Import from `../services/supabase` |
| `src/components/manager/UsersPanel.tsx` | Import from `../../services/supabase` |
| `src/services/roleClient.ts` | Import from `./supabase` instead of `./dataClient` |

### Patterns to Follow
1. **Error wrapping:** Current code wraps all errors in `new Error(\`Failed to X: \${message}\`)` -- maintain this pattern
2. **Firestore fallback:** Remove the try-Firestore-fallback-to-localStorage pattern entirely
3. **Subscription return type:** Return `() => void` cleanup function (same as current Unsubscribe)
4. **Export named functions:** No default exports in services
5. **Barrel exports:** Re-export everything from `index.ts` for clean imports

---

## Risk Assessment

### Technical Risks

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Step ID mismatch (number vs UUID) | HIGH | HIGH | Create mapping layer: use `position` field as the logical Step.id in app code |
| Timestamp format mismatch (number vs ISO string) | HIGH | HIGH | Create shared converter helpers in `mappers.ts`; test thoroughly |
| Realtime subscriptions behave differently (no initial data) | MED | HIGH | Fetch initial data before subscribing; re-fetch on every change event |
| Junction table writes need multi-step (not atomic) | MED | MED | Use Supabase's `upsert` where possible; for creates, insert parent first then children |
| Missing `Unsubscribe` type from firebase/firestore in 4 hooks | LOW | HIGH | Replace with `() => void` type alias |
| Test suite breaks from mock structure changes | MED | HIGH | Update all test mocks from firebase/firestore to @supabase/supabase-js |
| `roleClient.ts` breaks if dataClient API changes | MED | MED | Ensure barrel file exports same function names; roleClient imports will just change paths |
| Auth credential localStorage functions still needed | LOW | LOW | Explicitly preserve them in userService.ts until step 3 |
| `createOnboardingRunFromTemplate` calls `userOperations` functions | MED | MED | New `instanceService.ts` must import from `userService.ts` |
| onboarding instance step arrays in Firestore become separate table rows | HIGH | HIGH | All read operations must JOIN instance_steps; all writes must handle the child table |

### Complexity
- **Level:** Complex
- **Rationale:**
  1. The monolithic file touches 7 domain tables with cross-cutting concerns (e.g., `syncTemplateStepsToInstances`)
  2. Embedded array -> relational table is a fundamental data model change requiring mapping on every read/write
  3. 9 real-time subscriptions must all be converted to a different paradigm (Supabase channels vs Firestore snapshots)
  4. 3 type conversion challenges (camelCase/snake_case, timestamps, step IDs)
  5. 10 hooks + 3 components need import updates
  6. Test suite needs complete mock overhaul

---

## Open Questions

- [x] Q1: Should `roleClient.ts` be kept as a separate orchestration layer or folded into the Supabase role service?
  - Resolution: KEEP as separate file. It provides validation logic that is independent of the storage backend. Just update its imports from `./dataClient` to `./supabase`.

- [x] Q2: How to handle Step.id (currently `number`) when the database uses UUIDs with a `position` column?
  - Resolution: Map `position` -> `Step.id` on read, `Step.id` -> `position` on write. The UUID primary key is an internal database concern, not exposed to the app layer.

- [x] Q3: Should we create a shared `mappers.ts` or inline mapping logic in each service?
  - Resolution: Create `mappers.ts` with reusable functions: `toTemplate()`, `toInstance()`, `toUser()`, etc. plus shared helpers `toUnixMs()`, `toISOString()`, `toCamelCase()`.

- [x] Q4: What happens to the auth credential localStorage functions during this step?
  - Resolution: Preserve them in `userService.ts`. They will be removed in step 3 (supabase-auth).

- [x] Q5: Should subscriptions use "re-fetch on change" or "apply delta" pattern?
  - Resolution: Use "re-fetch on change" pattern for simplicity and correctness. The delta approach is more complex and error-prone for collections with joined child tables.

- [x] Q6: How do we handle the `syncTemplateStepsToInstances` cross-domain concern?
  - Resolution: Keep this logic in `templateService.ts` where it lives now. It will import from `instanceService.ts` to update instances when template steps change.

---

## Recommended Approach

### Implementation Strategy

**Phase 1: Foundation (build once, use everywhere)**
1. Create `src/services/supabase/mappers.ts` with all row-to-app-type converters
2. Create `src/services/supabase/index.ts` barrel file (start empty, add exports as services are created)

**Phase 2: Simple Services First (build confidence)**
3. Create `activityService.ts` (simplest: flat table, no joins, no children)
4. Create `suggestionService.ts` (flat table, no joins, minimal complexity)
5. Create `roleService.ts` (flat table, no children, but has `roleNameExists` and `isRoleInUse` queries)

**Phase 3: Complex Services (parent + child table patterns)**
6. Create `templateService.ts` (template + template_steps join + `syncTemplateStepsToInstances`)
7. Create `profileService.ts` (profile + profile_role_tags junction)
8. Create `profileTemplateService.ts` (profile_template + profile_template_steps)
9. Create `instanceService.ts` (onboarding_instance + instance_steps + `createOnboardingRunFromTemplate`)
10. Create `userService.ts` (user + user_roles + user_profiles junctions + auth credential helpers)

**Phase 4: Hook & Component Updates**
11. Update all 10 hooks to import from `../services/supabase`
12. Update 3 components to import from new paths
13. Update `roleClient.ts` to import from `./supabase`
14. Remove `Unsubscribe` imports from `firebase/firestore` in 4 hooks

**Phase 5: Cleanup**
15. Delete `src/services/dataClient.ts`
16. Delete `src/services/userOperations.ts`
17. Update/rewrite test files for Supabase mocks

### Order of Work
1. `mappers.ts` + `index.ts` (foundation)
2. `activityService.ts` (simplest service)
3. `suggestionService.ts`
4. `roleService.ts`
5. `templateService.ts` (first complex service with child tables)
6. `profileService.ts`
7. `profileTemplateService.ts`
8. `instanceService.ts` (most complex -- has cross-domain deps)
9. `userService.ts` (second most complex -- junctions + auth helpers)
10. Hook + component import updates
11. `roleClient.ts` import update
12. Delete old files + update tests

### What to Defer
- **Auth migration:** Do NOT touch authService.ts, firebase.ts, or authContext.ts
- **RLS policy refinement:** Current policies are "allow all" -- proper policies come with supabase-auth step
- **Performance optimization:** Supabase query optimization (pagination, selective columns) can come later
- **Supabase Edge Functions:** Not needed for this step; all logic runs client-side

---

## Next Step

**All questions resolved. Status: research-complete.**

Run `/plan supabase-data-layer` to create the implementation plan with task breakdown.
