# Plan: supabase-data-layer

## Metadata
- **Feature:** supabase-data-layer
- **Created:** 2026-02-14T04:15
- **Status:** plan-complete
- **Based-on:** 2026-02-14T04:00_research.md
- **Migration Step:** 2 of 5 (Firebase -> Supabase)

---

## Architecture Overview

### Current State (Before)

```
Component / View
    |
    v
Hook (useTemplates, useUsers, etc.)
    |
    v
+-----------------------------------------+
| dataClient.ts (2,084 lines)             |  <-- Monolithic
| userOperations.ts (1,025 lines)         |  <-- Monolithic
| roleClient.ts (352 lines)              |  <-- Orchestration layer
+-----------------------------------------+
    |                   |
    v                   v
Firebase/Firestore    localStorage (fallback)
```

### Target State (After)

```
Component / View
    |
    v
Hook (useTemplates, useUsers, etc.)         -- Import path changes only
    |
    v
+-------------------------------------------------+
| src/services/supabase/index.ts (barrel)         |  <-- Clean re-exports
|   templateService.ts      (~120 lines)          |
|   instanceService.ts      (~200 lines)          |
|   suggestionService.ts    (~60 lines)           |
|   activityService.ts      (~40 lines)           |
|   roleService.ts          (~120 lines)          |
|   profileService.ts       (~120 lines)          |
|   profileTemplateService.ts (~120 lines)        |
|   userService.ts          (~200 lines)          |
|   mappers.ts              (~150 lines)          |
+-------------------------------------------------+
    |
    v
src/config/supabase.ts  -->  Supabase (Postgres)
```

### Data Flow Diagram

```
  [React Component]
        |
        | calls hook
        v
  [Custom Hook]  (e.g. useTemplates)
        |
        | imports from '../services/supabase'
        v
  [Service Function]  (e.g. listTemplates)
        |
        | calls supabase client
        v
  [Supabase Client]  (from src/config/supabase.ts)
        |
        | .from('templates').select('*, template_steps(*)')
        v
  [Postgres via PostgREST]
        |
        | returns { data, error }
        v
  [Mapper Function]  (e.g. toTemplate)
        |
        | snake_case -> camelCase
        | ISO timestamps -> Unix ms
        | child rows -> embedded arrays
        v
  [App-level Type]  (e.g. Template from src/types/index.ts)
        |
        | returned to hook
        v
  [Hook State Update]  (setState)
        |
        | re-render
        v
  [React Component]
```

### Real-time Subscription Flow

```
  subscribeToTemplates(callback)
        |
        | 1. Fetch initial data
        +---> listTemplates().then(callback)
        |
        | 2. Create Supabase channel
        +---> supabase.channel('templates-all')
        |         .on('postgres_changes', {
        |            event: '*',
        |            schema: 'public',
        |            table: 'templates'
        |         }, () => listTemplates().then(callback))
        |         .subscribe()
        |
        | 3. Return cleanup function
        +---> return () => supabase.removeChannel(channel)
```

---

## Tech Stack Summary

| Concern | Technology |
|---------|-----------|
| Database | Supabase (Postgres) via PostgREST |
| Client SDK | @supabase/supabase-js ^2.95.3 |
| Types | src/types/database.types.ts (DB) + src/types/index.ts (App) |
| Realtime | Supabase Realtime (postgres_changes) |
| Test framework | Vitest + jsdom + React Testing Library |
| Build | Vite + TypeScript |

---

## File Structure

### New Files to Create (10)

| # | File | Purpose | Estimated Lines |
|---|------|---------|-----------------|
| 1 | `src/services/supabase/mappers.ts` | Type converters: DB rows -> App types, timestamp helpers | ~150 |
| 2 | `src/services/supabase/activityService.ts` | Activities CRUD + subscription | ~50 |
| 3 | `src/services/supabase/suggestionService.ts` | Suggestions CRUD | ~70 |
| 4 | `src/services/supabase/roleService.ts` | Roles CRUD + roleNameExists + isRoleInUse + subscription | ~140 |
| 5 | `src/services/supabase/templateService.ts` | Templates CRUD + syncStepsToInstances + subscription | ~180 |
| 6 | `src/services/supabase/profileService.ts` | Profiles CRUD + profile_role_tags + subscription | ~130 |
| 7 | `src/services/supabase/profileTemplateService.ts` | Profile Templates CRUD + subscription | ~150 |
| 8 | `src/services/supabase/instanceService.ts` | Onboarding Instances CRUD + step status + createFromTemplate + subscriptions | ~250 |
| 9 | `src/services/supabase/userService.ts` | Users CRUD + auth credential helpers + subscription | ~220 |
| 10 | `src/services/supabase/index.ts` | Barrel file re-exporting all services | ~50 |

**Total new code: ~1,390 lines** (vs. 3,109 lines being replaced = 55% reduction)

### Existing Files to Modify (15)

| # | File | Change | Lines Affected |
|---|------|--------|---------------|
| 1 | `src/hooks/useTemplates.ts` | Change import from `../services/dataClient` to `../services/supabase`; remove `Unsubscribe` import from `firebase/firestore`; type cleanup as `() => void` | Lines 10-11 |
| 2 | `src/hooks/useSteps.ts` | Change import from `../services/dataClient` to `../services/supabase`; remove `Unsubscribe` import from `firebase/firestore`; type cleanup as `() => void` | Lines 7-8 |
| 3 | `src/hooks/useActivities.ts` | Change import from `../services/dataClient` to `../services/supabase`; remove `Unsubscribe` import from `firebase/firestore`; type cleanup as `() => void` | Lines 9-10 |
| 4 | `src/hooks/useRoles.ts` | Change import from `../services/dataClient` to `../services/supabase`; remove `Unsubscribe` import from `firebase/firestore`; type cleanup as `() => void` | Lines 11-12 |
| 5 | `src/hooks/useSuggestions.ts` | Change import from `../services/dataClient` to `../services/supabase` | Line 9 |
| 6 | `src/hooks/useOnboardingInstances.ts` | Change import from `../services/dataClient` to `../services/supabase` | Line 9 |
| 7 | `src/hooks/useEmployeeOnboarding.ts` | Change import from `../services/dataClient` to `../services/supabase` | Line 2 |
| 8 | `src/hooks/useCreateOnboarding.ts` | Change import from `../services/dataClient` to `../services/supabase` | Lines 8-12 |
| 9 | `src/hooks/useUsers.ts` | Change import from `../services/userOperations` to `../services/supabase` | Lines 7-13 |
| 10 | `src/views/TemplatesView.tsx` | Change import from `../services/dataClient` to `../services/supabase` | Line 10 |
| 11 | `src/components/OnboardingHub.tsx` | Change import from `../services/dataClient` to `../services/supabase` | Lines 16-27 |
| 12 | `src/components/manager/UsersPanel.tsx` | Change import from `../../services/userOperations` to `../../services/supabase` | Line 11 |
| 13 | `src/services/roleClient.ts` | Change imports from `./dataClient` to `./supabase` | Lines 7-15 |
| 14 | `src/test/setup.ts` | Change import from `../services/userOperations` to `../services/supabase` | Line 8 |
| 15 | `src/hooks/useManagerData.ts` | No change needed (only imports other hooks) | 0 |

### Test Files to Update (8)

| # | File | Change |
|---|------|--------|
| 1 | `src/hooks/useTemplates.test.ts` | Update mocks from `firebase/firestore` to `../services/supabase` |
| 2 | `src/hooks/useSteps.test.ts` | Update mocks from `firebase/firestore` to `../services/supabase` |
| 3 | `src/hooks/useActivities.test.ts` | Update mocks from `firebase/firestore` to `../services/supabase` |
| 4 | `src/hooks/useSuggestions.test.ts` | Update mocks from `../services/dataClient` to `../services/supabase` |
| 5 | `src/hooks/useUsers.test.ts` | Update mocks from `../services/userOperations` to `../services/supabase` |
| 6 | `src/services/dataClient.test.ts` | Replace with Supabase service tests or delete |
| 7 | `src/services/userOperations.test.ts` | Replace with userService tests or delete |
| 8 | `src/components/manager/UsersPanel.test.tsx` | Update mocks from `../../services/userOperations` to `../../services/supabase` |

### Files to Delete (2)

| # | File | Lines Removed | Reason |
|---|------|--------------|--------|
| 1 | `src/services/dataClient.ts` | 2,084 | Replaced by `src/services/supabase/*.ts` |
| 2 | `src/services/userOperations.ts` | 1,025 | Replaced by `src/services/supabase/userService.ts` |

### Files NOT Modified (Out of Scope)

| File | Reason |
|------|--------|
| `src/services/authService.ts` | Auth migration is step 3 |
| `src/config/firebase.ts` | Still needed for auth until step 3 |
| `src/config/authContext.tsx` | Auth migration is step 3 |
| `src/types/index.ts` | App-level types remain unchanged |
| `src/types/database.types.ts` | Database types from step 1, no changes needed |
| `src/config/supabase.ts` | Supabase client from step 1, no changes needed |

---

## Mapper/Converter Strategy

### Overview

The mapper layer (`src/services/supabase/mappers.ts`) bridges three type systems:

```
Database Types (snake_case)      App Types (camelCase)
database.types.ts                types/index.ts
---------------------            ----------------------
templates.Row                    Template
  template_steps.Row[]             .steps: Step[]
  .created_at: string              .createdAt: number
  .is_active: boolean              .isActive: boolean

onboarding_instances.Row         OnboardingInstance
  instance_steps.Row[]             .steps: Step[]
  .employee_name: string           .employeeName: string
  .template_id: string             .templateId: string
  .start_date: string              .startDate: number

users.Row                        User
  user_roles.Row[]                 .roles: string[]
  user_profiles.Row[]              .profiles: string[]
  .created_by: string              .createdBy: string

profiles.Row                     Profile
  profile_role_tags.Row[]          .roleTags: string[]

profile_templates.Row            ProfileTemplate
  profile_template_steps.Row[]     .steps: Step[]
  .profile_id: string              .profileId: string
  .is_published: boolean           .isPublished: boolean

template_steps.Row               Step
  .position: number                .id: number (mapped from position)

suggestions.Row                  Suggestion
  .user_name: string               .user: string
  .step_id: number                 .stepId: number

activities.Row                   Activity
  .user_initials: string           .userInitials: string
  .time_ago: string                .timeAgo: string
  .user_id: string                 .userId: string
  .resource_type: string           .resourceType: string
  .resource_id: string             .resourceId: string
```

### Shared Helper Functions

```typescript
// Timestamp conversion
toUnixMs(isoString: string | null): number      // ISO 8601 -> Unix milliseconds
toISO(unixMs: number): string                    // Unix milliseconds -> ISO 8601
toOptionalUnixMs(isoString: string | null | undefined): number | undefined

// Row-to-App mappers (one per domain)
toStep(row: TemplateStepRow | InstanceStepRow | ProfileTemplateStepRow): Step
toTemplate(row: TemplateRow, stepRows: TemplateStepRow[]): Template
toInstance(row: InstanceRow, stepRows: InstanceStepRow[]): OnboardingInstance
toSuggestion(row: SuggestionRow): Suggestion
toActivity(row: ActivityRow): Activity
toRole(row: RoleRow): CustomRole
toProfile(row: ProfileRow, roleTagRows: ProfileRoleTagRow[]): Profile
toProfileTemplate(row: ProfileTemplateRow, stepRows: ProfileTemplateStepRow[]): ProfileTemplate
toUser(row: UserRow, roleRows: UserRoleRow[], profileRows: UserProfileRow[]): User

// App-to-Row mappers (for inserts/updates)
fromStep(step: Step, parentId: string, parentField: string): StepInsertRow
fromTemplateInsert(template: Omit<Template, 'id' | 'createdAt'>): TemplateInsertRow
fromInstanceInsert(instance: Omit<OnboardingInstance, 'id' | 'createdAt'>): InstanceInsertRow
```

### Step ID Mapping (Critical)

The most important mapping concern:

```
App: Step.id = number (e.g., 1, 2, 3)
DB:  template_steps.position = integer (e.g., 1, 2, 3)
DB:  template_steps.id = UUID (internal PK, not exposed)

Read:  step.id = row.position
Write: row.position = step.id
```

All step mappers use `position` as the logical step ID. The UUID primary key is never exposed to the application layer.

---

## Component Architecture

### Service Dependencies

```
activityService ---- (standalone, no service deps)
suggestionService -- (standalone, no service deps)
roleService -------- (standalone, no service deps)

templateService -----> instanceService (syncTemplateStepsToInstances)
profileService ----- (standalone, no service deps)
profileTemplateService (standalone, no service deps)
instanceService -----> userService (ensureUserRecordForOnboarding)
                       templateService (getTemplate for createFromTemplate)
userService -------- (standalone, no service deps; has auth credential helpers)
```

### Circular Dependency Prevention

`templateService` calls `instanceService.updateOnboardingInstance` during `syncTemplateStepsToInstances`. `instanceService` calls `templateService.getTemplate` during `createOnboardingRunFromTemplate`. This is a potential circular import.

**Resolution:** The `instanceService` imports `getTemplate` from `templateService`, and `templateService` imports `updateOnboardingInstance` and `listOnboardingInstances` from `instanceService`. Since these are lazy (called at runtime, not at import time), circular imports work in ES modules. However, to be safe and explicit, we will:

1. Have `instanceService` accept a `getTemplate` function parameter in `createOnboardingRunFromTemplate` and bind it in the barrel file, OR
2. Accept the lazy circular import since ES modules handle this correctly for function exports.

**Decision:** Option 2 -- accept lazy circular imports. TypeScript and Vite handle this correctly for named function exports. The functions are not called at import time, only at runtime when invoked by user actions.

### State Management

No changes to state management pattern. Hooks continue to own state via `useState`. The only change is where hooks import their service functions from.

---

## Testing Strategy

### Unit Tests for Mappers (~20 tests)

| Test Group | Count | Description |
|-----------|-------|-------------|
| Timestamp conversion | 4 | toUnixMs, toISO, null handling, edge cases |
| Step mapping | 3 | position -> id, all fields mapped, null link |
| Template mapping | 3 | Full mapping with steps, empty steps, timestamps |
| Instance mapping | 3 | Full mapping with steps, optional fields, progress |
| User mapping | 3 | Full mapping with roles/profiles junction rows |
| Suggestion mapping | 2 | Full mapping, user_name -> user field rename |
| Activity mapping | 2 | Full mapping, optional fields |

### Unit Tests for Services (~40 tests)

Each service gets tests for its CRUD operations. Tests mock `supabase.from()` chain.

| Service | Test Count | Key Scenarios |
|---------|-----------|---------------|
| activityService | 4 | list, log, subscribe, error handling |
| suggestionService | 5 | list, create, updateStatus, delete, error handling |
| roleService | 8 | list, get, create, update, delete, nameExists, isRoleInUse, subscribe |
| templateService | 6 | list, get, create, update (with sync), delete, subscribe |
| instanceService | 8 | list, get, create, update, updateStepStatus, createFromTemplate, subscribe x2 |
| profileService | 6 | list, get, create, update (with roleTags), delete, subscribe |
| profileTemplateService | 6 | list (with filter), get, create, update (with steps), delete, subscribe |
| userService | 7 | list, get, create, update, delete (cascade), emailExists, subscribe |

### Integration Tests (~5 tests)

| Test | Description |
|------|-------------|
| Hook + Service wiring | Verify useTemplates calls subscribeToTemplates from supabase service |
| Import path verification | Verify no remaining imports from firebase/firestore in hooks/services |
| Barrel export completeness | Verify all expected functions are exported from index.ts |
| roleClient integration | Verify roleClient works with new supabase imports |
| Build compilation | `tsc -b` succeeds with no new errors |

### Existing Test Updates (~8 test files)

All existing test files that mock `firebase/firestore` or import from `dataClient`/`userOperations` must be updated to mock `../services/supabase` instead. The test logic itself does not change -- only the mock targets.

---

## Migration Strategy

### Approach: Direct Swap (No Feature Flag)

The research considered a feature flag approach but this adds unnecessary complexity. Instead:

1. Build all new Supabase services
2. Update all imports in one pass
3. Delete old files
4. Run full test suite to verify

**Rationale:**
- The public API is preserved (same function names and signatures)
- All changes are in the service layer -- no component logic changes
- Tests catch any wiring issues immediately
- A feature flag would require maintaining two code paths indefinitely

### Swap Order (Minimize Broken State)

1. **Create all new service files first** (no imports change yet, app still works with old files)
2. **Update barrel file** (make all new functions available)
3. **Update all imports atomically** (hooks, components, roleClient, test setup)
4. **Delete old files** (only after all imports point to new services)
5. **Update test mocks** (tests now mock supabase instead of firebase)
6. **Run full test suite** to verify

This order ensures the app is never in a broken state during development. At step 3, if any import is missed, TypeScript will catch it immediately.

### Preserved Public API

These function names and signatures are preserved exactly:

**From dataClient.ts (re-exported via barrel):**
- `listTemplates`, `getTemplate`, `createTemplate`, `updateTemplate`, `deleteTemplate`
- `listOnboardingInstances`, `getOnboardingInstance`, `createOnboardingInstance`, `updateOnboardingInstance`, `updateStepStatus`
- `createOnboardingRunFromTemplate`, `OnboardingValidationError`, `CreateOnboardingRunInput`
- `listSuggestions`, `createSuggestion`, `updateSuggestionStatus`, `deleteSuggestion`
- `listActivities`, `logActivity`
- `subscribeToTemplates`, `subscribeToOnboardingInstance`, `subscribeToSteps`, `subscribeToActivities`, `subscribeToOnboardingInstances`, `subscribeToEmployeeInstance`
- `listRoles`, `getRole`, `createRole`, `updateRole`, `deleteRole`, `roleNameExists`, `isRoleInUse`, `subscribeToRoles`
- `listProfiles`, `getProfile`, `createProfile`, `updateProfile`, `deleteProfile`, `subscribeToProfiles`
- `listProfileTemplates`, `getProfileTemplate`, `createProfileTemplate`, `updateProfileTemplate`, `deleteProfileTemplate`, `subscribeToProfileTemplates`

**From userOperations.ts (re-exported via barrel):**
- `listUsers`, `getUser`, `createUser`, `updateUser`, `deleteUser`, `userEmailExists`
- `subscribeToUsers`, `areUsersEqual`
- `addUserToAuthCredentials`, `getAuthCredential`, `removeUserFromAuthCredentials` (kept until auth migration)
- `logActivity` (from userOperations -- same name as dataClient; userService re-exports it)
- `saveLocalUsers` (exported for test setup.ts)
- `setDisableDefaultUserSeeding`, `clearAllUsersForTesting` (test helpers)

---

## Implementation Notes

### Design Decisions

1. **Re-fetch on change pattern for subscriptions:** Instead of applying deltas from realtime events, we re-fetch the full dataset on any change. This is simpler, avoids complex delta merging for joined tables, and the data volumes are small (< 1000 rows per table).

2. **No localStorage fallback:** All localStorage read/write/event patterns are removed. Supabase is the sole data source. The auth credential localStorage functions are preserved because auth migration is step 3.

3. **Mapper layer centralized:** All type conversions live in `mappers.ts` rather than being inlined in each service. This ensures consistency and makes it easy to find/fix mapping bugs.

4. **Error wrapping pattern preserved:** All errors are caught and re-thrown as `new Error('Failed to X: message')` matching the current pattern that components/hooks expect.

5. **Validation functions preserved as-is:** `validateEmployeeData`, `OnboardingValidationError`, and all roleClient validation functions are pure logic with no storage dependencies. They are kept unchanged.

6. **syncTemplateStepsToInstances preserved:** This cross-domain function lives in `templateService.ts` and imports from `instanceService.ts`. The logic is equivalent to the current implementation but uses Supabase queries instead of Firestore.

7. **Junction table writes use delete-then-insert:** For updates to junction tables (user_roles, user_profiles, profile_role_tags), we delete existing rows and insert new ones rather than trying to diff. This is simpler and Postgres handles it efficiently.

### Patterns

- **Query pattern:** `const { data, error } = await supabase.from('table').select('*'); if (error) throw new Error(...); return data.map(toMapper);`
- **Insert pattern:** `const { data, error } = await supabase.from('table').insert(row).select().single(); if (error) throw new Error(...);`
- **Subscription pattern:** Initial fetch + channel listener + re-fetch on change + return cleanup function.

### Trade-offs

| Decision | Pro | Con |
|----------|-----|-----|
| Re-fetch on change | Simple, always correct | Slightly more network calls |
| No feature flag | Less code, simpler migration | Can't A/B test both backends |
| Centralized mappers | Consistent, testable | Extra file to maintain |
| Direct swap (no dual-write) | Clean, no dual-code | Must swap everything at once |

---

## Non-Goals

These items are explicitly **NOT** part of this feature:

1. **Auth migration** -- authService.ts, firebase.ts, authContext.tsx are not touched
2. **RLS policy tightening** -- Current permissive policies stay until supabase-auth step
3. **Query optimization** -- No pagination, selective columns, or caching. Keep queries simple.
4. **Edge functions** -- All logic remains client-side
5. **Component logic changes** -- No changes to rendering, state management, or UI behavior
6. **App-level type changes** -- src/types/index.ts is not modified
7. **Database schema changes** -- The schema from supabase-setup is used as-is
8. **Supabase local development setup** -- This plan assumes Supabase is accessible via env vars
9. **Performance benchmarking** -- No A/B comparison of Firebase vs Supabase performance

---

## Risk Mitigation

| Risk | Mitigation |
|------|-----------|
| Step ID mismatch (number vs UUID) | Mapper uses `position` field as logical ID; UUID never exposed to app |
| Timestamp format mismatch | Shared helper functions with unit tests; all services use same converters |
| Circular imports (template <-> instance) | ES module lazy imports; functions are called at runtime, not import time |
| Missing export in barrel file | Integration test verifies all expected exports exist |
| Broken component after import swap | TypeScript compilation catches missing/renamed exports immediately |
| Test suite regressions | Update all test mocks in same pass; run full suite before marking done |
| Auth credential helpers removed too early | Explicitly preserved in userService.ts with TODO comments for step 3 |

---

## Success Criteria

- [ ] All 10 new service files created in `src/services/supabase/`
- [ ] Barrel file exports all functions with same names as current API
- [ ] All 15 files updated with new import paths
- [ ] No remaining imports from `firebase/firestore` in hooks or service files (except authService.ts)
- [ ] No remaining imports from `./dataClient` or `./userOperations` anywhere
- [ ] `dataClient.ts` and `userOperations.ts` deleted
- [ ] All mapper unit tests pass
- [ ] All service unit tests pass
- [ ] All existing hook/component tests pass (with updated mocks)
- [ ] Build succeeds: `tsc -b && vite build`
- [ ] roleClient.ts works with new imports
- [ ] Auth credential localStorage functions still work
