# Research: restore-users-tab

## Metadata
- **Feature:** restore-users-tab
- **Created:** 2026-02-15T02:55
- **Status:** research-complete
- **Researcher:** research-agent

## Feature Context

The old `UsersPanel.tsx` (636 lines) was a full CRUD admin for system users (managers, admins, contractors). It was deleted in commit `45c2555` when `NewHiresPanel.tsx` replaced the entire Users tab. However, the two views serve different purposes:

- **NewHiresPanel** (249 lines): Read-only view of onboarding instances (employees going through onboarding). Uses `useOnboardingInstances()`.
- **UsersPanel** (old, 636 lines): CRUD management of system user records (create/edit/delete users with roles and profiles). Uses `useUsers()`.

The deletion orphaned `useUsers` (hook) and `userService` (service) -- both still exist in the codebase with no UI consuming them. The restored Users tab should sit alongside New Hires as a 4th tab in ManagerView: Dashboard, Roles, New Hires, Users.

### Dependencies on other features
- None. All prerequisite infrastructure (userService, useUsers hook, UserModal, DeleteConfirmationDialog) is already built and tested.

## Requirements

### Functional Requirements
- [ ] FR1: Add a "Users" tab to ManagerView alongside Dashboard, Roles, New Hires (source: user request)
- [ ] FR2: Users tab renders a new `UsersPanel` component showing all system users in a table (source: user request)
- [ ] FR3: Table columns: Name, Email, Roles, Profiles, Actions (edit/delete) -- NO onboarding status columns (source: user request -- onboarding display now lives in NewHiresPanel)
- [ ] FR4: "New User" button opens UserModal in create mode (source: old UsersPanel behavior)
- [ ] FR5: Edit button opens UserModal in edit mode, pre-filled with user data (source: old UsersPanel behavior)
- [ ] FR6: Delete button opens DeleteConfirmationDialog with appropriate message (source: old UsersPanel behavior)
- [ ] FR7: Activity logging for create/edit/delete operations via `logActivity` (source: old UsersPanel behavior)
- [ ] FR8: Success/error toast messages for CRUD operations (source: old UsersPanel behavior)
- [ ] FR9: Loading state while users are being fetched (source: old UsersPanel behavior)
- [ ] FR10: Empty state when no users exist (source: old UsersPanel behavior)

### Technical Requirements
- [ ] TR1: Component should be significantly leaner than the old 636-line version by removing all onboarding-related code (instancesByEmail, onboarding status columns, filter toggle, useOnboardingInstances dependency)
- [ ] TR2: Use existing `useUsers` hook (126 lines) -- already provides users, isLoading, error, createNewUser, editUser, removeUser, reset
- [ ] TR3: Use existing `UserModal` component (348 lines) -- already supports create and edit modes with validation
- [ ] TR4: Use existing `DeleteConfirmationDialog` component (119 lines) -- already supports loading state and custom messaging
- [ ] TR5: Use existing `useRoles` hook for passing roles to UserModal
- [ ] TR6: Use existing `useAuth` hook for getting current user ID for activity logging
- [ ] TR7: Export `UsersPanel` from manager barrel export (`src/components/manager/index.ts`)
- [ ] TR8: Wire `UsersPanel` into ManagerView tab system with `activeTab` state extended to `'users'`
- [ ] TR9: Follow existing Tailwind CSS patterns (dark mode support, brand colors, responsive tables)
- [ ] TR10: Estimated target: ~250-300 lines (vs old 636), by removing all onboarding-related rendering

### Constraints
- Must not break existing 338 tests
- Must not duplicate functionality in NewHiresPanel (no onboarding status display)
- Must use existing modal/dialog infrastructure -- no new modal components

## Existing Code Analysis

### Project State
- Project exists: YES
- All 338 tests pass
- Relevant infrastructure is fully intact

### Code to Reuse (unchanged)
| File | What to reuse | Lines |
|------|--------------|-------|
| `src/hooks/useUsers.ts` | Full hook: users list, CRUD operations, loading/error state, optimistic updates | 126 |
| `src/services/supabase/userService.ts` | Full service: createUser, updateUser, deleteUser, subscribeToUsers, logActivity | 438 |
| `src/components/modals/UserModal.tsx` | Full modal: create/edit modes, form validation, role/profile selection | 348 |
| `src/components/ui/DeleteConfirmationDialog.tsx` | Full dialog: confirmation with loading state | 119 |
| `src/hooks/useUsers.test.ts` | Full test suite: 10 tests for hook CRUD operations | 293 |
| `src/services/supabase/userService.test.ts` | Full test suite: 6 tests for deleteUser cascade logic | 195 |

### Code to Modify
| File | What needs changing |
|------|-------------------|
| `src/views/ManagerView.tsx` | Add 'users' to activeTab union type, add Users tab button, add UsersPanel render block, import UsersPanel |
| `src/components/manager/index.ts` | Add `export { UsersPanel } from './UsersPanel'` |

### Code to Create
| File | Purpose |
|------|---------|
| `src/components/manager/UsersPanel.tsx` | New leaner Users panel (~250-300 lines) |
| `src/components/manager/UsersPanel.test.tsx` | Unit tests for the new UsersPanel |

### Patterns to Follow
- **Tab pattern in ManagerView**: `activeTab` state with button-based tab bar, conditional rendering via `{activeTab === 'xxx' && (...)}`. Each tab content is wrapped in `<div className="bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 p-6">`.
- **Panel pattern from NewHiresPanel**: Header section with icon + title + subtitle, filter controls, loading/error/empty states, responsive table.
- **CRUD panel pattern from old UsersPanel**: Modal state management (showCreateModal, editingUser, showEditModal, userToDelete), submit handlers with try/catch, activity logging with fire-and-forget pattern.
- **Table styling**: `w-full text-sm`, thead with `bg-slate-50 dark:bg-slate-700`, tbody with `divide-y`, hover rows with `hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors`.

## What to Remove from Old UsersPanel

The following code from the old 636-line UsersPanel should NOT be restored (it now lives in NewHiresPanel or is unnecessary):

1. **`useOnboardingInstances` import and usage** (~5 lines) -- onboarding display is in NewHiresPanel
2. **`instancesByEmail` memo** (~10 lines) -- email-to-instance lookup for onboarding status
3. **Onboarding status columns** (Status, Progress, Start Date) -- ~40 lines per table
4. **Employee vs Admin table split** (~2 separate table renderers, ~200 lines) -- replace with single unified table
5. **Filter toggle** (All Employees / Currently Onboarding) -- ~30 lines -- onboarding filtering is in NewHiresPanel
6. **Status badge helpers** (`getStatusBadgeClasses`, `getStatusLabel`, `formatDate`) -- ~25 lines -- only used for onboarding display
7. **Onboarding-aware delete message** -- simplify to basic confirmation
8. **"Use New Hire" tip card** -- no longer needed since both tabs coexist

### Estimated line savings
- Old: 636 lines
- Removed onboarding code: ~300 lines
- Merged 2 tables into 1: ~50 lines saved
- New estimate: ~250-300 lines

## Risk Assessment

### Technical Risks
| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| UsersPanel imports something that was removed | Low | Low | All dependencies verified as still existing (UserModal, DeleteConfirmationDialog, useUsers, useRoles, useAuth, logActivity) |
| Tab state type not extended cleanly | Low | Low | Simple union type change: add `'users'` to existing type |
| Tests break from ManagerView changes | Low | Low | ManagerView has no dedicated tests; tab rendering is straightforward conditional |

### Complexity
- **Level:** Simple
- **Rationale:** All infrastructure exists. The component is a slimmed-down version of a previously working component with well-established patterns. No new dependencies, no new APIs, no new architectural decisions. The main work is writing a clean, lean component and wiring it into the tab system.

## Open Questions

All questions resolved -- no blockers.

- [x] Q1: Should we split users into Employee vs Admin/Manager tables like the old panel?
  - Resolution: No. The old split was motivated by showing onboarding columns on the employee table. Since onboarding display is now in NewHiresPanel, a single unified table showing all users is simpler and sufficient. Users can be distinguished by their role badges.

- [x] Q2: Should we keep the "Tip" info card about New Hire vs New User distinction?
  - Resolution: Keep a brief version. It was useful UX guidance. Can be a one-liner info banner rather than a card.

- [x] Q3: Should the delete confirmation message mention onboarding data cleanup?
  - Resolution: Yes, but simplified. The `userService.deleteUser()` already handles cascade deletion of onboarding instances. The confirmation message should mention this: "This will also delete any associated onboarding data."

- [x] Q4: Do we need the old filter toggle (All / Currently Onboarding)?
  - Resolution: No. That filter was for onboarding status display, which is now in NewHiresPanel. The Users tab is purely for user CRUD.

## Recommended Approach

### Implementation Strategy

Build a new, lean `UsersPanel.tsx` (~250-300 lines) that reuses all existing infrastructure. Do NOT copy-paste the old 636-line file -- write it fresh following the patterns established in `NewHiresPanel.tsx` (cleaner, more modular) while adding CRUD functionality via modals.

The component structure should be:
1. Hook setup (useUsers, useRoles, useAuth)
2. Modal state management (create, edit, delete)
3. CRUD handlers with activity logging
4. Render: header + info banner + table + modals

### Order of Work
1. Create `src/components/manager/UsersPanel.tsx` -- the main component
2. Export from `src/components/manager/index.ts`
3. Wire into `src/views/ManagerView.tsx` (add tab button + conditional render)
4. Write tests in `src/components/manager/UsersPanel.test.tsx`
5. Run full test suite to verify no regressions

### What to Defer
- Search/filter functionality on the users table (can be added later if needed)
- Pagination for large user lists (not needed for typical onboarding app scale)
- Bulk actions (multi-select delete, etc.)

## Key Files Reference

| File | Path | Role |
|------|------|------|
| UsersPanel (to create) | `src/components/manager/UsersPanel.tsx` | New lean CRUD panel |
| ManagerView | `src/views/ManagerView.tsx` | Tab container, needs Users tab added |
| Manager barrel | `src/components/manager/index.ts` | Needs UsersPanel export |
| useUsers hook | `src/hooks/useUsers.ts` | Provides users + CRUD operations |
| userService | `src/services/supabase/userService.ts` | Backend CRUD + subscriptions |
| UserModal | `src/components/modals/UserModal.tsx` | Create/edit modal |
| DeleteConfirmationDialog | `src/components/ui/DeleteConfirmationDialog.tsx` | Delete confirmation |
| User type | `src/types/index.ts` (lines 83-92) | User interface definition |
| UserFormData type | `src/types/index.ts` (lines 97-102) | Form data interface |
| useUsers tests | `src/hooks/useUsers.test.ts` | 10 existing hook tests |
| userService tests | `src/services/supabase/userService.test.ts` | 6 existing service tests |

## Next Step

Run `/plan restore-users-tab` to create the implementation plan.
