# Plan: restore-users-tab

## Metadata
- **Feature:** restore-users-tab
- **Created:** 2026-02-15T03:00
- **Status:** plan-complete
- **Based On:** 2026-02-15T02:55_research.md

## Architecture Overview

```
ManagerView.tsx (tab container)
  |
  +-- activeTab state: 'dashboard' | 'roles' | 'new-hires' | 'users'
  |
  +-- Tab bar: [Dashboard] [Roles] [New Hires] [Users]  <-- add Users button
  |
  +-- Conditional render blocks:
      |-- activeTab === 'dashboard'  --> KPISection + SuggestionsSection + ActivitySection
      |-- activeTab === 'roles'      --> RoleManagementPanel
      |-- activeTab === 'new-hires'  --> NewHiresPanel
      +-- activeTab === 'users'      --> UsersPanel  <-- NEW
```

### UsersPanel Internal Architecture

```
UsersPanel.tsx (~250-300 lines)
  |
  +-- Hooks:
  |   +-- useUsers()   --> users[], isLoading, error, createNewUser, editUser, removeUser
  |   +-- useRoles()   --> roles[] (passed to UserModal for role selection)
  |   +-- useAuth()    --> user.uid (for activity logging createdBy field)
  |
  +-- Modal State:
  |   +-- showCreateModal: boolean
  |   +-- editingUser: User | null  (non-null = edit modal open)
  |   +-- userToDelete: User | null (non-null = delete dialog open)
  |   +-- isSubmitting: boolean
  |   +-- isDeleting: boolean
  |   +-- modalError: string | null
  |
  +-- CRUD Handlers:
  |   +-- handleCreate(data: UserFormData)  --> createNewUser + logActivity + toast
  |   +-- handleEdit(data: UserFormData)    --> editUser + logActivity + toast
  |   +-- handleDelete()                    --> removeUser + logActivity + toast
  |
  +-- Render:
      +-- Header (icon + title + subtitle + "New User" button)
      +-- Info banner (one-liner: "New User = system account; New Hire = onboarding")
      +-- Toast message area (success/error)
      +-- Loading state
      +-- Error state
      +-- Empty state
      +-- Users table (Name, Email, Roles, Profiles, Actions)
      +-- UserModal (create/edit, reused from modals/)
      +-- DeleteConfirmationDialog (reused from ui/)
```

### Data Flow

```
Supabase 'users' table
    |
    v
userService.ts (subscribeToUsers, createUser, updateUser, deleteUser)
    |
    v
useUsers.ts hook (real-time subscription, optimistic updates)
    |
    v
UsersPanel.tsx (renders table, opens modals)
    |
    +-- UserModal.tsx (form for create/edit)
    +-- DeleteConfirmationDialog.tsx (confirmation for delete)
    |
    v
activityService.ts (logActivity -- fire-and-forget)
```

## Tech Stack Summary

| Layer | Technology | Notes |
|-------|-----------|-------|
| Component | React 18 + TypeScript | Functional component with hooks |
| Styling | Tailwind CSS 3 | Dark mode via `dark:` prefix, brand colors |
| Data | useUsers hook | Real-time Supabase subscription |
| Modals | UserModal, DeleteConfirmationDialog | Existing components, no changes needed |
| Icons | Lucide React | UserCog or Users icon for header |
| Testing | Vitest + React Testing Library | Mock hooks, test render + interactions |

## File Structure

### New Files

| File | Purpose | Est. Lines |
|------|---------|-----------|
| `src/components/manager/UsersPanel.tsx` | Main Users panel component with CRUD table | ~250-300 |
| `src/components/manager/UsersPanel.test.tsx` | Unit tests for UsersPanel | ~250-300 |

### Modified Files

| File | Change | Lines Affected |
|------|--------|---------------|
| `src/views/ManagerView.tsx` | (1) Add `'users'` to activeTab union type (line 68), (2) import UsersPanel (line 18), (3) add Users tab button after New Hires button (after line 151), (4) add Users tab content block after New Hires block (after line 205) | ~20 lines added |
| `src/components/manager/index.ts` | Add `export { UsersPanel } from './UsersPanel'` at end of file | 1 line added |

### Unchanged Files (reused as-is)

| File | Role |
|------|------|
| `src/hooks/useUsers.ts` | Provides users[], CRUD operations, loading/error state |
| `src/services/supabase/userService.ts` | Backend CRUD + real-time subscriptions |
| `src/components/modals/UserModal.tsx` | Create/edit user modal with validation |
| `src/components/ui/DeleteConfirmationDialog.tsx` | Delete confirmation dialog |
| `src/services/supabase/activityService.ts` | logActivity for audit trail |
| `src/config/authContext.tsx` | useAuth for current user ID |
| `src/hooks/useRoles.ts` | Provides roles[] for UserModal |

## Component Architecture

### UsersPanel State Management

```
State Variables:
  showCreateModal:  boolean     -- controls UserModal visibility (create mode)
  editingUser:      User | null -- non-null opens UserModal in edit mode
  userToDelete:     User | null -- non-null opens DeleteConfirmationDialog
  isSubmitting:     boolean     -- disables modal buttons during create/edit
  isDeleting:       boolean     -- disables dialog buttons during delete
  modalError:       string|null -- shows error in modal
  successMessage:   string|null -- shows toast after successful operation
```

### CRUD Handler Patterns

Following the pattern established in `RoleManagementPanel.tsx`:

```typescript
// Create handler pattern:
async function handleCreateSubmit(data: UserFormData) {
  setModalError(null);
  setIsSubmitting(true);
  try {
    await createNewUser(data, currentUserId);
    // Fire-and-forget activity log
    logActivity({ ... }).catch(() => {});
    setSuccessMessage('User created successfully');
    setShowCreateModal(false);
    setTimeout(() => setSuccessMessage(null), 3000);
  } catch (err) {
    setModalError(err instanceof Error ? err.message : 'Failed to create user');
  } finally {
    setIsSubmitting(false);
  }
}
```

### Table Columns

| Column | Source | Rendering |
|--------|--------|----------|
| Name | `user.name` | Bold text, `font-medium text-slate-900 dark:text-slate-50` |
| Email | `user.email` | Mono text, `text-xs font-mono text-slate-600 dark:text-slate-300` |
| Roles | `user.roles` | Comma-joined badges, brand color pills |
| Profiles | `user.profiles` | Comma-joined badges or dash if empty |
| Actions | - | Edit (pencil icon) + Delete (trash icon) buttons |

## Testing Strategy

### Unit Tests (UsersPanel.test.tsx) -- ~12 tests

**Rendering (4 tests):**
1. Renders table with user data (names, emails visible)
2. Renders column headers (Name, Email, Roles, Profiles, Actions)
3. Renders role badges for each user
4. Renders "New User" button in header

**States (3 tests):**
5. Shows loading spinner when isLoading is true
6. Shows error message when error is present
7. Shows empty state when no users exist

**CRUD Interactions (5 tests):**
8. Clicking "New User" opens UserModal in create mode
9. Clicking edit button opens UserModal in edit mode with user data
10. Clicking delete button opens DeleteConfirmationDialog
11. Confirming delete calls removeUser with correct user ID
12. Shows success toast after successful operation

### Mock Strategy

Follow the pattern from `NewHiresPanel.test.tsx` and `RoleManagementPanel.test.tsx`:
- Mock `useUsers` hook via `vi.mock('../../hooks/useUsers')`
- Mock `useRoles` hook via `vi.mock('../../hooks/useRoles')`
- Mock `useAuth` via `vi.mock('../../config/authContext')`
- Mock `logActivity` via `vi.mock('../../services/supabase')`
- Mock `UserModal` and `DeleteConfirmationDialog` as simple stubs that expose `onSubmit`/`onConfirm` callbacks

### Existing Tests (no changes needed)

| File | Tests | Coverage |
|------|-------|---------|
| `src/hooks/useUsers.test.ts` | 10 tests | Hook CRUD operations |
| `src/services/supabase/userService.test.ts` | 6 tests | Delete cascade logic |

### Test Count Impact

- Current: 338 tests
- New: ~12 tests in UsersPanel.test.tsx
- Expected total: ~350 tests

## Implementation Notes

### Design Decisions

1. **Single unified table** -- The old UsersPanel split users into "Employees" and "Admins/Managers" tables. This was driven by onboarding status columns on the employee table. Since onboarding display now lives in NewHiresPanel, a single table for all users is simpler and sufficient. Role badges distinguish user types visually.

2. **No search/filter** -- The old panel had a filter toggle (All Employees / Currently Onboarding) which was onboarding-specific. For a pure CRUD panel, search can be deferred. The user list is expected to be small (< 50 users for a typical onboarding app).

3. **Fire-and-forget activity logging** -- Following the pattern from `responsive-ux` feature: `logActivity({...}).catch(() => {})`. Activity logging failures must not block or fail the CRUD operation.

4. **Info banner vs tip card** -- Research resolved Q2: keep a brief info banner (not a full card) explaining "New User creates a system account; to start an onboarding journey, use New Hire on the Dashboard tab." This prevents user confusion between the two tabs.

5. **Delete message mentions cascade** -- Research resolved Q3: the confirmation message should say "This will also delete any associated onboarding data" since `userService.deleteUser()` cascades to onboarding instances.

### Patterns to Follow

- **Tab button pattern** from ManagerView lines 115-152: `onClick`, `className` with active/inactive ternary, `aria-label`, `aria-current`
- **Tab content wrapper** from ManagerView lines 194-205: `<div className="bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 p-6">`
- **Panel header pattern** from NewHiresPanel lines 94-105: icon in colored box + h2 title + p subtitle
- **Table styling** from NewHiresPanel lines 167-246: overflow-x-auto wrapper, w-full text-sm, bg-slate-50 thead, divide-y tbody, hover:bg-slate-50 rows
- **CRUD state management** from RoleManagementPanel lines 40-57: separate boolean states for each operation's loading, shared modalError
- **Import pattern**: Import `useUsers` from `../../hooks`, `useAuth` from `../../config/authContext`, `logActivity` from `../../services/supabase`

### Trade-offs

| Decision | Benefit | Cost |
|----------|---------|------|
| No search/filter | Simpler component, fewer lines | Must add later if user list grows |
| No pagination | Simpler, matches other panels | May need for very large user bases |
| Single table (not split) | Cleaner, less code, less confusing | Loses at-a-glance employee vs admin grouping |
| Mock modals in tests | Faster tests, less fragile | Less integration coverage of modal interactions |

## Non-Goals

- **Search/filter on users table** -- can be added in a future iteration
- **Pagination** -- not needed at current scale
- **Bulk actions** (multi-select delete) -- out of scope
- **Inline editing** -- use modal-based editing like existing patterns
- **User import/export** -- not a current requirement
- **Onboarding status display** -- that is NewHiresPanel's responsibility
- **Changes to UserModal or DeleteConfirmationDialog** -- reuse as-is
