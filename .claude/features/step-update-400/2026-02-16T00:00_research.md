# Research: step-update-400

## Metadata
- **Feature:** step-update-400
- **Created:** 2026-02-16T00:00
- **Status:** research-complete
- **Researcher:** research-agent

## Feature Context
- **Description:** P0 CRITICAL bug -- Employee "Mark as Done" fails with HTTP 400 on PATCH to Supabase. Step changes never persist to the database. The optimistic UI briefly shows the step as completed, then a toast error appears and the UI reverts.
- **Where it fits:** This bug blocks the core employee onboarding workflow. Without it, employees cannot complete any onboarding steps.
- **Dependencies:** None -- this is a standalone bugfix on the existing database schema and service layer.

## Root Cause (CONFIRMED via live reproduction)

### The Bug in One Sentence
The `onboarding_instances` table has a BEFORE UPDATE trigger (`update_updated_at`) that sets `NEW.updated_at = now()`, but the table has **no `updated_at` column**, causing PostgreSQL error 42703 on every UPDATE to that table.

### Detailed Trace

**Code path when employee clicks "Mark as Done":**

1. `ActionBar.tsx` calls `onStatusChange(step.id, 'completed')`
2. `OnboardingHub.tsx` `handleStatusChange()` calls `updateStatus(id, newStatus)` (from `useSteps` hook)
3. `useSteps.ts` calls `store._updateStepStatus(instanceId, stepId, status)`
4. `useOnboardingStore.ts` `_updateStepStatus` does optimistic update, then calls `updateStepStatus(instanceId, stepId, status)` from `instanceService.ts`
5. `instanceService.ts` `updateStepStatus()` executes 3 queries:
   - **Step 1:** `PATCH instance_steps SET status WHERE instance_id AND position` -- **SUCCEEDS (200)**
   - **Step 2:** `SELECT status FROM instance_steps WHERE instance_id` -- **SUCCEEDS (200)**
   - **Step 3:** `PATCH onboarding_instances SET progress, status, completed_at WHERE id` -- **FAILS (400)**

**The exact error returned by Supabase/PostgREST:**
```json
{
  "code": "42703",
  "details": null,
  "hint": null,
  "message": "record \"new\" has no field \"updated_at\""
}
```

PostgreSQL error 42703 = `undefined_column`. The BEFORE UPDATE trigger `update_updated_at()` fires on every UPDATE to `onboarding_instances` and attempts `NEW.updated_at = now()`, but the column does not exist in the table schema.

### Schema Evidence

**`onboarding_instances` table (from `00001_create_core_tables.sql` lines 78-91):**
```sql
CREATE TABLE IF NOT EXISTS onboarding_instances (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  employee_name TEXT NOT NULL,
  employee_email TEXT NOT NULL,
  role TEXT NOT NULL,
  department TEXT NOT NULL,
  template_id UUID REFERENCES templates(id) ON DELETE SET NULL,
  progress INTEGER NOT NULL DEFAULT 0 CHECK (progress >= 0 AND progress <= 100),
  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'completed', 'on_hold')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  start_date TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  template_snapshots JSONB
);
```
**No `updated_at` column.**

**Trigger (from `00006_create_triggers.sql` lines 37-39):**
```sql
CREATE TRIGGER onboarding_instances_updated_at
  BEFORE UPDATE ON onboarding_instances
  FOR EACH ROW EXECUTE FUNCTION update_updated_at();
```

**Trigger function (lines 11-17):**
```sql
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

The migration comment at line 5-6 says "attaches to the 5 tables that have an updated_at column" and lists `onboarding_instances` -- but this table was never given an `updated_at` column in the CREATE TABLE statement.

### Consequence
- The step status update (Step 1) succeeds -- the `instance_steps` row IS updated in the database
- But the progress recalculation (Step 3) fails -- the `onboarding_instances` row is NOT updated
- The `updateStepStatus` function throws an error, which causes the Zustand store to roll back the optimistic update
- The user sees a brief flash of "Completed" then it reverts to the previous state with an error toast

### Secondary Effect
The `updateOnboardingInstance` function (lines 134-197) also PATCHes the `onboarding_instances` table, meaning ANY update to an instance (not just step status changes) would also fail with the same 400 error.

## Requirements

### Functional Requirements
- [ ] FR1: Employee clicking "Mark as Done" must persist the step status change to the database
- [ ] FR2: After marking a step as done, the parent instance's `progress` field must be recalculated
- [ ] FR3: When all steps are completed, instance status must change to 'completed' with `completed_at` timestamp
- [ ] FR4: When steps are uncompleted, instance status must revert to 'active' with `completed_at` cleared
- [ ] FR5: Optimistic UI update should remain (not roll back) on success

### Technical Requirements
- [ ] TR1: Add `updated_at TIMESTAMPTZ DEFAULT now()` column to `onboarding_instances` table (Supabase migration)
- [ ] TR2: Update `database.types.ts` to include `updated_at` in the `onboarding_instances` Row/Insert/Update types
- [ ] TR3: Update `mappers.ts` `toInstance()` if the new column should be exposed to the app layer
- [ ] TR4: Verify `updateOnboardingInstance()` also works after the fix (same trigger issue)
- [ ] TR5: Existing tests must continue to pass

### Code Examples / References

**File that needs a new SQL migration:**
- `supabase/migrations/` -- new migration to ALTER TABLE

**Files that need type updates:**
- `src/types/database.types.ts` -- add `updated_at` to `onboarding_instances` Row/Insert/Update

**Files that MAY need mapper updates:**
- `src/services/supabase/mappers.ts` -- `toInstance()` could optionally map `updated_at`

### Warnings/Critical Notes
> The fix requires a database schema change (ALTER TABLE). This must be applied to the live Supabase instance. A new migration file should be created.
> The trigger already exists in production, so the column must be added (not the trigger removed), to maintain consistency with other tables.

## Existing Code Analysis

### Project State
- Project exists: YES
- Relevant existing files: see below

### Code to Reuse
- `supabase/migrations/` pattern for creating new migrations
- `src/types/database.types.ts` pattern for adding columns

### Code to Modify
- **New file:** `supabase/migrations/00008_add_updated_at_to_instances.sql` -- ALTER TABLE to add column
- **Modify:** `src/types/database.types.ts` -- add `updated_at` to `onboarding_instances` types
- **Optionally modify:** `src/services/supabase/mappers.ts` -- add `updatedAt` to `OnboardingInstance` if desired
- **Optionally modify:** `src/types/index.ts` -- add `updatedAt` to `OnboardingInstance` interface if desired

### Patterns to Follow
- Migration numbering: next is `00008_*` (00007 is the last existing migration)
- Column defaults: use `DEFAULT now()` like `users.updated_at` and `roles.updated_at`
- Use `NOT NULL` since existing rows need a value -- set DEFAULT for the ALTER

## Constraints

### Performance
- No performance impact -- adding a column with a default is a metadata-only change in PostgreSQL 11+

### Platform
- Requires applying migration to the live Supabase project at `ecnshfhpgwjxvuybewth.supabase.co`
- Can be done via Supabase Dashboard SQL editor or `supabase db push`

### Dependencies
- No code dependencies -- this is a schema-only fix
- The TypeScript type update is for consistency but isn't strictly required for the fix to work (the Supabase client uses generic types for the PATCH payload in `updateStepStatus`)

## Risk Assessment

### Technical Risks
| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Migration fails on live DB | High | Low | Test SQL in Supabase SQL editor first |
| Existing rows lack `updated_at` value | Low | N/A | DEFAULT now() handles this at ALTER time |
| Type mismatch after adding column | Low | Low | Update database.types.ts to match |

### Complexity
- **Level:** Simple
- **Rationale:** Single ALTER TABLE + type update. No logic changes needed. The code is already correct -- it's the schema that's missing a column.

## Open Questions

All questions resolved during research:

- [x] Q1: Is the 400 from the step update or the instance progress update?
  - Resolution: The instance progress update (Step 3 of `updateStepStatus`). The step update succeeds.

- [x] Q2: Is this an RLS policy issue?
  - Resolution: No. RLS policies are permissive (`USING (true) WITH CHECK (true)`). The error is a trigger referencing a non-existent column.

- [x] Q3: Is this a column name mismatch (camelCase vs snake_case)?
  - Resolution: No. The column names in the PATCH payload are correct snake_case. The issue is a missing column entirely.

- [x] Q4: Does the same issue affect `updateOnboardingInstance()`?
  - Resolution: Yes. Any UPDATE to `onboarding_instances` will fail with the same error because the trigger fires on all UPDATEs.

## Recommended Approach

### Implementation Strategy

**Two-part fix:**

1. **Database migration** -- Add `updated_at` column to `onboarding_instances`:
   ```sql
   ALTER TABLE onboarding_instances
     ADD COLUMN updated_at TIMESTAMPTZ NOT NULL DEFAULT now();
   ```

2. **TypeScript types** -- Update `database.types.ts` to include `updated_at` in the `onboarding_instances` Row/Insert/Update types.

**Optionally** (recommended for consistency):
3. Add `updatedAt` to the `OnboardingInstance` interface in `src/types/index.ts`
4. Map `updated_at` in `toInstance()` in `src/services/supabase/mappers.ts`

### Order of Work
1. Create new migration file `supabase/migrations/00008_add_updated_at_to_instances.sql`
2. Apply migration to live Supabase (via SQL editor or CLI)
3. Update `src/types/database.types.ts`
4. Optionally update `src/types/index.ts` and `src/services/supabase/mappers.ts`
5. Verify fix by clicking "Mark as Done" in the employee view

### What to Defer
- Adding `updated_at` to the app-level `OnboardingInstance` type can be done now or during a later cleanup pass. It's not needed for the fix since the trigger handles it server-side.

## Key Files

| File | Path | Role |
|------|------|------|
| Core tables migration | `/home/sanjay/Workspace/onboarding/supabase/migrations/00001_create_core_tables.sql` | Defines `onboarding_instances` WITHOUT `updated_at` |
| Triggers migration | `/home/sanjay/Workspace/onboarding/supabase/migrations/00006_create_triggers.sql` | Attaches `update_updated_at` trigger to `onboarding_instances` |
| Instance service | `/home/sanjay/Workspace/onboarding/src/services/supabase/instanceService.ts` | `updateStepStatus()` at line 204 -- the function that fails at Step 3 |
| Database types | `/home/sanjay/Workspace/onboarding/src/types/database.types.ts` | TypeScript types for `onboarding_instances` (missing `updated_at`) |
| App types | `/home/sanjay/Workspace/onboarding/src/types/index.ts` | `OnboardingInstance` interface (no `updatedAt` field) |
| Mappers | `/home/sanjay/Workspace/onboarding/src/services/supabase/mappers.ts` | `toInstance()` mapper (does not map `updated_at`) |
| Zustand store | `/home/sanjay/Workspace/onboarding/src/store/useOnboardingStore.ts` | `_updateStepStatus` action -- calls `updateStepStatus` and rolls back on error |
| OnboardingHub | `/home/sanjay/Workspace/onboarding/src/components/OnboardingHub.tsx` | `handleStatusChange` at line 74 -- entry point for step status changes |

## Next Step

**All questions resolved. Status: research-complete.**

Run `/plan step-update-400` to create implementation plan.
