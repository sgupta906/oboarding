# Plan: step-update-400

## Metadata
- **Feature:** step-update-400
- **Created:** 2026-02-16T00:01
- **Status:** plan-complete
- **Based on:** 2026-02-16T00:00_research.md
- **Complexity:** Simple (schema fix + type update)

## Problem Summary

The `onboarding_instances` table has a `BEFORE UPDATE` trigger (`update_updated_at`) that sets `NEW.updated_at = now()`, but the table has no `updated_at` column. Every UPDATE to `onboarding_instances` fails with PostgreSQL error 42703 (`undefined_column`). This blocks:
- Employee "Mark as Done" (step status persistence)
- Instance progress recalculation
- Any instance field update via `updateOnboardingInstance()`

## Architecture Overview

No architectural changes. This is a schema-only fix with corresponding type updates.

```
Fix Flow:

  Migration (SQL)           TypeScript Types           Mapper
  +-----------------+      +------------------+      +------------------+
  | ALTER TABLE      | ---> | database.types   | ---> | mappers.ts       |
  | onboarding_      |      | .ts: add         |      | toInstance():    |
  | instances ADD    |      | updated_at to    |      | add updatedAt    |
  | COLUMN           |      | Row/Insert/      |      | mapping          |
  | updated_at       |      | Update           |      |                  |
  +-----------------+      +------------------+      +------------------+
                                                       |
                                                       v
                                                     +------------------+
                                                     | types/index.ts   |
                                                     | OnboardingInstance|
                                                     | add updatedAt?   |
                                                     +------------------+
```

## Tech Stack (no changes)
- PostgreSQL via Supabase
- TypeScript types in `src/types/database.types.ts`
- Mappers in `src/services/supabase/mappers.ts`

## File Structure

### New Files
| File | Purpose |
|------|---------|
| `supabase/migrations/00008_add_updated_at_to_instances.sql` | ALTER TABLE to add missing `updated_at` column |

### Modified Files
| File | Change |
|------|--------|
| `src/types/database.types.ts` (lines 193-237) | Add `updated_at` to `onboarding_instances` Row/Insert/Update types |
| `src/types/index.ts` (line 271, after `completedAt`) | Add optional `updatedAt?: number` to `OnboardingInstance` interface |
| `src/services/supabase/mappers.ts` (line 165, in `toInstance()`) | Map `row.updated_at` to `updatedAt` |
| `src/services/supabase/mappers.test.ts` (lines 146-176) | Add `updated_at` to test fixture row, assert `updatedAt` in output |

## Data Model Change

### `onboarding_instances` table -- ADD COLUMN

```sql
ALTER TABLE onboarding_instances
  ADD COLUMN updated_at TIMESTAMPTZ NOT NULL DEFAULT now();

-- Backfill: use completed_at if available, otherwise created_at
UPDATE onboarding_instances
  SET updated_at = COALESCE(completed_at, created_at, now());
```

**Why NOT NULL DEFAULT now():** Matches the pattern used by `users.updated_at` and `roles.updated_at`. The trigger already sets this on every UPDATE, so it will always have a value going forward. The backfill ensures existing rows get a sensible initial value.

**PostgreSQL 11+ note:** `ADD COLUMN ... DEFAULT` is a metadata-only operation (no table rewrite), so this is safe even on large tables.

## Testing Strategy

### Unit Tests (1 update)
- Update `mappers.test.ts` `toInstance` test: add `updated_at` to the fixture row, assert `updatedAt` is mapped correctly

### Integration / E2E Verification
- After applying migration: click "Mark as Done" in employee view, confirm no 400 error
- Verify instance progress updates after step completion
- Verify `updateOnboardingInstance()` works (any instance update)

## Implementation Notes

### Decisions
1. **Add column, not remove trigger:** The trigger is shared infrastructure (`update_updated_at()` function) used by 5 tables. Removing it from `onboarding_instances` would be inconsistent. Adding the missing column is the correct fix.
2. **Include updatedAt in app types:** For consistency with other entities (Template, CustomRole, User all expose `updatedAt`). It is optional since older code paths do not use it.
3. **Backfill strategy:** Use `COALESCE(completed_at, created_at, now())` -- completed instances get their completion timestamp, active instances get their creation timestamp.

### Patterns to Follow
- Migration naming: `00008_*` (next sequential number)
- Column default: `DEFAULT now()` (matches users, roles)
- Type pattern: `updated_at: string` in Row, `updated_at?: string` in Insert/Update
- Mapper pattern: `updatedAt: toOptionalUnixMs(row.updated_at)` (matches toTemplate pattern)

## Non-Goals
- No changes to the trigger function itself
- No changes to `instanceService.ts` (the service code is already correct)
- No changes to the Zustand store or UI components
- No new test files (only updating existing test)
