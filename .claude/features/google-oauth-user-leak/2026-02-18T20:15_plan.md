# Plan: google-oauth-user-leak

## Metadata
- **Feature:** google-oauth-user-leak
- **Created:** 2026-02-18T20:15
- **Status:** plan-complete
- **Based On:** 2026-02-18T20:00_research.md

## Problem Statement

When signing in with Google OAuth, a new user is created in the `users` table with `roles: []`. The `UsersPanel` component renders ALL users from the Zustand store without filtering, so this roleless Google OAuth user appears in the Users tab. It should only appear in the Unassigned Users section on the New Hires tab.

## Architecture Overview

```
                        Zustand users slice
                        (ALL users from DB)
                              |
              +---------------+---------------+
              |                               |
        UsersPanel.tsx              UnassignedUsersSection.tsx
        (Users tab)                 (New Hires tab)
              |                               |
        BUG: No filter              OK: filters roles.length === 0
        Shows ALL users             Shows only roleless users
              |
        FIX: Add useMemo filter
        u.roles.length > 0
```

**What changes:** `UsersPanel.tsx` gets a `useMemo` filter to exclude users with zero roles.
**What stays the same:** The Zustand store, `useUsers` hook, `UnassignedUsersSection`, and all other components remain untouched.

## Tech Stack (No Changes)

- React 18 + TypeScript
- Zustand (users slice)
- Vitest + React Testing Library

## File Structure

### Files to Modify

| File | Change | Lines Affected |
|------|--------|----------------|
| `src/components/manager/UsersPanel.tsx` | Add `useMemo` import, rename `users` to `allUsers`, add filtered `users` memo | Lines 1 (import), 25 (destructure), +3 new lines |
| `src/components/manager/UsersPanel.test.tsx` | Add regression test and mock data for roleless user | +20 lines at end of file |

### No New Files

This is a 2-file change. No new components, hooks, services, or migrations.

## Specific Code Changes

### 1. UsersPanel.tsx

**Change the import on line 9:**
```typescript
// Before:
import { useState } from 'react';

// After:
import { useState, useMemo } from 'react';
```

**Change the hook destructure on line 25 and add filter:**
```typescript
// Before:
const { users, isLoading, error, createNewUser, editUser, removeUser, reset } = useUsers();

// After:
const { users: allUsers, isLoading, error, createNewUser, editUser, removeUser, reset } = useUsers();

// Filter out unassigned users (Google OAuth sign-ins with no roles).
// These users appear in the Unassigned Users section on the New Hires tab.
const users = useMemo(
  () => allUsers.filter((u) => u.roles.length > 0),
  [allUsers],
);
```

The rest of the component continues to reference `users` unchanged, so no further edits are needed in the JSX.

### 2. UsersPanel.test.tsx

Add a regression test in the `Rendering` describe block that:
1. Adds a roleless user to the mock data (simulating a Google OAuth sign-in)
2. Renders `UsersPanel`
3. Asserts the roleless user's name/email is NOT in the document
4. Asserts the existing users with roles ARE still rendered

## Data Model Changes

None. The fix is purely in the presentation layer.

## Component Architecture

No new components. The existing `UsersPanel` component gains a `useMemo` derived value.

```
UsersPanel (modified)
  |-- uses: useUsers()  (unchanged)
  |-- adds: useMemo filter for roles.length > 0
  |-- renders: only users with at least one role (unchanged JSX)
```

## Testing Strategy

### Unit Tests (1 new test)

| Test | Description | File |
|------|-------------|------|
| Regression: excludes roleless users | Verify that a user with `roles: []` does not appear in the Users table | `UsersPanel.test.tsx` |

### Existing Tests (must pass)

All 669 existing tests must continue to pass. The `users` variable name is preserved in the component's JSX, so all existing test assertions remain valid. The mock `useUsers` hook returns users with roles in all existing tests, so no existing test behavior changes.

### No Integration or E2E Tests Needed

This is a presentation-layer filter. The Zustand store, services, and data layer are unchanged. No cross-component interactions are affected.

## Implementation Notes

### Decision: Option A (filter roleless only)

Per the research document, we go with `u.roles.length > 0` (Option A) rather than also filtering out employee-only users. This is the minimal fix for the reported bug. Option B (also hiding employees) can be a follow-up if desired.

### Pattern Consistency

The filter pattern mirrors `UnassignedUsersSection.tsx:33-34` which uses `useMemo` with `u.roles.length === 0`. This is the inverse filter, maintaining codebase consistency.

### Risk: Empty State

If ALL users happen to be roleless (edge case), the Users tab will show the "No users" empty state. This is correct behavior -- there are no system users to manage.

## Non-Goals

- Filtering at the store/subscription level (would break UnassignedUsersSection)
- Hiding employee-role users from Users tab (Option B -- can be a follow-up)
- Modifying the `useUsers` hook or Zustand users slice
- Adding any database migrations
- Modifying the auth flow or `ensureUserExists()`
