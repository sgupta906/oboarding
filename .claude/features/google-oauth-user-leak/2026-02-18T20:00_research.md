# Research: google-oauth-user-leak

## Metadata
- **Feature:** google-oauth-user-leak
- **Created:** 2026-02-18T20:00
- **Status:** research-complete
- **Researcher:** research-agent

## Bug Description

When signing in with Google OAuth using a new email, the user appears in BOTH:
1. The **New Hires tab** > Unassigned Users section (correct)
2. The **Users tab** > Users table (incorrect -- should NOT appear here)

The Users tab should only show manually-created users managed by managers. Google OAuth sign-ins should only appear in the Unassigned Users section until they are assigned a role and template.

## Root Cause Analysis

### Data Flow Walkthrough

**Step 1: Google OAuth sign-in triggers `ensureUserExists()`**

File: `src/config/authContext.tsx:190-201`

When a new Google OAuth user signs in and has no role yet (`userRole` is null), the `onAuthStateChange` handler calls:

```typescript
await ensureUserExists(
  session.user.id,
  session.user.email,
  session.user.user_metadata?.full_name,
);
```

**Step 2: `ensureUserExists()` upserts into the `users` table**

File: `src/services/authService.ts:135-151`

```typescript
export async function ensureUserExists(uid, email, displayName) {
  const name = displayName || email.split('@')[0];
  const { error } = await supabase.from('users').upsert({
    id: uid,
    email,
    name,
    updated_at: new Date().toISOString(),
  });
  // ...
}
```

This creates a row in the `users` table. Crucially, it does NOT create any `user_roles` rows, so the user has `roles: []`.

**Step 3: Both UsersPanel and UnassignedUsersSection read from the SAME data source**

The Zustand users slice (`src/store/slices/usersSlice.ts:49`) subscribes to the `users` table via `subscribeToUsers()`, which calls `crudFactory.subscribe()`. The subscription query is:

```
SELECT *, user_roles(*), user_profiles(*) FROM users LIMIT 200
```

This fetches ALL users from the `users` table, regardless of whether they have roles or not.

**Step 4: UsersPanel displays ALL users without filtering**

File: `src/components/manager/UsersPanel.tsx:215`

```tsx
{users.map((u) => ( ... ))}
```

There is NO filter on `UsersPanel`. It renders every user from the store, including Google OAuth users with `roles: []`.

**Step 5: UnassignedUsersSection filters for roleless users**

File: `src/components/manager/UnassignedUsersSection.tsx:33-34`

```typescript
const unassignedUsers = useMemo(
  () => users.filter((u) => u.roles.length === 0),
  [users],
);
```

This correctly filters for users with no roles.

**Result:** A Google OAuth user with no roles appears in:
- UnassignedUsersSection (via `roles.length === 0` filter) -- CORRECT
- UsersPanel (no filter, shows all users) -- BUG

### Root Cause

`UsersPanel` has no filter to exclude unassigned (roleless) users. It was designed for manually-created users who always have at least one role assigned at creation time (see `UserModal` which requires a role selection). Google OAuth users are a new user category that enter the `users` table without any role, which was not accounted for in the `UsersPanel` design.

## Requirements

### Functional Requirements
- [ ] FR1: Google OAuth users with no roles MUST NOT appear in the Users tab table
- [ ] FR2: Google OAuth users with no roles MUST appear in the Unassigned Users section (New Hires tab) -- already works
- [ ] FR3: After a Google OAuth user is assigned a role (becoming 'employee'), they MUST NOT appear in the Users tab -- they are hires, not system users
- [ ] FR4: Users manually created via the Users tab (who always have roles) MUST continue to appear in the Users tab

### Technical Requirements
- [ ] TR1: The fix must not break the existing `useUsers` hook or Zustand users slice -- both are consumed by multiple components
- [ ] TR2: The fix should be in the presentation layer (UsersPanel), not in the data layer (store/subscription)
- [ ] TR3: All existing tests must continue to pass (669 tests)

### Constraints
- The Zustand users slice is shared between `UsersPanel` and `NewHiresPanel` (which hosts `UnassignedUsersSection`). Both need access to the full user list from the store.
- Filtering at the store/subscription level would break `UnassignedUsersSection` which needs to see roleless users.

## Recommended Fix

### Approach: Filter in UsersPanel

Add a filter in `UsersPanel` to exclude users with zero roles. This is the simplest and safest approach:

**File: `src/components/manager/UsersPanel.tsx`**

Change line 25 from:
```typescript
const { users, isLoading, error, createNewUser, editUser, removeUser, reset } = useUsers();
```

To add a filtered users list:
```typescript
const { users: allUsers, isLoading, error, createNewUser, editUser, removeUser, reset } = useUsers();

// Filter out unassigned users (Google OAuth sign-ins with no roles).
// These users are managed via the Unassigned Users section in New Hires tab.
const users = useMemo(
  () => allUsers.filter((u) => u.roles.length > 0),
  [allUsers],
);
```

This ensures:
- Google OAuth users with `roles: []` are excluded from the Users tab
- They remain visible in UnassignedUsersSection (which does its own filter)
- After role assignment (where they get `roles: ['employee']`), they would technically appear in UsersPanel -- BUT this is also undesirable (FR3), since assigned hires should appear in the New Hires table, not the Users table
- If the business rule is "Users tab = non-employee system accounts", the filter should be `u.roles.length > 0 && !u.roles.includes('employee')` or simply `u.roles.some(r => r !== 'employee')`

### Decision Point: Should employees appear in Users tab?

**Option A: Filter out roleless users only** -- `u.roles.length > 0`
- Simplest change (1 line)
- Assigned employees (role='employee') still appear in Users tab
- May be desired so managers can edit/delete employee user accounts

**Option B: Filter out roleless AND employee-only users** -- `u.roles.some(r => r !== 'employee')`
- Users tab only shows managers/admins/contractors
- Employee-only users are managed via New Hires tab
- Cleaner separation: "Users tab = system accounts, New Hires tab = employees"

**Recommendation: Option A** is the minimal fix for the reported bug. If the user wants Option B as well, it can be layered on.

## Files to Modify

| File | Change | Lines |
|------|--------|-------|
| `src/components/manager/UsersPanel.tsx` | Add `useMemo` import + filter users to exclude `roles.length === 0` | ~3 lines changed |
| `src/components/manager/UsersPanel.test.tsx` | Add test verifying unassigned users are excluded | ~15 lines added |

## Existing Code Analysis

### Project State
- Project exists: YES
- Relevant existing files identified and analyzed

### Code to Reuse
- `useMemo` already imported in other components for filtering (e.g., `UnassignedUsersSection.tsx:33`)
- Filter pattern `u.roles.length === 0` already established in `UnassignedUsersSection`

### Code to Modify
- `src/components/manager/UsersPanel.tsx:25` -- add filter
- `src/components/manager/UsersPanel.test.tsx` -- add regression test

### Patterns to Follow
- `useMemo` for derived/filtered data (used consistently across the codebase)
- Test pattern from existing UsersPanel tests

## Risk Assessment

### Technical Risks
| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Filter hides legitimate users | Medium | Low | Only filters `roles.length === 0`, which should never apply to manually-created users since UserModal requires a role |
| Breaking existing tests | Low | Low | Only adding a filter + new test, not changing data flow |
| Affecting assign-role flow | Low | Very Low | Assign flow in NewHiresPanel reads from `useUsers()` directly, not from UsersPanel's filtered list |

### Complexity
- **Level:** Simple
- **Rationale:** Single-line filter addition in one component, plus a regression test. No architectural changes, no data model changes, no store modifications.

## Open Questions

- [x] Q1: Should the Users tab also exclude users with only the 'employee' role?
  - Recommendation: Start with Option A (exclude roleless only) as the minimal fix. Option B can be a follow-up.
  - Status: RESOLVED (go with Option A, user can request Option B)

- [x] Q2: Could filtering at the store level be better?
  - Resolution: No. Both `UsersPanel` and `UnassignedUsersSection` consume the same store. `UnassignedUsersSection` needs roleless users. Filtering must be in the presentation layer.

## Next Step

**All questions resolved.**
Run `/plan google-oauth-user-leak` to create implementation plan.
