# Plan: template-step-insert

## Metadata
- **Feature:** template-step-insert
- **Created:** 2026-02-17T21:00
- **Status:** plan-complete
- **Based on:** 2026-02-17T21:00_research.md

## Architecture Overview

This is a focused UI enhancement to `TemplateModal.tsx`. The change adds an "insert step below" affordance to each step card, allowing users to insert a blank step at any position in the step list (not just append to the end). No service, database, type, or hook changes are needed.

```
TemplateModal.tsx
+--------------------------------------------------------------+
|  Template Name: [____________]                                |
|  Roles: [x] Engineering  [ ] Sales                           |
|  Status: (o) Draft  ( ) Published                            |
|                                                               |
|  Onboarding Steps (3)                   [+ Add Step]          |
|  +----------------------------------------------------------+|
|  | Step 1 of 3       [^] [v] [+insert] [trash]              ||
|  | Title: [Setup Dev Environment]                            ||
|  | ...                                                       ||
|  +----------------------------------------------------------+|
|  | Step 2 of 3       [^] [v] [+insert] [trash]              ||
|  | Title: [Get Access Badges]                                ||
|  | ...                                                       ||
|  +----------------------------------------------------------+|
|  | Step 3 of 3       [^] [v] [+insert] [trash]              ||
|  | Title: [Meet the Team]                                    ||
|  | ...                                                       ||
|  +----------------------------------------------------------+|
+--------------------------------------------------------------+
```

### Data Flow

```
User clicks [+insert] on step N
        |
        v
handleInsertStepAfter(N)
        |
        v
splice(N+1, 0, newBlankStep) --> setSteps(newSteps)
        |
        v
React re-renders all step cards with updated indices
        |
        v
useEffect detects lastInsertedUid change --> scrollIntoView
        |
        v
User fills in the new step, saves template
        |
        v
handleSubmit() --> onSubmit(templateData) with steps[].id = index+1
        |
        v
templateService.updateTemplate() --> syncTemplateStepsToInstances()
        |  (existing infrastructure, no changes needed)
        v
Instances updated with new step (status: 'pending')
```

## Tech Stack Summary

- **Language:** TypeScript
- **UI:** React 18, Tailwind CSS 3
- **Icons:** lucide-react (`Plus` icon, already imported)
- **Testing:** Vitest + React Testing Library + userEvent
- **No new dependencies**

## File Structure

### Files to Modify

| File | Lines | Changes |
|------|-------|---------|
| `src/components/templates/TemplateModal.tsx` | ~629 | Add `handleInsertStepAfter` function (~6 lines at line 190), add scroll-into-view state + useEffect (~10 lines), add insert button to each step header row (~8 lines at line 487), add `useRef` + `useCallback` imports |
| `src/components/templates/TemplateModal.test.tsx` | ~857 | Add new `describe('step insertion')` block with ~7 tests |

### No New Files

This feature requires no new files. It is entirely contained within the existing TemplateModal component and its test file.

### No Files to Delete

No files need to be removed.

## Data Model Changes

None. The existing `Step` type, `template_steps` table, and service layer all handle arbitrary step counts and positions without modification.

## Component Architecture

```
TemplateModal (modified)
  |
  +-- State additions:
  |     lastInsertedUid: string | null   (tracks which step to scroll to)
  |
  +-- Function additions:
  |     handleInsertStepAfter(index: number)
  |       - Creates blank step with nextStepUid()
  |       - Splices into steps array at index + 1
  |       - Sets lastInsertedUid for scroll-into-view
  |
  +-- useEffect addition:
  |     When lastInsertedUid changes, find the DOM element
  |     with data-step-uid matching, call scrollIntoView(),
  |     then clear lastInsertedUid
  |
  +-- JSX additions:
        Insert button in step header row (between ChevronDown and Trash2)
        data-step-uid attribute on each step card div
```

### State Management

No Zustand store changes. Templates are managed via local `useState` within TemplateModal and the standalone `useTemplates` hook. The step insertion is purely local state manipulation before form submission.

## Testing Strategy

### Unit Tests (7 new tests in TemplateModal.test.tsx)

| # | Test | Type |
|---|------|------|
| 1 | Insert button is present on each step card | Render |
| 2 | Clicking insert on step 1 of 3 adds a blank step at position 2 | Interaction |
| 3 | Clicking insert on the last step adds a blank step at the end | Interaction |
| 4 | Inserted step has empty fields (title, description, owner, expert, link) | Interaction |
| 5 | Step count label updates after insertion (e.g., "3" -> "4") | Interaction |
| 6 | Step numbers update after insertion (Step N of M correct for all) | Interaction |
| 7 | Submitted step IDs are correct (1-based) after insertion | Integration |

### Integration Tests

No additional integration tests needed. The existing submission tests already verify that `onSubmit` receives correct step IDs (1-based by position) and the sync function operates on the submitted data without TemplateModal-specific knowledge.

### E2E Tests

No Playwright E2E tests planned for this feature. The behavior is fully testable through React Testing Library.

## Implementation Notes

### Key Decisions

1. **Icon choice:** Reuse the `Plus` icon at `size={14}` (smaller than the header Add Step at 16) to keep the button compact. The `Plus` icon is already imported; no new import needed.

2. **Button placement:** Between ChevronDown and Trash2 in the step header button group. This groups all step manipulation controls together and keeps the insert button visually distinct from the top-level "Add Step" button.

3. **Scroll-into-view approach:** Use a `lastInsertedUid` state variable combined with a `useEffect` that queries `document.querySelector('[data-step-uid="..."]')` and calls `scrollIntoView({ behavior: 'smooth', block: 'nearest' })`. The `data-step-uid` attribute is added to each step card's outer div. This also addresses bug #19 (scroll to newly added step).

4. **No "insert above" button:** Keeping it simple with "insert below" only. Users can insert below step 1 and then reorder with ChevronUp if they need a step before step 1. The top-level "Add Step" button continues to append to the end.

### Patterns Followed

- Same blank step creation pattern as `handleAddStep`
- Same button styling as ChevronUp/ChevronDown (dark mode variants, transition-colors)
- Same aria-label pattern with dynamic step number
- Same `_uid` key pattern for stable React keys

### Trade-offs

- **Adding a button to every step card:** Increases visual density slightly, but the `size={14}` Plus icon is compact and matches existing controls. The `title` tooltip ("Insert step below") provides discoverability.
- **No drag-and-drop:** Deferred. The combination of insert + reorder (ChevronUp/ChevronDown) provides full positioning control without the complexity of drag-and-drop.

## Non-goals

- Drag-and-drop step reordering (future feature)
- Bulk step insertion
- Step templates / step library (reusable step snippets)
- "Insert above" button (users can insert below and reorder)
- Changes to the top-level "Add Step" button behavior
- Any service layer, database, or type changes
