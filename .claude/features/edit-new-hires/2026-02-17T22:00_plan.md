# Plan: edit-new-hires

## Metadata
- **Feature:** edit-new-hires
- **Created:** 2026-02-17T22:00
- **Status:** plan-complete
- **Based on:** 2026-02-17T20:00_research.md

## Architecture Overview

```
ManagerView
  |
  +-- NewHiresPanel (self-contained, uses useOnboardingInstances hook)
  |     |
  |     +-- [Edit button per row] --> opens EditHireModal
  |     +-- [Delete button per row] --> opens DeleteConfirmationDialog (existing)
  |     |
  |     +-- EditHireModal (NEW)
  |           |
  |           +-- ModalWrapper (existing)
  |           +-- Form fields: name, email, role, department, template
  |           +-- Template preview (reuses pattern from CreateOnboardingModal)
  |           +-- Template change warning (amber banner)
  |           +-- Calls updateInstance() from useOnboardingInstances hook
  |
  +-- (rest of ManagerView unchanged)
```

### Data Flow: Edit Instance

```
User clicks Edit --> EditHireModal opens with pre-filled data
                        |
User modifies fields, selects new template
                        |
User clicks "Save Changes"
                        |
EditHireModal.handleSubmit()
  |
  +-- If template changed:
  |     1. Fetch new template via getTemplate(newTemplateId)
  |     2. Build merged steps via title-based matching:
  |        - Existing steps with matching titles: keep status
  |        - New template steps without match: status = 'pending'
  |        - Old steps not in new template: dropped
  |     3. Recalculate progress
  |
  +-- Call updateInstance(instanceId, updates) from hook
        |
        +-- Hook calls store._updateInstance(instanceId, updates)
              |
              +-- Optimistic update: replace instance in store array
              +-- Server call: updateOnboardingInstance(id, updates)
              +-- On error: rollback to snapshot
              |
              +-- Fire-and-forget: logActivity(...)
```

### Title-Based Step Merging (same as syncTemplateStepsToInstances)

```
Existing Instance Steps:          New Template Steps:
[1] "Setup Dev Env" (completed)   [1] "Setup Dev Env"
[2] "Code Review" (pending)       [2] "Security Training" (NEW)
[3] "Meet the Team" (completed)   [3] "Code Review"
                                  [4] "Deploy Pipeline" (NEW)

Result (merged):
[1] "Setup Dev Env" (completed)  <-- title match, status preserved
[2] "Security Training" (pending) <-- new step, pending
[3] "Code Review" (pending)       <-- title match, status preserved
[4] "Deploy Pipeline" (pending)   <-- new step, pending
"Meet the Team" DROPPED           <-- not in new template

Progress: 1/4 = 25%
```

## Tech Stack Summary

- React 18 + TypeScript (component + hook)
- Zustand (store action: `_updateInstance`)
- Vitest + React Testing Library (unit tests)
- Tailwind CSS 3 with dark mode variants
- Lucide React (Pencil icon for edit button)
- Existing services: `updateOnboardingInstance`, `getTemplate`

## File Structure

### New Files

| File | Purpose |
|------|---------|
| `src/components/modals/EditHireModal.tsx` | Edit modal with pre-filled form, template change warning, step merging logic |
| `src/components/modals/EditHireModal.test.tsx` | Unit tests for EditHireModal (validation, pre-fill, template change, step merging, submission) |

### Modified Files

| File | Lines | Changes |
|------|-------|---------|
| `src/store/useOnboardingStore.ts` | ~15 lines added | Add `_updateInstance` action to InstancesSlice interface + implementation (optimistic update + server call + rollback) |
| `src/hooks/useOnboardingInstances.ts` | ~8 lines added | Add `updateInstance` function to return type and implementation |
| `src/components/manager/NewHiresPanel.tsx` | ~30 lines added | Import Pencil icon, add Edit button per row, manage editingInstance state, render EditHireModal |
| `src/components/modals/index.ts` | 1 line added | Export EditHireModal |
| `src/components/manager/NewHiresPanel.test.tsx` | ~30 lines added | Add tests for Edit button rendering, opening EditHireModal |
| `src/store/useOnboardingStore.test.ts` | ~25 lines added | Add tests for `_updateInstance` action (optimistic update, rollback) |

### Files NOT Modified

- `src/types/index.ts` -- No new types needed. `OnboardingInstance` and `Partial<OnboardingInstance>` are sufficient for the edit form data. The modal will use inline form state (same pattern as CreateOnboardingModal).
- `src/services/supabase/instanceService.ts` -- `updateOnboardingInstance` already handles all needed fields including steps replacement.
- `src/views/ManagerView.tsx` -- EditHireModal is self-contained inside NewHiresPanel, not wired through ManagerView.

## Component Architecture

### EditHireModal

```
EditHireModal
  Props:
    isOpen: boolean
    onClose: () => void
    onSubmit: (instanceId: string, updates: Partial<OnboardingInstance>) => Promise<void>
    instance: OnboardingInstance | null    -- pre-fill source
    isSubmitting?: boolean
    error?: string | null
    roles?: CustomRole[]
    rolesLoading?: boolean
    templates?: Template[]
    templatesLoading?: boolean

  Internal State:
    employeeName: string
    employeeEmail: string
    role: string
    department: string
    templateId: string
    fieldErrors: FieldErrors
    hasAttemptedSubmit: boolean
    showTemplateWarning: boolean          -- true when template changed from original

  Key Behaviors:
    1. Pre-fill all fields from instance prop via useEffect (same pattern as UserModal)
    2. Track whether templateId has changed from original (instance.templateId)
    3. If template changed: show amber warning about step status reset
    4. On submit with template change:
       a. Fetch new template via getTemplate()
       b. Build merged steps with title-based matching
       c. Recalculate progress
       d. Pass steps + progress in updates
    5. On submit without template change:
       a. Only pass changed field values
    6. Reset form on close (handleClose calls resetForm)
    7. Reset form when instance changes (useEffect on instance + isOpen)
```

### NewHiresPanel Changes

```
NewHiresPanel (existing, modified)
  New State:
    editingInstance: OnboardingInstance | null     -- which instance is being edited

  New Imports:
    Pencil from 'lucide-react'
    EditHireModal from '../modals/EditHireModal'
    useRoles, useTemplates from hooks
    updateOnboardingInstance, getTemplate from services

  UI Changes:
    - Add Pencil icon button next to existing Trash2 button in Actions column
    - Render EditHireModal at bottom of component (alongside DeleteConfirmationDialog)

  Handler:
    handleEditSubmit(instanceId, updates) --> calls updateInstance from hook
```

### Store: _updateInstance Action

```
InstancesSlice (existing, modified)
  New Action:
    _updateInstance: (instanceId: string, updates: Partial<OnboardingInstance>) => Promise<void>

  Implementation:
    1. Capture snapshot of current instances array
    2. Optimistic update: replace matching instance with merged fields
    3. Call updateOnboardingInstance(instanceId, updates) on server
    4. On error: rollback to snapshot, re-throw error
```

## Testing Strategy

### Unit Tests: EditHireModal (~15 tests)

| # | Test | Category |
|---|------|----------|
| 1 | Pre-fills form fields from instance prop | Pre-fill |
| 2 | Shows current template selected in dropdown | Pre-fill |
| 3 | Validation error for empty employee name | Validation |
| 4 | Validation error for invalid email format | Validation |
| 5 | Validation error for empty role | Validation |
| 6 | Validation error for empty department | Validation |
| 7 | Shows template change warning when template is different | Template Change |
| 8 | Does NOT show warning when template is unchanged | Template Change |
| 9 | Displays template preview when template is selected | Template Preview |
| 10 | Submits with correct data (no template change) | Submission |
| 11 | Submits with merged steps when template changes | Submission |
| 12 | Preserves step completion status via title-based matching | Step Merging |
| 13 | Resets form when modal is closed and re-opened | Reset |
| 14 | Shows loading state during submission | UX |
| 15 | Dark mode renders correctly | Dark Mode |

### Unit Tests: Store _updateInstance (~4 tests)

| # | Test | Category |
|---|------|----------|
| 1 | Optimistically updates instance in store | Optimistic |
| 2 | Rolls back on server error | Rollback |
| 3 | Calls updateOnboardingInstance with correct args | Server |
| 4 | Re-throws server errors | Error |

### Unit Tests: NewHiresPanel additions (~4 tests)

| # | Test | Category |
|---|------|----------|
| 1 | Renders edit button for each row | Rendering |
| 2 | Edit button has correct aria-label | A11y |
| 3 | Opens EditHireModal when edit button clicked | Interaction |
| 4 | Passes correct instance to EditHireModal | Props |

### Total Estimated Tests: ~23 new tests

## Implementation Notes

### Design Decisions

1. **EditHireModal is self-contained inside NewHiresPanel** -- follows the same pattern as DeleteConfirmationDialog. The modal does not live in ManagerView because NewHiresPanel already owns the data context (instances, delete handler). Adding edit alongside delete keeps concerns colocated. NewHiresPanel will import `useRoles` and `useTemplates` directly (same as ManagerView does for CreateOnboardingModal).

2. **Step merging happens in the modal's submit handler, not in a service function** -- the merging logic is straightforward (title-based map + walk), and putting it in the modal keeps it testable without service mocks. The result is passed as `updates.steps` to `updateOnboardingInstance`, which handles the DB delete+insert.

3. **No new type definitions needed** -- the edit form data is the same shape as the instance fields (name, email, role, department, templateId). We use `Partial<OnboardingInstance>` for the update payload, which `updateOnboardingInstance` already accepts.

4. **Template fetching uses `getTemplate()` directly** -- when the user selects a different template, we need its steps for the merge. Rather than prop-drilling template steps through the templates array (which only has metadata), we fetch the full template on submit. This is a single lightweight query.

5. **Optimistic store update follows `_editUser` pattern** -- snapshot, optimistic merge, server call, rollback on error. This is the established pattern in the codebase.

### Patterns Followed

- **Modal pattern**: ModalWrapper, Cancel/Submit footer, validation with fieldErrors + hasAttemptedSubmit, useEffect reset on isOpen
- **Dark mode**: All elements get `dark:` Tailwind variants
- **Accessibility**: aria-labels on all interactive elements, role="alert" on validation errors, focus management via ModalWrapper
- **Error handling**: try/catch in submit, re-throw for parent error display, no form reset on error (Bug #8 pattern)
- **Activity logging**: fire-and-forget logActivity after successful edit
- **Toast**: useToast for success feedback in NewHiresPanel

### Trade-offs

- **Dedicated modal vs dual-mode**: We chose a dedicated EditHireModal rather than extending CreateOnboardingModal. This costs some code duplication (form fields), but the edit modal has fundamentally different concerns (pre-fill, template change warning, step merging, no start date editing needed). The CreateOnboardingModal would become overly complex with conditional branches.

- **Step merge in modal vs service**: Putting merge logic in the modal means it's coupled to the UI, but it's trivially testable and keeps the service layer simple. The alternative (a `reassignTemplate` service function) would add another abstraction layer with minimal benefit.

## Non-Goals

- **Multi-template assignment**: The user explicitly stated templates are assigned one at a time. No multi-select UI.
- **Editing status field**: The current edit focuses on role, department, name, email, and template. Status changes (active/completed/on_hold) are a separate concern.
- **Editing start date**: Start date is set at creation time and should not change. The edit modal does not include a start date field.
- **instance_template_refs table**: This junction table exists but is unused. We update `template_id` directly on the instance. Audit trail can be added later.
- **Undo/revert template change**: No "undo" button after template reassignment. The manager must manually re-assign the old template if needed.
