# Research: no-instance-delete

## Metadata
- **Feature:** no-instance-delete (Bug #6 of 6 in bugfix-round)
- **Created:** 2026-02-16T12:00
- **Status:** research-complete
- **Researcher:** research-agent

## Feature Context
- **Description:** There is currently no way to delete onboarding instances from the New Hires table in the manager dashboard. The table is entirely read-only with no action column.
- **Where it fits:** The New Hires tab is one of 4 tabs in the ManagerView (Dashboard, Roles, New Hires, Users). The Users tab already has full CRUD (create, edit, delete) with a DeleteConfirmationDialog. The New Hires tab needs a delete action to match.
- **Dependencies:** No blocking dependencies. The CRUD factory already provides a `remove` method, and the database has proper CASCADE foreign keys. The Zustand store has an instances slice that needs a `_removeInstance` action.

## Requirements

### Functional Requirements
- FR1: Delete button added to each row in the New Hires table (source: bug #6 description)
- FR2: Confirmation dialog displays before deleting an instance (source: existing pattern from UsersPanel)
- FR3: Instance deleted from database via service layer (source: inferred from architecture)
- FR4: Instance removed from Zustand store using server-first pattern (source: existing pattern from `_removeUser`)
- FR5: Success toast displays after successful deletion (source: existing pattern from UsersPanel)
- FR6: Error message displays if deletion fails (source: existing pattern from UsersPanel)
- FR7: Deletion activity logged to activity feed (source: existing pattern from UsersPanel)

### Technical Requirements
- TR1: Using `crud.remove` from instance service's CRUD factory
- TR2: `_removeInstance` action added to Zustand InstancesSlice
- TR3: `deleteOnboardingInstance` exported from instance service and barrel export
- TR4: "Actions" column header added to New Hires table
- TR5: Using existing `DeleteConfirmationDialog` component
- TR6: Using `Trash2` icon from Lucide React (same as UsersPanel)
- TR7: Unit tests added for delete functionality

### Constraints
- No bulk delete needed (single row at a time, matching UsersPanel pattern)
- Managers and admins should both be able to delete (current RLS is "allow all" so no restriction needed)

## Existing Code Analysis

### Project State
- Project exists: YES
- Relevant existing files listed below

### Code to Reuse

1. **`/home/sanjay/Workspace/onboarding/src/services/supabase/crudFactory.ts`** (lines 126-132):
   The factory already generates a `remove(id)` method. The instance service creates a `crud` object at line 48 with `createCrudService<OnboardingInstance>(...)`. The `crud.remove` function exists but is **NOT exported** from `instanceService.ts`. Only `crud.list`, `crud.get`, and `crud.subscribe` are exported (lines 60-62).

2. **`/home/sanjay/Workspace/onboarding/src/components/ui/DeleteConfirmationDialog.tsx`**:
   A fully reusable confirmation dialog component. Props: `isOpen`, `title`, `message`, `confirmLabel`, `cancelLabel`, `onConfirm`, `onCancel`, `isLoading`, `isDangerous`. Already exported from `src/components/ui/index.ts`.

3. **`/home/sanjay/Workspace/onboarding/src/components/manager/UsersPanel.tsx`**:
   The exact pattern to follow. It has:
   - `userToDelete` state (`useState<User | null>(null)`)
   - `isDeleting` state (`useState(false)`)
   - `handleDeleteConfirm` async handler
   - Trash2 icon button in each row
   - DeleteConfirmationDialog at the bottom
   - Activity logging after successful delete
   - Success toast via `showSuccess()`

4. **`/home/sanjay/Workspace/onboarding/src/store/useOnboardingStore.ts`** (lines 478-489):
   The `_removeUser` action pattern: server-first delete, then remove from local state. This is the pattern to follow for `_removeInstance`.

### Code to Modify

1. **`/home/sanjay/Workspace/onboarding/src/services/supabase/instanceService.ts`**:
   - Export `crud.remove` as `deleteOnboardingInstance` (one line: `export const deleteOnboardingInstance = crud.remove;`)

2. **`/home/sanjay/Workspace/onboarding/src/services/supabase/index.ts`**:
   - Add `deleteOnboardingInstance` to the Instance Service exports block

3. **`/home/sanjay/Workspace/onboarding/src/store/useOnboardingStore.ts`**:
   - Add `_removeInstance` action to the `InstancesSlice` interface
   - Implement the action in the store (server-first delete, then filter from local state)
   - Import `deleteOnboardingInstance` from services

4. **`/home/sanjay/Workspace/onboarding/src/hooks/useOnboardingInstances.ts`**:
   - Add `removeInstance` to the return type and implementation (delegate to store `_removeInstance`)

5. **`/home/sanjay/Workspace/onboarding/src/components/manager/NewHiresPanel.tsx`**:
   - Add `Trash2` icon import
   - Add `useState` for `instanceToDelete` and `isDeleting`
   - Add "Actions" column header to the table
   - Add delete button (Trash2 icon) in each row
   - Add `handleDeleteConfirm` handler
   - Add `DeleteConfirmationDialog` component
   - Add success toast (import `useToast` from context)
   - Add activity logging (import `logActivity` from services)

6. **`/home/sanjay/Workspace/onboarding/src/components/manager/NewHiresPanel.test.tsx`**:
   - Add tests for: delete button rendering, confirmation dialog, successful deletion, error handling

### Patterns to Follow

1. **Server-first delete (not optimistic):** The `_removeUser` pattern does server delete first, then removes from local state on success. This is safer for destructive operations.
   ```typescript
   _removeInstance: async (instanceId: string) => {
     try {
       await deleteOnboardingInstance(instanceId);
       set((state) => ({ instances: state.instances.filter((i) => i.id !== instanceId) }));
     } catch (err) {
       throw new Error(msg);
     }
   }
   ```

2. **Delete confirmation dialog pattern:**
   ```tsx
   <DeleteConfirmationDialog
     isOpen={instanceToDelete !== null}
     title="Delete Onboarding Instance"
     message={`Are you sure you want to delete the onboarding for "${instanceToDelete?.employeeName}"? ...`}
     onConfirm={handleDeleteConfirm}
     onCancel={() => setInstanceToDelete(null)}
     isLoading={isDeleting}
     isDangerous
   />
   ```

3. **Activity logging pattern (fire-and-forget):**
   ```typescript
   logActivity({ userInitials: '...', action: `Deleted onboarding for ${name}`, timeAgo: 'just now' }).catch(() => {});
   ```

## Database Cascade Analysis

When an `onboarding_instances` row is deleted, the following cascades occur automatically:

| Table | Foreign Key | ON DELETE Behavior |
|-------|------------|-------------------|
| `instance_steps` | `instance_id` references `onboarding_instances(id)` | **CASCADE** - all steps deleted automatically |
| `instance_profiles` | `instance_id` references `onboarding_instances(id)` | **CASCADE** - junction rows deleted automatically |
| `instance_template_refs` | `instance_id` references `onboarding_instances(id)` | **CASCADE** - junction rows deleted automatically |
| `suggestions` | `instance_id` references `onboarding_instances(id)` | **SET NULL** - suggestions preserved but `instance_id` set to null |
| `templates` | `template_id` referenced BY `onboarding_instances` | No cascade (template not affected) |

**Key finding:** The CRUD factory's `remove` method (`crud.remove(id)`) does a simple `supabase.from(table).delete().eq('id', id)`. The database CASCADE handles all child table cleanup. No manual cleanup code is needed (unlike user deletion which has to manually delete instances by email because there's no FK).

## RLS Policies

The current RLS policy on `onboarding_instances` is permissive: `FOR ALL USING (true) WITH CHECK (true)`. This means any authenticated user can delete any instance. No RLS changes needed.

## Risk Assessment

### Technical Risks
| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Accidental deletion of active instance | High | Low | Confirmation dialog with employee name prevents accidental clicks |
| Suggestions losing instance_id reference | Low | Certain (by design) | SET NULL is correct - suggestions are preserved, just unlinked |
| Realtime subscription not refreshing after delete | Medium | Low | The existing `subscribeToOnboardingInstances` subscription will pick up the delete via Realtime; plus the optimistic removal from Zustand store provides immediate UI feedback |

### Complexity
- **Level:** Simple
- **Rationale:** This is a straightforward CRUD addition. Every piece of infrastructure already exists: the CRUD factory has `remove`, the UI has `DeleteConfirmationDialog`, the Zustand store has the `_removeUser` pattern to copy, and the database has proper CASCADE constraints. The implementation is essentially wiring together existing patterns.

## Open Questions

All questions resolved through code analysis:

- [x] Q1: Is there already a delete function in the instance service?
  - Resolution: The CRUD factory generates `crud.remove` but it is NOT exported from `instanceService.ts`. We need to add one line: `export const deleteOnboardingInstance = crud.remove;`

- [x] Q2: What data gets cascade-deleted with an instance?
  - Resolution: `instance_steps` (CASCADE), `instance_profiles` (CASCADE), `instance_template_refs` (CASCADE). `suggestions.instance_id` gets SET NULL. No manual cleanup needed.

- [x] Q3: Who should be able to delete instances?
  - Resolution: RLS is currently "allow all" on all tables. No restrictions needed. Both managers and admins can delete.

- [x] Q4: Should there be bulk delete?
  - Resolution: No. The UsersPanel pattern uses single-row delete. Keep it consistent.

- [x] Q5: What happens to the UI after deletion?
  - Resolution: Optimistic removal from Zustand store (instant UI update). Success toast (3-second auto-dismiss). Activity log entry.

- [x] Q6: Should the NewHiresPanel use the `useOnboardingInstances` hook or the store directly?
  - Resolution: Continue using `useOnboardingInstances` hook. Add a `removeInstance` function to the hook's return value that delegates to the store's `_removeInstance` action.

## Recommended Approach

### Implementation Strategy

Follow the exact same pattern as UsersPanel's delete feature. The work is small and well-scoped:

1. **Service layer** (1 line): Export `crud.remove` as `deleteOnboardingInstance`
2. **Barrel export** (1 line): Add to `index.ts`
3. **Zustand store** (15 lines): Add `_removeInstance` action to InstancesSlice
4. **Hook** (5 lines): Add `removeInstance` to `useOnboardingInstances` return
5. **Component** (50 lines): Add Actions column, Trash2 button, DeleteConfirmationDialog, handlers
6. **Tests** (60 lines): Add tests for delete button, confirmation, success/error states

### Order of Work
1. Export `deleteOnboardingInstance` from instance service + barrel
2. Add `_removeInstance` to Zustand store (InstancesSlice interface + implementation)
3. Add `removeInstance` to `useOnboardingInstances` hook
4. Update `NewHiresPanel` component with delete UI
5. Update `NewHiresPanel.test.tsx` with delete tests

### What to Defer
- Bulk delete (not needed, not consistent with existing patterns)
- Role-based delete permissions (RLS is already permissive, can tighten later)
- Undo/soft delete (no existing pattern for this in the codebase)

### Estimated Size
- ~6 files modified
- ~130 lines added
- ~5 new tests
- Complexity: Simple

## Files Referenced

| File | Path | Role |
|------|------|------|
| NewHiresPanel | `/home/sanjay/Workspace/onboarding/src/components/manager/NewHiresPanel.tsx` | Primary component to modify |
| NewHiresPanel tests | `/home/sanjay/Workspace/onboarding/src/components/manager/NewHiresPanel.test.tsx` | Test file to extend |
| instanceService | `/home/sanjay/Workspace/onboarding/src/services/supabase/instanceService.ts` | Export crud.remove |
| barrel export | `/home/sanjay/Workspace/onboarding/src/services/supabase/index.ts` | Add deleteOnboardingInstance |
| Zustand store | `/home/sanjay/Workspace/onboarding/src/store/useOnboardingStore.ts` | Add _removeInstance |
| useOnboardingInstances | `/home/sanjay/Workspace/onboarding/src/hooks/useOnboardingInstances.ts` | Add removeInstance |
| DeleteConfirmationDialog | `/home/sanjay/Workspace/onboarding/src/components/ui/DeleteConfirmationDialog.tsx` | Reuse as-is |
| UsersPanel (reference) | `/home/sanjay/Workspace/onboarding/src/components/manager/UsersPanel.tsx` | Pattern to follow |
| crudFactory | `/home/sanjay/Workspace/onboarding/src/services/supabase/crudFactory.ts` | Already provides remove() |
| Migration 00001 | `/home/sanjay/Workspace/onboarding/supabase/migrations/00001_create_core_tables.sql` | FK constraints verified |
| Migration 00002 | `/home/sanjay/Workspace/onboarding/supabase/migrations/00002_create_step_tables.sql` | instance_steps CASCADE verified |
| Migration 00003 | `/home/sanjay/Workspace/onboarding/supabase/migrations/00003_create_junction_tables.sql` | Junction CASCADE verified |
| Migration 00005 | `/home/sanjay/Workspace/onboarding/supabase/migrations/00005_enable_rls.sql` | RLS permissive confirmed |

## Next Step

**All questions resolved. Status: research-complete.**

Run `/plan no-instance-delete` to create implementation plan.
