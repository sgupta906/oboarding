# Plan: no-instance-delete

## Metadata
- **Feature:** no-instance-delete (Bug #6 of 6 in bugfix-round)
- **Created:** 2026-02-16T12:30
- **Status:** plan-complete
- **Based On:** `.claude/features/no-instance-delete/2026-02-16T12:00_research.md`

## Architecture Overview

### Data Flow: Delete Instance

```
User clicks Trash2 icon on row
         |
         v
NewHiresPanel sets instanceToDelete state
         |
         v
DeleteConfirmationDialog opens (shows employee name)
         |
         v
User clicks "Delete" confirm button
         |
         v
handleDeleteConfirm() called
         |
         v
useOnboardingStore._removeInstance(id)
    |-- Server-first: await deleteOnboardingInstance(id)
    |     |
    |     v
    |   Supabase DELETE from onboarding_instances WHERE id = ?
    |     |
    |     v
    |   DB CASCADE: instance_steps, instance_profiles,
    |               instance_template_refs deleted
    |   DB SET NULL: suggestions.instance_id nulled
    |
    |-- On success: filter instance from store.instances
    |
    v
Back in NewHiresPanel:
  - Close dialog (setInstanceToDelete(null))
  - Show success toast
  - Log activity (fire-and-forget)
```

### Component Hierarchy (relevant portion)

```
ManagerView
  |-- NewHiresPanel (modified)
        |-- Status filter buttons
        |-- <table> with 8 columns (was 7, adding "Actions")
        |     |-- Each row now has Trash2 delete button
        |-- DeleteConfirmationDialog (new, reused from ui/)
        |-- Success toast (inline, same pattern as UsersPanel)
```

## Tech Stack Summary

No new dependencies. Everything used already exists in the project:

| Concern | Existing Tool | Status |
|---------|--------------|--------|
| Delete service function | `crud.remove` from crudFactory | Exists but NOT exported |
| Confirmation dialog | `DeleteConfirmationDialog` from `ui/` | Reuse as-is |
| Delete icon | `Trash2` from `lucide-react` | Already in project |
| State management | Zustand `useOnboardingStore` | Add `_removeInstance` action |
| Activity logging | `logActivity` from services | Reuse as-is |
| Auth context | `useAuth` from `config/authContext` | Reuse as-is |

## File Structure

### Files to Modify (6 files)

#### 1. `src/services/supabase/instanceService.ts`
- **Line ~62**: Add `export const deleteOnboardingInstance = crud.remove;` after the existing `subscribeToOnboardingInstances` export
- **Change size:** +1 line

#### 2. `src/services/supabase/index.ts`
- **Line ~71 (Instance Service exports block)**: Add `deleteOnboardingInstance` to the export list
- **Change size:** +1 line

#### 3. `src/store/useOnboardingStore.ts`
- **InstancesSlice interface (line ~54)**: Add `_removeInstance: (instanceId: string) => Promise<void>;`
- **Store import (line ~24)**: Add `deleteOnboardingInstance` to the import from services
- **Store implementation (after `_addInstance`, line ~284)**: Add `_removeInstance` action implementation following `_removeUser` pattern
- **Change size:** +15 lines

#### 4. `src/hooks/useOnboardingInstances.ts`
- **Return type interface (line ~14)**: Add `removeInstance: (id: string) => Promise<void>;`
- **Hook body (line ~38)**: Add `removeInstance` function that delegates to store `_removeInstance`
- **Change size:** +8 lines

#### 5. `src/components/manager/NewHiresPanel.tsx`
- **Imports (line ~2-4)**: Add `Trash2` to lucide-react import, add `useAuth`, `logActivity`, `DeleteConfirmationDialog`, `useOnboardingStore`
- **Component state (line ~68)**: Add `instanceToDelete`, `isDeleting`, `successMessage` state
- **Helper functions**: Add `getInitials`, `showSuccess`, `handleDeleteConfirm`
- **Table header (line ~171-193)**: Add "Actions" column header
- **Table body (line ~196-241)**: Add Actions cell with Trash2 button in each row
- **After table**: Add success toast and DeleteConfirmationDialog
- **Change size:** +65 lines

#### 6. `src/components/manager/NewHiresPanel.test.tsx`
- **Mocks section**: Add mock for `useOnboardingStore`, `logActivity`, `useAuth`
- **New describe block**: Add "Delete" test suite with 5 tests
- **Change size:** +70 lines

### New Files

None. All changes are modifications to existing files.

## Data Model Changes

None. The database schema already has CASCADE foreign keys that handle child table cleanup. No migrations needed.

## Component Architecture

### NewHiresPanel State Additions

```typescript
// Existing state
const [filter, setFilter] = useState<StatusFilter>('all');

// New state for delete
const [instanceToDelete, setInstanceToDelete] = useState<OnboardingInstance | null>(null);
const [isDeleting, setIsDeleting] = useState(false);
const [successMessage, setSuccessMessage] = useState<string | null>(null);
```

### Delete Handler Pattern (from UsersPanel)

```typescript
const handleDeleteConfirm = async () => {
  if (!instanceToDelete) return;
  setIsDeleting(true);
  try {
    await removeInstance(instanceToDelete.id);
    // Fire-and-forget activity log
    logActivity({
      userInitials: authUser ? getInitials(authUser.email ?? '') : 'SY',
      action: `Deleted onboarding for ${instanceToDelete.employeeName}`,
      timeAgo: 'just now',
      userId: authUser?.uid ?? 'unknown',
    }).catch(() => {});
    showSuccess('Onboarding instance deleted successfully');
    setInstanceToDelete(null);
  } catch (err) {
    // Error is handled by the store; just close the dialog
    setInstanceToDelete(null);
  } finally {
    setIsDeleting(false);
  }
};
```

### Store Action Pattern (from _removeUser)

```typescript
_removeInstance: async (instanceId: string) => {
  try {
    await deleteOnboardingInstance(instanceId);
    set((state) => ({
      instances: state.instances.filter((i) => i.id !== instanceId),
    }));
  } catch (err) {
    const msg = err instanceof Error ? err.message : 'Failed to delete onboarding instance';
    throw new Error(msg);
  }
},
```

Key design decision: **Server-first, not optimistic**. For destructive operations, the `_removeUser` pattern waits for the server to confirm deletion before removing from local state. This avoids showing a "deleted" state while the server still holds the data.

## Testing Strategy

### Unit Tests (store): 3 tests in `useOnboardingStore.test.ts`

1. **`_removeInstance` is available as a function** - Verify the action exists on the store
2. **`_removeInstance` removes from array after server call** - Pre-populate store, call `_removeInstance`, verify array filtered
3. **`_removeInstance` throws and does not remove on server error** - Mock `deleteOnboardingInstance` to reject, verify array unchanged and error thrown

### Component Tests: 5 tests in `NewHiresPanel.test.tsx`

1. **Renders delete button for each row** - Check Trash2 buttons exist with correct aria-labels
2. **Shows Actions column header** - Verify "Actions" header text
3. **Opens confirmation dialog on delete click** - Click Trash2, verify dialog with employee name appears
4. **Calls removeInstance on confirm and shows success toast** - Mock removeInstance to resolve, click confirm, verify function called and success message shown
5. **Closes dialog on cancel** - Click Trash2, then click cancel, verify dialog closes

### Total new tests: ~8

### Existing tests that must still pass

All 12 existing NewHiresPanel tests must continue to pass (rendering, filtering, states). The mock return structure does not change (just adds `removeInstance` to the hook mock).

## Implementation Notes

### Decisions

1. **Hook vs. store direct access**: The component will use `useOnboardingInstances` hook (which already provides `data`, `isLoading`, `error`) and additionally get `_removeInstance` from the store directly. The research suggested adding `removeInstance` to the hook's return type, but looking at the actual code, NewHiresPanel already imports `useOnboardingInstances` from hooks. The cleanest approach is to add `removeInstance` to the hook's return value to keep the component's interface consistent.

2. **Error handling in component**: UsersPanel shows errors via `modalError` state. For NewHiresPanel, since there is no modal involved (just a dialog), errors from the delete operation will be silently handled (the dialog closes, and the instance remains in the table since the server-first pattern means it was never removed). This matches the principle of least surprise.

3. **Activity logging**: Uses the same fire-and-forget pattern as UsersPanel (`.catch(() => {})`). No need to block the UI for activity logging.

4. **Success toast**: Uses the same inline pattern as UsersPanel (`successMessage` state with 3-second auto-dismiss via `setTimeout`). Not using the shared `ToastContext` because UsersPanel does not use it either, and consistency within the manager panel is more valuable.

### Patterns Followed

- Server-first delete (from `_removeUser` in store)
- Trash2 icon button with hover-to-red styling (from UsersPanel)
- DeleteConfirmationDialog with `isDangerous` prop (from UsersPanel)
- Fire-and-forget activity logging (from UsersPanel)
- Inline success toast with auto-dismiss (from UsersPanel)
- `getInitials` helper for activity logging (from UsersPanel)

### Trade-offs

- **No error toast for delete failures**: If the server delete fails, the dialog closes and the row remains. This is safer than showing an alarming error message. The console will log the error for debugging.
- **No undo**: Consistent with the existing deletion patterns in the app. Adding undo would require a soft-delete mechanism that does not exist.
- **No bulk delete**: Consistent with UsersPanel. Single-row delete only.

## Non-Goals

- Bulk delete (selecting multiple rows to delete at once)
- Soft delete / undo functionality
- Role-based delete permissions (RLS is currently permissive)
- Delete confirmation with password re-entry
- Archiving instances instead of deleting
