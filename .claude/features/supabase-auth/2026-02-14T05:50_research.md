# Research: supabase-auth

## Metadata
- **Feature:** supabase-auth
- **Created:** 2026-02-14
- **Status:** research-complete
- **Researcher:** research-agent

## Feature Context

Step 3 of Firebase-to-Supabase migration. Steps 1 (`supabase-setup`) and 2 (`supabase-data-layer`) are done. The data layer uses Supabase for all CRUD, but authentication still runs through Firebase Auth + Firestore. This feature replaces all Firebase Auth usage with Supabase Auth equivalents.

## Current Auth Architecture (Firebase)

### Sign-In Flow
1. User enters email in `SignInView`
2. `signInWithEmailLink(email)` called in `authService.ts`
3. Checks `getAuthCredential(email)` for Users panel-created users (localStorage)
4. Checks `MOCK_EMAIL_ROLES` map for hardcoded test emails
5. Tries `createUserWithEmailAndPassword` (Firebase) — if exists, tries `signInWithEmailAndPassword`
6. On Firebase failure, falls back to localStorage mock auth
7. Stores user+role in Firestore via `setUserRole()`, or in localStorage
8. Dispatches `authStorageChange` custom event

### Auth State Observation
`AuthProvider` in `authContext.tsx` has two `useEffect` hooks:
- **Effect 1:** Checks localStorage for `mockAuthUser` first. If found, uses it and skips Firebase. Otherwise, calls `onAuthStateChanged(auth, callback)`.
- **Effect 2:** Listens for `storage` events (cross-tab) and `authStorageChange` custom events (same-tab).

On Firebase auth state change, calls `getUserRole(uid)` to fetch role from Firestore `users/{uid}` doc.

### Sign-Out Flow
`signOut()` in `authService.ts`: clears localStorage `mockAuthUser`, dispatches custom event, calls `firebaseSignOut(auth)`.

### Auth Types (`authTypes.ts`)
- `UserRole = 'employee' | 'manager' | 'admin'`
- `AuthUser = { uid: string; email: string; role: UserRole }`
- `FirestoreUser = { uid, email, role, createdAt, updatedAt }` (Firestore-specific, remove)
- `AuthContextValue = { user, role, loading, isAuthenticated, signOut }`

### Auth-Related Firebase Imports (must be eliminated)

| Import | File | Used For |
|--------|------|----------|
| `onAuthStateChanged` | `authContext.tsx` | Listen to auth state |
| `createUserWithEmailAndPassword` | `authService.ts` | Create user on sign-in |
| `signInWithEmailAndPassword` | `authService.ts` | Sign in existing user |
| `signOut` (as `firebaseSignOut`) | `authService.ts` | Sign out |
| `doc`, `setDoc`, `getDoc`, `Timestamp` | `authService.ts` | Read/write user roles in Firestore |
| `auth`, `firestore` from `./firebase` | `authService.ts` | Firebase instances |
| `auth` from `./firebase` | `authContext.tsx` | Firebase Auth instance |

## Requirements

### Functional Requirements
- [ ] FR1: Replace `onAuthStateChanged` (Firebase) with `supabase.auth.onAuthStateChange`
- [ ] FR2: Replace `createUserWithEmailAndPassword` / `signInWithEmailAndPassword` with Supabase Auth
- [ ] FR3: Replace `firebaseSignOut` with `supabase.auth.signOut()`
- [ ] FR4: Replace Firestore `getUserRole()` with Supabase query from `users` + `user_roles`
- [ ] FR5: Replace Firestore `setUserRole()` with Supabase upsert to `users` + `user_roles`
- [ ] FR6: Preserve localStorage fallback auth flow for development
- [ ] FR7: Preserve QA impersonation feature (`impersonateUserForQA`)
- [ ] FR8: Preserve `getAuthCredential()` integration for Users panel-created users
- [ ] FR9: Keep `AuthContextValue` interface stable
- [ ] FR10: Preserve role-based routing in `App.tsx`
- [ ] FR11: Remove all `firebase/auth` imports from production code
- [ ] FR12: Remove `firebase/firestore` imports from `authService.ts`

### Technical Requirements
- [ ] TR1: Code must work in dev mode with localStorage fallback (no live Supabase)
- [ ] TR2: Maintain lazy-init Proxy pattern for Supabase client
- [ ] TR3: All 651+ existing tests must pass
- [ ] TR4: Test mocks must shift from `firebase/auth` to Supabase
- [ ] TR5: `AuthUser` type must remain stable; consumers need no changes
- [ ] TR6: Zero TypeScript errors (`tsc -b`)

## Supabase Auth API Mapping

| Firebase Method | Supabase Equivalent | Notes |
|----------------|---------------------|-------|
| `onAuthStateChanged(auth, cb)` | `supabase.auth.onAuthStateChange(cb)` | Callback: `(event, session)` vs `(user)` |
| `createUserWithEmailAndPassword(auth, email, pw)` | `supabase.auth.signUp({ email, password })` | Returns `{ data: { user, session }, error }` |
| `signInWithEmailAndPassword(auth, email, pw)` | `supabase.auth.signInWithPassword({ email, password })` | Returns `{ data: { user, session }, error }` |
| `signOut(auth)` | `supabase.auth.signOut()` | Returns `{ error }` |
| `auth.currentUser` | `supabase.auth.getUser()` | Async in Supabase |
| Firestore `getDoc(users/{uid})` | `supabase.from('users').select('*, user_roles(*)').eq('id', uid)` | Role in junction table |

## Files That Must Change

| File | Lines | What Changes | Complexity |
|------|-------|-------------|------------|
| `src/config/authTypes.ts` | 58 | Remove `FirestoreUser` type | Low |
| `src/services/authService.ts` | 303 | Rewrite: Firebase -> Supabase Auth + DB | High |
| `src/config/authContext.tsx` | 287 | Rewrite: Firebase listener -> Supabase listener | High |
| `src/views/SignInView.tsx` | 293 | Update env var reference | Low |
| `src/test/setup.ts` | 94 | Update env var names | Low |
| `src/services/authService.test.ts` | 418 | Rewrite mocks for Supabase | Medium |
| `src/config/authContext.test.tsx` | 573 | Rewrite mocks for Supabase | Medium |
| `src/views/SignInView.integration.test.tsx` | 265 | Update mocks | Medium |
| `src/views/AuthFlow.integration.test.tsx` | 599 | Update mocks | Medium |

### Files That Should NOT Change (consumers using only `useAuth()` hook)
- `src/App.tsx`
- `src/components/OnboardingHub.tsx`
- `src/components/ui/NavBar.tsx`
- `src/views/SignOutView.tsx`

### Files to Defer (cleanup step)
- `src/config/firebase.ts` — leave alone
- `src/config/firebase.test.ts` — leave alone
- `package.json` firebase dependency — remove in cleanup step

## Code to Reuse
- `src/config/supabase.ts` — typed Supabase client with Proxy pattern
- `src/services/supabase/userService.ts` — `getUser()` queries `users` + `user_roles` + `user_profiles`
- `src/services/supabase/mappers.ts` — `toUser()` mapper
- `src/types/database.types.ts` — `users`, `user_roles` table types

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Breaking 651+ tests due to mock changes | High | Medium | Update mocks file-by-file; run tests after each |
| Supabase auth listener different callback shape | Medium | High | Map `(event, session)` to same internal logic |
| Dev mode localStorage fallback integration | Medium | Low | Keep same dual-path approach |
| Test setup.ts env var changes affect unrelated tests | Medium | Low | Test incrementally |

**Complexity: Medium** — Auth surface well-contained (2 main source files + 4 test files). Supabase Auth API maps cleanly to Firebase Auth.

## Open Questions — All Resolved

1. **Auth method:** Email/password (maps to current Firebase approach)
2. **Env var rename:** `VITE_USE_FIREBASE_EMULATOR` -> `VITE_USE_DEV_AUTH`
3. **`getCurrentUser()`:** Replace with Supabase equivalent; only used internally
4. **`FirestoreUser` type:** Remove; use database types instead
5. **`firebase.ts` changes:** Leave alone; cleanup step handles removal

## Recommended Approach

### Strategy: Incremental replacement with stable API surface

The `AuthContextValue` interface and `useAuth()` hook are the public API. Keep them stable, swap internals.

### Order of Work
1. `src/config/authTypes.ts` — Remove `FirestoreUser` (smallest, no deps)
2. `src/services/authService.ts` — Rewrite to Supabase Auth + DB (core logic)
3. `src/config/authContext.tsx` — Rewrite auth listener (depends on authService)
4. `src/views/SignInView.tsx` — Update env var reference
5. `src/test/setup.ts` — Update env vars
6. `src/services/authService.test.ts` — Rewrite mocks
7. `src/config/authContext.test.tsx` — Rewrite mocks
8. `src/views/SignInView.integration.test.tsx` — Update mocks
9. `src/views/AuthFlow.integration.test.tsx` — Update mocks

### What to Defer
- Removing `firebase.ts` entirely (cleanup step)
- Removing `firebase` package (cleanup step)
- Real email verification / magic link (future enhancement)
- RLS policies tied to Supabase Auth (requires live instance)

## Next Step

**All questions resolved. Status: research-complete.**

Run `/plan supabase-auth` to create the implementation plan.
