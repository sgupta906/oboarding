# Research: profiles-cleanup

## Metadata
- **Feature:** profiles-cleanup (Bug #39 `profiles-table-unused`)
- **Created:** 2026-02-17T21:00
- **Status:** research-complete
- **Researcher:** research-agent

## Feature Context

The `profiles` table and `profileService.ts` are fully implemented with complete CRUD operations, but NO component, hook, or store in the application ever calls them. The `Profile` type interface IS used in a few places (props definitions, filter utilities), but ONLY in test fixtures and as optional props that are never actually passed in production code.

Additionally, `profileTemplateService.ts` follows the same pattern -- fully implemented but never imported or called by any hook, component, or store.

### Dependencies
- No features depend on profile service or profile template service.
- The `Profile` type is used as an optional prop type in `WelcomeHeaderProps` and `KPISectionProps`, and in `filterUtils.ts` utility functions. However, these profile-related props are **never passed** in production code -- they only appear in test fixtures.
- The `user_profiles` junction table IS used by `userService.ts` (for user profile assignments), but it stores text-based `profile_name` strings and has NO FK to the `profiles` table.

### Scope Clarification

This bug has **two distinct layers** of dead code:

1. **profileService.ts** -- CRUD service for the `profiles` DB table. Zero consumers. Safe to remove entirely.
2. **profileTemplateService.ts** -- CRUD service for `profile_templates` DB table. Zero consumers outside barrel export. Safe to remove entirely.
3. **Profile type, filterUtils, and component props** -- The `Profile` interface, `filterUtils.ts`, and optional profile-related props on `WelcomeHeaderProps` and `KPISectionProps` form an unused feature surface. These are never wired up in production.

**Recommendation:** Remove layers 1 and 2 (services) in this bug. Layer 3 (types/props/utils) is a larger refactor and can be a separate cleanup task. The optional props and filter utilities do no harm -- they are type-only overhead with zero runtime cost.

## Requirements

### Functional Requirements
- FR1: Remove `profileService.ts` -- zero consumers
- FR2: Remove `profileTemplateService.ts` -- zero consumers
- FR3: Remove barrel exports for both services from `index.ts`
- FR4: Remove profile-specific mapper function `toProfile` from `mappers.ts`
- FR5: Remove profile-specific mapper function `toProfileTemplate` from `mappers.ts`
- FR6: Remove profile-related row type aliases and joined types that are only used by the removed services
- FR7: Remove `toProfile` test from `mappers.test.ts`
- FR8: Remove `toProfileTemplate` test from `mappers.test.ts`
- FR9: Remove `Profile` import from `mappers.ts`
- FR10: Remove `ProfileTemplate` import from `mappers.ts`

### Technical Requirements
- TR1: All existing tests pass after removal
- TR2: TypeScript compiles cleanly
- TR3: No runtime behavior changes -- purely dead code removal

### Out of Scope (Defer to separate cleanup)
- Removing `Profile` interface from `types/index.ts` -- still used by `filterUtils.ts`, `WelcomeHeader`, `KPISection`
- Removing `filterUtils.ts` and related tests -- functional code, just never wired up
- Removing optional profile props from `WelcomeHeaderProps` and `KPISectionProps`
- Removing database tables (`profiles`, `profile_templates`, `profile_template_steps`, `profile_role_tags`, `instance_profiles`) -- DB schema cleanup is a separate concern
- Removing database type definitions from `database.types.ts` -- these mirror the live DB schema

## Existing Code Analysis

### Complete Inventory of Profile-Related Code

#### 1. profileService.ts (REMOVE)
- **File:** `src/services/supabase/profileService.ts` (162 lines)
- **Exports:** `listProfiles`, `getProfile`, `createProfile`, `updateProfile`, `deleteProfile`, `subscribeToProfiles`
- **Consumers:** ZERO (only the barrel `index.ts`)
- **Internal dependencies:** `mappers.ts` (toProfile, toISO, ProfileRow, ProfileRoleTagRow), `crudFactory.ts`, `uuid.ts`, `userService.ts` (creatorExists)

#### 2. profileTemplateService.ts (REMOVE)
- **File:** `src/services/supabase/profileTemplateService.ts` (277 lines)
- **Exports:** `listProfileTemplates`, `getProfileTemplate`, `createProfileTemplate`, `updateProfileTemplate`, `deleteProfileTemplate`, `subscribeToProfileTemplates`
- **Consumers:** ZERO (only the barrel `index.ts`)
- **Internal dependencies:** `mappers.ts` (toProfileTemplate, toISO, ProfileTemplateRow, ProfileTemplateStepRow), `crudFactory.ts`, `uuid.ts`, `userService.ts` (creatorExists), `debounce.ts`

#### 3. Barrel exports in index.ts (MODIFY)
- **File:** `src/services/supabase/index.ts`
- **Lines 49-67:** Profile Service + Profile Template Service exports
- **Action:** Remove these two export blocks

#### 4. mappers.ts -- profile-related code (MODIFY)
- **File:** `src/services/supabase/mappers.ts`
- **Row types to remove** (lines 35-36): `ProfileRow`, `ProfileRoleTagRow`
- **Row types to remove** (lines 37-38): `ProfileTemplateRow`, `ProfileTemplateStepRow`
- **Re-exports to remove** (lines 52-55): `ProfileRow`, `ProfileRoleTagRow`, `ProfileTemplateRow`, `ProfileTemplateStepRow`
- **Joined type to remove** (line 72): `ProfileWithTags`
- **Joined type to remove** (line 75): `ProfileTemplateWithSteps`
- **Mapper to remove** (lines 223-232): `toProfile()`
- **Mapper to remove** (lines 238-256): `toProfileTemplate()`
- **Imports to update** (lines 15-16): Remove `Profile` and `ProfileTemplate` from the import
- **Note:** `UserProfileRow` (line 41), `UserWithJunctions` (line 78), and `toUser` (lines 262-277) must be KEPT -- they are used by `userService.ts`

#### 5. mappers.test.ts -- profile-related tests (MODIFY)
- **File:** `src/services/supabase/mappers.test.ts`
- **Line 17:** Remove `toProfile` from import
- **Line 18 (toProfileTemplate):** Remove from import
- **Lines 285-306:** Remove `describe('toProfile', ...)` block
- **Lines 308-334:** Remove `describe('toProfileTemplate', ...)` block

### Code to Keep (NOT profile service related)

The following items use the word "profile" but are NOT part of the dead profile service code:

| Item | Why Keep |
|------|----------|
| `Profile` interface in `types/index.ts` (lines 40-47) | Used by `filterUtils.ts`, `WelcomeHeaderProps`, `KPISectionProps` -- out of scope |
| `ProfileTemplate` interface in `types/index.ts` (lines 54-65) | Paired with `Profile` -- out of scope |
| `filterUtils.ts` and `filterUtils.test.ts` | Functional utility code using `Profile` type -- out of scope |
| `WelcomeHeaderProps.profiles` in `types/index.ts` (line 194) | Optional prop -- out of scope |
| `KPISectionProps.profiles` in `types/index.ts` (line 364) | Optional prop -- out of scope |
| `WelcomeHeader.test.tsx` Profile usage | Tests optional prop rendering -- out of scope |
| `KPISection.test.tsx` Profile usage | Tests optional prop rendering -- out of scope |
| `KPISection.tsx` profile filtering logic | Uses `Profile` type for optional filtering -- out of scope |
| `WelcomeHeader.tsx` profile selector | Uses `Profile` type for optional selector -- out of scope |
| `UserProfileRow` in `mappers.ts` | Used by `userService.ts` for `user_profiles` junction -- KEEP |
| `userService.ts` user_profiles operations | User profile name assignments -- KEEP |
| `User.profiles` field | String array of profile names on User type -- KEEP |
| Database tables (profiles, profile_templates, etc.) | DB schema -- out of scope |
| Database types in `database.types.ts` | Mirror live DB -- out of scope |
| SQL migrations referencing profiles | DB migration history -- immutable |

### Patterns to Follow
- Services are deleted as whole files
- Barrel exports are removed as blocks
- Mapper functions are removed individually
- Test blocks are removed individually
- Imports are updated to remove unused symbols

## Constraints

### Performance
- No performance impact -- removing dead code only

### Platform
- No platform constraints

### Dependencies
- `profileService.ts` imports from `crudFactory.ts`, `uuid.ts`, and `userService.ts` (creatorExists). Removing the file does NOT affect these dependencies.
- `profileTemplateService.ts` imports from `debounce.ts`, `crudFactory.ts`, `uuid.ts`, and `userService.ts` (creatorExists). Removing the file does NOT affect these dependencies.

## Risk Assessment

### Technical Risks
| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Accidentally removing code used by userService | High | Low | Carefully verify: `UserProfileRow` and `toUser` must be kept. They handle `user_profiles` junction, not `profiles` table. |
| Breaking mappers.test.ts import line | Medium | Low | Update import to remove only `toProfile` and `toProfileTemplate`, keep all other imports |
| Tree-shaking already removes dead code at build | Low | Medium | True at build time, but removing source code improves DX (grep noise, IDE autocomplete, code review surface) |

### Complexity
- **Level:** Simple
- **Rationale:** Pure dead code removal. No runtime behavior changes. No cascading effects. All changes are deletions or import cleanups. The only subtlety is ensuring `UserProfileRow` and `user_profiles`-related code in `mappers.ts` and `userService.ts` is NOT touched, since those handle user-to-profile-name assignments (a different concept from the `profiles` table entity).

## Open Questions

- [x] Q1: Is the `Profile` type interface also unused?
  - Resolution: NO. The `Profile` type is used by `filterUtils.ts`, `WelcomeHeader.tsx`, `KPISection.tsx`, and their tests. These are optional profile-filtering features that are wired into the component props but never actually connected (no parent passes profile data). Removing the type would be a larger refactor and is out of scope for this bug.

- [x] Q2: Is `profileTemplateService.ts` also unused?
  - Resolution: YES. `profileTemplateService.ts` has zero consumers outside the barrel export. It should be removed alongside `profileService.ts`.

- [x] Q3: Should we also remove the database tables?
  - Resolution: NO. Database schema changes require migrations and are a separate concern. The tables exist in the live Supabase instance and removing them requires a new migration file. Out of scope.

- [x] Q4: Should we remove `database.types.ts` entries for profiles/profile_templates/profile_role_tags?
  - Resolution: NO. `database.types.ts` is designed to mirror the actual database schema. Since we are NOT removing the database tables, the types should stay to keep the file in sync with the DB. If tables are dropped later, the types file should be regenerated.

## Recommended Approach

### Implementation Strategy

Delete-and-clean approach:
1. Delete `profileService.ts` (162 lines)
2. Delete `profileTemplateService.ts` (277 lines)
3. Clean barrel export `index.ts` (remove 2 export blocks, ~18 lines)
4. Clean `mappers.ts` (remove 2 mapper functions, row types, joined types, update imports; ~40 lines)
5. Clean `mappers.test.ts` (remove 2 test blocks, update imports; ~55 lines)
6. Run `npx tsc -b` to verify no type errors
7. Run `npx vitest run` to verify all tests pass

### Order of Work
1. Delete the two service files
2. Remove barrel exports from `index.ts`
3. Clean up `mappers.ts` (remove functions, types, imports)
4. Clean up `mappers.test.ts` (remove test blocks, imports)
5. Verify TypeScript compilation
6. Verify tests pass

### What to Defer
- `Profile` type removal from `types/index.ts`
- `ProfileTemplate` type removal from `types/index.ts`
- `filterUtils.ts` removal (and its test file)
- Optional profile props removal from `WelcomeHeaderProps` and `KPISectionProps`
- WelcomeHeader and KPISection profile selector UI removal
- Database table removal (requires migration)
- `database.types.ts` profile entries removal

### Expected Impact
- **Lines removed:** ~535 (162 + 277 + 18 + 40 + 55 - some import line adjustments)
- **Files deleted:** 2 (`profileService.ts`, `profileTemplateService.ts`)
- **Files modified:** 3 (`index.ts`, `mappers.ts`, `mappers.test.ts`)
- **Tests removed:** 2 test blocks (toProfile: 1 test, toProfileTemplate: 1 test)
- **Net test count:** ~631 (633 - 2)
- **Runtime behavior change:** NONE

## Exact Changes List

### File: `src/services/supabase/profileService.ts`
- **Action:** DELETE entire file

### File: `src/services/supabase/profileTemplateService.ts`
- **Action:** DELETE entire file

### File: `src/services/supabase/index.ts`
- **Action:** Remove lines 49-67 (Profile Service and Profile Template Service export blocks)

### File: `src/services/supabase/mappers.ts`
- **Action:** Remove from import line 15: `Profile`
- **Action:** Remove from import line 16: `ProfileTemplate`
- **Action:** Remove type alias line 35: `type ProfileRow = ...`
- **Action:** Remove type alias line 36: `type ProfileRoleTagRow = ...`
- **Action:** Remove type alias line 37: `type ProfileTemplateRow = ...`
- **Action:** Remove type alias line 38: `type ProfileTemplateStepRow = ...`
- **Action:** Remove re-exports lines 52-55: `ProfileRow, ProfileRoleTagRow, ProfileTemplateRow, ProfileTemplateStepRow`
- **Action:** Remove joined type line 72: `export type ProfileWithTags = ...`
- **Action:** Remove joined type line 75: `export type ProfileTemplateWithSteps = ...`
- **Action:** Remove mapper function lines 220-232: `toProfile()` (including JSDoc)
- **Action:** Remove mapper function lines 234-256: `toProfileTemplate()` (including JSDoc)

### File: `src/services/supabase/mappers.test.ts`
- **Action:** Remove `toProfile` from import line 17
- **Action:** Remove `toProfileTemplate` from import line 18
- **Action:** Remove test block lines 285-306: `describe('toProfile', ...)`
- **Action:** Remove test block lines 308-334: `describe('toProfileTemplate', ...)`

## Next Step

**All questions resolved.**
Run `/plan profiles-cleanup` to create implementation plan.
