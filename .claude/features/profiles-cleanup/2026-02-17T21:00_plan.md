# Plan: profiles-cleanup

## Metadata
- **Feature:** profiles-cleanup (Bug #39)
- **Created:** 2026-02-17T21:00
- **Status:** plan-complete
- **Based on:** 2026-02-17T21:00_research.md
- **Complexity:** Simple (dead code removal, no runtime behavior change)

## Architecture Overview

This is a pure deletion task. Two unused Supabase service files and their supporting mapper/test code are removed. No new code is written.

```
BEFORE                               AFTER
src/services/supabase/               src/services/supabase/
  index.ts (8 service blocks)          index.ts (6 service blocks)
  mappers.ts (14 row types,            mappers.ts (10 row types,
    8 mappers, 4 joined types)           6 mappers, 2 joined types)
  mappers.test.ts (10 describes)       mappers.test.ts (8 describes)
  profileService.ts (162 lines)        [DELETED]
  profileTemplateService.ts (277)      [DELETED]
```

## Tech Stack
- No new dependencies
- No new patterns
- Uses existing Vitest + tsc for validation

## File Structure

### Files to DELETE (2)
| File | Lines | Purpose |
|------|-------|---------|
| `src/services/supabase/profileService.ts` | 162 | Unused CRUD for `profiles` table |
| `src/services/supabase/profileTemplateService.ts` | 277 | Unused CRUD for `profile_templates` table |

### Files to MODIFY (3)
| File | Changes |
|------|---------|
| `src/services/supabase/index.ts` | Remove 2 export blocks (lines 49-67, ~19 lines) |
| `src/services/supabase/mappers.ts` | Remove 2 imports, 4 row types, 4 re-exports, 2 joined types, 2 mapper functions; update `toStep` union type (~40 lines) |
| `src/services/supabase/mappers.test.ts` | Remove 2 imports, 2 describe blocks (~55 lines) |

### Files to KEEP (explicitly NOT touching)
- `src/types/index.ts` -- `Profile` and `ProfileTemplate` interfaces used by components
- `src/types/database.types.ts` -- mirrors live DB schema
- `src/utils/filterUtils.ts` -- uses `Profile` type, out of scope
- `src/services/supabase/userService.ts` -- uses `UserProfileRow`, unrelated to `profiles` table
- `src/services/supabase/mappers.ts` line 41 `UserProfileRow` -- used by `userService.ts`
- `src/services/supabase/mappers.ts` line 58 `UserProfileRow` re-export -- used by `userService.ts`
- `src/services/supabase/mappers.ts` line 78 `UserWithJunctions` -- uses `UserProfileRow`, keep

## Detailed Changes

### 1. mappers.ts -- Import line update
**Current (lines 14-16):**
```ts
  Profile,
  ProfileTemplate,
  Step,
```
**After:** Remove `Profile` and `ProfileTemplate` from the import.

### 2. mappers.ts -- Row type aliases
**Remove lines 35-38:**
```ts
type ProfileRow = Database['public']['Tables']['profiles']['Row'];
type ProfileRoleTagRow = Database['public']['Tables']['profile_role_tags']['Row'];
type ProfileTemplateRow = Database['public']['Tables']['profile_templates']['Row'];
type ProfileTemplateStepRow = Database['public']['Tables']['profile_template_steps']['Row'];
```

### 3. mappers.ts -- Re-exports
**Remove from export block (lines 52-55):**
```ts
  ProfileRow,
  ProfileRoleTagRow,
  ProfileTemplateRow,
  ProfileTemplateStepRow,
```

### 4. mappers.ts -- Joined types
**Remove lines 71-75:**
```ts
/** Profile row with joined profile_role_tags rows. */
export type ProfileWithTags = ProfileRow & { profile_role_tags: ProfileRoleTagRow[] };

/** Profile template row with joined profile_template_steps rows. */
export type ProfileTemplateWithSteps = ProfileTemplateRow & { profile_template_steps: ProfileTemplateStepRow[] };
```

### 5. mappers.ts -- toStep union type
**Current (line 116):**
```ts
export function toStep(row: TemplateStepRow | InstanceStepRow | ProfileTemplateStepRow): Step {
```
**After:**
```ts
export function toStep(row: TemplateStepRow | InstanceStepRow): Step {
```
(ProfileTemplateStepRow removed from union since the type alias no longer exists and no caller passes it)

### 6. mappers.ts -- Mapper functions
**Remove lines 220-256:**
- `toProfile()` function (lines 220-232, including JSDoc)
- `toProfileTemplate()` function (lines 234-256, including JSDoc)

### 7. index.ts -- Export blocks
**Remove lines 49-67:**
```ts
// -- Profile Service --
export { ... } from './profileService';

// -- Profile Template Service --
export { ... } from './profileTemplateService';
```

### 8. mappers.test.ts -- Import updates
**Remove `toProfile` and `toProfileTemplate` from import (lines 17-18)**

### 9. mappers.test.ts -- Test blocks
**Remove lines 285-334:**
- `describe('toProfile', ...)` block
- `describe('toProfileTemplate', ...)` block

## Testing Strategy

No new tests are needed. This is a removal-only change.

**Validation:**
- `npx tsc -b` -- TypeScript compiles cleanly (no dangling references)
- `npx vitest run` -- All remaining tests pass
- Expected test count: ~631 (633 minus 2 removed tests)

## Implementation Notes

### Key Decision: toStep signature
The `toStep` function accepts `TemplateStepRow | InstanceStepRow | ProfileTemplateStepRow`. Since we are removing `ProfileTemplateStepRow`, we must also narrow the union type to `TemplateStepRow | InstanceStepRow`. This is safe because:
1. The only caller that passed `ProfileTemplateStepRow` was inside `toProfileTemplate()`, which is also being removed.
2. The function body only accesses fields common to all step row types (`position`, `title`, `description`, `role`, `owner`, `expert`, `status`, `link`).

### Order Matters
Edit `mappers.ts` before deleting the service files, so `tsc` can still resolve imports during incremental checks. In practice, since we delete files and edit in one pass, the order doesn't strictly matter -- but the task list reflects logical dependency order.

## Non-Goals
- Removing `Profile`/`ProfileTemplate` type interfaces from `types/index.ts`
- Removing `filterUtils.ts` or component-level profile prop usage
- Dropping database tables or modifying `database.types.ts`
- Writing any new code or tests

## Expected Impact
- **Lines removed:** ~535
- **Files deleted:** 2
- **Files modified:** 3
- **Tests removed:** 2 (toProfile, toProfileTemplate)
- **Net test count change:** -2
- **Runtime behavior change:** NONE
