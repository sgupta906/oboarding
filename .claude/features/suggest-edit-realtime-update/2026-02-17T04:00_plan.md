# Plan: suggest-edit-realtime-update

**Feature:** suggest-edit-realtime-update
**Date:** 2026-02-17T04:00
**Status:** complete
**Based on:** 2026-02-17T04:00_research.md

---

## Architecture Overview

```
Employee clicks "Submit Suggestion"
        |
        v
OnboardingHub.handleSuggestEdit()
        |
        +--> createSuggestion({...})  -- writes to DB, returns ID
        |
        +--> store._addSuggestion({   -- NEW: optimistic local update
        |      id, stepId, user,
        |      text, status, createdAt,
        |      instanceId
        |    })
        |
        v
  Zustand store.suggestions updated
        |
        v
  useSuggestions hook re-renders consumers
        |
        v
  StepCard shows amber "Feedback Sent" badge IMMEDIATELY
        |
        ... later ...
        |
  Realtime subscription fires --> full array replacement (dedup automatic)
```

## Tech Stack

- Zustand (existing store)
- TypeScript (existing types)
- Vitest + React Testing Library (existing test infra)

## File Structure

### Modified Files

| File | Change | Lines |
|------|--------|-------|
| `src/store/useOnboardingStore.ts` | Add `_addSuggestion` to SuggestionsSlice interface (after line 155) and implementation (after line 638) | ~6 lines |
| `src/components/OnboardingHub.tsx` | After `createSuggestion()` call, construct Suggestion and call `_addSuggestion` | ~10 lines |

### New Files

None.

### Database Changes

None.

## Detailed Changes

### 1. `src/store/useOnboardingStore.ts`

**Interface addition** (SuggestionsSlice, after `_rollbackSuggestions`):
```typescript
/** Optimistically appends a newly created suggestion to the store. */
_addSuggestion: (suggestion: Suggestion) => void;
```

**Implementation addition** (after `_rollbackSuggestions` implementation):
```typescript
_addSuggestion: (suggestion: Suggestion) => {
  set((state) => ({ suggestions: [...state.suggestions, suggestion] }));
},
```

### 2. `src/components/OnboardingHub.tsx`

**Import addition:** Add `useOnboardingStore` import.

**In `handleSuggestEdit`:** Capture the returned ID and call store action:
```typescript
const newId = await createSuggestion({
  stepId: activeModal.stepId,
  user: employeeInstance.employeeName,
  text: text.trim(),
  status: 'pending',
  instanceId: employeeInstance.id,
});

// Optimistic store update -- badge appears immediately
useOnboardingStore.getState()._addSuggestion({
  id: newId,
  stepId: activeModal.stepId,
  user: employeeInstance.employeeName,
  text: text.trim(),
  status: 'pending',
  createdAt: Date.now(),
  instanceId: employeeInstance.id,
});
```

Note: Using `useOnboardingStore.getState()` (outside React render) is the standard Zustand pattern for calling actions from event handlers. This is consistent with how other slices work.

## Testing Strategy

### Unit Tests (2 tests)

1. **Store test:** `_addSuggestion` appends a suggestion to the store's suggestions array
2. **Store test:** `_addSuggestion` preserves existing suggestions (no mutation)

### Integration Test (1 test)

3. **OnboardingHub test:** After calling `handleSuggestEdit`, the suggestion appears in the store immediately (verifies the wiring between OnboardingHub and store)

**Total new tests:** ~3
**Expected test count after:** ~543

## Non-Goals

- No deduplication logic (Realtime does full array replacement)
- No rollback on `createSuggestion` failure (existing error toast is sufficient)
- No changes to the Realtime subscription
- No changes to the Suggestion type
