# Research: suggest-edit-realtime-update

**Feature:** suggest-edit-realtime-update
**Date:** 2026-02-17T04:00
**Status:** complete

---

## Bug Description

After an employee submits a suggestion via the "Suggest Edit" modal, the amber "Feedback Sent" badge does NOT appear on the step card until the page is reloaded. The suggestion is successfully written to the database, but the local Zustand store is never updated.

## Root Cause

`OnboardingHub.handleSuggestEdit` (line 136-160) calls `createSuggestion()` from `suggestionService.ts`, which inserts the row into the `suggestions` table and returns the new row ID. However, the function does not update the Zustand store's `suggestions` array afterward.

The `SuggestionsSlice` in `useOnboardingStore.ts` has these optimistic actions:
- `_optimisticUpdateSuggestionStatus` -- updates status of existing suggestion
- `_optimisticRemoveSuggestion` -- removes a suggestion
- `_rollbackSuggestions` -- restores snapshot

But there is NO `_addSuggestion` action to append a new suggestion to the store.

The Realtime subscription eventually replaces the full array via `subscribeToSuggestions`, but this depends on the Realtime channel delivering the event, which may be delayed or (in dev-auth mode) may not fire at all.

## Affected Files

1. **`src/store/useOnboardingStore.ts`** -- SuggestionsSlice interface (line 126-156) and implementation (line 570-638). Missing `_addSuggestion` action.
2. **`src/components/OnboardingHub.tsx`** -- `handleSuggestEdit` (line 136-160). Calls `createSuggestion()` but does not update store.

## Existing Patterns

The InstancesSlice already has `_addInstance` (line 55, 283-287) which follows the exact pattern needed:
```typescript
_addInstance: (instance: OnboardingInstance) => {
  set((state) => ({
    instances: [...state.instances, instance],
  }));
},
```

The `handleSuggestEdit` handler already has all the data needed to construct a full `Suggestion` object:
- `activeModal.stepId` -- the step ID
- `employeeInstance.employeeName` -- the user name
- `text.trim()` -- the suggestion text
- `employeeInstance.id` -- the instance ID
- The returned ID from `createSuggestion()`
- `Date.now()` -- the creation timestamp

## Fix Approach

1. Add `_addSuggestion` action to `SuggestionsSlice` interface and implementation
2. After `createSuggestion()` resolves in `handleSuggestEdit`, construct a `Suggestion` object and call `_addSuggestion`

No deduplication logic is needed because the Realtime subscription does a full array replacement via `crud.list()` (from `crudFactory.ts`), which will overwrite the optimistic entry with the authoritative server data.

## Service Return Type

`createSuggestion()` returns `Promise<string>` -- the `id` field from the inserted `SuggestionRow`. The `Suggestion.id` type is `number | string`, so the returned string is compatible.

## Risk Assessment

**Low risk.** This is a 2-file, ~15-line change following an established pattern (`_addInstance`). No database migration, no new dependencies, no breaking changes.
