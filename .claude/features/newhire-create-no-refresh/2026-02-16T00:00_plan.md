# Plan: newhire-create-no-refresh

## Metadata
- **Feature:** newhire-create-no-refresh (Bug #4 of 6 in bugfix-round)
- **Created:** 2026-02-16T00:00
- **Status:** plan-complete
- **Based On:** 2026-02-16T00:00_research.md

## Architecture Overview

### Current Data Flow (broken)

```
User submits form
    |
    v
CreateOnboardingModal.onSubmit(formData)
    |
    v
ManagerView.handleSubmitOnboarding
    |
    v
useCreateOnboarding.mutate(formData)
    |
    v
createOnboardingRunFromTemplate(data) --> Supabase INSERT
    |
    v
setData(result)  <-- LOCAL useState only, NOT in Zustand store
    |
    v
Success toast + close modal
    |
    v
NewHiresPanel reads store.instances --> STALE (new instance missing)
```

### Fixed Data Flow

```
User submits form
    |
    v
CreateOnboardingModal.onSubmit(formData)
    |
    v
ManagerView.handleSubmitOnboarding
    |
    v
useCreateOnboarding.mutate(formData)
    |
    v
createOnboardingRunFromTemplate(data) --> Supabase INSERT
    |
    v
setData(result)  <-- local state (unchanged)
    |
    +-- NEW --> useOnboardingStore.getState()._addInstance(result)
    |                  |
    |                  v
    |           set(state => ({ instances: [...state.instances, result] }))
    |                  |
    |                  v
    |           NewHiresPanel re-renders with new instance  <-- INSTANT
    |
    v
Success toast + close modal
    |
    v
(Later) Realtime subscription fires --> replaces instances array (dedup safe)
```

## Tech Stack Summary

- **Store:** Zustand (already in use, 5 slices)
- **Pattern:** Optimistic append (same as `_createUser` in UsersSlice)
- **No new dependencies**

## Files to Modify

### Modified Files

| File | Lines | Change |
|------|-------|--------|
| `src/store/useOnboardingStore.ts` | Interface: line 52 (after `_startInstancesSubscription`), Impl: line 276 (after `_startInstancesSubscription` closing brace) | Add `_addInstance` action to InstancesSlice interface and implementation |
| `src/hooks/useCreateOnboarding.ts` | Lines 40-41 (after `setData(result)`) | Import store, call `_addInstance(result)` after successful creation |
| `src/store/useOnboardingStore.test.ts` | After line 306 (end of InstancesSlice tests, before StepsSlice) | Add tests for `_addInstance` action |

### Files NOT Modified (confirmed no changes needed)

| File | Reason |
|------|--------|
| `src/views/ManagerView.tsx` | Already reads from `useOnboardingInstances()` which reads store |
| `src/components/manager/NewHiresPanel.tsx` | Already reads from `useOnboardingInstances()` which reads store |
| `src/components/modals/CreateOnboardingModal.tsx` | Pure UI form, no state logic |
| `src/services/supabase/instanceService.ts` | Service layer works correctly |

## Exact Changes

### 1. Store Interface (useOnboardingStore.ts, ~line 52)

Add `_addInstance` to the `InstancesSlice` interface, after `_startInstancesSubscription`:

```typescript
/** Optimistically appends a newly created instance to the store. */
_addInstance: (instance: OnboardingInstance) => void;
```

### 2. Store Implementation (useOnboardingStore.ts, ~line 276)

Add implementation after the `_startInstancesSubscription` method (before `// -- StepsSlice state --`):

```typescript
_addInstance: (instance: OnboardingInstance) => {
  set((state) => ({
    instances: [...state.instances, instance],
  }));
},
```

This follows the exact same pattern as `_createUser` (line 435-446) which does `set((state) => ({ users: [...state.users, newUser] }))`.

### 3. Hook Change (useCreateOnboarding.ts, ~line 40-41)

Add import at top of file:
```typescript
import { useOnboardingStore } from '../store/useOnboardingStore';
```

After `setData(result)` on line 41, add:
```typescript
useOnboardingStore.getState()._addInstance(result);
```

## Deduplication Safety

When the Realtime subscription eventually fires (INSERT event on `onboarding_instances`), it triggers `list()` which fetches ALL instances and calls `set({ instances })`, completely replacing the array. The optimistically-added instance gets replaced by the server-fetched version. No duplicates possible.

This is identical to how `_createUser` works -- optimistic local append, then Realtime replaces the full list.

## Testing Strategy

### Unit Tests (3 new tests in useOnboardingStore.test.ts)

1. **`_addInstance appends to instances array`** -- Pre-populate store with one instance, call `_addInstance` with a new instance, verify array has two entries.

2. **`_addInstance works on empty array`** -- Start with empty instances, call `_addInstance`, verify array has one entry.

3. **`_addInstance is available as a function`** -- Verify the action exists on the store (consistent with existing initialization tests).

### Existing Test Verification

All 432 existing tests must continue to pass. The changes are additive (new store action, one extra line in hook). No existing behavior is modified.

## Implementation Notes

### Decisions
- **Option A chosen (store action)** over Option B (view-level push) because it centralizes the store update in the hook, not the view. This is consistent with `_createUser` being in the store rather than in the view that calls it.
- **No `useCallback` dependency change** needed in `useCreateOnboarding.mutate` because `useOnboardingStore.getState()` is called imperatively (not a hook dependency).

### Patterns Followed
- Action name prefix: `_` for internal actions (matches `_createUser`, `_editUser`, `_removeUser`, etc.)
- Optimistic append pattern: `set((state) => ({ instances: [...state.instances, newItem] }))`
- Imperative store access: `useOnboardingStore.getState()._addInstance(result)` (same pattern as `_updateStepStatus` calls in useSteps)

### Trade-offs
- We are NOT adding error handling / rollback for the optimistic append because the Supabase INSERT has already succeeded by the time we call `_addInstance`. If the INSERT fails, the hook's existing `catch` block handles it and `_addInstance` is never called.

## Non-Goals

- **Not fixing Realtime server-side configuration** -- that is tracked separately in MEMORY.md
- **Not adding delete functionality** -- that is bug #6 (`no-instance-delete`)
- **Not refactoring `useCreateOnboarding` to be a store action** -- the hook pattern works fine for create operations that have complex error message conversion
- **Not adding integration tests for the hook** -- the hook already works correctly; only the store connection is missing
