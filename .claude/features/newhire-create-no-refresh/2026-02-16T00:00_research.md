# Research: newhire-create-no-refresh

## Metadata
- **Feature:** newhire-create-no-refresh (Bug #4 of 6 in bugfix-round)
- **Created:** 2026-02-16T00:00
- **Status:** research-complete
- **Researcher:** research-agent

## Feature Context
- **Bug:** New Hires table doesn't refresh after creating a hire -- only shows after full page reload
- **Priority:** P1 HIGH
- **Suspected Root Cause (from STATUS.md):** `onRefreshInstances` callback not passed from `OnboardingHub` to `ManagerView`
- **Actual Root Cause (from analysis):** The `useCreateOnboarding` hook does NOT update the Zustand store after creating an instance. The Realtime subscription SHOULD pick it up, but the create-and-display path has no store integration.

## Requirements

### Functional Requirements
- [ ] FR1: After creating a new hire via the CreateOnboardingModal, the New Hires table must display the new entry without a page reload
- [ ] FR2: The KPI section on the dashboard tab must reflect the new instance immediately
- [ ] FR3: The EmployeeSelector dropdown (when manager views employee tab) must include the new instance

### Technical Requirements
- [ ] TR1: The Zustand instances slice must be updated after a successful `createOnboardingRunFromTemplate` call
- [ ] TR2: The fix must not break the existing Realtime subscription (which should eventually deliver the same data)
- [ ] TR3: The fix should follow the established optimistic update pattern used in other slices

### Constraints
- Must work within the existing Zustand store architecture (ref-counted subscriptions)
- Must not introduce duplicate instance entries (optimistic + Realtime delivering the same row)

## Root Cause Analysis

### End-to-End Flow Trace

**Step 1: User clicks "+ New Hire" button**
- Location: `src/components/manager/ManagerDashboardHeader.tsx` line 28
- Calls `onNewHireClick` prop, which is `handleOpenCreateOnboarding` in ManagerView (line 142)

**Step 2: User fills form and submits**
- Location: `src/components/modals/CreateOnboardingModal.tsx` line 138-161
- Calls `onSubmit(formData)` prop, which is `handleSubmitOnboarding` in ManagerView (line 154)

**Step 3: ManagerView.handleSubmitOnboarding calls useCreateOnboarding.mutate**
- Location: `src/views/ManagerView.tsx` line 154-170
```typescript
const handleSubmitOnboarding = async (formData: OnboardingFormData) => {
    try {
      await createOnboarding(formData);     // <-- calls useCreateOnboarding.mutate
      setSuccessMessage(`Onboarding created for ${formData.employeeName}`);
      setTimeout(() => {
        handleCloseCreateOnboarding();
        setSuccessMessage(null);
      }, 1500);
    } catch (err) {
      // Error state is managed by the hook and displayed in the modal
    }
  };
```

**Step 4: useCreateOnboarding.mutate calls createOnboardingRunFromTemplate**
- Location: `src/hooks/useCreateOnboarding.ts` line 34-51
```typescript
const mutate = useCallback(
    async (employeeData: CreateOnboardingRunInput): Promise<OnboardingInstance> => {
      setIsLoading(true);
      setError(null);
      try {
        const result = await createOnboardingRunFromTemplate(employeeData);
        setData(result);           // <-- stores result in LOCAL useState
        setIsLoading(false);
        return result;
      } catch (err) { ... }
    }, []);
```

**Step 5: createOnboardingRunFromTemplate inserts into Supabase**
- Location: `src/services/supabase/instanceService.ts` lines 323-382
- Calls `createOnboardingInstance()` which inserts into `onboarding_instances` table + `instance_steps` table
- Returns the created `OnboardingInstance` object

**THE BUG IS HERE -- Step 6: Nothing updates the Zustand store**

After the service call succeeds:
1. `useCreateOnboarding` stores the result in its own `useState` (line 41: `setData(result)`) -- this is local to the hook and NOT connected to the Zustand store
2. `handleSubmitOnboarding` shows a success message and closes the modal after 1.5s
3. **No code calls the Zustand store to add the new instance to `instances[]`**

### Why the Realtime subscription SHOULD fix this (but may not)

The instances subscription in the Zustand store uses `subscribeToOnboardingInstances` from the crudFactory:
- File: `src/services/supabase/instanceService.ts` line 62
- Channel: `instances-all` (line 55)
- Listens on: `onboarding_instances` table AND `instance_steps` table (lines 56-57)

When a new row is inserted into `onboarding_instances`, the Realtime channel should fire, triggering a debounced `list()` re-fetch (crudFactory.ts line 142-143), which fetches all instances and calls the callback, which the store sets as the new `instances` array.

**Potential Realtime issues:**
1. The Realtime subscription may not be working at all (see bug #2 `realtime-websocket-fail` -- it was "fixed" but server-side config still needs manual verification)
2. The 300ms debounce might cause a perceptible delay
3. If the subscription channel errored or timed out, no update would arrive

**However**, even if Realtime IS working, there's a poor UX: the user creates a new hire, sees a success message, the modal closes, and then... nothing changes for 300ms+ until the Realtime event triggers a full re-fetch. This is inconsistent with the optimistic update patterns used everywhere else in the app (steps, users, suggestions all have optimistic updates).

### Two Consumers of Instance Data in ManagerView

Both ManagerView and NewHiresPanel call `useOnboardingInstances()`:

1. **ManagerView** (line 56): `const { data: onboardingInstances } = useOnboardingInstances();`
   - Used for KPI calculations, managerSteps derivation, stuckEmployeeNames
2. **NewHiresPanel** (line 67): `const { data } = useOnboardingInstances();`
   - Used for the table display

Both read from the same Zustand store via the `useOnboardingInstances` hook, which reads `store.instances`. So if the store is updated, BOTH consumers will re-render.

### Confirmed: No Store Update After Creation

The `useCreateOnboarding` hook (line 40-41):
```typescript
const result = await createOnboardingRunFromTemplate(employeeData);
setData(result);  // <-- local useState only!
```

There is NO call to:
- `useOnboardingStore.getState()` to push the new instance
- Any store action like `_addInstance` (which doesn't exist)
- Any manual re-fetch of the instances list

## The Fix

### Primary Fix: Add the created instance to the Zustand store optimistically

After `createOnboardingRunFromTemplate` returns the new `OnboardingInstance`, push it into the store's `instances` array. This gives instant UI feedback.

**Option A (Recommended): Add an `_addInstance` action to the store**

Add to `useOnboardingStore.ts`:
```typescript
_addInstance: (instance: OnboardingInstance) => {
  set((state) => ({
    instances: [...state.instances, instance],
  }));
},
```

Then in `useCreateOnboarding.ts`, after the service call succeeds:
```typescript
const result = await createOnboardingRunFromTemplate(employeeData);
useOnboardingStore.getState()._addInstance(result);
```

This is consistent with the pattern in `_createUser` (store line 435-446) which does the same thing for users.

**Option B: Have ManagerView push the instance into the store**

In `handleSubmitOnboarding`:
```typescript
const newInstance = await createOnboarding(formData);
useOnboardingStore.getState()._addInstance(newInstance);
```

Option A is cleaner because it centralizes the store update in the hook, not the view.

### Deduplication Concern

When the Realtime subscription fires (after the INSERT), it will call `list()` which fetches ALL instances including the new one. This will REPLACE the entire `instances` array via `set({ instances })`, so the optimistically-added instance will be replaced by the server-fetched version. No duplicates.

This is the same pattern used by `_createUser` in the store (line 439): optimistic local append, then Realtime replaces the full list.

## Existing Code Analysis

### Project State
- Project exists: YES
- Zustand migration complete (5/5 slices)
- All 5 slices are in a single file: `src/store/useOnboardingStore.ts`

### Code to Modify

| File | What Changes | Lines |
|------|-------------|-------|
| `src/store/useOnboardingStore.ts` | Add `_addInstance` action to InstancesSlice interface and implementation | Interface ~line 52, impl ~line 276 |
| `src/hooks/useCreateOnboarding.ts` | After successful creation, call `_addInstance` to push into store | ~line 40-41 |

### Code That Does NOT Need Changes

| File | Why No Change Needed |
|------|---------------------|
| `src/views/ManagerView.tsx` | Already calls `useOnboardingInstances()` which reads from store |
| `src/components/manager/NewHiresPanel.tsx` | Already calls `useOnboardingInstances()` which reads from store |
| `src/components/OnboardingHub.tsx` | Already calls `useOnboardingInstances(isManager)` which reads from store |
| `src/services/supabase/instanceService.ts` | Service layer is correct -- creates the instance and returns it |
| `src/components/modals/CreateOnboardingModal.tsx` | Form/UI is correct |

### Patterns to Follow
- **Optimistic append pattern:** Same as `_createUser` in the store (line 435-446)
- **Store action naming:** Prefixed with `_` for internal actions (e.g., `_addInstance`)
- **Hook imports store directly:** `useOnboardingStore.getState()._addInstance(result)` (same as how `useSteps` calls `_updateStepStatus`)

## Risk Assessment

### Technical Risks
| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Realtime subscription not working (server-side not configured) | Medium -- optimistic update still shows the instance, but if user refreshes and Realtime is broken, data disappears until next list() call | Medium | The optimistic add is the fix; Realtime is a bonus. The subscription does an initial `list()` fetch on mount, so data loads on refresh regardless. |
| Duplicate entries if Realtime fires before optimistic update renders | Low -- Zustand set() is synchronous, React batches renders | Very Low | The Realtime callback replaces the entire array, so even if both fire, the final state is correct. |
| createOnboardingRunFromTemplate returns instance without DB-generated fields | Low -- the function constructs the full OnboardingInstance with all fields before returning | Very Low | The function at instanceService.ts:378-381 returns `{ id: instanceId, ...newInstanceData }` which includes all fields. |

### Complexity
- **Level:** Simple
- **Rationale:** Two files need changes. One new store action (3 lines), one import + one function call in the hook (2 lines). Total: ~8 lines of code. Pattern already established by `_createUser`.

## Open Questions

All questions resolved through code analysis:

- [x] Q1: Is this a props-not-passed issue as STATUS.md suggests?
  - Resolution: NO. The original diagnosis was for the pre-Zustand architecture. After the Zustand cleanup, ManagerView and NewHiresPanel both read from the store directly. The real issue is that `useCreateOnboarding` doesn't update the store after creation.

- [x] Q2: Does Realtime subscription work for instances?
  - Resolution: The subscription IS configured correctly (crudFactory subscribe with channel `instances-all` listening on both `onboarding_instances` and `instance_steps`). However, it depends on server-side Realtime being enabled, which hasn't been verified. The fix should not depend on Realtime -- it should use optimistic updates.

- [x] Q3: Will adding the instance to the store cause duplicates?
  - Resolution: No. The Realtime callback does `set({ instances })` which replaces the entire array. The optimistic entry will be overwritten by the server-fetched list.

- [x] Q4: Should `useCreateOnboarding` be modified or should the store get a new action?
  - Resolution: Both. Add `_addInstance` action to the store (consistent with existing patterns), then call it from `useCreateOnboarding` after the service call succeeds.

## Recommended Approach

### Implementation Strategy

1. Add `_addInstance` action to `InstancesSlice` interface in `useOnboardingStore.ts`
2. Implement `_addInstance` in the store's create() function
3. Import `useOnboardingStore` in `useCreateOnboarding.ts`
4. After `createOnboardingRunFromTemplate` succeeds, call `useOnboardingStore.getState()._addInstance(result)`
5. Write unit tests for the new action

### Order of Work
1. Add `_addInstance` to store interface + implementation (store change)
2. Wire `useCreateOnboarding` to call `_addInstance` after success (hook change)
3. Add unit test for `_addInstance` action
4. Add integration test: create instance -> verify store has it
5. Playwright functional test: create new hire -> verify table shows it without reload

### What to Defer
- Realtime server-side configuration verification (separate concern, tracked in MEMORY.md)
- No need to touch ManagerView, NewHiresPanel, or any other component

## Key File References

| File | Path | Relevance |
|------|------|-----------|
| Zustand Store | `/home/sanjay/Workspace/onboarding/src/store/useOnboardingStore.ts` | Add `_addInstance` action |
| Create Hook | `/home/sanjay/Workspace/onboarding/src/hooks/useCreateOnboarding.ts` | Call `_addInstance` after creation |
| Store Test | `/home/sanjay/Workspace/onboarding/src/store/useOnboardingStore.test.ts` | Add test for `_addInstance` |
| Instance Service | `/home/sanjay/Workspace/onboarding/src/services/supabase/instanceService.ts` | No changes needed (returns full instance) |
| ManagerView | `/home/sanjay/Workspace/onboarding/src/views/ManagerView.tsx` | No changes needed (reads from store) |
| NewHiresPanel | `/home/sanjay/Workspace/onboarding/src/components/manager/NewHiresPanel.tsx` | No changes needed (reads from store) |
| CreateOnboardingModal | `/home/sanjay/Workspace/onboarding/src/components/modals/CreateOnboardingModal.tsx` | No changes needed (pure UI) |

## Next Step

**All questions resolved.** Run `/plan newhire-create-no-refresh` to create implementation plan.
