# Plan: supabase-realtime

## Metadata
- **Feature:** supabase-realtime
- **Created:** 2026-02-14T08:20
- **Status:** plan-complete
- **Based On:** 2026-02-14T08:15_research.md
- **Migration Step:** 4 of 5 (Firebase -> Supabase)

---

## Architecture Overview

### What Changes and Why

This feature completes the Supabase Realtime wiring. Step 2 (supabase-data-layer) already
implemented all 10 subscribe functions using `supabase.channel().on('postgres_changes', ...)`.
However, three gaps remain that prevent Realtime from working end-to-end:

1. **Database publication config** -- Supabase Realtime requires tables to be added to the
   `supabase_realtime` publication. Without this, `postgres_changes` events never fire on a
   live instance. A new migration (00007) adds all 16 tables.

2. **`useSuggestions` still polls** -- The only hook that uses `setInterval` instead of a
   Realtime subscription. The `suggestionService.ts` lacks a `subscribeToSuggestions` function.
   This must be added and the hook converted.

3. **Stale comments** -- Several hooks and services still reference "Firebase", "Firestore",
   "dataClient", or "localStorage fallback" in their JSDoc comments. These are misleading
   after three migration steps.

### What Does NOT Change

- No component render logic changes
- No TypeScript type changes
- No auth-related file changes
- No rewriting of the 10 existing subscribe functions
- No new patterns invented -- everything follows established patterns

### Data Flow (Before vs After)

```
BEFORE (useSuggestions):
  Component mount -> listSuggestions() -> setData
                  -> setInterval(5s) -> listSuggestions() -> setData
                  -> setInterval(5s) -> listSuggestions() -> setData
                  ...
  Component unmount -> clearInterval

AFTER (useSuggestions):
  Component mount -> subscribeToSuggestions(callback)
                       -> listSuggestions() -> callback -> setData    (initial fetch)
                       -> channel.on('postgres_changes') -> listSuggestions() -> callback -> setData
                       ...
  Component unmount -> supabase.removeChannel(channel)
```

All other hooks already use the "AFTER" pattern.

---

## Tech Stack Summary

| Layer | Technology | Relevant to This Feature |
|-------|-----------|--------------------------|
| Database | PostgreSQL (via Supabase) | Migration 00007 |
| Realtime | Supabase Realtime (postgres_changes) | All subscribe functions |
| Services | TypeScript modules in `src/services/supabase/` | `suggestionService.ts` |
| Hooks | React custom hooks in `src/hooks/` | `useSuggestions.ts` |
| Tests | Vitest + React Testing Library | `useSuggestions.test.ts` |

---

## File Structure

### New Files

| File | Purpose | Est. Lines |
|------|---------|------------|
| `supabase/migrations/00007_enable_realtime.sql` | Add all 16 tables to `supabase_realtime` publication | ~30 |

### Modified Files

| File | Lines | Change Description |
|------|-------|--------------------|
| `src/services/supabase/suggestionService.ts` | +25 | Add `subscribeToSuggestions` function (lines 87+) |
| `src/services/supabase/index.ts` | +1, ~1 | Add `subscribeToSuggestions` to barrel exports; update stale comment on line 8 |
| `src/hooks/useSuggestions.ts` | ~30 rewrite | Replace polling with subscription pattern (lines 1-78) |
| `src/hooks/useSuggestions.test.ts` | ~60 rewrite | Replace polling mocks with subscription mocks (lines 1-159) |
| `src/hooks/useRoles.ts` | 3 lines | Update stale comments on lines 6, 39, 55 |
| `src/hooks/useCreateOnboarding.ts` | 2 lines | Update stale comment on line 3; update error check on line 109 |
| `src/hooks/useManagerData.ts` | 1 line | Update stale comment on line 2 |
| `src/services/supabase/userService.ts` | 2 lines | Update stale comments on lines 4, 19 |

### Estimated Totals

- 1 new file (SQL migration)
- 8 files modified
- ~130 lines changed
- Net change: approximately -20 lines (polling logic removed, simpler subscription added)

---

## Data Model Changes

### Migration 00007: Enable Realtime Publication

No new tables or columns. This migration adds existing tables to the `supabase_realtime`
publication so that `postgres_changes` events fire.

**Tables to add (all 16):**

```
users, roles, profiles, templates, profile_templates,
onboarding_instances, suggestions, activities,
template_steps, instance_steps, profile_template_steps,
user_roles, user_profiles, profile_role_tags,
instance_profiles, instance_template_refs
```

**REPLICA IDENTITY:** `DEFAULT` is sufficient. All subscribe functions use the "re-fetch on
change" pattern and ignore the event payload. No `REPLICA IDENTITY FULL` needed.

**Rollback strategy:** `ALTER PUBLICATION supabase_realtime DROP TABLE <table_name>` for each
table if needed.

---

## Component Architecture

### Subscribe Function Pattern (Reference: `activityService.ts` lines 64-86)

```
subscribeToSuggestions(callback)
  |
  +-- 1. Initial fetch: listSuggestions().then(callback)
  |
  +-- 2. Channel: supabase.channel('suggestions-all')
  |       .on('postgres_changes', { event: '*', table: 'suggestions' }, re-fetch)
  |       .subscribe()
  |
  +-- 3. Return cleanup: () => supabase.removeChannel(channel)
```

### Hook Pattern (Reference: `useActivities.ts` lines 24-63)

```
useSuggestions(enabled)
  |
  +-- State: { data: Suggestion[], isLoading: boolean, error: Error | null }
  |
  +-- useEffect([enabled]):
  |     if (!enabled) -> reset state, return
  |     unsubscribe = subscribeToSuggestions(callback)
  |     return () -> unsubscribe()
  |
  +-- Return: { data, isLoading, error }
```

### State Management

No changes to state management. The hook API contract remains identical:
- Input: `enabled: boolean` (default `true`)
- Output: `{ data: Suggestion[], isLoading: boolean, error: Error | null }`

---

## Testing Strategy

### Unit Tests (Modified)

| Test File | Tests | Description |
|-----------|-------|-------------|
| `src/hooks/useSuggestions.test.ts` | ~7 | Rewrite to test subscription lifecycle instead of polling |

**Test cases for `useSuggestions` (modeled on `useActivities.test.ts`):**

1. Should initialize with loading state and empty data
2. Should update data when subscription receives suggestions
3. Should handle error gracefully during subscription
4. Should unsubscribe on unmount
5. Should return empty array while loading
6. Should handle empty suggestions array from subscription
7. Should handle multiple suggestion updates

### Existing Tests (Must Continue Passing)

All 654 existing tests must pass unchanged. The only test file being modified is
`useSuggestions.test.ts`. All other test files are unaffected.

### Integration Tests

No new integration tests needed. The subscription pattern is identical to `useActivities`
which is already integration-tested through `useManagerData.ts` and its tests.

### Validation Checklist

- [ ] `npx vitest run` -- all tests pass (654/654)
- [ ] `npx tsc -b` -- zero TypeScript errors
- [ ] `npx vite build` -- build succeeds

---

## Implementation Notes

### Decisions

1. **Follow existing patterns exactly.** The `subscribeToSuggestions` function mirrors
   `subscribeToActivities`. The `useSuggestions` hook mirrors `useActivities`. The test
   file mirrors `useActivities.test.ts`. No new patterns needed.

2. **Single table subscription.** Unlike templates or users which need multi-table
   subscriptions, suggestions is a flat table with no child or junction tables.

3. **Channel name: `'suggestions-all'`.** Follows the convention of other collection-wide
   subscriptions (`'activities-all'`, `'roles-all'`, etc.).

4. **REPLICA IDENTITY DEFAULT.** All subscribe functions use re-fetch-on-change and ignore
   the payload. No need for `REPLICA IDENTITY FULL`.

5. **Defer error/reconnection handling.** The research recommended deferring advanced
   subscription error handling. Current pattern is sufficient for MVP.

### Patterns

- Subscribe function: initial fetch + channel listener + cleanup return
- Hook: `useEffect` with `unsubscribe` closure
- Test mock: `vi.mock('../services/supabase', ...)` with `subscribeToSuggestions: vi.fn()`

### Trade-offs

- **Polling removal** removes the 5-second refresh guarantee. Realtime subscriptions
  deliver changes faster (typically <100ms) but depend on the Supabase Realtime connection
  being healthy. If the connection drops, changes stop until reconnection. This is acceptable
  because all other hooks already use this same pattern.

### Non-Goals

- NOT adding error/reconnection handling to existing subscribe functions
- NOT modifying `REPLICA IDENTITY` (DEFAULT is sufficient)
- NOT removing Firebase dependencies (that is the `cleanup` step)
- NOT changing component render logic
- NOT changing TypeScript types
- NOT adding new hooks or components
