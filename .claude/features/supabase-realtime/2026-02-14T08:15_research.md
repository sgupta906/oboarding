# Research: supabase-realtime

## Metadata
- **Feature:** supabase-realtime
- **Created:** 2026-02-14T08:15
- **Status:** research-complete
- **Researcher:** research-agent
- **Migration Step:** 4 of 5 (Firebase -> Supabase)

## Feature Context

Replace all Firestore `onSnapshot` real-time listeners with Supabase Realtime subscriptions across all hooks.

### Critical Finding: Subscriptions Already Implemented

The data-layer migration (step 2, commit 9efdfed) already implemented all 10 Supabase Realtime subscription functions. The hooks already import and use them from `src/services/supabase/`. There are **zero remaining `onSnapshot` calls** or `firebase/firestore` imports in hooks or services.

### What Was Already Done in Step 2

All 10 subscribe functions are fully implemented using `supabase.channel().on('postgres_changes', ...).subscribe()`:

| Function | Service File | Tables Listened | Pattern |
|----------|-------------|-----------------|---------|
| `subscribeToActivities` | `activityService.ts` | `activities` | Fetch all on change |
| `subscribeToRoles` | `roleService.ts` | `roles` | Fetch all on change |
| `subscribeToTemplates` | `templateService.ts` | `templates`, `template_steps` | Fetch all on change |
| `subscribeToProfiles` | `profileService.ts` | `profiles`, `profile_role_tags` | Fetch all on change |
| `subscribeToProfileTemplates` | `profileTemplateService.ts` | `profile_templates` (filtered), `profile_template_steps` | Fetch filtered on change |
| `subscribeToOnboardingInstances` | `instanceService.ts` | `onboarding_instances`, `instance_steps` | Fetch all on change |
| `subscribeToOnboardingInstance` | `instanceService.ts` | `onboarding_instances` (filtered), `instance_steps` (filtered) | Fetch single on change |
| `subscribeToSteps` | `instanceService.ts` | `instance_steps` (filtered), `onboarding_instances` (filtered) | Fetch steps on change |
| `subscribeToEmployeeInstance` | `instanceService.ts` | `onboarding_instances`, `instance_steps` | Fetch filtered on change |
| `subscribeToUsers` | `userService.ts` | `users`, `user_roles`, `user_profiles` | Fetch all on change |

### What Remains To Be Done

Despite the subscriptions being coded, there are real gaps that prevent them from working with a live Supabase instance:

1. **Database publication configuration** - No migration adds tables to the `supabase_realtime` publication, which is required for `postgres_changes` events to fire.
2. **`useSuggestions` still uses polling** - Uses `setInterval` every 5 seconds instead of a realtime subscription (the `suggestionService.ts` has no `subscribeToSuggestions` function).
3. **Stale comments** - Several hooks/services reference "Firebase", "Firestore", "dataClient", or "localStorage fallback" in their JSDoc comments.
4. **No error handling for subscription failures** - The subscription functions call `.subscribe()` but don't handle the subscription status callback to detect connection failures.
5. **No reconnection logic** - If the Supabase Realtime connection drops, there's no reconnection or retry mechanism.
6. **Channel naming could cause conflicts** - Static channel names like `'activities-all'` could conflict if multiple components subscribe independently (though current hook architecture prevents this).

### Where It Fits

- **Prerequisites:** Steps 1-3 complete (supabase-setup, supabase-data-layer, supabase-auth)
- **This step:** Ensure Supabase Realtime actually works end-to-end; add missing publication config; convert `useSuggestions` from polling to realtime; clean up stale references
- **Next step:** `cleanup` -- remove Firebase deps, dead code, simplify codebase

---

## Requirements

### Functional Requirements
- [ ] FR1: Add all 16 tables to the `supabase_realtime` publication so `postgres_changes` events actually fire
- [ ] FR2: Convert `useSuggestions` hook from polling (`setInterval` 5s) to Supabase Realtime subscription
- [ ] FR3: Create `subscribeToSuggestions` function in `suggestionService.ts`
- [ ] FR4: Add subscription status/error handling in subscribe functions (detect failed connections)
- [ ] FR5: Clean up stale Firebase/Firestore/dataClient/localStorage references in comments across hooks and services
- [ ] FR6: Verify the Proxy-based lazy-init client works correctly with `.channel()` method (confirmed working via test in `supabase.test.ts` line 41)
- [ ] FR7: Ensure all existing tests continue to pass (653/654 currently passing; 1 pre-existing flaky test)

### Technical Requirements
- [ ] TR1: New SQL migration (`00007_enable_realtime.sql`) to add tables to `supabase_realtime` publication
- [ ] TR2: Set `REPLICA IDENTITY FULL` on tables that need it for UPDATE/DELETE change events
- [ ] TR3: `subscribeToSuggestions` must follow the same pattern as other subscribe functions (initial fetch + channel listener + cleanup)
- [ ] TR4: `useSuggestions` must match existing hook API (`{ data, isLoading, error }` + `enabled` parameter)
- [ ] TR5: Build must pass (`tsc -b && vite build`)
- [ ] TR6: Zero new TypeScript errors

### Constraints
- Must NOT modify auth-related files (`authService.ts`, `authContext.tsx`, `firebase.ts`)
- Must NOT change app-level TypeScript types in `src/types/index.ts`
- Must NOT change component render logic -- only imports, hook internals, and comments
- Must NOT break the existing hook API contract (same return types, same parameters)
- The 10 existing subscribe functions are already implemented and working in tests -- do not rewrite them, only enhance

---

## Existing Code Analysis

### Project State
- **Project exists:** YES - mature codebase, 31 test files, 654 tests
- **Supabase Realtime:** Already coded in all 8 service files
- **Firebase imports in hooks/services:** NONE (all removed in steps 2-3)
- **Firebase imports remaining:** Only in `src/config/firebase.ts` and its test (to be removed in cleanup step)

### Subscription Implementation Inventory

All 10 subscribe functions follow the same pattern:

```typescript
export function subscribeToX(callback: (data: T) => void): () => void {
  // 1. Initial fetch
  listX().then(callback).catch(console.error);

  // 2. Listen for changes
  const channel = supabase
    .channel('unique-channel-name')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'x' }, () => {
      listX().then(callback).catch(console.error);
    })
    .subscribe();

  // 3. Return cleanup
  return () => { supabase.removeChannel(channel); };
}
```

Multi-table subscriptions (templates, instances, users, profiles, profile_templates) listen on both parent and child tables using multiple `.on()` calls on the same channel.

### Code to Create

| File | Purpose | Estimated Lines |
|------|---------|-----------------|
| `supabase/migrations/00007_enable_realtime.sql` | Add tables to `supabase_realtime` publication + set `REPLICA IDENTITY` | ~40 |
| (additions to) `src/services/supabase/suggestionService.ts` | Add `subscribeToSuggestions` function | ~25 |

### Code to Modify

| File | Change | Complexity |
|------|--------|------------|
| `src/services/supabase/index.ts` | Add `subscribeToSuggestions` to barrel exports | Low |
| `src/hooks/useSuggestions.ts` | Replace polling with `subscribeToSuggestions` subscription | Low |
| `src/hooks/useSuggestions.test.ts` | Update tests from polling mocks to subscription mocks | Low |
| `src/hooks/useRoles.ts` | Update stale comments (lines 6, 39, 55) | Trivial |
| `src/hooks/useCreateOnboarding.ts` | Update stale comment (line 3) and error message (line 109) | Trivial |
| `src/hooks/useManagerData.ts` | Update stale comment (line 2) | Trivial |
| `src/services/supabase/index.ts` | Update stale comment (line 8) | Trivial |
| `src/services/supabase/userService.ts` | Update stale comment (lines 4, 19) | Trivial |

### Code to Reuse
- All 10 existing subscribe functions in `src/services/supabase/*.ts` -- fully functional
- Hook patterns from `useActivities.ts` (clean subscription pattern to replicate for `useSuggestions`)
- Test patterns from `useActivities.test.ts` (subscription mock pattern to replicate for `useSuggestions.test.ts`)

### Patterns to Follow
1. **Subscribe function pattern:** Initial fetch + channel listener + cleanup (see `activityService.ts` lines 64-86)
2. **Hook subscription pattern:** `useEffect` with `unsubscribe` closure (see `useActivities.ts` lines 29-60)
3. **Test mock pattern:** `vi.mock('../services/supabase', ...)` with `subscribeToX: vi.fn()` (see `useActivities.test.ts`)
4. **Error wrapping:** `catch(console.error)` in subscribe callbacks
5. **Channel naming:** `'<domain>-all'` for collection-wide, `'<domain>-${id}'` for filtered

---

## Database Configuration Gap: Realtime Publication

### The Problem

Supabase Realtime `postgres_changes` requires tables to be added to the `supabase_realtime` publication. Without this, the `.on('postgres_changes', ...)` callbacks will never fire on a live Supabase instance.

The current migrations (00001-00006) do not include any publication configuration.

### The Fix

Create migration `00007_enable_realtime.sql`:

```sql
-- Add all tables to the supabase_realtime publication
ALTER PUBLICATION supabase_realtime ADD TABLE
  users,
  roles,
  profiles,
  templates,
  profile_templates,
  onboarding_instances,
  suggestions,
  activities,
  template_steps,
  instance_steps,
  profile_template_steps,
  user_roles,
  user_profiles,
  profile_role_tags,
  instance_profiles,
  instance_template_refs;
```

### REPLICA IDENTITY Consideration

By default, PostgreSQL tables use `REPLICA IDENTITY DEFAULT`, which only includes the primary key in WAL records for UPDATE/DELETE events. The subscription code uses the "re-fetch on change" pattern (ignoring the payload), so `DEFAULT` identity is sufficient -- the code does not inspect the changed row data from the payload.

However, if we later want to use payload data for optimistic updates, we would need `REPLICA IDENTITY FULL` on relevant tables. For now, `DEFAULT` is fine.

---

## `useSuggestions` Polling-to-Realtime Conversion

### Current Implementation (Polling)

`useSuggestions.ts` uses `setInterval(fetchSuggestions, 5000)` to poll every 5 seconds. This is the only hook that doesn't use a Supabase Realtime subscription.

### Why It Was Left as Polling

The data-layer migration (step 2) was focused on CRUD operations and subscription functions. The `suggestionService.ts` only has CRUD functions (list, create, update, delete) with no `subscribeToSuggestions`. The polling pattern was carried over from the original Firebase implementation where suggestions didn't use `onSnapshot` either.

### The Conversion

1. Add `subscribeToSuggestions` to `suggestionService.ts` (following the `subscribeToActivities` pattern exactly)
2. Update `useSuggestions.ts` to use the subscription pattern (following `useActivities.ts` exactly)
3. Update `useSuggestions.test.ts` to mock the subscription (following `useActivities.test.ts` exactly)
4. Export `subscribeToSuggestions` from the barrel file

The conversion is straightforward because both `suggestions` and `activities` are flat tables (no child/junction tables) with identical hook API shapes.

---

## Risk Assessment

### Technical Risks

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Publication not added = realtime silently fails | HIGH | HIGH (currently missing) | Create migration 00007 to add tables to publication |
| Polling removal in `useSuggestions` breaks existing behavior | LOW | LOW | Follow exact same pattern as `useActivities` which already works |
| `REPLICA IDENTITY` misconfiguration | LOW | LOW | Current code ignores payload; uses re-fetch pattern; DEFAULT identity is fine |
| Multiple channel subscriptions on same table (e.g., two components mount `useActivities`) | LOW | LOW | Supabase handles multiple channels; unique channel names prevent conflicts |
| Test breakage from `useSuggestions` conversion | LOW | MED | Model tests exactly on `useActivities.test.ts` which is proven |
| Comment cleanup accidentally changes code logic | LOW | LOW | Only touch JSDoc comment strings, not executable code |

### Complexity
- **Level:** Simple
- **Rationale:**
  1. All 10 Supabase Realtime subscription functions are already implemented and tested
  2. The only real code change is converting `useSuggestions` from polling to subscription (a pattern already repeated 7 times in other hooks)
  3. The database migration is a single `ALTER PUBLICATION` statement
  4. Comment cleanup is mechanical and low-risk
  5. No new patterns need to be invented -- everything follows established patterns

---

## Open Questions

- [x] Q1: Are the Supabase Realtime subscriptions already implemented?
  - Resolution: YES. All 10 subscribe functions were implemented in step 2 (`supabase-data-layer`). They use `supabase.channel().on('postgres_changes', ...).subscribe()` with initial fetch + re-fetch on change pattern.

- [x] Q2: Does the Proxy-based lazy-init client work with `.channel()`?
  - Resolution: YES. Confirmed by test in `supabase.test.ts` line 41: `expect(typeof supabase.channel).toBe('function')`.

- [x] Q3: Are there any remaining Firebase/Firestore imports in hooks or services?
  - Resolution: NO. Zero `firebase/firestore` imports remain in hooks or service files. Only `src/config/firebase.ts` and its test still import Firebase (to be removed in cleanup step).

- [x] Q4: Why does `useSuggestions` use polling instead of realtime?
  - Resolution: The original Firebase implementation didn't use `onSnapshot` for suggestions either (it polled). The `suggestionService.ts` was built without a subscribe function. This should be converted.

- [x] Q5: Is the database configured for Supabase Realtime?
  - Resolution: NO. No migration adds tables to the `supabase_realtime` publication. A new migration (00007) is needed.

- [x] Q6: Should we add error/reconnection handling to subscriptions?
  - Resolution: DEFER. The current "re-fetch on change" pattern is sufficient for MVP. Error handling and reconnection logic can be added in a future enhancement. The hooks already have error states and timeouts (e.g., `useTemplates` has a 3-second timeout fallback).

- [x] Q7: What about the `subscribeToEmployeeInstance` filter -- does it need a filter on the channel?
  - Resolution: Already handled. The function listens on both `onboarding_instances` and `instance_steps` tables (unfiltered since filtering by `employee_email` is not supported in channel filters) and re-fetches with a filtered query. This is correct for the current implementation.

---

## Recommended Approach

### Implementation Strategy

This is a straightforward, low-risk feature with three independent work streams:

1. **Database migration** -- Add tables to `supabase_realtime` publication
2. **Suggestion realtime conversion** -- Add subscribe function + update hook + update tests
3. **Comment cleanup** -- Update stale Firebase/Firestore/dataClient references

### Order of Work

1. Create `supabase/migrations/00007_enable_realtime.sql` (add all 16 tables to publication)
2. Add `subscribeToSuggestions` to `src/services/supabase/suggestionService.ts`
3. Export `subscribeToSuggestions` from `src/services/supabase/index.ts`
4. Convert `src/hooks/useSuggestions.ts` from polling to subscription
5. Update `src/hooks/useSuggestions.test.ts` to test subscription pattern
6. Clean up stale comments in:
   - `src/hooks/useRoles.ts` (3 stale comments)
   - `src/hooks/useCreateOnboarding.ts` (1 stale comment + 1 error message)
   - `src/hooks/useManagerData.ts` (1 stale comment)
   - `src/services/supabase/index.ts` (1 stale comment)
   - `src/services/supabase/userService.ts` (2 stale comments)
7. Run full test suite to verify no regressions

### What to Defer
- **Advanced error/reconnection handling** -- Current pattern is sufficient; enhancement for later
- **Payload-based optimistic updates** -- Would require `REPLICA IDENTITY FULL`; not needed now
- **Channel multiplexing optimization** -- Current separate-channel-per-domain is clean and correct
- **Firebase removal** -- That's the `cleanup` step (step 5)

---

## File Inventory

### Files to Create
| File | Purpose |
|------|---------|
| `supabase/migrations/00007_enable_realtime.sql` | Enable Realtime publication for all 16 tables |

### Files to Modify
| File | Lines Changed | Change Type |
|------|--------------|-------------|
| `src/services/supabase/suggestionService.ts` | +25 | Add `subscribeToSuggestions` |
| `src/services/supabase/index.ts` | +1 | Add export |
| `src/hooks/useSuggestions.ts` | ~30 rewrite | Polling -> subscription |
| `src/hooks/useSuggestions.test.ts` | ~60 rewrite | Polling mocks -> subscription mocks |
| `src/hooks/useRoles.ts` | 3 comment lines | Comment cleanup |
| `src/hooks/useCreateOnboarding.ts` | 2 lines | Comment + error string cleanup |
| `src/hooks/useManagerData.ts` | 1 comment line | Comment cleanup |
| `src/services/supabase/index.ts` | 1 comment line | Comment cleanup |
| `src/services/supabase/userService.ts` | 2 comment lines | Comment cleanup |

### Estimated Total Changes
- ~1 new file (migration SQL)
- ~9 files modified
- ~130 lines changed (mostly in `useSuggestions.ts` and its test file)
- Net line change: approximately -20 (removing polling logic, adding simpler subscription)

---

## Next Step

**All questions resolved. Status: research-complete.**

Run `/plan supabase-realtime` to create the implementation plan with task breakdown.
