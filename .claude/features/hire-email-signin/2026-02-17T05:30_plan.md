# Plan: hire-email-signin

**Feature:** Hire Email Sign-In Bug Fix
**Date:** 2026-02-17T05:30
**Status:** complete
**Based-on:** 2026-02-17T05:30_research.md

---

## Architecture Overview

```
Sign-In Flow (Before)
=====================
signInWithEmailLink(email)
  |
  +-- getAuthCredential(email)    <-- Users panel only
  |
  +-- MOCK_EMAIL_ROLES[email]     <-- 3 test accounts only
  |
  +-- Supabase Auth + setUserRole


Sign-In Flow (After)
====================
signInWithEmailLink(email)
  |
  +-- getAuthCredential(email)            <-- Users panel credentials
  |
  +-- getInstanceByEmployeeEmail(email)   <-- NEW: hire lookup
  |     |
  |     +-- Query onboarding_instances by employee_email
  |     +-- If found: sign in as employee, return
  |
  +-- MOCK_EMAIL_ROLES[email]             <-- test accounts
  |
  +-- Supabase Auth + setUserRole
```

```
Data Flow
=========
                    +--------------------+
  User types email  |  SignInView.tsx     |
  ----------------->|  signInWithEmailLink|
                    +--------+-----------+
                             |
            +----------------+----------------+
            |                |                |
     getAuthCredential  getInstanceBy    MOCK_EMAIL_ROLES
     (localStorage)     EmployeeEmail    (hardcoded map)
                        (Supabase)
                             |
                    +--------v---------+
                    | onboarding_      |
                    | instances table  |
                    | (employee_email) |
                    +------------------+
```

---

## Tech Stack

No changes to tech stack. Uses existing:
- Supabase client (`src/config/supabase.ts`)
- Vitest + vi.mock patterns for testing
- localStorage + CustomEvent for auth state propagation

---

## File Structure

### New Files

None. All changes are modifications to existing files.

### Modified Files

| File | Change Description | Approximate Lines |
|------|-------------------|-------------------|
| `src/services/supabase/instanceService.ts` | Add `getInstanceByEmployeeEmail()` function (~20 lines) | Insert after line 63 |
| `src/services/supabase/index.ts` | Add `getInstanceByEmployeeEmail` to exports | Modify line 71 block |
| `src/services/authService.ts` | Import new function, add hire email check block (~25 lines) | Modify line 8, insert after line 154 |
| `src/services/authService.test.ts` | Add test cases for hire email sign-in (~80 lines) | Insert after line 394 |

---

## Component Architecture

No new components. This is a service-layer-only change.

### Service Layer Changes

```
src/services/
  supabase/
    instanceService.ts    <-- ADD getInstanceByEmployeeEmail()
    index.ts              <-- ADD export
  authService.ts          <-- ADD hire email check path
  authService.test.ts     <-- ADD test cases
```

### State Management

No state management changes. The existing pattern is:
1. `signInWithEmailLink()` writes `mockAuthUser` to localStorage
2. `AuthProvider` picks up the change via `authStorageChange` CustomEvent
3. `useEmployeeOnboarding(user.email)` finds the instance by email from the Zustand store

This all works today -- the only gap is step 1 (getting the user signed in).

---

## Data Model Changes

None. The `onboarding_instances` table already has the `employee_email` column. No migrations needed.

---

## Implementation Details

### 1. getInstanceByEmployeeEmail() (instanceService.ts)

```typescript
/**
 * Fetches the most recent onboarding instance for an employee by email.
 * Returns null if no instance exists for the given email.
 */
export async function getInstanceByEmployeeEmail(
  email: string
): Promise<OnboardingInstance | null> {
  const normalizedEmail = email.toLowerCase().trim();
  const { data, error } = await supabase
    .from('onboarding_instances')
    .select('*, instance_steps(*)')
    .eq('employee_email', normalizedEmail)
    .order('created_at', { ascending: false })
    .limit(1);

  if (error) {
    console.error(`Failed to fetch instance by email: ${error.message}`);
    return null;
  }

  if (!data || data.length === 0) return null;

  const row: any = data[0];
  return toInstance(
    row as InstanceRow,
    ((row as any).instance_steps ?? []) as InstanceStepRow[]
  );
}
```

### 2. Hire email check in signInWithEmailLink() (authService.ts)

```typescript
// NEW: Check if this email belongs to an onboarding instance (hire)
try {
  const instance = await getInstanceByEmployeeEmail(trimmedEmail);
  if (instance) {
    const hireUid = getDevAuthUUID(trimmedEmail);
    localStorage.setItem(
      'mockAuthUser',
      JSON.stringify({
        uid: hireUid,
        email: trimmedEmail,
        role: 'employee',
      })
    );
    window.dispatchEvent(
      new CustomEvent('authStorageChange', {
        detail: { key: 'mockAuthUser' },
      })
    );
    console.log(`[Auth] Signed in as ${trimmedEmail} (employee) - hire with onboarding instance`);
    return;
  }
} catch (instanceError) {
  // Supabase may be unavailable -- fall through to MOCK_EMAIL_ROLES
  console.warn('Instance lookup failed, falling through:', instanceError);
}
```

### 3. Import addition (authService.ts line 8)

```typescript
import { getAuthCredential, getInstanceByEmployeeEmail } from './supabase';
```

---

## Testing Strategy

### Unit Tests (~6 new test cases in authService.test.ts)

| Test | Description |
|------|-------------|
| hire email signs in as employee | Mock `getInstanceByEmployeeEmail` to return an instance, verify mockAuthUser written with role='employee' |
| hire email dispatches auth event | Verify `authStorageChange` CustomEvent is dispatched |
| hire email does not call Supabase Auth | Verify `signUp`/`signInWithPassword` are NOT called |
| unknown email still rejected | Verify emails with no credential, no instance, and no MOCK_EMAIL_ROLES entry still throw |
| instance lookup failure falls through | Mock `getInstanceByEmployeeEmail` to throw, verify MOCK_EMAIL_ROLES check still works |
| hire email is case-insensitive | Verify `Delaney@Gmail.COM` finds instance for `delaney@gmail.com` |

### Integration Tests

None needed -- this is a pure service-layer change. The existing `useEmployeeOnboarding` hook tests already cover the email-to-instance lookup.

### E2E Tests

Manual verification:
1. Create hire as manager
2. Sign out
3. Sign in with hire's email
4. Verify employee dashboard loads with correct onboarding steps

---

## Implementation Notes

### Design Decisions

1. **Hire email check goes BEFORE MOCK_EMAIL_ROLES** -- This ensures hires can sign in without needing to be in the hardcoded test map. The order is: Users panel credentials -> hire instances -> test accounts.

2. **Role is always 'employee' for hires** -- Hires created via New Hires panel are always employees. There is no mechanism to create a hire as a manager.

3. **Non-deterministic UUID is acceptable** -- `getDevAuthUUID()` returns `crypto.randomUUID()` for non-test emails. This is fine because the app uses email-based instance lookups (`useEmployeeOnboarding`), not UID-based lookups. The UID just needs to be a valid UUID for the auth session.

4. **Graceful fallthrough on query failure** -- If Supabase is unavailable, the instance lookup is wrapped in try/catch and falls through to the MOCK_EMAIL_ROLES check. This maintains the existing resilience pattern.

### Patterns Used

- **Same auth pattern as Users panel check** -- localStorage write + CustomEvent dispatch + early return
- **Same query pattern as subscribeToEmployeeInstance** -- `eq('employee_email', ...)` with `order('created_at', { ascending: false }).limit(1)`
- **Same test mock pattern as getAuthCredential** -- extend existing `vi.mock('./supabase')` factory

### Trade-offs

- **Extra Supabase query on every sign-in attempt** -- For emails not in Users panel credentials, we now query `onboarding_instances` before checking MOCK_EMAIL_ROLES. This adds one query for test account sign-ins but is necessary for hire sign-ins. The query is fast (indexed by email, limit 1).

---

## Non-Goals

- **Hire email persistence across sessions** -- We do NOT store hire credentials in localStorage like Users panel does. Each sign-in re-queries the instance table. This is simpler and ensures the hire's instance data is always current.
- **Supabase Auth for hires** -- We do NOT create a real Supabase Auth user for hires. They use the same localStorage mock auth as the Users panel check.
- **Role selection for hires** -- Hires are always employees. No UI for choosing a different role at sign-in.
- **Multiple instance handling** -- If a hire has multiple instances, we use the most recent one. No UI for selecting which instance.
