# Research: hire-email-signin

**Feature:** Hire Email Sign-In Bug Fix
**Date:** 2026-02-17T05:30
**Status:** complete
**Bug ID:** #38 follow-up

---

## Problem Statement

When a hire (onboarding instance) is created via the New Hires panel with an email like `delaney@gmail.com`, that person cannot sign in using their email. The sign-in screen shows "Email not recognized" because the authentication flow does not check the `onboarding_instances` table.

### Root Cause

`signInWithEmailLink()` in `src/services/authService.ts` (lines 122-241) has only two sign-in paths:

1. **localStorage auth credentials** (line 133-154) -- checks `getAuthCredential(email)` which only finds users created via the Users panel (stored in localStorage by `addUserToAuthCredentials`)
2. **Hardcoded test accounts** (line 157-163) -- checks `MOCK_EMAIL_ROLES` map which only contains `test-employee@example.com`, `test-manager@example.com`, `test-admin@example.com`

Hires are separate from users. They have `onboarding_instances` rows with `employee_email` but never get auth credentials in localStorage. Bug #38 correctly removed `createUser` from hire creation (since hires are not users), but left hires with no sign-in path.

### Reproduction Steps

1. Sign in as Manager (test-manager@example.com)
2. Navigate to New Hires tab
3. Create a new hire with email `delaney@gmail.com`
4. Sign out
5. Try to sign in as `delaney@gmail.com`
6. **Result:** "Email not recognized" error
7. **Expected:** Sign in succeeds, employee dashboard shows their onboarding steps

---

## Codebase Analysis

### Sign-In Flow (authService.ts lines 122-241)

```
signInWithEmailLink(email)
  |
  +-- Validate email format (regex)
  |
  +-- Check 1: getAuthCredential(email) -- localStorage Users panel credentials
  |     If found: set mockAuthUser, dispatch event, return
  |
  +-- Check 2: MOCK_EMAIL_ROLES[email] -- hardcoded test accounts
  |     If NOT found: throw "Email not recognized"   <-- HIRE EMAILS FAIL HERE
  |
  +-- (rest of flow: Supabase signUp/signIn, setUserRole, localStorage fallback)
```

### Instance Service (instanceService.ts)

The `subscribeToEmployeeInstance()` function (lines 494-564) already queries `onboarding_instances` by `employee_email`. This confirms the pattern of looking up instances by email.

However, there is no standalone `getInstanceByEmployeeEmail()` function that performs a one-shot query (the existing function is subscription-based). We need to add one.

### Employee Onboarding Hook (useEmployeeOnboarding.ts)

The `useEmployeeOnboarding(email)` hook derives the employee's instance from the Zustand store by filtering `s.instances` with case-insensitive email matching. This means once a hire signs in, the existing hook will find their onboarding instance by email automatically.

### UUID Considerations (uuid.ts)

`getDevAuthUUID(email)` returns deterministic UUIDs only for the 3 test accounts. For any other email, it calls `crypto.randomUUID()` which generates a new UUID each time. This is acceptable because:
- The app looks up onboarding instances by **email**, not UID
- `useEmployeeOnboarding(user.email)` matches on `employeeEmail`, not user ID
- The UID only needs to be valid for the auth session, not persistent

### Barrel Export (supabase/index.ts)

The barrel file at `src/services/supabase/index.ts` exports all instance service functions on lines 69-84. The new function needs to be added here.

---

## Existing Patterns

### Auth Credential Check Pattern (authService.ts lines 133-154)

```typescript
const dynamicCredential = getAuthCredential(trimmedEmail);
if (dynamicCredential) {
  localStorage.setItem('mockAuthUser', JSON.stringify({
    uid: dynamicCredential.uid,
    email: dynamicCredential.email,
    role: dynamicCredential.role,
  }));
  window.dispatchEvent(new CustomEvent('authStorageChange', {
    detail: { key: 'mockAuthUser' },
  }));
  return;
}
```

The new hire email check should follow this exact same pattern -- query the instance, and if found, write `mockAuthUser` to localStorage and dispatch the event.

### Instance Query Pattern (instanceService.ts lines 501-520)

```typescript
const { data, error } = await supabase
  .from('onboarding_instances')
  .select('*, instance_steps(*)')
  .eq('employee_email', normalizedEmail)
  .order('created_at', { ascending: false })
  .limit(1);
```

The new `getInstanceByEmployeeEmail()` function should use this same query pattern, just returning the result directly instead of through a subscription callback.

### Test Patterns (authService.test.ts)

Tests mock the supabase client via `vi.mock('../config/supabase')` and mock the barrel import via `vi.mock('./supabase')`. The new hire email check imports a function from the barrel, so it needs to be added to the existing `vi.mock('./supabase')` mock.

---

## Fix Design

### 1. Add `getInstanceByEmployeeEmail()` to instanceService.ts

New function that performs a one-shot query to find an onboarding instance by employee email. Returns the instance or null.

### 2. Export from barrel (supabase/index.ts)

Add `getInstanceByEmployeeEmail` to the Instance Service export block.

### 3. Add hire email check to signInWithEmailLink()

Insert a new check between the localStorage credential check (line 154) and the MOCK_EMAIL_ROLES check (line 157). The new check:
1. Imports and calls `getInstanceByEmployeeEmail(trimmedEmail)`
2. If an instance is found, signs in as role='employee' with a generated UUID
3. Writes mockAuthUser to localStorage and dispatches the auth change event
4. Returns early (same pattern as the dynamicCredential check)

### Flow After Fix

```
signInWithEmailLink(email)
  |
  +-- Validate email format
  |
  +-- Check 1: getAuthCredential(email)     -- Users panel credentials
  |
  +-- Check 2: getInstanceByEmployeeEmail() -- NEW: Hire email check
  |     If found: set mockAuthUser as employee, dispatch event, return
  |
  +-- Check 3: MOCK_EMAIL_ROLES[email]      -- Hardcoded test accounts
  |
  +-- (Supabase auth flow for test accounts)
```

---

## Files to Modify

| File | Change | Lines |
|------|--------|-------|
| `src/services/supabase/instanceService.ts` | Add `getInstanceByEmployeeEmail()` function | After line 63 (after factory exports) |
| `src/services/supabase/index.ts` | Export `getInstanceByEmployeeEmail` | Line 71 (Instance Service block) |
| `src/services/authService.ts` | Import + call `getInstanceByEmployeeEmail`, add hire email check | Lines 8, 154-157 |
| `src/services/authService.test.ts` | Add tests for hire email sign-in path | After line 394 |

---

## Risks and Mitigations

| Risk | Likelihood | Mitigation |
|------|-----------|------------|
| Supabase query fails at sign-in time | Medium | Wrap in try/catch, fall through to MOCK_EMAIL_ROLES check |
| Multiple instances for same email | Low | Use `ORDER BY created_at DESC LIMIT 1` (same as existing pattern) |
| Non-deterministic UUID across sessions | N/A | App uses email-based lookups, not UID-based; UUID only needed for session |
| Test mock complexity | Low | Extend existing `vi.mock('./supabase')` to include new function |

---

## Dependencies

- No new npm packages needed
- No database migrations needed
- No new environment variables needed
- Existing `onboarding_instances` table already has `employee_email` column
