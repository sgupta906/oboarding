# Research: template-steps-ux

## Metadata
- **Feature:** template-steps-ux
- **Created:** 2026-02-16T22:00
- **Status:** research-complete
- **Researcher:** research-agent
- **Bugs Addressed:** #13 (template-steps-cramped), #14 (template-no-step-reorder)

## Feature Context

The TemplateModal component is used by managers to create and edit onboarding templates. Each template has metadata (name, roles, status) and a dynamic list of steps, each with title, description, owner, and expert fields. With realistic content, the steps area is severely height-constrained and there is no way to reorder steps after adding them.

### Where it fits
- `TemplatesView` (parent) renders two `TemplateModal` instances (create + edit mode)
- `TemplateModal` uses `ModalWrapper` for the modal shell (header, scrollable body, footer)
- Steps are managed as local `useState` array inside `TemplateModal`

### Dependencies
- No external dependencies needed -- all fixes are CSS/layout and simple state manipulation
- `lucide-react` already includes `ChevronUp`, `ChevronDown` icons (verified in node_modules)

---

## Requirements

### Functional Requirements
- FR1: Steps area shows significantly more than 1.5 steps at a time with realistic content (source: Bug #13)
- FR2: Eliminated double-nested scroll - single ModalWrapper body scroll (source: Bug #13 / scouting report Issue 10)
- FR3: Users can move a step up in the list (source: Bug #14)
- FR4: Users can move a step down in the list (source: Bug #14)
- FR5: Step reorder controls are disabled at boundaries (cannot move first step up, cannot move last step down) (source: implied by FR3/FR4)
- FR6: Step numbers update automatically after reorder (source: implied by FR3/FR4)
- FR7: Step count indicator added next to "Onboarding Steps" label (source: scouting report Issue 6, Bug #18)

### Technical Requirements
- TR1: No new npm dependencies - used existing lucide-react icons for reorder buttons
- TR2: Existing unit tests continue to pass (474 tests in suite)
- TR3: New unit tests for `handleMoveStepUp` and `handleMoveStepDown` functionality
- TR4: Dark mode support for all new UI elements (reorder buttons have proper dark: variants)
- TR5: Accessibility: reorder buttons have proper aria-labels (e.g., "Move step 2 up", "Move step 3 down")

### Constraints
- Must follow existing code patterns (Tailwind classes, lucide-react icons, no external component libraries)
- ModalWrapper is a shared component used by 6+ modals -- changes must not break other modals
- Template step data model (`TemplateStep` interface) does not need changes -- reordering is purely a UI/state operation on the array

---

## Existing Code Analysis

### Project State
- Project exists: YES
- All relevant files identified and read

### Key Files

| File | Lines | Purpose |
|------|-------|---------|
| `src/components/templates/TemplateModal.tsx` | 535 | Main template create/edit modal -- **primary file to modify** |
| `src/components/ui/ModalWrapper.tsx` | 106 | Reusable modal container -- **needs size variant addition** |
| `src/types/index.ts` | 378 | Type definitions -- **needs size type update** |
| `src/components/templates/TemplateModal.test.tsx` | 374 | Unit tests -- **needs new reorder tests** |
| `src/views/TemplatesView.tsx` | 339 | Templates CRUD view -- **no changes needed** |

### Current Scroll Architecture (the problem)

```
ModalWrapper (line 93):
  <div className="p-6 overflow-y-auto" style={{ maxHeight: 'calc(90vh - 180px)' }}>
    {children}  <!-- This is the TemplateModal form -->
  </div>

  Inside TemplateModal form (line 406):
    <div className="space-y-4 max-h-96 overflow-y-auto">
      {steps.map(...)}  <!-- INNER scroll container! -->
    </div>
```

**Result:** Two nested scroll containers. The outer one (ModalWrapper body) scrolls the entire form including Template Name, Roles, Status, and Steps. The inner one (`max-h-96`) constrains steps to 384px and adds its own scrollbar. This causes:
1. Steps area shows only ~1.35 steps at a time (each step card is ~284px, container is 384px)
2. Unpredictable scroll behavior -- mouse wheel might scroll inner or outer container
3. No way to see the full form context while scrolling steps

### Measured Dimensions (from Playwright)
- `max-h-96` container height: **384px**
- Total scroll height with 5 steps: **1419px**
- Each step card height: **~284px**
- Visible steps at once: **~1.35 steps**

### Current Step Management Code

```typescript
// Adding steps (line 141-143) -- append only, no insert/reorder
const handleAddStep = () => {
  setSteps([...steps, { title: '', description: '', owner: '', expert: '' }]);
};

// Removing steps (line 145-147)
const handleRemoveStep = (index: number) => {
  setSteps(steps.filter((_, i) => i !== index));
};

// Editing step fields (line 149-157)
const handleStepChange = (index: number, field: keyof Omit<TemplateStep, 'id'>, value: string) => {
  const newSteps = [...steps];
  newSteps[index] = { ...newSteps[index], [field]: value };
  setSteps(newSteps);
};
```

No `handleMoveStepUp`, `handleMoveStepDown`, `handleInsertStep`, or any reorder logic exists.

### Current Step Rendering (lines 407-511)

```tsx
{steps.map((step, index) => (
  <div key={index} className="p-4 border ... relative">
    {/* Step N badge */}
    <div className="absolute top-2 right-2">Step {index + 1}</div>
    {/* Title, Description, Owner/Expert inputs */}
    {/* Trash button: absolute top-2 right-10 */}
  </div>
))}
```

Key observations:
- Uses `key={index}` (array index) -- this will cause React reconciliation issues on reorder. **Must switch to stable IDs.**
- Step number badge shows `index + 1` -- automatically correct after reorder since it reads from index
- Trash button positioned absolutely next to step badge -- will need repositioning when reorder buttons are added

### ModalWrapper Size Variants (line 10-14)

```typescript
const sizeMap = {
  sm: 'max-w-sm',  // 384px
  md: 'max-w-md',  // 448px
  lg: 'max-w-lg',  // 512px
};
```

TemplateModal uses `size="lg"` (512px). No `xl` or `2xl` variants exist.

### ModalWrapperProps Type (types/index.ts line 341-348)

```typescript
export interface ModalWrapperProps {
  isOpen: boolean;
  title: string;
  children: React.ReactNode;
  footer?: React.ReactNode;
  onClose: () => void;
  size?: 'sm' | 'md' | 'lg';
}
```

---

## Visual Evidence

### Screenshot: Cramped Steps Area (5 steps, scrolled to top)
- **File:** `.claude/features/template-steps-ux/screenshot-5steps-top.png`
- **Shows:** Only Step 1 fully visible + title of Step 2 peeking. Steps 3-5 completely hidden below the 384px container. Inner scrollbar visible.

### Screenshot: Cramped Steps Area (4 steps, scrolled to bottom)
- **File:** `.claude/features/template-steps-ux/screenshot-cramped-top.png`
- **Shows:** Only bottom of Step 3 (Owner/Expert) and Step 4 visible. Steps 1-2 hidden above. No reorder controls anywhere on step cards.

### Key Observations from Screenshots
1. The Trash icon (16px) and Step badge are crowded in the top-right corner of each step card
2. There is ample vertical space in the viewport being wasted -- the modal only uses about 60% of viewport height
3. The "Onboarding Steps" label has no count indicator
4. No up/down arrows or drag handles visible on any step card

---

## Recommended Approach

### Bug #13 Fix: Remove double-scroll, widen modal

**Strategy: Remove inner scroll constraint, let ModalWrapper body handle all scrolling.**

1. **Remove `max-h-96 overflow-y-auto`** from the steps container (line 406)
   - Change: `<div className="space-y-4 max-h-96 overflow-y-auto">` --> `<div className="space-y-4">`
   - The ModalWrapper body already has `overflow-y-auto` with `maxHeight: calc(90vh - 180px)`, which is ~540-720px depending on viewport -- much more than 384px

2. **Add `xl` and `2xl` size variants** to ModalWrapper
   - Add to `sizeMap`: `xl: 'max-w-xl'` (576px), `2xl: 'max-w-2xl'` (672px)
   - Update `ModalWrapperProps.size` type to include `'xl' | '2xl'`
   - Change TemplateModal to use `size="2xl"` (672px -- 31% more width than current 512px)

3. **Add step count indicator** next to "Onboarding Steps" label
   - Change: `Onboarding Steps` --> `Onboarding Steps ({steps.length})`

**Impact:** Single scroll area, ~2.5 steps visible at once (vs 1.35), wider modal gives steps more breathing room.

### Bug #14 Fix: Add up/down arrow reorder buttons

**Strategy: Simple ChevronUp/ChevronDown buttons on each step card. No drag-and-drop library.**

Rationale for choosing simple buttons over drag-and-drop:
- **No new dependency** -- `@dnd-kit/core` or `react-beautiful-dnd` would add 15-40KB to the bundle
- **Simpler implementation** -- ~30 lines of code vs 100+ for DnD setup with context providers
- **Better accessibility** -- buttons work with keyboard navigation out of the box; DnD requires complex ARIA patterns
- **Template steps are typically 5-10 items** -- simple buttons are perfectly adequate for this list size; DnD is overkill
- **Consistent with the project's "no unnecessary dependencies" convention** -- only 4 runtime deps (React, ReactDOM, Supabase, Zustand)

Implementation:

1. **Add two handler functions:**
```typescript
const handleMoveStepUp = (index: number) => {
  if (index === 0) return;
  const newSteps = [...steps];
  [newSteps[index - 1], newSteps[index]] = [newSteps[index], newSteps[index - 1]];
  setSteps(newSteps);
};

const handleMoveStepDown = (index: number) => {
  if (index === steps.length - 1) return;
  const newSteps = [...steps];
  [newSteps[index], newSteps[index + 1]] = [newSteps[index + 1], newSteps[index]];
  setSteps(newSteps);
};
```

2. **Add ChevronUp/ChevronDown buttons** in each step card header area (next to step badge and trash icon)
   - Move-up button: disabled when `index === 0`
   - Move-down button: disabled when `index === steps.length - 1`
   - Use `ChevronUp` and `ChevronDown` from lucide-react (already in node_modules)

3. **Fix React keys** -- replace `key={index}` with stable unique IDs
   - Add `_uid` field to `TemplateStep` interface (internal only, not submitted)
   - Generate unique IDs on step creation: `_uid: crypto.randomUUID()` or incrementing counter
   - Use `_uid` as React key instead of array index

4. **Reposition action buttons** in step card header
   - Current layout: `[...empty space...] [Trash] [Step N badge]` (absolute positioned, crowded)
   - New layout: Step header row with `[Step N badge] [flex spacer] [ChevronUp] [ChevronDown] [Trash]`
   - Move from absolute positioning to a flex header row for better control

---

## Files That Need Changes

| File | Change Type | What Changes |
|------|-------------|-------------|
| `src/components/templates/TemplateModal.tsx` | Major | Remove inner scroll, add reorder handlers, add reorder buttons, fix React keys, add step count, reposition actions |
| `src/components/ui/ModalWrapper.tsx` | Minor | Add `xl` and `2xl` to sizeMap |
| `src/types/index.ts` | Minor | Add `'xl' \| '2xl'` to ModalWrapperProps.size type |
| `src/components/templates/TemplateModal.test.tsx` | Medium | Add tests for moveStepUp, moveStepDown, step count display |

---

## Risk Assessment

### Technical Risks
| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Removing inner scroll makes modal body very tall on many steps | Low | Medium | ModalWrapper body already caps at `calc(90vh - 180px)` -- this is the intended single-scroll behavior |
| React key change (index -> uid) causes form state loss on existing open modals | Low | Low | The `_uid` is generated when steps are created/loaded; existing form state is preserved since we are changing the key strategy, not the data |
| Widening modal to `2xl` breaks on small screens | Low | Low | Tailwind `max-w-2xl` is still responsive -- it only applies when viewport is wide enough. On mobile, the modal already fills available width |
| Step reorder breaks the `handleSubmit` step processing | Low | Low | `handleSubmit` reads from `steps` state directly -- reordering changes array order, which is exactly the desired effect on submission |

### Complexity
- **Level:** Simple-Medium
- **Rationale:** Both fixes are purely frontend -- CSS changes for the scroll/size issue, and two simple array swap functions + UI buttons for reorder. No backend changes, no new dependencies, no state management changes. The most complex part is reorganizing the step card header layout.

---

## Open Questions

All questions resolved -- no blockers.

- [x] Q1: Should we use drag-and-drop or simple buttons for reorder?
  - Resolution: Simple up/down buttons. No new dependency, better a11y, sufficient for 5-10 item lists.

- [x] Q2: Should we widen the modal?
  - Resolution: Yes, add `xl`/`2xl` variants to ModalWrapper. Use `2xl` (672px) for TemplateModal.

- [x] Q3: Should we also fix the React key issue (index-based keys)?
  - Resolution: Yes, must fix to prevent reconciliation bugs when reordering. Add internal `_uid` to TemplateStep.

- [x] Q4: Should we address description textarea size (Bug #16) and delete button overlap (Bug #17) in this feature?
  - Resolution: These are separate bugs (P2). The scope of this feature is Bug #13 (cramped) and Bug #14 (reorder) only. However, since we are touching the step card layout for reorder buttons, we can optionally improve the textarea (`rows={3}`, `resize-y`) and fix the delete button position as low-cost additions. Recommend including them if time permits, but they are not required.

---

## Recommended Implementation Order

1. **ModalWrapper size variants** -- Add `xl`/`2xl` to sizeMap and type (2 files, 5 minutes)
2. **Remove double-scroll** -- Delete `max-h-96 overflow-y-auto` from steps container, change TemplateModal to `size="2xl"` (1 file, 2 minutes)
3. **Add step count indicator** -- Append `({steps.length})` to the "Onboarding Steps" label (1 file, 1 minute)
4. **Add stable React keys** -- Add `_uid` to TemplateStep, generate on creation/load, use as key (1 file, 10 minutes)
5. **Add reorder handlers** -- `handleMoveStepUp` and `handleMoveStepDown` (1 file, 5 minutes)
6. **Add reorder buttons to step card** -- Reorganize step card header, add ChevronUp/ChevronDown with proper disabled states and aria-labels (1 file, 15 minutes)
7. **Write tests** -- Tests for reorder up/down, boundary conditions, step count display (1 file, 15 minutes)

**Estimated total:** ~1 hour of implementation work.

---

## What to Defer

- **Drag-and-drop** -- Overkill for this list size, can add later if needed
- **Accordion/collapsible steps** -- Nice-to-have but significantly more complex; simple scroll is sufficient
- **Auto-scroll on step add** (Bug #19) -- Low priority, can be added later with `scrollIntoView`
- **Mobile responsiveness for Owner/Expert grid** (scouting issue 9) -- Separate bug, not in scope
- **Description textarea improvements** (Bug #16) -- Separate bug, but trivial to include if touching the step card

---

## Next Step

**All questions resolved. Status: research-complete.**

Run `/plan template-steps-ux` to create the implementation plan.
