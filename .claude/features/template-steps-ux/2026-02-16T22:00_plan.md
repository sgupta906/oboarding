# Plan: template-steps-ux

## Metadata
- **Feature:** template-steps-ux
- **Created:** 2026-02-16T22:00
- **Status:** plan-complete
- **Based-on:** 2026-02-16T22:00_research.md
- **Bugs Addressed:** #13 (template-steps-cramped), #14 (template-no-step-reorder), #15 (template-modal-too-narrow), #18 (template-no-step-count), #20 (template-index-as-key)

---

## Architecture Overview

### Current State

```
ModalWrapper (max-w-lg = 512px)
  +----------------------------------------------+
  | Header: "Edit Template: X"            [X]    |
  +----------------------------------------------+
  | Body: overflow-y-auto, calc(90vh - 180px)    |
  |  +------------------------------------------+|
  |  | Template Name input                      ||
  |  | Role Tags checkboxes                     ||
  |  | Status radios                            ||
  |  | "Onboarding Steps"         [+ Add Step]  ||
  |  |  +--------------------------------------+||
  |  |  | INNER SCROLL: max-h-96 (384px)       |||  <-- PROBLEM
  |  |  |  [Step 1] [Trash] [Step N badge]     |||
  |  |  |  [Step 2] (barely visible)           |||
  |  |  |  [Step 3..N] (hidden, scroll needed) |||
  |  |  +--------------------------------------+||
  |  +------------------------------------------+|
  +----------------------------------------------+
  | Footer: [Delete] [Cancel] [Save Changes]     |
  +----------------------------------------------+
```

### Target State

```
ModalWrapper (max-w-2xl = 672px)
  +----------------------------------------------------------+
  | Header: "Edit Template: X"                        [X]    |
  +----------------------------------------------------------+
  | Body: overflow-y-auto, calc(90vh - 180px)                |
  |  +------------------------------------------------------+|
  |  | Template Name input                                  ||
  |  | Role Tags checkboxes                                 ||
  |  | Status radios                                        ||
  |  | "Onboarding Steps (3)"               [+ Add Step]   ||
  |  |                                                      ||
  |  | NO INNER SCROLL -- all steps flow naturally          ||
  |  |                                                      ||
  |  |  +--------------------------------------------------+||
  |  |  | [Step 1 of 3]        [^] [v-disabled] [Trash]   |||
  |  |  | Title: [____________]                            |||
  |  |  | Description: [_______________]                   |||
  |  |  | Owner: [______]  Expert: [______]                |||
  |  |  +--------------------------------------------------+||
  |  |                                                      ||
  |  |  +--------------------------------------------------+||
  |  |  | [Step 2 of 3]              [^] [v] [Trash]      |||
  |  |  | ...                                              |||
  |  |  +--------------------------------------------------+||
  |  |                                                      ||
  |  |  +--------------------------------------------------+||
  |  |  | [Step 3 of 3]        [^-disabled] [v] [Trash]   |||
  |  |  | ...                                              |||
  |  |  +--------------------------------------------------+||
  |  +------------------------------------------------------+|
  +----------------------------------------------------------+
  | Footer: [Delete] [Cancel] [Save Changes]                 |
  +----------------------------------------------------------+
```

### Key Architectural Changes

1. **Single scroll surface** -- Remove inner `max-h-96 overflow-y-auto` from steps container. The ModalWrapper body already provides a single scrollable region capped at `calc(90vh - 180px)`.

2. **Wider modal** -- Add `xl` and `2xl` size variants to ModalWrapper's `sizeMap` and `ModalWrapperProps.size` type. TemplateModal switches from `size="lg"` (512px) to `size="2xl"` (672px) -- a 31% width increase.

3. **Step reorder buttons** -- Add `handleMoveStepUp` and `handleMoveStepDown` handlers. Each step card gets ChevronUp/ChevronDown buttons in a flex header row alongside the step badge and trash button.

4. **Stable React keys** -- Replace `key={index}` with `key={step._uid}` using an internal `_uid` field generated via an incrementing counter. This prevents React reconciliation bugs when steps are reordered or deleted.

5. **Step count indicator** -- Add `({steps.length})` next to the "Onboarding Steps" label.

---

## Tech Stack Summary

No changes to the tech stack. All modifications use existing dependencies:
- **Tailwind CSS** for styling (existing)
- **lucide-react** for ChevronUp/ChevronDown icons (already installed, verified in node_modules)
- **React useState** for step state management (existing pattern)

---

## File Structure

### New Files

None. All changes are modifications to existing files.

### Modified Files

| # | File | Lines | Change Scope | Description |
|---|------|-------|-------------|-------------|
| 1 | `src/types/index.ts` | 347 | 1 line | Add `'xl' \| '2xl'` to `ModalWrapperProps.size` type |
| 2 | `src/components/ui/ModalWrapper.tsx` | 10-14 | 2 lines | Add `xl` and `2xl` entries to `sizeMap` object |
| 3 | `src/components/templates/TemplateModal.tsx` | Multiple | ~60 lines net | Remove inner scroll, add reorder handlers, add reorder buttons, fix keys, add step count, restructure step card header |
| 4 | `src/components/templates/TemplateModal.test.tsx` | End of file | ~120 lines added | New test suite for reorder, step count, boundary conditions |

### Detailed Change Map

#### 1. `src/types/index.ts` (line 347)

**Before:**
```typescript
size?: 'sm' | 'md' | 'lg';
```

**After:**
```typescript
size?: 'sm' | 'md' | 'lg' | 'xl' | '2xl';
```

#### 2. `src/components/ui/ModalWrapper.tsx` (lines 10-14)

**Before:**
```typescript
const sizeMap = {
  sm: 'max-w-sm',
  md: 'max-w-md',
  lg: 'max-w-lg',
};
```

**After:**
```typescript
const sizeMap = {
  sm: 'max-w-sm',
  md: 'max-w-md',
  lg: 'max-w-lg',
  xl: 'max-w-xl',
  '2xl': 'max-w-2xl',
};
```

#### 3. `src/components/templates/TemplateModal.tsx`

**a) Import change (line 8):**
Add `ChevronUp, ChevronDown` to the lucide-react import.

**b) TemplateStep interface (line 26-32):**
Add internal `_uid` field:
```typescript
interface TemplateStep {
  id?: number;
  _uid: string;  // Internal stable key for React reconciliation
  title: string;
  description: string;
  owner: string;
  expert: string;
}
```

**c) UID counter (before component function):**
Add a module-level counter for generating stable UIDs:
```typescript
let stepUidCounter = 0;
function nextStepUid(): string {
  return `step-${++stepUidCounter}`;
}
```

Rationale for counter vs `crypto.randomUUID()`: A simple incrementing counter is sufficient for React keys (uniqueness within a single component's step list), lighter weight, and deterministic in tests.

**d) Initial state (line 56-58):**
Update to include `_uid`:
```typescript
const [steps, setSteps] = useState<TemplateStep[]>([
  { _uid: nextStepUid(), title: '', description: '', owner: '', expert: '' },
]);
```

**e) Pre-fill effect (lines 69-76):**
Update mapped steps to include `_uid`:
```typescript
setSteps(
  template.steps.map((s) => ({
    _uid: nextStepUid(),
    id: s.id,
    title: s.title,
    description: s.description,
    owner: s.owner,
    expert: s.expert,
  }))
);
```

**f) resetForm (line 87):**
Update to include `_uid`:
```typescript
setSteps(
  isEdit ? [] : [{ _uid: nextStepUid(), title: '', description: '', owner: '', expert: '' }]
);
```

**g) handleAddStep (line 141-143):**
Update to include `_uid`:
```typescript
const handleAddStep = () => {
  setSteps([...steps, { _uid: nextStepUid(), title: '', description: '', owner: '', expert: '' }]);
};
```

**h) New reorder handlers (after handleStepChange, ~line 157):**
```typescript
const handleMoveStepUp = (index: number) => {
  if (index === 0) return;
  const newSteps = [...steps];
  [newSteps[index - 1], newSteps[index]] = [newSteps[index], newSteps[index - 1]];
  setSteps(newSteps);
};

const handleMoveStepDown = (index: number) => {
  if (index === steps.length - 1) return;
  const newSteps = [...steps];
  [newSteps[index], newSteps[index + 1]] = [newSteps[index + 1], newSteps[index]];
  setSteps(newSteps);
};
```

**i) Modal size (line 291):**
Change `size="lg"` to `size="2xl"`.

**j) Step count indicator (line 392-393):**
Change label from `Onboarding Steps` to include count:
```tsx
<label className="block text-sm font-medium text-slate-700 dark:text-slate-200">
  Onboarding Steps ({steps.length})
</label>
```

**k) Steps container (line 406):**
Remove inner scroll classes:
```tsx
{/* Before */}
<div className="space-y-4 max-h-96 overflow-y-auto">

{/* After */}
<div className="space-y-4">
```

**l) Step card key (line 409):**
Change from `key={index}` to `key={step._uid}`.

**m) Step card header (lines 411-415, 499-508):**
Replace the absolute-positioned step badge and trash button with a flex header row:

```tsx
{/* New flex header row */}
<div className="flex items-center justify-between mb-2">
  <span className="text-xs font-medium text-slate-500 dark:text-slate-300 bg-slate-100 dark:bg-slate-600 px-2 py-1 rounded">
    Step {index + 1} of {steps.length}
  </span>
  <div className="flex items-center gap-1">
    <button
      type="button"
      onClick={() => handleMoveStepUp(index)}
      disabled={index === 0}
      className="p-1 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors disabled:opacity-30 disabled:cursor-not-allowed"
      aria-label={`Move step ${index + 1} up`}
    >
      <ChevronUp size={16} />
    </button>
    <button
      type="button"
      onClick={() => handleMoveStepDown(index)}
      disabled={index === steps.length - 1}
      className="p-1 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors disabled:opacity-30 disabled:cursor-not-allowed"
      aria-label={`Move step ${index + 1} down`}
    >
      <ChevronDown size={16} />
    </button>
    {steps.length > 1 && (
      <button
        type="button"
        onClick={() => handleRemoveStep(index)}
        className="p-1 text-slate-400 hover:text-red-600 dark:hover:text-red-400 transition-colors"
        aria-label={`Remove step ${index + 1}`}
      >
        <Trash2 size={16} />
      </button>
    )}
  </div>
</div>
```

Remove the old absolute-positioned elements:
- Delete the `<div className="absolute top-2 right-2 ...">Step {index + 1}</div>` block (lines 412-415)
- Delete the old `{steps.length > 1 && (<button ... absolute top-2 right-10 ...>` block (lines 500-508)
- Remove `relative` from the step card's className (line 410)

**n) handleStepChange type (line 149-152):**
Update to exclude `_uid` as well:
```typescript
const handleStepChange = (
  index: number,
  field: keyof Omit<TemplateStep, 'id' | '_uid'>,
  value: string
) => {
```

---

## Data Model Changes

None. The `_uid` field is internal to the TemplateModal component and is not persisted to the database. It is stripped during `handleSubmit` when constructing the `Step[]` array (the existing map on line 176 already only copies `id`, `title`, `description`, `role`, `owner`, `expert`, `status`, `link`).

---

## Component Architecture

```
TemplatesView
  +-- TemplateModal (mode="create", size="2xl")
  |     +-- ModalWrapper (size="2xl" = max-w-2xl)
  |           +-- form
  |                 +-- Template Name input
  |                 +-- Role Tags fieldset
  |                 +-- Status fieldset
  |                 +-- Steps section
  |                       +-- Step count label: "Onboarding Steps (N)"
  |                       +-- [+ Add Step] button
  |                       +-- Step cards (key={_uid})
  |                             +-- Header row (flex)
  |                             |     +-- "Step X of Y" badge
  |                             |     +-- [ChevronUp] [ChevronDown] [Trash2]
  |                             +-- Title input
  |                             +-- Description textarea
  |                             +-- Owner/Expert grid
  |
  +-- TemplateModal (mode="edit", size="2xl")
        +-- (same structure as create)
        +-- DeleteConfirmDialog (sibling)
```

### State Management

No state management changes. Steps continue to be managed via `useState<TemplateStep[]>` inside TemplateModal. The two new handlers (`handleMoveStepUp`, `handleMoveStepDown`) simply swap adjacent elements in the array.

---

## Testing Strategy

### Unit Tests (TemplateModal.test.tsx)

Existing tests: 14 tests across create/edit modes (validation, submission, pre-fill, step management).

New tests to add (~10 tests):

**Reorder functionality:**
1. `should move step up when clicking move-up button` -- Verify step titles swap positions
2. `should move step down when clicking move-down button` -- Verify step titles swap positions
3. `should disable move-up button for first step` -- First step's up button has `disabled` attribute
4. `should disable move-down button for last step` -- Last step's down button has `disabled` attribute
5. `should preserve step data after reorder` -- All fields (title, description, owner, expert) survive the swap
6. `should update step numbers after reorder` -- "Step X of Y" badges reflect new positions

**Step count indicator:**
7. `should display step count in section label` -- "Onboarding Steps (1)" on initial render
8. `should update step count when adding steps` -- Count increments after Add Step click
9. `should update step count when removing steps` -- Count decrements after step removal

**ModalWrapper size variants:**
10. `should render with 2xl size` -- ModalWrapper applies `max-w-2xl` class (can test via container className)

### Integration Tests

Not needed for this feature -- the changes are purely presentational and local state manipulation within a single component. The existing `handleSubmit` tests verify that the step data is correctly passed to `onSubmit` regardless of step order.

### E2E Tests

Not planned as part of this feature. The functional test agent can verify the modal visually during the `/test` phase.

---

## Implementation Notes

### Design Decisions

1. **Counter-based UIDs over crypto.randomUUID():** A simple incrementing counter (`step-1`, `step-2`, ...) is sufficient for React key uniqueness within a single component instance. It avoids unnecessary crypto overhead and is deterministic in tests.

2. **Flex header row over absolute positioning:** The current step card uses `relative` + `absolute top-2 right-2/right-10` for the badge and trash button. This is fragile (overlapping, hard to extend). Moving to a flex header row gives clean spacing and makes it trivial to add the two new reorder buttons.

3. **`disabled:opacity-30` for boundary buttons:** At `opacity-30` the icon is clearly "ghosted" but still visible, indicating the button exists but is inactive. This is more informative than hiding the button entirely.

4. **`_uid` excluded from submission:** The `handleSubmit` function on line 176 constructs `Step[]` objects by explicitly picking fields (`id`, `title`, `description`, etc.), so `_uid` is automatically excluded. No filtering needed.

5. **No `_uid` on the shared `TemplateStep` type in types/index.ts:** The `TemplateStep` interface is local to `TemplateModal.tsx` (not exported, not in `types/index.ts`). Adding `_uid` there has zero external impact.

### Patterns Used

- **Array swap via destructuring:** `[a[i], a[j]] = [a[j], a[i]]` -- standard JavaScript idiom
- **Disabled at boundary:** `disabled={index === 0}` / `disabled={index === steps.length - 1}` -- simple boolean prop
- **lucide-react icons:** `ChevronUp`, `ChevronDown` -- already used pattern throughout the project

### Trade-offs

| Decision | Pro | Con |
|----------|-----|-----|
| Simple buttons vs drag-and-drop | No new dependency, simple code, good a11y | Less "modern" feel for large lists |
| `max-w-2xl` (672px) width | 31% more space for step fields | Slightly larger modal on smaller screens |
| Counter-based UIDs | Deterministic, lightweight, testable | Not globally unique (only per-component, which is sufficient) |

---

## Non-Goals

These are explicitly **not** in scope for this feature:

- **Drag-and-drop step reordering** -- Overkill for 5-10 item lists; simple buttons are sufficient
- **Accordion/collapsible steps** -- Would add significant complexity; single scroll is adequate
- **Auto-scroll on step add (Bug #19)** -- Separate bug, P3 priority
- **Description textarea resize (Bug #16)** -- Separate bug, not in scope
- **Mobile responsiveness for Owner/Expert grid** -- Separate concern
- **Step insert at specific position** -- "Add Step" appends; reorder buttons achieve the same result
- **Backend changes** -- This feature is purely frontend

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| ModalWrapper `2xl` size breaks other modals | Low | None | Other modals specify their own `size` prop; `2xl` only applies to TemplateModal |
| Removing inner scroll makes modal very tall | Low | Medium | ModalWrapper body caps at `calc(90vh - 180px)` -- designed for this |
| Existing 14 tests break | Medium | Low | Changes are additive (new handlers, new UI elements); only the step card structure changes, and existing tests query by aria-label/display-value, not by DOM structure |
| React key change causes test failures | Low | Medium | Tests query steps by `getByLabelText('Step N title')` which uses index, not key; the key change is invisible to tests |
