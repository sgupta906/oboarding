# Plan: suggestion-improvements

## Metadata
- **Feature:** suggestion-improvements
- **Created:** 2026-02-16T23:30
- **Status:** plan-complete
- **Based on:** 2026-02-16T23:30_research.md
- **Bugs covered:** #41, #42, #43

## Architecture Overview

All three bugs share one root cause: numeric step IDs displayed to users instead of resolved step titles. The fix is a step-title resolution pattern applied at three locations.

```
                        CURRENT (broken)
                        =================

  OnboardingHub                         ManagerView
  +-----------------------+             +--------------------------+
  | logActivity(                        | logActivity(
  |   "completed step 2"  <-- bare ID  |   "approved a doc        <-- no context
  | )                                   |    suggestion"
  +-----------------------+             | )
                                        |
                                        | SuggestionsSection
                                        | +------------------------+
                                        | | getStepTitle(stepId)   |
                                        | |   steps.find(...)      <-- ambiguous
                                        | +------------------------+
                                        +--------------------------+

                        FIXED
                        =====

  OnboardingHub                         ManagerView
  +-----------------------+             +--------------------------+
  | getStepTitle(id):                   | resolveStepTitle(id, instanceId):
  |   employeeStepsData                 |   onboardingInstances
  |     .find(s => s.id)                |     .find(i => i.id)
  |     ?.title                         |     .steps.find(s => s.id)
  |                                     |     ?.title
  | logActivity(                        |
  |   'completed "Setup    <-- title   | logActivity(
  |    Laptop"'                         |   'approved suggestion
  | )                                   |    from Alice on         <-- context
  +-----------------------+             |    "Setup Laptop"'
                                        | )
                                        |
                                        | SuggestionsSection
                                        | +------------------------+
                                        | | getStepTitle(stepId,   |
                                        | |   instanceId):         |
                                        | |   onboardingInstances  <-- scoped
                                        | |     .find(by instance) |
                                        | |     .steps.find(by id) |
                                        | +------------------------+
                                        +--------------------------+
```

### Resolution Strategy

Two independent helper functions (NOT a shared utility -- different data sources):

1. **OnboardingHub `getStepTitle(stepId)`** -- Uses `employeeStepsData` (the employee's own steps). Single instance, no ambiguity. Simple `.find()`.

2. **ManagerView `resolveStepTitle(stepId, instanceId)`** -- Uses `onboardingInstances` array. Prefers instance-scoped lookup when `instanceId` is available, falls back to flat `managerSteps.find()` for old suggestions without `instanceId`.

3. **SuggestionsSection** -- Receives `onboardingInstances` as a new optional prop. Updates its existing `getStepTitle` to accept `instanceId` and use instance-scoped lookup with fallback.

## Tech Stack

No new dependencies. Changes are limited to:
- TypeScript interface update (1 optional prop)
- String formatting in `logActivity()` calls
- Local helper functions (2-5 lines each)

## File Structure

### Modified Files

| File | Lines Changed | Purpose |
|------|--------------|---------|
| `src/types/index.ts` (line 369-375) | +1 line | Add `onboardingInstances?: OnboardingInstance[]` to `SuggestionsSectionProps` |
| `src/components/manager/SuggestionsSection.tsx` (lines 20-32, 71) | ~15 lines | Destructure new prop, update `getStepTitle` signature, pass `instanceId` |
| `src/views/ManagerView.tsx` (lines 95-137, 268-274) | ~20 lines | Add `resolveStepTitle` helper, update approve/reject messages, pass prop |
| `src/components/OnboardingHub.tsx` (lines 74-141) | ~15 lines | Add `getStepTitle` helper, update 4 `logActivity` calls |
| `src/views/ManagerView.test.tsx` (lines 54-69, 338-343, 390-396) | ~15 lines | Add `instanceId` to mock suggestions, update activity message assertions |

### New Files

None.

## Data Model Changes

None. The `Suggestion.instanceId` field already exists in the type, is stored in the database, and is populated during creation.

## Component Architecture

No component tree changes. Only prop additions:

```
ManagerView
  |-- SuggestionsSection
        props: { ..., onboardingInstances? }   <-- NEW optional prop
        |-- SuggestionCard (no changes -- receives stepTitle as string)
```

## Activity Message Format Changes

### OnboardingHub (Bug #42)

| Action | Before | After |
|--------|--------|-------|
| Complete step | `completed step 2` | `completed "Read handbook"` |
| Report stuck | `reported stuck on step 2` | `reported stuck on "Read handbook"` |
| Mark pending | `marked step 2 as pending` | `marked "Read handbook" as pending` |
| Submit suggestion | `submitted suggestion for step 2` | `submitted suggestion for "Read handbook"` |

### ManagerView (Bug #43)

| Action | Before | After |
|--------|--------|-------|
| Approve | `approved a documentation suggestion` | `approved suggestion from Alice on "Setup Laptop"` |
| Reject | `rejected a documentation suggestion` | `rejected suggestion from Alice on "Setup Laptop"` |

### ActivityFeed Icon Compatibility

The `getActionIcon()` function in `ActivityFeed.tsx` uses `.includes()` checks:
- `"completed"` -- still present in new format
- `"stuck"` / `"report"` -- still present
- `"suggestion"` -- still present in approve/reject messages
- `"marked"` + `"pending"` -- still present

No changes needed to `ActivityFeed.tsx`.

## Testing Strategy

### Existing Tests to Update (2 assertions)

| File | Test | Change |
|------|------|--------|
| `ManagerView.test.tsx` | `handleApproveSuggestion > calls optimistic...` | Update assertion from exact `'approved a documentation suggestion'` to `expect.stringContaining('approved suggestion from')` |
| `ManagerView.test.tsx` | `handleRejectSuggestion > calls optimistic...` | Update assertion from exact `'rejected a documentation suggestion'` to `expect.stringContaining('rejected suggestion from')` |

### New Tests to Add (~8 tests)

| Location | Tests | Count |
|----------|-------|-------|
| `ManagerView.test.tsx` | Approve/reject messages include employee name and step title | 2 |
| `ManagerView.test.tsx` | Approve/reject with missing instanceId falls back gracefully | 2 |
| `SuggestionsSection` (inline in `ManagerView.test.tsx`) | Step title resolves correctly with instanceId | 1 |
| `SuggestionsSection` (inline in `ManagerView.test.tsx`) | Step title falls back when instanceId missing | 1 |
| `SuggestionsSection` (inline in `ManagerView.test.tsx`) | Step title falls back when instanceId points to unknown instance | 1 |
| `ManagerView.test.tsx` | Verify `onboardingInstances` prop passed to SuggestionsSection | 1 |

**Estimated total: ~8 new tests, 2 updated assertions**

### No E2E Tests

These are string formatting changes. The Playwright functional test would need a full employee-submit-suggestion-then-manager-approves flow with database setup, which is disproportionate to the risk. Unit tests are sufficient.

## Implementation Notes

### Design Decisions

1. **Two separate helpers, not a shared utility.** `OnboardingHub.getStepTitle` operates on `employeeStepsData` (single-instance, no ambiguity). `ManagerView.resolveStepTitle` operates on `onboardingInstances` (multi-instance, needs `instanceId` for disambiguation). Different data shapes, different calling conventions.

2. **Optional prop for `onboardingInstances`.** Making it optional preserves backward compatibility -- `SuggestionsSection` can still work with just `steps` if `onboardingInstances` is not passed (falls back to existing flat-array behavior).

3. **Quoted titles in messages.** Using `"Step Title"` (with double quotes) in activity messages makes the title visually distinct from the surrounding sentence text.

4. **Graceful degradation.** Old suggestions without `instanceId` (created before the field was added) use the existing first-match behavior. The fallback to `Step ${id}` handles the unlikely case where a step title cannot be resolved at all.

### Patterns Followed

- Fire-and-forget activity logging: `logActivity({...}).catch(console.warn)`
- Optimistic update + rollback for approve/reject (unchanged)
- Props interface defined in `src/types/index.ts`
- Test mocks follow existing `vi.mock('../services/supabase', ...)` pattern

## Non-Goals

- **No shared utility module** for step title resolution (unnecessary abstraction for 3-line functions with different data sources)
- **No database backfill** of existing activity records (they are historical)
- **No changes to `ActivityFeed.tsx`** (icon logic already handles new message formats)
- **No changes to Supabase services** (data already flows correctly)
- **No Zustand store changes** (data is already available at all call sites via hooks)
