# Research: suggestion-improvements

## Metadata
- **Feature:** suggestion-improvements
- **Created:** 2026-02-16T23:30
- **Status:** research-complete
- **Researcher:** research-agent
- **Bugs covered:** #41 (suggestion-step-lookup-ambiguous), #42 (suggestion-no-step-title-in-activity), #43 (suggestion-approve-reject-generic)

## Feature Context

Three related suggestion bugs that all stem from insufficient context in suggestion display and activity logging:

1. **Bug #41**: SuggestionsSection looks up step titles by `stepId` across a flattened array of all steps from all instances -- first match wins, which may be from the wrong instance.
2. **Bug #42**: Activity messages use bare numeric step IDs ("completed step 2") instead of step titles.
3. **Bug #43**: Manager approve/reject activity messages are completely generic ("approved a documentation suggestion") with no step title, employee name, or instance context.

All three bugs are about **resolving context at the right time** -- mapping numeric IDs to human-readable names at the point where the data is available.

## Requirements

### Functional Requirements
- FR1: Suggestion cards display the correct step title, even when multiple onboarding instances have steps with the same `stepId` (Bug #41)
- FR2: Activity feed messages for step status changes include the step title, not the numeric ID (Bug #42)
- FR3: Activity feed messages for suggestion submission include the step title (Bug #42)
- FR4: Activity feed messages for suggestion approval include step title and employee name (Bug #43)
- FR5: Activity feed messages for suggestion rejection include step title and employee name (Bug #43)
- FR6: Activity feed messages for "report stuck" include the step title (Bug #42)

### Technical Requirements
- TR1: No changes to the database schema or Supabase service layer
- TR2: No changes to the `Suggestion` type (it already has `instanceId?: string`)
- TR3: Existing tests continue to pass (update assertions for new message formats)
- TR4: New unit tests for step title resolution logic
- TR5: Follow existing fire-and-forget `logActivity().catch(console.warn)` pattern

### Constraints
- Activity messages are stored as plain strings in the `activities` table `action` column -- there is no structured data. Step titles must be resolved at log time and embedded in the string.
- The `Suggestion.stepId` is a numeric position (1-based), not a UUID. The `Step.id` field comes from `row.position` in the mapper (see `mappers.ts:118`).

## Existing Code Analysis

### Project State
- Project exists: YES
- Zustand migration complete (5/5 slices)
- 508 tests passing

### Detailed Code Trace

#### Bug #41: Step Title Lookup in SuggestionsSection

**File: `src/components/manager/SuggestionsSection.tsx`**

```typescript
// Line 30-32: The problematic lookup
const getStepTitle = (stepId: number): string => {
  return steps.find((s) => s.id === stepId)?.title || 'Unknown Step';
};
```

The `steps` prop is `Step[]`, which comes from `ManagerView.tsx` line 77-80:

```typescript
const managerSteps = useMemo<Step[]>(
  () => onboardingInstances.flatMap((instance) => instance.steps),
  [onboardingInstances]
);
```

**Problem**: `managerSteps` flattens ALL steps from ALL instances into one array. If Instance A has step 1 = "Setup Laptop" and Instance B has step 1 = "Read Handbook", `.find(s => s.id === stepId)` returns whichever comes first in the flattened array.

**The Suggestion type already has `instanceId`:**
```typescript
// src/types/index.ts line 137-145
export interface Suggestion {
  id: number | string;
  stepId: number;
  user: string;
  text: string;
  status: SuggestionStatus;
  createdAt?: number;
  instanceId?: string;  // <-- Already exists
}
```

And `createSuggestion` in `OnboardingHub.tsx` already passes it:
```typescript
// OnboardingHub.tsx line 112-118
await createSuggestion({
  stepId: activeModal.stepId,
  user: employeeInstance.employeeName,
  text: text.trim(),
  status: 'pending',
  instanceId: employeeInstance.id,  // <-- Already passed
});
```

And it's stored in the DB:
```typescript
// suggestionService.ts line 47
instance_id: suggestion.instanceId ?? null,
```

And mapped back:
```typescript
// mappers.ts line 185
instanceId: row.instance_id ?? undefined,
```

**Fix approach**: Change the step title lookup in `SuggestionsSection` to filter by `instanceId` before looking up:

```typescript
const getStepTitle = (stepId: number, instanceId?: string): string => {
  if (instanceId) {
    const instance = onboardingInstances.find(i => i.id === instanceId);
    if (instance) {
      const step = instance.steps.find(s => s.id === stepId);
      if (step) return step.title;
    }
  }
  // Fallback to existing behavior for suggestions without instanceId
  return steps.find((s) => s.id === stepId)?.title || 'Unknown Step';
};
```

This requires `SuggestionsSection` to receive `onboardingInstances` (or an equivalent lookup structure) as a prop, OR for the lookup to happen in `ManagerView` before passing to `SuggestionsSection`.

**Design decision**: Two options:
1. Pass `onboardingInstances` to `SuggestionsSection` as a new prop
2. Move the step title resolution into `ManagerView` and pass a `Map<suggestionId, stepTitle>` or do it inline

Option 1 is cleaner because `SuggestionsSection` already owns the lookup logic.

#### Bug #42: Step Titles in Activity Messages (OnboardingHub.tsx)

**File: `src/components/OnboardingHub.tsx`**

Four locations log activities with bare step IDs:

1. **Line 79-88 (handleStatusChange):**
```typescript
logActivity({
  userInitials: employeeInstance.employeeName.slice(0, 2).toUpperCase(),
  action:
    newStatus === 'completed'
      ? `completed step ${id}`          // <-- bare numeric ID
      : newStatus === 'stuck'
        ? `reported stuck on step ${id}` // <-- bare numeric ID
        : `marked step ${id} as pending`, // <-- bare numeric ID
  timeAgo: 'just now',
}).catch(console.warn);
```

2. **Line 119-123 (handleSuggestEdit):**
```typescript
logActivity({
  userInitials: employeeInstance.employeeName.slice(0, 2).toUpperCase(),
  action: `submitted suggestion for step ${activeModal.stepId}`, // <-- bare numeric ID
  timeAgo: 'just now',
}).catch(console.warn);
```

3. **Line 137-141 (handleReportStuck):**
```typescript
logActivity({
  userInitials: employeeInstance.employeeName.slice(0, 2).toUpperCase(),
  action: `reported stuck on step ${activeModal.stepId}`, // <-- bare numeric ID
  timeAgo: 'just now',
}).catch(console.warn);
```

**Fix approach**: At each logging point, resolve the step title from `employeeStepsData`:

```typescript
const stepTitle = employeeStepsData.find(s => s.id === id)?.title || `Step ${id}`;
```

Then use it in the message:
```typescript
action: `completed "${stepTitle}"`
```

**Data availability**: At each logging point in `OnboardingHub`, `employeeStepsData` is in scope (it's a component-level variable). The step `id` parameter is the numeric position, and `employeeStepsData[].id` is also the position (from the mapper). The lookup is safe and correct because it's scoped to the employee's own instance steps.

#### Bug #43: Generic Approve/Reject Activity Messages (ManagerView.tsx)

**File: `src/views/ManagerView.tsx`**

1. **Line 100-104 (handleApproveSuggestion):**
```typescript
logActivity({
  userInitials: 'MG',
  action: 'approved a documentation suggestion', // <-- generic
  timeAgo: 'just now',
}).catch(console.warn);
```

2. **Line 122-126 (handleRejectSuggestion):**
```typescript
logActivity({
  userInitials: 'MG',
  action: 'rejected a documentation suggestion', // <-- generic
  timeAgo: 'just now',
}).catch(console.warn);
```

**Data availability at approve/reject time**: The handler receives `suggestionId`. The `suggestions` array is available in scope. From the suggestion, we can get:
- `suggestion.user` (employee name who submitted it)
- `suggestion.stepId` (numeric position)
- `suggestion.instanceId` (optional, links to instance)

From `onboardingInstances` (also in scope), we can resolve the step title using `instanceId` + `stepId`.

**Fix approach**:

```typescript
const handleApproveSuggestion = async (suggestionId: number | string) => {
  const suggestion = suggestions.find(s => s.id === suggestionId);
  const stepTitle = resolveStepTitle(suggestion?.stepId, suggestion?.instanceId);
  const employeeName = suggestion?.user || 'Unknown';

  // ... existing optimistic update ...

  logActivity({
    userInitials: 'MG',
    action: `approved suggestion from ${employeeName} on "${stepTitle}"`,
    timeAgo: 'just now',
  }).catch(console.warn);
};
```

The `resolveStepTitle` helper can be a local function in `ManagerView` that uses `onboardingInstances` (already available) to look up the instance, then find the step by position.

### Helper Function Design

A shared helper pattern for step title resolution:

```typescript
// In ManagerView (local to component)
const resolveStepTitle = (stepId?: number, instanceId?: string): string => {
  if (stepId === undefined) return 'Unknown Step';
  if (instanceId) {
    const instance = onboardingInstances.find(i => i.id === instanceId);
    if (instance) {
      const step = instance.steps.find(s => s.id === stepId);
      if (step) return step.title;
    }
  }
  // Fallback: search all instances (less precise but handles missing instanceId)
  const step = managerSteps.find(s => s.id === stepId);
  return step?.title || `Step ${stepId}`;
};
```

This same pattern applies in `SuggestionsSection` for Bug #41.

### Files That Need Changes

| File | Change | Bug |
|------|--------|-----|
| `src/views/ManagerView.tsx` | Add `resolveStepTitle` helper, update approve/reject activity messages | #43 |
| `src/components/manager/SuggestionsSection.tsx` | Update `getStepTitle` to accept `instanceId` and use instance-scoped lookup | #41 |
| `src/components/OnboardingHub.tsx` | Resolve step titles in activity messages for status changes, suggestion submission, and report stuck | #42 |
| `src/views/ManagerView.test.tsx` | Update expected activity message assertions | #43 |
| `src/types/index.ts` | Update `SuggestionsSectionProps` to add `onboardingInstances` prop | #41 |

### Files That Do NOT Need Changes

| File | Reason |
|------|--------|
| `src/components/manager/SuggestionCard.tsx` | Already receives `stepTitle` as a prop -- correct by design |
| `src/services/supabase/suggestionService.ts` | Already stores and retrieves `instanceId` correctly |
| `src/services/supabase/mappers.ts` | Already maps `instance_id` to `instanceId` |
| `src/services/supabase/activityService.ts` | Activities are stored as plain strings; no schema change needed |
| `src/store/useOnboardingStore.ts` | No store changes needed |
| `src/hooks/useSuggestions.ts` | Hook already returns `Suggestion[]` with `instanceId` |
| `src/types/database.types.ts` | No DB schema changes |

### Patterns to Follow
- Fire-and-forget activity logging: `logActivity({...}).catch(console.warn)`
- Optimistic update + rollback for approve/reject (already in place, no changes needed)
- Props interface changes go in `src/types/index.ts`
- Test mock pattern: `vi.mock('../services/supabase', () => ({...}))`

## Constraints

### Performance
- Step title resolution is O(n) where n = total steps across all instances. With typical instance counts (<100), this is negligible.
- Resolution happens at approve/reject/submit time (user-triggered), not on every render.

### Platform
- No platform constraints for this feature.

### Dependencies
- Suggestion `instanceId` field must be populated. It is already stored by `createSuggestion` in `OnboardingHub.tsx`. Existing suggestions in the DB that were created before `instanceId` was added will use the fallback (first-match) behavior.

## Risk Assessment

### Technical Risks
| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Old suggestions without `instanceId` | Low | Medium | Fallback to first-match behavior (current behavior) when `instanceId` is missing |
| Activity message format change breaks ActivityFeed icon logic | Low | Low | `getActionIcon` in `ActivityFeed.tsx` uses `.includes()` checks ("completed", "stuck", "suggestion") -- new messages still contain these keywords |
| Test assertion changes for new message formats | Low | High | Update all test assertions for `logActivity` calls with new message formats |

### Complexity
- **Level:** Simple
- **Rationale:** All three bugs are variations of the same problem (resolving step title from numeric ID). The data is already available at every call site. No new services, hooks, or store changes needed. The fix is localized string formatting + a lookup function.

## Open Questions

All questions are resolved based on code analysis:

- [x] Q1: Does the `Suggestion` type already have `instanceId`?
  - Resolution: YES. `instanceId?: string` exists on the type, is stored in DB, and is passed during creation.

- [x] Q2: What data is available at each activity logging point?
  - Resolution: In `OnboardingHub.tsx`, `employeeStepsData` (the employee's steps) is in scope. In `ManagerView.tsx`, `suggestions` (with `instanceId`), `onboardingInstances`, and `managerSteps` are all in scope.

- [x] Q3: Will changing activity message format break the ActivityFeed icon logic?
  - Resolution: No. `ActivityFeed.tsx` uses `.includes('completed')`, `.includes('stuck')`, `.includes('suggestion')` which will still match.

- [x] Q4: How does `SuggestionsSection` get instance data for the lookup?
  - Resolution: Add `onboardingInstances` to `SuggestionsSectionProps`. `ManagerView` already has `onboardingInstances` and passes `steps` (the flattened array) -- adding the instances prop is trivial.

## Recommended Approach

### Implementation Strategy

Create a step title resolution pattern used consistently across all three bug fixes:

1. **SuggestionsSection (Bug #41)**: Add `onboardingInstances` prop, update `getStepTitle` to prefer instance-scoped lookup with fallback.

2. **OnboardingHub (Bug #42)**: Add a local helper function that resolves step title from `employeeStepsData` by step ID. Update all 4 `logActivity` call sites.

3. **ManagerView (Bug #43)**: Add a local `resolveStepTitle` helper using `onboardingInstances`. Look up the suggestion to get `user`, `stepId`, `instanceId` before logging.

### Order of Work

1. **Types**: Add `onboardingInstances` to `SuggestionsSectionProps` in `src/types/index.ts`
2. **SuggestionsSection (Bug #41)**: Update `getStepTitle` to use instance-scoped lookup
3. **ManagerView (Bug #43)**: Add `resolveStepTitle` helper, update approve/reject activity messages, pass `onboardingInstances` to `SuggestionsSection`
4. **OnboardingHub (Bug #42)**: Add step title resolution to all `logActivity` calls
5. **Tests**: Update `ManagerView.test.tsx` assertions, add tests for `SuggestionsSection` step title resolution

### What to Defer
- No need for a shared utility module for `resolveStepTitle` -- the function is small and the contexts (ManagerView vs OnboardingHub) use different data sources.
- No need to backfill existing activity records in the DB -- they are historical.

### Exact Code Changes

#### 1. `src/types/index.ts` -- Add `onboardingInstances` to SuggestionsSectionProps

```typescript
export interface SuggestionsSectionProps {
  suggestions: Suggestion[];
  steps: Step[];
  onApprove?: (id: number | string) => void;
  onReject?: (id: number | string) => void;
  loadingSuggestionIds?: Set<number | string>;
  onboardingInstances?: OnboardingInstance[];  // NEW
}
```

#### 2. `src/components/manager/SuggestionsSection.tsx` -- Instance-scoped step lookup

```typescript
const getStepTitle = (stepId: number, instanceId?: string): string => {
  if (instanceId && onboardingInstances) {
    const instance = onboardingInstances.find(i => i.id === instanceId);
    if (instance) {
      const step = instance.steps.find(s => s.id === stepId);
      if (step) return step.title;
    }
  }
  return steps.find((s) => s.id === stepId)?.title || 'Unknown Step';
};
```

Update the call site:
```typescript
stepTitle={getStepTitle(sugg.stepId, sugg.instanceId)}
```

Destructure `onboardingInstances` from props.

#### 3. `src/views/ManagerView.tsx` -- Contextual approve/reject messages

Add helper:
```typescript
const resolveStepTitle = (stepId?: number, instanceId?: string): string => {
  if (stepId === undefined) return 'Unknown Step';
  if (instanceId) {
    const instance = onboardingInstances.find(i => i.id === instanceId);
    if (instance) {
      const step = instance.steps.find(s => s.id === stepId);
      if (step) return step.title;
    }
  }
  return managerSteps.find(s => s.id === stepId)?.title || `Step ${stepId}`;
};
```

Update approve handler:
```typescript
const suggestion = suggestions.find(s => s.id === suggestionId);
const stepTitle = resolveStepTitle(suggestion?.stepId, suggestion?.instanceId);
const employeeName = suggestion?.user || 'Unknown';

logActivity({
  userInitials: 'MG',
  action: `approved suggestion from ${employeeName} on "${stepTitle}"`,
  timeAgo: 'just now',
}).catch(console.warn);
```

Update reject handler similarly:
```typescript
action: `rejected suggestion from ${employeeName} on "${stepTitle}"`,
```

Pass `onboardingInstances` to SuggestionsSection:
```typescript
<SuggestionsSection
  suggestions={suggestions}
  steps={managerSteps}
  onApprove={handleApproveSuggestion}
  onReject={handleRejectSuggestion}
  loadingSuggestionIds={loadingSuggestionIds}
  onboardingInstances={onboardingInstances}  // NEW
/>
```

#### 4. `src/components/OnboardingHub.tsx` -- Step titles in all activity messages

Add local helper:
```typescript
const getStepTitle = (stepId: number): string => {
  return employeeStepsData.find(s => s.id === stepId)?.title || `Step ${stepId}`;
};
```

Update handleStatusChange (line 79-88):
```typescript
const stepTitle = getStepTitle(id);
logActivity({
  userInitials: employeeInstance.employeeName.slice(0, 2).toUpperCase(),
  action:
    newStatus === 'completed'
      ? `completed "${stepTitle}"`
      : newStatus === 'stuck'
        ? `reported stuck on "${stepTitle}"`
        : `marked "${stepTitle}" as pending`,
  timeAgo: 'just now',
}).catch(console.warn);
```

Update handleSuggestEdit (line 119-123):
```typescript
const stepTitle = getStepTitle(activeModal.stepId);
logActivity({
  userInitials: employeeInstance.employeeName.slice(0, 2).toUpperCase(),
  action: `submitted suggestion for "${stepTitle}"`,
  timeAgo: 'just now',
}).catch(console.warn);
```

Update handleReportStuck (line 137-141):
```typescript
const stepTitle = getStepTitle(activeModal.stepId);
logActivity({
  userInitials: employeeInstance.employeeName.slice(0, 2).toUpperCase(),
  action: `reported stuck on "${stepTitle}"`,
  timeAgo: 'just now',
}).catch(console.warn);
```

#### 5. Tests

**`src/views/ManagerView.test.tsx`**: Update assertions:
- Line 340: `action: 'approved a documentation suggestion'` --> `action: expect.stringContaining('approved suggestion from Alice on')`
- Line 393: `action: 'rejected a documentation suggestion'` --> `action: expect.stringContaining('rejected suggestion from Alice on')`

**New test file or additions for SuggestionsSection**: Test that instance-scoped lookup returns correct step title when multiple instances have overlapping step IDs.

## Next Step

**All questions resolved. Ready for planning.**

Run `/plan suggestion-improvements` to create implementation plan.
