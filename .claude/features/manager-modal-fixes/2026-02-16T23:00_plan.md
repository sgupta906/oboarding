# Plan: manager-modal-fixes

## Metadata
- **Feature:** manager-modal-fixes (Bugs #5 and #28)
- **Created:** 2026-02-16T23:00
- **Status:** plan-complete
- **Based on:** 2026-02-16T23:00_research.md

---

## Architecture Overview

### Bug #5: readOnly prop threading

```
OnboardingHub (readOnly={isManager && currentView === 'employee'})
  |
  v
MemoizedEmployeeView (readOnly)
  |
  v
StepTimeline (readOnly)
  |
  v
StepCard (readOnly)
  |
  v
ActionBar (readOnly)  -->  if readOnly: render "View Only" badge, hide all buttons
```

The `readOnly` prop is a simple boolean drilled through 4 component layers. When true, ActionBar renders a read-only indicator instead of action buttons. No callbacks are removed from signatures -- the prop is purely a rendering concern.

### Bug #28: useEffect reset pattern

```
Each modal with form state:

  isOpen: false -> true  (modal opens)
        |
        v
  useEffect(() => {
    if (isOpen) resetForm();  // or pre-fill for edit mode
  }, [isOpen]);
        |
        v
  Form starts clean every time, regardless of how previous close happened
```

This is additive -- the existing `handleClose` -> `resetForm()` flow is kept intact for defense-in-depth. Both reset paths coexist harmlessly.

---

## Tech Stack Summary

No new dependencies. All changes use existing React patterns:
- TypeScript optional prop (`readOnly?: boolean`)
- `useEffect` hook (already imported in most modal files)

---

## File Structure

### Files to Modify

| File | Change | Lines Affected |
|------|--------|----------------|
| `src/types/index.ts` | Add `readOnly?: boolean` to `StepCardProps` and `ActionBarProps` | ~L179-203 |
| `src/components/onboarding/ActionBar.tsx` | Accept `readOnly` prop; when true, render "View Only" badge instead of buttons | Full component (~111 lines) |
| `src/components/onboarding/StepCard.tsx` | Accept and forward `readOnly` prop to ActionBar | ~L21-28, L141-147 |
| `src/components/onboarding/StepTimeline.tsx` | Accept and forward `readOnly` prop to StepCard | ~L10-16, L74-81 |
| `src/views/EmployeeView.tsx` | Accept and forward `readOnly` prop to StepTimeline | ~L12-20, L115-121 |
| `src/components/OnboardingHub.tsx` | Pass `readOnly={isManager && currentView === 'employee'}` to MemoizedEmployeeView | ~L219-227 |
| `src/components/modals/CreateOnboardingModal.tsx` | Add `useEffect` that calls `resetForm()` when `isOpen` becomes true | After L68 |
| `src/components/modals/UserModal.tsx` | Add `useEffect` for create-mode reset when `isOpen` becomes true | After L54 |
| `src/components/modals/RoleModal.tsx` | Add `useEffect` that resets form when `isOpen` becomes true | After L56, also add `useEffect` to imports |
| `src/components/templates/TemplateModal.tsx` | Add `useEffect` for create-mode reset when `isOpen` becomes true | After L67 |
| `src/components/modals/SuggestEditModal.tsx` | Add `useEffect` that resets text/showValidation when `isOpen` becomes true | After L32, also add `useEffect` to imports |

### Test Files to Modify

| File | Change |
|------|--------|
| `src/components/onboarding/ActionBar.test.tsx` | Add tests: readOnly hides buttons, readOnly shows "View Only" badge |
| `src/views/EmployeeView.test.tsx` | Add test: readOnly prop forwarded (no action buttons visible) |
| `src/components/modals/CreateOnboardingModal.test.tsx` | Add test: form resets when re-opened |
| `src/components/modals/UserModal.test.tsx` | Add test: form resets on re-open (create mode) |
| `src/components/modals/RoleModal.test.tsx` | Add test: form resets on re-open (create mode) |
| `src/components/templates/TemplateModal.test.tsx` | Add test: form resets on re-open (create mode) |
| `src/components/modals/SuggestEditModal.test.tsx` | Add test: text/validation resets on re-open |

### No New Files

All changes are within existing files.

---

## Data Model Changes

None. These are purely UI-layer bugs.

---

## Component Architecture

### readOnly prop chain

```
StepCardProps (types/index.ts)
  + readOnly?: boolean

ActionBarProps (types/index.ts)
  + readOnly?: boolean

StepTimelineProps (StepTimeline.tsx, inline interface)
  + readOnly?: boolean

EmployeeViewProps (EmployeeView.tsx, inline interface)
  + readOnly?: boolean
```

### ActionBar readOnly rendering

When `readOnly` is true:
- Hide all action buttons (Mark as Done, Mark as Incomplete, I'm Stuck, Resume Work, Suggest Edit)
- Show a simple read-only indicator: "View Only" text with an Eye icon
- Keep the border-top separator line for visual consistency

When `readOnly` is false or undefined:
- No change to current behavior

### Modal useEffect pattern

Each modal gets a `useEffect` that runs on `isOpen` change:

**Create-mode modals** (CreateOnboardingModal, UserModal create, RoleModal create, TemplateModal create):
```typescript
useEffect(() => {
  if (isOpen) {
    resetForm();
  }
}, [isOpen]);
```

**Edit-mode modals** (UserModal edit, TemplateModal edit):
- Already have a `useEffect` that pre-fills from props on `isOpen` change. No additional effect needed.

**RoleModal** -- special case:
- Create mode: reset `name`, `description`, `touched` on open
- Edit mode: `description` initialized from `currentRole` in `useState`, but no `useEffect` to re-sync. Add a `useEffect` that re-syncs `description` from `currentRole` when `isOpen` becomes true in edit mode.

**SuggestEditModal**:
```typescript
useEffect(() => {
  if (isOpen) {
    setText('');
    setShowValidation(false);
  }
}, [isOpen]);
```

---

## Testing Strategy

### Unit Tests (7 new tests, added to existing test files)

| Test | File | Description |
|------|------|-------------|
| ActionBar readOnly hides buttons | ActionBar.test.tsx | Render with `readOnly={true}`, verify no action buttons, verify "View Only" text |
| ActionBar readOnly shows indicator | ActionBar.test.tsx | Render with `readOnly={true}`, verify View Only indicator present |
| EmployeeView forwards readOnly | EmployeeView.test.tsx | Render with `readOnly={true}`, verify no "Mark as Done" buttons in DOM |
| CreateOnboardingModal resets on re-open | CreateOnboardingModal.test.tsx | Type data, close, re-open, verify fields are empty |
| UserModal (create) resets on re-open | UserModal.test.tsx | Type data, close, re-open, verify fields are empty |
| RoleModal (create) resets on re-open | RoleModal.test.tsx | Type data, close, re-open, verify fields are empty |
| SuggestEditModal resets on re-open | SuggestEditModal.test.tsx | Type text, close, re-open, verify textarea is empty |

### Integration Tests

No new integration tests. The readOnly prop is purely a rendering concern with no service-layer interaction. Modal reset is a client-side state concern.

### E2E Tests (Playwright)

Deferred to `/test` phase. The test agent should:
1. Log in as Manager, navigate to Employee View, select an employee, verify no action buttons visible
2. Open CreateOnboardingModal, fill partial data, close, re-open, verify form is clean

---

## Implementation Notes

### Decisions
1. **readOnly prop over removing onStatusChange**: Keeps TypeScript signatures stable. A separate boolean is cleaner than making all callbacks optional.
2. **useEffect reset over conditional mount**: Keeps existing component tree structure. Conditional mounting would cause flash/flicker and is a larger refactor.
3. **Keep handleClose reset alongside useEffect reset**: Defense-in-depth. Both can coexist without conflict.

### Patterns
- The `readOnly` prop follows the same drilling pattern as `loadingStepIds` through the component chain.
- The `useEffect` reset pattern already exists in `UserModal` (edit mode, line 56-65) and `TemplateModal` (edit mode, line 70-87).

### Trade-offs
- Threading `readOnly` through 4 components is slightly verbose, but context/store would be overkill for a single boolean.
- The module-level `stepUidCounter` in TemplateModal will increment on every resetForm call. This is cosmetic and not worth fixing.

---

## Non-Goals

- **Not fixing**: Module-level `stepUidCounter` growing forever in TemplateModal
- **Not removing**: Existing `handleClose` -> `resetForm()` flow (kept for defense-in-depth)
- **Not adding**: Manager ability to update employee steps (explicitly prohibited by business rules)
- **Not refactoring**: Modal mounting pattern (always-mounted vs conditional-mount)
- **Not adding**: Dark mode classes to ActionBar's new "View Only" indicator (covered by separate Bug #25)
