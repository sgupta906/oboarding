# Plan: pdf-template-import

## Metadata
- **Feature:** pdf-template-import
- **Created:** 2026-02-17T20:30
- **Status:** plan-complete
- **Based on:** 2026-02-17T20:00_research.md

## Architecture Overview

The PDF template import feature allows managers to upload a PDF file containing bulleted or numbered onboarding instructions, parse them client-side into template steps, and create a template via the existing `TemplateModal`. The design maximizes reuse of existing components -- no new modals, no database changes, no new API endpoints.

### Data Flow

```
                                  TemplatesView
                                       |
                      +----------------+------------------+
                      |                                   |
             "Create Template"                    "Import from PDF"
              (existing flow)                    (new flow)
                      |                                   |
                      |                          <input type="file">
                      |                                   |
                      |                       validate file (type, size)
                      |                                   |
                      |                       dynamic import pdfParser
                      |                                   |
                      |                    extractTextFromPdf(file)
                      |                        [pdfjs-dist]
                      |                                   |
                      |                    parseBulletsToSteps(rawText)
                      |                        [regex heuristics]
                      |                                   |
                      |                       ParsedStep[] result
                      |                                   |
                      v                                   v
                  TemplateModal  <---  initialSteps prop ---+
                  (create mode)
                      |
                 useTemplates().create()
                      |
                  templateService.createTemplate()
                      |
                  Supabase DB
```

### Component Hierarchy (Changes Only)

```
TemplatesView (MODIFY)
  +-- <input type="file" accept=".pdf" hidden />    (NEW)
  +-- "Import from PDF" button                       (NEW)
  +-- TemplateModal (MODIFY - add initialSteps prop)
        mode="create"
        initialSteps={parsedSteps}         (NEW prop)
        pdfFileName={fileName}             (NEW prop, for info banner)
```

## Tech Stack Summary

| Layer | Technology | Notes |
|-------|-----------|-------|
| PDF parsing | `pdfjs-dist` ^5.x | Client-side, dynamic import, CDN worker |
| Bullet parsing | Custom regex heuristics | `src/utils/pdfParser.ts` |
| UI | Existing `TemplateModal` | Extended with `initialSteps` prop |
| State | React local state | No Zustand changes needed |
| Persistence | Existing `useTemplates().create()` | No service changes |
| Testing | Vitest + RTL | Unit tests for parser, component tests for modal |

## File Structure

### New Files

| File | Purpose |
|------|---------|
| `src/utils/pdfParser.ts` | PDF text extraction (`extractTextFromPdf`) + bullet parsing (`parseBulletsToSteps`) + types (`ParsedStep`) |
| `src/utils/pdfParser.test.ts` | Unit tests for `parseBulletsToSteps` (pure function, no mocking needed) and `extractTextFromPdf` (mocked pdfjs-dist) |

### Modified Files

| File | Changes | Lines Affected |
|------|---------|---------------|
| `src/components/templates/TemplateModal.tsx` | 1. Add `initialSteps` and `pdfFileName` to `TemplateModalProps` interface (lines 13-24). 2. Destructure new props in component (line 45-56). 3. Update create-mode `useEffect` reset to use `initialSteps` if provided (lines 70-74). 4. Add info banner when `pdfFileName` is set (inside form, after error messages, ~line 340). | ~20 lines added |
| `src/views/TemplatesView.tsx` | 1. Add imports for `FileUp`, `Loader2` (line 8). 2. Add state: `importLoading`, `importError`, `importedSteps`, `pdfFileName` (after line 30). 3. Add `handlePdfImport` async handler (after line 102). 4. Add hidden `<input type="file">` ref (in JSX, before modals). 5. Add "Import from PDF" button next to "Create Template" (lines 130-138). 6. Pass `initialSteps` and `pdfFileName` to create-mode `TemplateModal` (lines 306-318). | ~50 lines added |
| `src/components/templates/TemplateModal.test.tsx` | Add test suite for `initialSteps` prop behavior: steps pre-filled, info banner displayed, form still validates. | ~40 lines added |
| `package.json` | Add `pdfjs-dist` to dependencies (line 19 area). | 1 line added |

### Files NOT Modified

- `src/types/index.ts` -- No new types needed in the global types file. `ParsedStep` is local to `pdfParser.ts`.
- `src/services/supabase/*` -- No backend changes.
- `src/hooks/useTemplates.ts` -- No hook changes.
- `src/components/templates/index.ts` -- No new exported components.
- `vite.config.ts` -- CDN worker approach requires no Vite config changes.

## Data Model

**No database changes.** The PDF import produces the same `Omit<Template, 'id' | 'createdAt'>` payload that manual template creation does. The `ParsedStep` type is a simple local interface:

```typescript
export interface ParsedStep {
  title: string;
  description: string;
}
```

This maps to the existing `TemplateStep` local type inside `TemplateModal.tsx`:

```typescript
interface TemplateStep {
  id?: number;
  _uid: string;
  title: string;
  description: string;
  owner: string;
  expert: string;
}
```

The mapping happens inside `TemplateModal` when `initialSteps` are provided: each `ParsedStep` gets a `_uid`, empty `owner` and `expert` fields.

## Component Architecture

### TemplateModal Changes

The `TemplateModal` component gains two new optional props:

```typescript
interface TemplateModalProps {
  // ... existing props ...
  initialSteps?: Array<{ title: string; description: string }>;
  pdfFileName?: string;
}
```

**Behavior when `initialSteps` is provided:**

1. The create-mode `useEffect` (lines 70-74) checks for `initialSteps`
2. If present, it maps each item to a `TemplateStep` with `_uid`, empty `owner`/`expert`
3. If absent, it falls back to the existing single-empty-step default
4. An info banner is shown below the error block: "N steps imported from filename.pdf"
5. All other behavior (validation, submission, step editing) remains unchanged

### TemplatesView Changes

New state variables:
- `importLoading: boolean` -- true while PDF is being processed
- `importError: string | null` -- error message if import fails
- `importedSteps: ParsedStep[] | null` -- parsed steps to pass to TemplateModal
- `pdfFileName: string | null` -- source filename for info banner

New handler `handlePdfImport(event: React.ChangeEvent<HTMLInputElement>)`:
1. Validate file type is `.pdf`
2. Validate file size is under 10 MB
3. Set `importLoading = true`
4. Dynamic import `pdfParser` module
5. Call `extractTextFromPdf(file)` to get raw text
6. Call `parseBulletsToSteps(rawText)` to get steps
7. If steps.length === 0, show error "No steps could be extracted from this PDF"
8. Otherwise, set `importedSteps` and `pdfFileName`, open create modal
9. On modal close, clear `importedSteps` and `pdfFileName`

### pdfParser Module

Two exported functions, one exported type:

```
src/utils/pdfParser.ts
  |-- ParsedStep (interface)
  |-- extractTextFromPdf(file: File): Promise<string>
  |-- parseBulletsToSteps(rawText: string): ParsedStep[]
```

**`extractTextFromPdf`:**
- Uses `pdfjs-dist` to load the PDF from an ArrayBuffer
- Iterates all pages, extracts text content items
- Joins items with spaces per page, pages with newlines
- Configures worker via CDN URL on first call

**`parseBulletsToSteps`:**
- Splits raw text on newlines, trims, filters empty
- Applies bullet regex: unicode bullets, ASCII bullets (`-`, `*`, `+`), numbered lists (`1.`, `2)`), lettered lists (`a.`, `b)`), arrow markers, checkbox markers
- Each match becomes a `ParsedStep` with the captured text as `title`, empty `description`
- Fallback: if zero bullets detected, each non-empty line between 6-200 chars becomes a step
- Returns `ParsedStep[]` (may be empty if PDF has no parseable text)

## Testing Strategy

### Unit Tests: `src/utils/pdfParser.test.ts` (~25 tests)

**`parseBulletsToSteps` tests (pure function, no mocking):**
1. Parses dash-prefixed bullets (`- Step one`)
2. Parses asterisk-prefixed bullets (`* Step one`)
3. Parses plus-prefixed bullets (`+ Step one`)
4. Parses numbered lists with dots (`1. Step one`)
5. Parses numbered lists with parens (`1) Step one`)
6. Parses lettered lists with dots (`a. Step one`)
7. Parses lettered lists with parens (`a) Step one`)
8. Parses unicode bullet characters
9. Parses arrow markers (`> Step one`)
10. Parses checkbox markers
11. Ignores non-bullet text (headers, paragraphs)
12. Handles mixed bullet styles in one document
13. Trims whitespace from extracted titles
14. Returns empty array for empty string input
15. Returns empty array for whitespace-only input
16. Fallback: lines become steps when no bullets detected
17. Fallback: ignores very short lines (< 6 chars)
18. Fallback: ignores very long lines (> 200 chars)
19. Handles multi-page text (newline-separated)
20. Sets empty description for all parsed steps

**`extractTextFromPdf` tests (mocked pdfjs-dist):**
21. Returns extracted text from single-page PDF
22. Returns extracted text from multi-page PDF (newline-joined)
23. Returns empty string for empty PDF
24. Throws error for invalid/corrupt file
25. Configures worker source on invocation

### Component Tests: `src/components/templates/TemplateModal.test.tsx` (~6 new tests)

**`initialSteps` prop tests:**
26. Pre-fills step titles from `initialSteps` when in create mode
27. Pre-fills empty descriptions for imported steps
28. Shows info banner with step count and filename when `pdfFileName` is provided
29. Does not show info banner when `pdfFileName` is not provided
30. Still validates form (name, role required) even with pre-filled steps
31. Allows editing pre-filled step titles before saving

### Integration-style Tests in TemplatesView (Not in scope for unit tests)

The TemplatesView does not currently have a test file. Adding a full TemplatesView test suite is out of scope for this feature. The import flow will be tested via the `pdfParser` unit tests and the `TemplateModal` component tests. End-to-end validation can be done manually or via Playwright in the `/test` phase.

### Test Count Estimate

- New tests: ~31
- Modified test files: 1 (TemplateModal.test.tsx, +6 tests)
- New test files: 1 (pdfParser.test.ts, ~25 tests)

## Implementation Notes

### Decisions

1. **Reuse TemplateModal over building a new modal.** This was the research recommendation and is the clear winner for minimizing new code. The modal already has step editing, validation, role selection, and submission. Adding an `initialSteps` prop is straightforward.

2. **CDN worker for pdfjs-dist.** No Vite config changes needed. The CDN URL (`https://unpkg.com/pdfjs-dist@VERSION/build/pdf.worker.min.mjs`) is set at runtime. Downside: requires internet. Acceptable since the app already requires internet for Supabase.

3. **Dynamic import for code splitting.** `pdfjs-dist` is ~400-500 KB gzipped. Using `await import('../utils/pdfParser')` ensures it is only loaded when the user clicks "Import from PDF". No impact on normal page load.

4. **Bullet regex approach over text positioning.** PDF.js provides text positioning data that could be used for smarter paragraph detection. However, the regex approach is simpler, more testable, and sufficient for v1. The editable preview lets managers fix any parsing issues.

5. **`pdfFileName` as a separate prop** rather than embedding it in `initialSteps`. This keeps the data structure clean and makes it easy to conditionally render the info banner.

### Patterns

- **Error handling pattern:** Matches existing `TemplatesView` error display -- red-bordered alert boxes with `bg-red-50 dark:bg-red-900/30`.
- **Loading pattern:** `Loader2` spinner with `animate-spin` on the Import button during processing.
- **File input pattern:** Hidden `<input type="file">` triggered by button click via `useRef`. Standard React pattern.
- **Dark mode:** All new elements use `dark:` Tailwind variants per project convention.

### Trade-offs

| Decision | Benefit | Cost |
|----------|---------|------|
| CDN worker | Zero build config changes | Requires internet for PDF parsing |
| Dynamic import | Small main bundle | Slight delay on first import click |
| Regex-only parsing | Simple, testable | May miss multi-line bullets |
| No TemplatesView tests | Faster delivery | Less integration test coverage |
| Reuse TemplateModal | Less code, consistent UX | `initialSteps` prop adds complexity to an already large component |

## Non-Goals (Explicitly Deferred)

- **Drag-and-drop file upload** -- v2 enhancement. File picker button is sufficient for v1.
- **Multi-line bullet merging** -- v2 enhancement. Would require using pdf.js text position data.
- **PDF section header detection** -- v2 enhancement. Auto-grouping steps by headers.
- **Step description extraction from sub-bullets** -- v2 enhancement. All descriptions are empty in v1.
- **Support for other file formats (DOCX, TXT)** -- Separate feature entirely.
- **Server-side PDF processing** -- Out of scope. Entire feature is client-side.
- **PDF upload to Supabase Storage** -- Not needed. PDF is processed and discarded.
- **TemplatesView test suite** -- Out of scope for this feature. Would be a separate effort.

## Risk Mitigation

| Risk | Mitigation |
|------|-----------|
| pdfjs-dist CDN fails | Show clear error: "Could not load PDF processor. Please check your internet connection." Wrap the dynamic import in try/catch. |
| PDF has no extractable text (image-only) | Return empty string from `extractTextFromPdf`. `parseBulletsToSteps` returns empty array. UI shows: "No steps could be extracted from this PDF. The PDF may contain only images." |
| pdfjs-dist version mismatch with CDN worker | Pin the worker URL to `pdfjsLib.version` so they always match. |
| Large PDFs (50+ pages) cause slowdown | 10 MB file size limit catches most cases. Show loading state during extraction. |
| Bundle size regression | Dynamic import ensures pdfjs-dist is in a separate chunk. Verify with `npx vite build` that main chunk size is unchanged. |
