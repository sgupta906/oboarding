# Plan: template-reorder-fix

## Metadata
- **Feature:** template-reorder-fix
- **Bug #:** 37 (`template-reorder-not-persisted`)
- **Priority:** P1 HIGH
- **Created:** 2026-02-16T23:30
- **Status:** plan-complete
- **Based On:** `2026-02-16T23:30_research.md`

## Architecture Overview

### The Bug

When editing a template, reordering steps via ChevronUp/ChevronDown buttons updates the UI (optimistic state) but does NOT persist to the database. On page reload, steps revert to their original order.

### Root Cause (1 line)

```
TemplateModal.tsx line 205
```

```typescript
// BEFORE (buggy):
id: s.id || index + 1,

// AFTER (fixed):
id: index + 1,
```

### Why This Fixes It

```
                    DATA FLOW
                    =========

User reorders steps [A(id=1), B(id=2), C(id=3)] --> [B, A, C]

                  BEFORE FIX                          AFTER FIX
                  ----------                          ---------
TemplateModal     s.id || index+1                     index + 1
handleSubmit:     B.id=2, A.id=1, C.id=3              B.id=1, A.id=2, C.id=3
                  (original ids kept!)                 (new positions!)
                       |                                    |
                       v                                    v
templateService   position: step.id                   position: step.id
updateTemplate:   B=2, A=1, C=3                        B=1, A=2, C=3
                  (writes old order)                    (writes new order)
                       |                                    |
                       v                                    v
mappers.ts        sort by position                    sort by position
toTemplate:       A(1), B(2), C(3)                     B(1), A(2), C(3)
                  (original order!)                     (reordered!)
```

The `||` operator short-circuits because `s.id` is always a positive integer (truthy) for existing steps. Replacing with unconditional `index + 1` ensures the array position after reorder becomes the new step ID/position.

### Why Create Mode Is Unaffected

For new templates, `s.id` is `undefined` (the local `TemplateStep` interface has `id?: number`). So `undefined || index + 1` already evaluates to `index + 1`. After the fix, `index + 1` is used unconditionally -- same result.

### No Other Files Need Changes

- `templateService.ts` -- `position: step.id` is correct (now receives updated ids)
- `mappers.ts` -- `id: row.position` read path is correct
- `useTemplates.ts` -- optimistic update already uses the submitted data

## Tech Stack

No new dependencies. Uses existing Vitest + React Testing Library for the new test.

## File Structure

### Files to Modify

| File | Line | Change |
|------|------|--------|
| `src/components/templates/TemplateModal.tsx` | 205 | `s.id \|\| index + 1` --> `index + 1` |
| `src/components/templates/TemplateModal.test.tsx` | after line 579 | Add 1 new test case |

### No New Files

This is a 1-line bugfix with 1 new test.

## Testing Strategy

### New Test (1 test)

**"should submit correct step IDs after reorder"** -- verifies that when steps are reordered and the form is submitted, the `onSubmit` callback receives steps with `id` values matching their new array positions (1-based), NOT their original positions.

Test flow:
1. Render TemplateModal in edit mode with `mockTemplateWithMultipleSteps` (steps A=id:1, B=id:2, C=id:3)
2. Click "Move step 1 down" to reorder to [B, A, C]
3. Click "Save Changes"
4. Assert `onSubmit` was called with `steps[0].id === 1`, `steps[1].id === 2`, `steps[2].id === 3`
5. Also assert step titles match new order: steps[0].title === 'Step B', steps[1].title === 'Step A'

### Existing Tests (6 reorder tests)

All 6 existing reorder tests in `TemplateModal.test.tsx` (lines 420-579) test UI behavior only. They should continue to pass unchanged since the fix does not alter the UI reorder logic -- it only changes the `id` value in the submitted payload.

### Regression: Full Suite

Run `npx vitest run` to confirm all 508+ tests pass.

## Implementation Notes

- **Pattern:** This is a pure data-transformation bug, not a UI bug. The UI always showed the correct order (optimistic update). The fix ensures the persisted data matches the UI.
- **Risk:** Minimal. The change is strictly more correct -- unconditional `index + 1` is what was always intended.
- **The `Step.id === position` conflation** is a known design smell but works correctly everywhere once this line is fixed. Not worth refactoring now.

## Non-Goals

- Refactoring `Step.id` to separate identity from position
- Fixing `syncTemplateStepsToInstances` duplicate-step edge case (pre-existing, orthogonal)
- Adding E2E tests for reorder persistence (would require live Supabase)
