# Plan: responsive-ux

## Metadata
- **Feature:** responsive-ux
- **Created:** 2026-02-14T23:00
- **Status:** plan-complete
- **Based On:** 2026-02-14T22:55_research.md

## Architecture Overview

This feature adds an optimistic-update layer on top of the existing Supabase subscription
system. No new architecture is introduced -- we extend the existing hook/context/component
patterns with three capabilities:

1. **Optimistic state mutations** in hooks (`useSteps`, `useSuggestions`, `useUsers`)
2. **A global toast notification system** (new React Context following `DarkModeContext` pattern)
3. **Loading/disabled state propagation** from `OnboardingHub` down to action buttons

```
                          Data Flow (After Changes)
  +---------------------------------------------------------------------------+
  |                                                                           |
  |  User clicks "Mark as Done"                                               |
  |       |                                                                   |
  |       v                                                                   |
  |  OnboardingHub.handleStatusChange()                                       |
  |       |                                                                   |
  |       +---> 1. Add stepId to loadingStepIds Set                           |
  |       +---> 2. useSteps.updateStatus(id, newStatus) [optimistic]          |
  |       |         |                                                         |
  |       |         +---> setData(prev => patch step status) [INSTANT]        |
  |       |         +---> await updateStepStatus() [SERVER]                   |
  |       |         +---> on error: setData(snapshot) [ROLLBACK]              |
  |       |                         + showToast(error)                        |
  |       |                                                                   |
  |       +---> 3. logActivity() [FIRE-AND-FORGET, no await]                  |
  |       +---> 4. Remove stepId from loadingStepIds Set                      |
  |       |                                                                   |
  |       v                                                                   |
  |  Subscription fires (300ms debounce) -> overwrites with server truth      |
  |                                                                           |
  +---------------------------------------------------------------------------+

                       Toast System Architecture
  +------------------------------------------------------------+
  |  App.tsx                                                    |
  |  +------------------------------------------------------+  |
  |  | AuthProvider                                         |  |
  |  | +--------------------------------------------------+ |  |
  |  | | DarkModeProvider                                  | |  |
  |  | | +----------------------------------------------+ | |  |
  |  | | | ToastProvider  <--- NEW                       | | |  |
  |  | | |   - manages toast queue (useState)            | | |  |
  |  | | |   - auto-dismiss 4s timer (useEffect)         | | |  |
  |  | | |   - renders fixed-position toast container    | | |  |
  |  | | |   - z-[60] (above modals at z-50)             | | |  |
  |  | | |                                               | | |  |
  |  | | |   AppContent                                  | | |  |
  |  | | +----------------------------------------------+ | |  |
  |  | +--------------------------------------------------+ |  |
  |  +------------------------------------------------------+  |
  +------------------------------------------------------------+
```

## Tech Stack Summary

No additions to the tech stack. All changes use:
- React 18 (useState, useEffect, useCallback, useContext, createContext)
- TypeScript (strict mode)
- Tailwind CSS 3 (emerald/rose/slate palette, fixed positioning, z-index)
- Lucide React (X icon for toast dismiss)
- Existing Supabase service layer (unchanged API signatures)

## File Structure

### New Files

| File | Purpose | Est. Lines |
|------|---------|-----------|
| `src/context/ToastContext.tsx` | Toast notification context, provider, hook, and rendering | ~85 |
| `src/context/ToastContext.test.tsx` | Tests for toast context (render, auto-dismiss, types) | ~60 |

### Modified Files

| File | Lines | Changes |
|------|-------|---------|
| `src/services/supabase/instanceService.ts` | 244-248 | Add else branch: when progress < 100, set status='active', completed_at=null |
| `src/App.tsx` | 131-138 | Wrap `AppContent` with `ToastProvider` (inside `DarkModeProvider`) |
| `src/hooks/useSteps.ts` | Full rewrite of return shape | Add `updateStatus(stepId, status)` with optimistic update + rollback; change return type |
| `src/hooks/useSuggestions.ts` | Full rewrite of return shape | Add `optimisticUpdateStatus(id, status)` and `optimisticRemove(id)` with rollback |
| `src/hooks/useUsers.ts` | lines 68-77 | Add optimistic update before `await updateUser()`, rollback on error |
| `src/components/OnboardingHub.tsx` | lines 95-188 | Manage `loadingStepIds` Set; use optimistic hook methods; fire-and-forget logActivity; use toast for errors; pass isLoading to children |
| `src/components/onboarding/ActionBar.tsx` | lines 18-99 | Accept `isLoading` prop; disable buttons and show spinner when loading |
| `src/components/onboarding/StepCard.tsx` | line 140-145 | Pass `isLoading` through to ActionBar |
| `src/components/onboarding/StepTimeline.tsx` | lines 30-35, 72-78 | Accept and pass `loadingStepId` or per-step `isLoading` |
| `src/components/manager/SuggestionCard.tsx` | lines 40-98 | Accept `isLoading` prop; disable approve/reject buttons when loading |
| `src/components/manager/SuggestionsSection.tsx` | lines 66-74 | Pass `isLoading` or `loadingSuggestionIds` to SuggestionCard |
| `src/types/index.ts` | lines 196-201, 214-219 | Add `isLoading?: boolean` to `ActionBarProps`, `StepCardProps`, `SuggestionCardProps` |
| `src/views/EmployeeView.tsx` | lines 12-18, 77-84 | Accept and pass `loadingStepIds` through to StepTimeline |
| `src/views/ManagerView.tsx` | lines 23-33, 50-60 | Accept and pass `loadingSuggestionIds` through to SuggestionsSection |

## Data Model Changes

No database schema changes. No migrations needed.

The only data-layer change is a bug fix in `instanceService.ts` `updateStepStatus()`:
```typescript
// Current (line 244-248): only handles progress === 100
if (progress === 100) {
  instanceUpdates.status = 'completed';
  instanceUpdates.completed_at = new Date().toISOString();
}

// Fixed: also handles progress < 100 (revert completed -> active)
if (progress === 100) {
  instanceUpdates.status = 'completed';
  instanceUpdates.completed_at = new Date().toISOString();
} else {
  instanceUpdates.status = 'active';
  instanceUpdates.completed_at = null;
}
```

## Component Architecture

### Toast Component Tree
```
ToastProvider
  +-- toast container (fixed, bottom-right, z-[60])
       +-- toast items (animated, color-coded by type)
            +-- message text
            +-- dismiss button (X icon)
```

### Loading State Prop Flow (Employee Side)
```
OnboardingHub (manages loadingStepIds: Set<number>)
  +-- EmployeeView (receives loadingStepIds)
       +-- StepTimeline (receives loadingStepIds)
            +-- StepCard (receives isLoading per step)
                 +-- ActionBar (receives isLoading, disables buttons)
```

### Loading State Prop Flow (Manager Side)
```
OnboardingHub (manages loadingSuggestionIds: Set<number|string>)
  +-- ManagerView (receives loadingSuggestionIds)
       +-- SuggestionsSection (receives loadingSuggestionIds)
            +-- SuggestionCard (receives isLoading, disables buttons)
```

## Testing Strategy

### Unit Tests (~25 new tests)

| Area | Count | Description |
|------|-------|-------------|
| ToastContext | 6 | Provider renders, showToast adds toast, auto-dismiss at 4s, dismiss removes, error/success/info types render correctly, throws outside provider |
| useSteps.updateStatus | 4 | Optimistic update applies immediately, rollback on error, concurrent updates, loading state |
| useSuggestions optimistic | 4 | optimisticUpdateStatus changes status, optimisticRemove removes from list, rollback on error for each |
| useUsers.editUser optimistic | 3 | Optimistic update applies, rollback on error, original state preserved |
| instanceService bug fix | 3 | Progress < 100 sets status=active + completed_at=null, progress=100 still works, progress=0 edge case |
| ActionBar loading | 3 | Buttons disabled when isLoading, spinner visible, clicks prevented |
| SuggestionCard loading | 2 | Buttons disabled when isLoading, visual indicator shown |

### Integration Tests (~5 new tests)

| Area | Count | Description |
|------|-------|-------------|
| OnboardingHub status change flow | 2 | Full optimistic + rollback cycle, fire-and-forget logActivity not awaited |
| OnboardingHub suggestion flow | 2 | Approve/reject with optimistic update, error triggers toast |
| Toast integration | 1 | Error in handler surfaces as visible toast |

### Existing Test Regression

All 297 existing tests must continue to pass. The changes to hook return types require
updating tests that destructure `useSteps` and `useSuggestions` return values, but these
are read-only subscription hooks with minimal existing test surface.

## Implementation Notes

### Key Decisions

1. **Optimistic updates modify subscription state directly.** The hooks' `setData` is called
   immediately. When the Realtime subscription fires its debounced re-fetch (300ms), it
   overwrites with server truth. This avoids dual-state complexity.

2. **Loading state tracked per-ID, not globally.** Using `Set<number>` for step IDs and
   `Set<number|string>` for suggestion IDs allows multiple concurrent operations without
   blocking the entire UI.

3. **Toast z-index is z-[60].** Modals use z-50. Toasts must appear above modals since
   errors during modal operations should be visible.

4. **Fire-and-forget uses `.catch(console.warn)`.** Activity logging failures are not
   user-facing. Silent failures are acceptable, but console.warn helps debugging.

5. **No retry logic.** Simple rollback + error toast is sufficient. Retry adds complexity
   without proportional UX benefit for this app's scale.

### Patterns Used

- **Optimistic update pattern:** Snapshot current state, apply optimistic change, await
  server call, catch error -> restore snapshot + show toast. Identical to existing
  `useUsers.createNewUser` / `useUsers.removeUser` pattern.
- **Context pattern:** `createContext` + Provider + `useHook` with guard, identical to
  `DarkModeContext.tsx`.
- **Prop drilling for loading:** Follows existing pattern where `OnboardingHub` passes
  callbacks through `EmployeeView` -> `StepTimeline` -> `StepCard` -> `ActionBar`.

### Trade-offs

| Decision | Benefit | Cost |
|----------|---------|------|
| Modify subscription state for optimistic updates | Simple, no dual-state | Brief flicker possible if subscription fires between optimistic and server confirmation |
| Per-ID loading state | Concurrent operations possible | More props to thread through component tree |
| Toast as context (not portal) | Follows existing patterns, simple | Must manage z-index manually |
| No animation library for toast | Zero new dependencies | Less polished enter/exit animations (CSS transitions only) |

## Non-Goals

- No changes to the 300ms subscription debounce
- No changes to the CRUD factory or shared subscription manager
- No skeleton loading states or shimmer effects
- No retry logic for failed mutations
- No external toast library (no new npm dependencies)
- No restructuring of the Realtime subscription system
- No changes to service API signatures (only hook return types expand)
