# Research: responsive-ux

## Metadata
- **Feature:** responsive-ux
- **Created:** 2026-02-14T22:55
- **Status:** research-complete
- **Researcher:** research-agent

## Feature Context
- **Description:** Fix UI responsiveness issues identified by 8 QA scout agents. The root cause is that every user interaction waits for a full server round-trip (800-1400ms) with zero visual feedback. The fix involves adding optimistic updates, fire-and-forget activity logging, loading/disabled button states, error notification UI, and a bug fix for instance status reversion.
- **Where it fits:** This is a UX polish layer on top of the existing Supabase data layer. It does NOT change the subscription system, database schema, or service API signatures. It modifies hooks, components, and the main OnboardingHub orchestrator.
- **Dependencies:** All prior features complete (supabase-setup through slim-tests). No blocking prerequisites.

## Requirements

### Functional Requirements
- [x] FR1: Optimistic updates on step status changes -- UI updates INSTANTLY when user clicks "Mark as Done", "Mark as Incomplete", or "Resume Work"; rolls back on server error (source: QA issue #1)
- [x] FR2: Optimistic update on `useUsers.editUser` -- local state updates immediately, rolls back on error (source: QA issue #2)
- [x] FR3: Fire-and-forget `logActivity` -- remove `await` from all `logActivity()` calls so activity logging does not block user-facing actions (source: QA issue #3)
- [x] FR4: Loading/disabled state on action buttons -- "Mark as Done", "Mark as Incomplete", "Resume Work" buttons show loading state and prevent double-click while async operation is in-flight (source: QA issue #4)
- [x] FR5: User-facing error notifications -- replace `console.error`-only error handling with a toast/banner notification system visible to the user (source: QA issue #5)
- [x] FR6: Optimistic update on suggestion approve/reject -- suggestion card visually reflects approved/rejected state immediately; rolls back on error (source: QA issue #6)
- [x] FR7: Instance status reverts from 'completed' to 'active' when progress drops below 100% (source: QA issue #7)

### Technical Requirements
- [x] TR1: No changes to the 300ms debounce in subscription handlers
- [x] TR2: No restructuring of the Realtime subscription system
- [x] TR3: Changes must be minimal and focused -- UX fix, not architecture rewrite
- [x] TR4: All 297 existing tests must continue to pass
- [x] TR5: New behavior should have test coverage where practical
- [x] TR6: Must work with existing Supabase mock pattern (`vi.mock('./supabase')`)
- [x] TR7: TypeScript strict mode compliance (`npx tsc -b` must pass)

### Constraints
- Do NOT add new npm dependencies (no external toast libraries)
- Keep the existing component API signatures stable where possible
- Follow existing patterns: React Context for global state, Tailwind for styling, Lucide for icons

## Existing Code Analysis

### Project State
- **Project exists:** YES
- **Test suite:** 297 tests across 17 files, all passing
- **Relevant existing files:** Listed below with analysis

### Code to Modify

#### 1. `src/hooks/useSteps.ts` (61 lines)
- **Current:** Read-only subscription hook. `setData` only called from subscription callback.
- **Change needed:** Expose an `optimisticUpdate(stepId, newStatus)` function that calls `setData` immediately, then calls `updateStepStatus()`, and rolls back `setData` on error.
- **Alternative approach:** Keep `useSteps` read-only and do the optimistic update in `OnboardingHub` by passing a setter. But since `useSteps` owns the `data` state, it is cleaner to add the method here.
- **Recommended:** Add `updateStatus(stepId, status)` to the hook's return value.

#### 2. `src/components/OnboardingHub.tsx` (310 lines)
- **Current:** `handleStatusChange` (lines 95-112) awaits `updateStepStatus()` then awaits `logActivity()`. No loading state passed to children. Errors caught with `console.error` only.
- **Changes needed:**
  - `handleStatusChange`: Remove `await` from `logActivity()`, delegate optimistic update to `useSteps` hook.
  - `handleSuggestEdit` (lines 122-143): Remove `await` from `logActivity()`.
  - `handleReportStuck` (lines 146-161): Remove `await` from `logActivity()`.
  - `handleApproveSuggestion` (lines 164-175): Add optimistic update for suggestion status, remove `await` from `logActivity()`.
  - `handleRejectSuggestion` (lines 177-188): Add optimistic update for suggestion removal, remove `await` from `logActivity()`.
  - Add loading state tracking (which step ID is currently in-flight) and pass to ActionBar.
  - Replace `console.error` with calls to a toast/notification system.

#### 3. `src/components/onboarding/ActionBar.tsx` (100 lines)
- **Current:** No loading/disabled props. Buttons are always clickable (except "Mark as Done" when stuck).
- **Change needed:** Accept `isLoading` or `loadingStepId` prop. When loading, show a spinner or disabled state on the primary action button. Prevent clicks during loading.
- **Props to add:** `isLoading?: boolean` to `ActionBarProps` type (in `src/types/index.ts` line 196-201).

#### 4. `src/hooks/useUsers.ts` (120 lines)
- **Current:** `editUser` (lines 68-77) calls `await updateUser(userId, data)` but does NOT update local `users` state optimistically (unlike `createNewUser` and `removeUser` which do).
- **Change needed:** Add optimistic update: `setUsers(prev => prev.map(u => u.id === userId ? { ...u, ...data } : u))` before the `await`, roll back on error.

#### 5. `src/services/supabase/instanceService.ts` (lines 244-248)
- **Current:** `updateStepStatus()` sets `status = 'completed'` and `completed_at` when progress reaches 100%, but does NOT revert these when progress drops below 100%.
- **Change needed:** Add an `else` branch: when progress < 100, set `status = 'active'` and `completed_at = null`.

#### 6. `src/hooks/useSuggestions.ts` (63 lines)
- **Current:** Read-only subscription hook. No way to optimistically update.
- **Change needed:** Expose an `optimisticRemove(id)` and `optimisticUpdateStatus(id, status)` function for the manager approve/reject flow. The subscription will eventually confirm or override.

#### 7. `src/components/manager/SuggestionCard.tsx` (99 lines)
- **Current:** Approve/reject buttons have no loading/disabled state.
- **Change needed:** Accept `isLoading?: boolean` prop. When loading, disable both buttons and show visual indicator.

#### 8. New file: `src/context/ToastContext.tsx`
- **Purpose:** Simple toast notification system using React Context (following the `DarkModeContext` pattern).
- **API:** `useToast()` hook returns `{ showToast(message, type) }`. Provider renders a fixed-position toast container. Types: 'success' | 'error' | 'info'. Auto-dismiss after 4 seconds.
- **Integration:** Wrap in `App.tsx` alongside `DarkModeProvider`.

#### 9. `src/types/index.ts` (373 lines)
- **Changes needed:** Add `isLoading` to `ActionBarProps` and `SuggestionCardProps`.

### Code to Reuse
- `src/context/DarkModeContext.tsx`: Pattern for toast context (createContext, Provider, useHook)
- `src/components/ui/`: Tailwind styling patterns for consistent look
- `src/utils/debounce.ts`: Already used for subscription debouncing, no changes needed
- `src/services/supabase/crudFactory.ts`: Factory pattern for subscribe -- understanding needed but no modification required

### Patterns to Follow
- **Context pattern:** `createContext` + exported `Provider` + exported `useHook` with guard check (see `DarkModeContext.tsx`)
- **Hook pattern:** `useState` + `useEffect` + `useCallback` for memoized handlers (see `useUsers.ts`)
- **Optimistic update pattern:** Already exists in `useUsers.createNewUser` (line 56-58) and `useUsers.removeUser` (line 84-85). Follow same pattern: update local state first, then await server, catch error and revert.
- **Barrel exports:** All hooks export from `src/hooks/index.ts`, all UI from `src/components/ui/index.ts`
- **Error handling:** Currently `console.error` -- replacing with toast calls
- **Tailwind styling:** Use existing color palette (emerald for success, rose for error, slate for neutral)

## Constraints

### Performance
- Optimistic updates should feel instant (< 50ms perceived)
- Fire-and-forget `logActivity` eliminates 100-200ms per action
- Total improvement target: perceived latency drops from 800-1400ms to < 100ms

### Platform
- React 18 (no concurrent features needed -- standard setState batching is sufficient)
- Tailwind CSS 3 for toast styling
- No new npm dependencies

### Dependencies
- All changes are additive to the existing data layer
- No database schema changes
- No Supabase configuration changes

## Risk Assessment

### Technical Risks
| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Optimistic update and subscription fight (flicker) | Med | Med | Subscription overwrites optimistic state, which is fine -- the 300ms debounce means a brief moment where both agree |
| Rollback creates confusing UX (step flips back) | Low | Low | Show error toast on rollback so user understands what happened |
| Double-click before loading state prevents it | Low | Med | Track loading state per step ID, disable button immediately in onClick handler before async starts |
| Toast z-index conflicts with modals | Low | Low | Use z-50 for toast container (modals use z-40 via ModalWrapper) |
| `logActivity` fire-and-forget silently fails | Low | Med | Acceptable -- activity logging is not user-facing. Add `.catch(console.warn)` for debugging. |

### Complexity
- **Level:** Medium
- **Rationale:** Each individual change is straightforward (optimistic update is a well-known pattern, fire-and-forget is trivial, button loading state is basic React). The complexity comes from touching ~10 files and ensuring the optimistic + subscription interplay works cleanly. No new architecture is introduced -- just extending existing patterns.

## Open Questions

- [x] Q1: Should the toast notification auto-dismiss or require manual close?
  - Resolution: Auto-dismiss after 4 seconds with an X button for early dismissal. Standard UX pattern.

- [x] Q2: Should optimistic updates use a separate state or modify the subscription state?
  - Resolution: Modify the subscription state directly (via the hook's `setData`). When the subscription fires its debounced re-fetch, it will overwrite with server state. This is simpler and avoids maintaining two parallel state trees.

- [x] Q3: How to track which step is currently loading (for per-button loading states)?
  - Resolution: Use a `Set<number>` of in-flight step IDs in `OnboardingHub`. Pass `isLoading={loadingStepIds.has(step.id)}` through to ActionBar.

- [x] Q4: Should the instance status revert fix be in the service layer or the hook?
  - Resolution: Service layer (`instanceService.ts` `updateStepStatus`), since that is where progress calculation and status updates already happen. This is a bug fix, not an optimistic update concern.

## Recommended Approach

### Implementation Strategy
The changes split into 6 independent workstreams that touch minimal overlapping code:

1. **Bug fix first** (instanceService status revert) -- smallest, most isolated change
2. **Toast system** (new context + provider) -- needed by all other changes for error display
3. **Fire-and-forget logActivity** -- trivial change, instant win across 5 call sites
4. **Step status optimistic updates + loading states** -- highest-impact UX improvement
5. **Suggestion approve/reject optimistic updates** -- manager-side improvement
6. **useUsers.editUser optimistic update** -- smallest hook change

### Order of Work
1. Fix instance status revert bug in `instanceService.ts`
2. Create `ToastContext` (context + provider + hook)
3. Wire `ToastProvider` into `App.tsx`
4. Remove `await` from all `logActivity()` calls in `OnboardingHub.tsx`
5. Add `updateStatus()` to `useSteps` hook with optimistic update + rollback
6. Add loading state tracking to `OnboardingHub.tsx` (per-step-ID Set)
7. Add `isLoading` prop to `ActionBarProps` type and `ActionBar` component
8. Replace `console.error` calls with `showToast()` in `OnboardingHub.tsx`
9. Add `optimisticRemove` / `optimisticUpdateStatus` to `useSuggestions` hook
10. Wire suggestion optimistic updates in `OnboardingHub.tsx` handlers
11. Add `isLoading` to `SuggestionCard` buttons
12. Add optimistic update to `useUsers.editUser`
13. Write tests for new behavior
14. Run full test suite and type check

### What to Defer
- No changes to subscription debounce timing (300ms is fine with optimistic updates)
- No changes to the CRUD factory or shared subscription manager
- No skeleton loading states or shimmer effects -- out of scope
- No retry logic for failed mutations -- simple rollback + error toast is sufficient

## Files Inventory

All files that will be modified or created:

| File | Action | Lines Changed (est.) |
|------|--------|---------------------|
| `src/services/supabase/instanceService.ts` | Modify | +5 (else branch) |
| `src/context/ToastContext.tsx` | **Create** | ~80 lines |
| `src/App.tsx` | Modify | +3 (wrap ToastProvider) |
| `src/components/OnboardingHub.tsx` | Modify | ~40 lines changed |
| `src/hooks/useSteps.ts` | Modify | +25 (add updateStatus) |
| `src/hooks/useSuggestions.ts` | Modify | +20 (add optimistic methods) |
| `src/hooks/useUsers.ts` | Modify | +8 (optimistic editUser) |
| `src/components/onboarding/ActionBar.tsx` | Modify | +10 (loading prop) |
| `src/components/manager/SuggestionCard.tsx` | Modify | +8 (loading prop) |
| `src/types/index.ts` | Modify | +2 (isLoading props) |
| `src/hooks/index.ts` | No change | (ToastContext is in context/, not hooks/) |

**Estimated total:** ~200 lines added/changed, 1 new file

## Next Step

**All questions resolved.** Run `/plan responsive-ux` to create the implementation plan.
