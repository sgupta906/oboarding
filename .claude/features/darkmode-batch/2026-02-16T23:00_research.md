# Research: darkmode-batch

## Metadata
- **Feature:** darkmode-batch (Bugs #22-27)
- **Created:** 2026-02-16T23:00
- **Status:** research-complete
- **Researcher:** research-agent

## Feature Context
- **Description:** Add missing `dark:` Tailwind CSS class variants to 6 components that were written before the dark mode implementation. All 6 components have ZERO `dark:` classes currently.
- **Where it fits:** Polish pass following the completed `darkmode-suggest-edit` fix (Bug #21). The user reports dark mode "looks mostly fine" so this is verification + polish.
- **Dependencies:** Bug #21 (`darkmode-suggest-edit`) is already fixed and provides the reference pattern. `ModalWrapper` already has full dark mode support, so modal children inherit `dark:bg-slate-800` body background.
- **Scouting report:** `.claude/active-work/darkmode-scouting/bug-report.md`

## Requirements

### Functional Requirements
- [ ] FR1: Bug #22 - KPISection `<select>` and `<label>` must be readable in dark mode (source: scouting report)
- [ ] FR2: Bug #23 - ReportStuckModal all text/backgrounds must have dark variants (source: scouting report)
- [ ] FR3: Bug #24 - DeleteConfirmDialog (templates) text must be readable in dark mode (source: scouting report)
- [ ] FR4: Bug #25 - ActionBar buttons/badges must not show light background patches in dark mode (source: scouting report)
- [ ] FR5: Bug #26 - StepTimeline connector lines and completion footer must be visible in dark mode (source: scouting report)
- [ ] FR6: Bug #27 - WelcomeHeader `<select>` dropdown options must be readable (source: scouting report)
- [ ] FR7: Light mode must remain unchanged (regression prevention)

### Technical Requirements
- [ ] TR1: Use established dark mode pattern: `dark:bg-slate-700`, `dark:text-white`, `dark:border-slate-600`, `dark:text-slate-200` (labels), `dark:text-slate-400` (helper text), `dark:placeholder-slate-400` (placeholders)
- [ ] TR2: Normalize KPISection from `gray-` to `slate-` for color palette consistency
- [ ] TR3: Each component needs unit tests verifying `dark:` class presence (following SuggestEditModal.test.tsx pattern)
- [ ] TR4: All 474 existing tests must continue to pass
- [ ] TR5: Dark mode strategy is `darkMode: 'class'` in `tailwind.config.js` -- classes must use `dark:` prefix

### Code Examples / References

**Reference pattern from SuggestEditModal (Bug #21 fix):**

```tsx
// Textarea: dark:border-slate-600 dark:bg-slate-700 dark:text-white dark:placeholder-slate-400
// Amber warning: dark:bg-amber-900/20 dark:border-amber-700, text: dark:text-amber-300
// Emerald success: dark:bg-emerald-900/20 dark:border-emerald-700, text: dark:text-emerald-300
// Helper text: dark:text-slate-400
// Cancel button: dark:text-slate-300 dark:hover:text-slate-100 dark:hover:bg-slate-600
// Character count warning: dark:text-amber-400
```

**Reference pattern from DeleteConfirmationDialog (ui/):**

```tsx
// Container: dark:bg-slate-800
// Title: dark:text-slate-50
// Message: dark:text-slate-300
// Cancel button: dark:text-slate-300 dark:hover:bg-slate-600
// Icon background: dark:bg-red-900/40
// Footer: dark:bg-slate-700, border: dark:border-slate-600
```

**Reference pattern from ModalWrapper:**

```tsx
// Modal body: dark:bg-slate-800
// Header border: dark:border-slate-700
// Title: dark:text-white
// Close button: dark:text-slate-400 dark:hover:text-slate-200
// Footer: dark:bg-slate-700, border: dark:border-slate-700
```

### Test Pattern Reference (SuggestEditModal.test.tsx)

Tests verify dark mode by checking `className` contains specific `dark:` strings:
```tsx
it('textarea contains dark mode classes', () => {
  render(<SuggestEditModal {...defaultProps} />);
  const textarea = screen.getByLabelText('Suggestion text');
  expect(textarea.className).toContain('dark:border-slate-600');
  expect(textarea.className).toContain('dark:bg-slate-700');
  expect(textarea.className).toContain('dark:text-white');
});

it('light mode classes are still present (regression check)', () => {
  render(<SuggestEditModal {...defaultProps} />);
  const textarea = screen.getByLabelText('Suggestion text');
  expect(textarea.className).toContain('border-slate-200');
});
```

### Warnings/Critical Notes
> The ModalWrapper already provides `dark:bg-slate-800` on the modal container and `dark:bg-slate-700` on the footer. Modal children do NOT need to set their own container background -- they only need to style text, borders, and internal element backgrounds.

> KPISection uses `gray-` instead of `slate-` for its gray palette. This should be normalized to `slate-` during the fix.

> WelcomeHeader's `<select>` uses `bg-white/20 text-white` which works visually on the gradient in both modes. The problem is the **native `<option>` elements** that inherit white text on a browser-native white dropdown background. The fix is to add explicit `text-slate-900 bg-white` to `<option>` elements (not a dark mode class issue per se, but a browser rendering issue).

## Existing Code Analysis

### Project State
- Project exists: YES
- All 474 tests passing across 31 test files
- Branch: `zustand-migration-bugfixes`

### Component-by-Component Analysis

#### Bug #22: KPISection.tsx (P1 HIGH)
- **File:** `/home/sanjay/Workspace/onboarding/src/components/manager/KPISection.tsx`
- **Lines:** 146 total
- **dark: classes:** 0
- **Existing tests:** NONE
- **Visual verification:** Profile filter dropdown is NOT visible when no profiles are configured. Tested in dark mode -- KPI cards render correctly (they have their own dark mode support in `KPICard`). The issue is the filter dropdown specifically.
- **Elements needing dark variants:**
  1. Line 89 - Label: `text-gray-700` --> `text-slate-700 dark:text-slate-200` (also normalize gray to slate)
  2. Line 100 - Select: `border border-gray-300` --> `border border-slate-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white` (also normalize gray to slate)
- **Complexity:** LOW -- only 2 elements, simple class additions

#### Bug #23: ReportStuckModal.tsx (P1 HIGH)
- **File:** `/home/sanjay/Workspace/onboarding/src/components/modals/ReportStuckModal.tsx`
- **Lines:** 131 total
- **dark: classes:** 0
- **Existing tests:** NONE
- **Visual verification:** Could not reproduce (requires employee with assigned onboarding, "I'm Stuck" button). Code analysis confirms zero dark classes.
- **Elements needing dark variants:**
  1. Line 36 - Cancel button: `text-slate-600 hover:text-slate-800 hover:bg-slate-100` --> add `dark:text-slate-300 dark:hover:text-slate-100 dark:hover:bg-slate-600`
  2. Line 74 - Rose alert box: `bg-rose-50 border border-rose-200` --> add `dark:bg-rose-900/20 dark:border-rose-800`
  3. Line 77 - Alert icon: `text-rose-600` --> add `dark:text-rose-400`
  4. Line 81 - Alert title: `text-rose-900` --> add `dark:text-rose-200`
  5. Line 82 - Alert text: `text-rose-700` --> add `dark:text-rose-300`
  6. Line 88 - Step info border: `border border-slate-200` --> add `dark:border-slate-600`
  7. Line 90 - Label: `text-slate-500` --> add `dark:text-slate-400`
  8. Line 93 - Step title: `text-slate-900` --> add `dark:text-white`
  9. Line 96 - Inner border: `border-t border-slate-200` --> add `dark:border-slate-600`
  10. Line 97 - Label: `text-slate-500` --> add `dark:text-slate-400`
  11. Line 105 - Expert name: `text-slate-900` --> add `dark:text-white`
  12. Line 106 - Expert role: `text-slate-600` --> add `dark:text-slate-400`
  13. Line 112 - Blue info box: `bg-blue-50 border border-blue-200` --> add `dark:bg-blue-900/20 dark:border-blue-800`
  14. Line 115 - Clock icon: `text-blue-600` --> add `dark:text-blue-400`
  15. Line 118 - Info text: `text-blue-700` --> add `dark:text-blue-300`
  16. Line 124 - Footer disclaimer: `text-slate-600` --> add `dark:text-slate-400`
- **Complexity:** MEDIUM -- 16 elements, but all straightforward class additions

#### Bug #24: DeleteConfirmDialog.tsx (templates) (P1 HIGH)
- **File:** `/home/sanjay/Workspace/onboarding/src/components/templates/DeleteConfirmDialog.tsx`
- **Lines:** 82 total
- **dark: classes:** 0
- **Existing tests:** YES (4 tests in DeleteConfirmDialog.test.tsx -- functional tests for name display, warning, cancel/confirm callbacks)
- **Visual verification:** Dialog appeared briefly before immediate deletion. Code analysis confirms zero dark classes.
- **Elements needing dark variants:**
  1. Line 44 - Cancel button: `text-slate-700 hover:bg-slate-100` --> add `dark:text-slate-300 dark:hover:bg-slate-600`
  2. Line 69 - Alert icon: `text-red-600` is fine on dark backgrounds (bright enough)
  3. Line 72 - Message text: `text-slate-700` --> add `dark:text-slate-200`
  4. Line 75 - Sub-text: `text-slate-500` --> add `dark:text-slate-400`
- **Complexity:** LOW -- only 3 elements need dark classes (icon is bright enough already)

#### Bug #25: ActionBar.tsx (P1 HIGH)
- **File:** `/home/sanjay/Workspace/onboarding/src/components/onboarding/ActionBar.tsx`
- **Lines:** 111 total
- **dark: classes:** 0
- **Existing tests:** YES (5 tests in ActionBar.test.tsx -- loading/disabled state tests)
- **Visual verification:** Screenshot captured. The "Completed" badge shows `bg-emerald-50` as a light patch. "Mark as Incomplete" shows `bg-slate-100` as a light patch.
- **Elements needing dark variants:**
  1. Line 31 - Border separator: `border-t border-slate-100` --> add `dark:border-slate-700`
  2. Line 39 - Mark as Done disabled: `bg-slate-100 text-slate-400` --> add `dark:bg-slate-700 dark:text-slate-500`
  3. Line 40 - Mark as Done enabled: `bg-slate-900 text-white hover:bg-slate-800` --> these are fine in dark mode (dark bg, white text)
  4. Line 55 - Completed badge: `text-emerald-600 ... bg-emerald-50` --> add `dark:bg-emerald-900/20 dark:text-emerald-400`
  5. Line 63 - Mark as Incomplete: `text-slate-600 ... bg-slate-100 hover:bg-slate-200 hover:text-slate-700` --> add `dark:text-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 dark:hover:text-slate-200`
  6. Line 80 - Resume Work: `text-emerald-600 hover:bg-emerald-50 hover:text-emerald-700` --> add `dark:text-emerald-400 dark:hover:bg-emerald-900/20 dark:hover:text-emerald-300`
  7. Line 91 - I'm Stuck: `text-rose-600 hover:bg-rose-50 hover:text-rose-700` --> add `dark:text-rose-400 dark:hover:bg-rose-900/20 dark:hover:text-rose-300`
  8. Line 102 - Suggest Edit: `text-slate-500 hover:text-brand-600 hover:bg-brand-50` --> add `dark:text-slate-400 dark:hover:text-brand-400 dark:hover:bg-brand-900/20`
- **Complexity:** MEDIUM -- 8 elements, multiple button states

#### Bug #26: StepTimeline.tsx (P1 HIGH)
- **File:** `/home/sanjay/Workspace/onboarding/src/components/onboarding/StepTimeline.tsx`
- **Lines:** 120 total
- **dark: classes:** 0
- **Existing tests:** NONE
- **Visual verification:** Screenshot captured. The "Onboarding Complete" footer shows `bg-emerald-50 border-emerald-200` as a light patch at the bottom. Connector lines use `bg-slate-200` / `bg-emerald-300`.
- **Elements needing dark variants:**
  1. Line 57 - Main timeline line: `from-slate-200 via-slate-300 to-slate-200` --> add `dark:from-slate-700 dark:via-slate-600 dark:to-slate-700`
  2. Line 93 - Completed connector: `bg-emerald-300` --> add `dark:bg-emerald-600`
  3. Line 94 - Pending connector: `bg-slate-200` --> add `dark:bg-slate-700`
  4. Line 110 - Completion footer: `bg-emerald-50 border border-emerald-200` --> add `dark:bg-emerald-900/20 dark:border-emerald-700`
  5. Line 112 - Completion text: `text-emerald-700` --> add `dark:text-emerald-300`
- **Complexity:** LOW -- 5 elements, straightforward

#### Bug #27: WelcomeHeader.tsx (P2 MEDIUM)
- **File:** `/home/sanjay/Workspace/onboarding/src/components/onboarding/WelcomeHeader.tsx`
- **Lines:** 104 total
- **dark: classes:** 0
- **Existing tests:** NONE
- **Visual verification:** Screenshot captured. The gradient header looks good in dark mode. White text on blue gradient reads well. Profile selector dropdown was not visible (no profiles configured). The issue is specifically with the native `<option>` elements inheriting `text-white` from the parent `<select>`, making them invisible on the browser's white dropdown background.
- **Elements needing fixes:**
  1. Lines 68-72 - `<option>` elements: Need explicit `className="text-slate-900 bg-white"` to override the parent's `text-white` color for native dropdown rendering
  2. Line 65 - The `<select>` element itself: The `bg-white/20 text-white` styling works on the gradient background in both modes. No `dark:` class needed for the select itself since it sits on a brand gradient that's the same in both modes.
- **Complexity:** LOW -- only need to style `<option>` elements
- **Note:** This is technically not a dark-mode-only issue -- it affects light mode too in some browsers. The white text on white dropdown background is a browser rendering issue.

### Code to Reuse
- **SuggestEditModal.tsx:** Already has the exact dark mode pattern to follow -- use as template for all 6 fixes
- **DeleteConfirmationDialog.tsx (ui/):** Additional reference for modal dark mode patterns
- **ModalWrapper.tsx:** Already provides dark backgrounds/borders -- children just need text and element-level dark classes
- **SuggestEditModal.test.tsx:** Test pattern to follow for all 6 components

### Code to Modify
1. `/home/sanjay/Workspace/onboarding/src/components/manager/KPISection.tsx` - Add dark: variants to label and select (2 elements)
2. `/home/sanjay/Workspace/onboarding/src/components/modals/ReportStuckModal.tsx` - Add dark: variants to all text and background elements (16 elements)
3. `/home/sanjay/Workspace/onboarding/src/components/templates/DeleteConfirmDialog.tsx` - Add dark: variants to text elements (3 elements)
4. `/home/sanjay/Workspace/onboarding/src/components/onboarding/ActionBar.tsx` - Add dark: variants to all buttons/badges (8 elements)
5. `/home/sanjay/Workspace/onboarding/src/components/onboarding/StepTimeline.tsx` - Add dark: variants to timeline lines and footer (5 elements)
6. `/home/sanjay/Workspace/onboarding/src/components/onboarding/WelcomeHeader.tsx` - Add `text-slate-900 bg-white` to option elements (1 fix pattern)

### New Files to Create (Tests)
- `KPISection.test.tsx` - NEW (no existing test)
- `ReportStuckModal.test.tsx` - NEW (no existing test)
- `StepTimeline.test.tsx` - NEW (no existing test)
- `WelcomeHeader.test.tsx` - NEW (no existing test)
- `DeleteConfirmDialog.test.tsx` - EXTEND existing (add dark mode tests)
- `ActionBar.test.tsx` - EXTEND existing (add dark mode tests)

### Patterns to Follow
- `dark:bg-slate-700` for input/select backgrounds inside a `dark:bg-slate-800` modal
- `dark:text-white` for primary text, `dark:text-slate-200` for secondary, `dark:text-slate-400` for tertiary/muted
- `dark:border-slate-600` for borders inside modals
- `dark:bg-{color}-900/20` with `dark:border-{color}-700` for colored alert/info boxes
- `dark:text-{color}-300` or `dark:text-{color}-400` for colored text (amber, emerald, rose, blue)
- `text-slate-900 bg-white` on native `<option>` elements to override parent `text-white`
- Tests use `expect(element.className).toContain('dark:...')` pattern

## Constraints

### Performance
- No performance constraints -- purely CSS class changes
- No new dependencies required

### Platform
- Tailwind CSS 3 with `darkMode: 'class'` strategy
- Dark mode toggled via class on root element
- Native `<select>` dropdown styling varies by browser/OS -- `<option>` styling has limited CSS support

### Dependencies
- No external dependencies
- All fixes are within component files -- no service/store changes
- ModalWrapper already provides dark mode container styling

## Risk Assessment

### Technical Risks
| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Light mode regression | Medium | Low | Tests verify both dark: and original light classes are present |
| WelcomeHeader option styling may not work in all browsers | Low | Medium | `text-slate-900 bg-white` on options is the standard approach; some browsers ignore option CSS |
| HMR bounce (bug #11) makes manual visual testing difficult | Low | Known | Code analysis + test verification is sufficient; Playwright screenshots captured key views |

### Complexity
- **Level:** Simple
- **Rationale:** All 6 bugs are the same pattern: add `dark:` Tailwind class variants to existing `className` strings. No logic changes, no state changes, no API changes. The reference pattern (SuggestEditModal) provides an exact template to follow. Each component fix is mechanical: find light-only classes, add corresponding dark variants.

## Open Questions

- [x] Q1: Are any of these bugs already partially fixed?
  - Resolution: No. All 6 components confirmed to have ZERO `dark:` classes via grep search. None have been touched.

- [x] Q2: Does the WelcomeHeader dropdown actually look bad in dark mode?
  - Resolution: The `<select>` itself looks fine on the gradient background. The issue is native `<option>` elements inheriting `text-white` from the parent, making them invisible on the browser's native white dropdown. This affects both light and dark mode in browsers that inherit text color to option elements. Fix is `text-slate-900 bg-white` on option elements.

- [x] Q3: Does the KPI profile filter dropdown actually appear in the current app?
  - Resolution: No -- no profiles are configured in the current database, so `profiles.length > 0` is false. The dropdown only renders when profiles exist. But the code clearly has `text-gray-700` without dark variant, so it needs fixing.

- [x] Q4: How many tests should we add?
  - Resolution: Follow the SuggestEditModal pattern -- add dark mode class presence tests + light mode regression check to each component. Estimate 2-4 tests per component for dark mode validation, plus 1 regression test each. Total: ~15-20 new tests across 6 files.

- [x] Q5: Should the `gray-` colors in KPISection be normalized to `slate-`?
  - Resolution: Yes -- all other components in the app use `slate-` for the gray palette. KPISection is the only one using `gray-`. Normalize during the fix.

## Recommended Approach

### Implementation Strategy

This is a batch polish fix -- all 6 bugs follow the exact same pattern (add `dark:` class variants). They should be implemented together in a single pipeline run since:
1. They all use the same reference pattern (SuggestEditModal)
2. They are all purely CSS class changes with no logic changes
3. They are all in the dark mode bug category (#22-27)
4. Testing them together is more efficient than 6 separate pipeline runs

### Order of Work

1. **ActionBar.tsx** (Bug #25) - Most visually impactful (seen on every step card), has existing tests to extend
2. **StepTimeline.tsx** (Bug #26) - Second most visible (container for step cards), no existing tests
3. **ReportStuckModal.tsx** (Bug #23) - Most elements to fix (16), no existing tests
4. **DeleteConfirmDialog.tsx** (Bug #24) - Fewest elements (3), has existing tests to extend
5. **KPISection.tsx** (Bug #22) - Also normalizes gray-->slate, no existing tests
6. **WelcomeHeader.tsx** (Bug #27) - Different fix pattern (option styling, not dark: classes), no existing tests

### What to Defer
- Nothing -- all 6 bugs are straightforward and should be completed in this batch
- The scouting report also identified EmployeeSelector and SuggestionCard/SuggestionsSection as MEDIUM severity -- those are outside the scope of this batch (bugs #22-27 only)

## Class Change Summary Per Component

### KPISection.tsx (2 changes)
| Line | Element | Current | Add |
|------|---------|---------|-----|
| 89 | label | `text-gray-700` | Change to `text-slate-700 dark:text-slate-200` |
| 100 | select | `border border-gray-300` | Change to `border border-slate-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white` |

### ReportStuckModal.tsx (16 changes)
| Line | Element | Current | Add |
|------|---------|---------|-----|
| 36 | Cancel button | `text-slate-600 hover:text-slate-800 hover:bg-slate-100` | `dark:text-slate-300 dark:hover:text-slate-100 dark:hover:bg-slate-600` |
| 74 | Rose alert bg | `bg-rose-50 border border-rose-200` | `dark:bg-rose-900/20 dark:border-rose-800` |
| 77 | Alert icon | `text-rose-600` | `dark:text-rose-400` |
| 81 | Alert title | `text-rose-900` | `dark:text-rose-200` |
| 82 | Alert text | `text-rose-700` | `dark:text-rose-300` |
| 88 | Step info border | `border border-slate-200` | `dark:border-slate-600` |
| 90 | Step label | `text-slate-500` | `dark:text-slate-400` |
| 93 | Step title | `text-slate-900` | `dark:text-white` |
| 96 | Expert section border | `border-t border-slate-200` | `dark:border-slate-600` |
| 97 | Expert label | `text-slate-500` | `dark:text-slate-400` |
| 105 | Expert name | `text-slate-900` | `dark:text-white` |
| 106 | Expert role | `text-slate-600` | `dark:text-slate-400` |
| 112 | Blue info bg | `bg-blue-50 border border-blue-200` | `dark:bg-blue-900/20 dark:border-blue-800` |
| 115 | Clock icon | `text-blue-600` | `dark:text-blue-400` |
| 118 | Info text | `text-blue-700` | `dark:text-blue-300` |
| 124 | Disclaimer | `text-slate-600` | `dark:text-slate-400` |

### DeleteConfirmDialog.tsx (3 changes)
| Line | Element | Current | Add |
|------|---------|---------|-----|
| 44 | Cancel button | `text-slate-700 hover:bg-slate-100` | `dark:text-slate-300 dark:hover:bg-slate-600` |
| 72 | Message text | `text-slate-700` | `dark:text-slate-200` |
| 75 | Sub-text | `text-slate-500` | `dark:text-slate-400` |

### ActionBar.tsx (8 changes)
| Line | Element | Current | Add |
|------|---------|---------|-----|
| 31 | Border separator | `border-t border-slate-100` | `dark:border-slate-700` |
| 39 | Mark Done disabled | `bg-slate-100 text-slate-400` | `dark:bg-slate-700 dark:text-slate-500` |
| 55 | Completed badge | `text-emerald-600 bg-emerald-50` | `dark:text-emerald-400 dark:bg-emerald-900/20` |
| 63 | Mark Incomplete | `text-slate-600 bg-slate-100 hover:bg-slate-200 hover:text-slate-700` | `dark:text-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 dark:hover:text-slate-200` |
| 80 | Resume Work | `text-emerald-600 hover:bg-emerald-50 hover:text-emerald-700` | `dark:text-emerald-400 dark:hover:bg-emerald-900/20 dark:hover:text-emerald-300` |
| 91 | I'm Stuck | `text-rose-600 hover:bg-rose-50 hover:text-rose-700` | `dark:text-rose-400 dark:hover:bg-rose-900/20 dark:hover:text-rose-300` |
| 102 | Suggest Edit | `text-slate-500 hover:text-brand-600 hover:bg-brand-50` | `dark:text-slate-400 dark:hover:text-brand-400 dark:hover:bg-brand-900/20` |

### StepTimeline.tsx (5 changes)
| Line | Element | Current | Add |
|------|---------|---------|-----|
| 57 | Main timeline gradient | `from-slate-200 via-slate-300 to-slate-200` | `dark:from-slate-700 dark:via-slate-600 dark:to-slate-700` |
| 93 | Completed connector | `bg-emerald-300` | `dark:bg-emerald-600` |
| 94 | Pending connector | `bg-slate-200` | `dark:bg-slate-700` |
| 110 | Completion footer | `bg-emerald-50 border border-emerald-200` | `dark:bg-emerald-900/20 dark:border-emerald-700` |
| 112 | Completion text | `text-emerald-700` | `dark:text-emerald-300` |

### WelcomeHeader.tsx (1 change pattern)
| Line | Element | Current | Add |
|------|---------|---------|-----|
| 68 | option "All Roles" | no className | `className="text-slate-900 bg-white"` |
| 70-72 | option elements in map | no className | `className="text-slate-900 bg-white"` |

## Next Step

**All questions resolved.** Run `/plan darkmode-batch` to create the implementation plan.
