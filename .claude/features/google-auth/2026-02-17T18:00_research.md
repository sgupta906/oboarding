# Research: google-auth

## Metadata
- **Feature:** google-auth
- **Created:** 2026-02-17T18:00
- **Status:** research-complete
- **Researcher:** research-agent

## Feature Context

Move from mock/dev auth to production-level Google OAuth **via Supabase's built-in OAuth provider support**. Supabase handles the entire OAuth flow â€” redirect to Google, token exchange, session creation, and callback. The only client-side code is `supabase.auth.signInWithOAuth({ provider: 'google' })`. No direct Google API calls, no backend routes, no token management. Server-side setup: enable Google provider in Supabase Dashboard (Authentication > Providers > Google), paste Google Cloud Console OAuth credentials.

The current auth system uses a dual-track approach: Supabase Auth with password-based signUp/signIn for "real" auth, plus a localStorage `mockAuthUser` fallback for dev-auth mode (`VITE_USE_DEV_AUTH=true`). This feature replaces the password-based Supabase Auth path with Google OAuth while preserving the dev-auth fallback.

### Where it fits in the project
- This is a new production-readiness feature, not a bugfix
- It affects the entire auth flow: sign-in, session management, role resolution, and the new-user onboarding pipeline
- Dependencies: None blocked; all 40 prior features are complete
- This feature spans: auth service, auth context, SignInView UI, NewHiresPanel (add Edit button), ManagerView (wire Edit modal), and Supabase project configuration

## Requirements

### Functional Requirements
- [ ] FR1: Google OAuth sign-in button on SignInView (source: user request)
- [ ] FR2: New Google users auto-created as users with NO role and NO onboarding template (source: user request)
- [ ] FR3: New Google users appear in Manager's New Hires table as "unassigned" (source: user request)
- [ ] FR4: Manager can click Edit on a New Hires row to assign a role + onboarding template (source: user request)
- [ ] FR5: Employee's onboarding view stays empty ("No onboarding assigned yet") until manager assigns a template (source: user request)
- [ ] FR6: Dev-auth mode (`VITE_USE_DEV_AUTH=true`) continues to work alongside Google OAuth (source: user request)
- [ ] FR7: Admins/Managers are hard-seeded -- not self-serve registration (source: user request)
- [ ] FR8: Session persistence via `onAuthStateChange` -- user stays signed in across page refreshes (source: implied)

### Technical Requirements
- [ ] TR1: Use `supabase.auth.signInWithOAuth({ provider: 'google' })` for the OAuth flow (source: Supabase SDK)
- [ ] TR2: Handle OAuth callback -- Supabase redirects back to the app URL with tokens in the URL hash (source: Supabase docs)
- [ ] TR3: `onAuthStateChange` must detect Google OAuth sessions and resolve the user's role from the database (source: existing pattern in `authContext.tsx`)
- [ ] TR4: 563 existing tests must continue passing (source: constraint)
- [ ] TR5: No new npm dependencies needed -- `@supabase/supabase-js` already supports OAuth (source: SDK analysis)
- [ ] TR6: Supabase project Google OAuth provider must be enabled in the Dashboard (server-side config) (source: Supabase docs)

### Constraints
- Dev-auth mode must remain fully functional
- Supabase project ref: `ecnshfhpgwjxvuybewth`
- App runs on port 5173 (OAuth redirect URL: `http://localhost:5173`)
- Must work with existing Zustand store architecture
- RLS policies are currently permissive ("allow all") -- no auth-scoped RLS changes needed yet

## Existing Code Analysis

### Project State
- Project exists: YES
- 563 tests passing across 30+ test files
- Zustand migration complete (5/5 slices)
- Auth system is dual-track: Supabase Auth + localStorage mock

### Key Files to Modify

#### 1. `src/services/authService.ts` (300 lines)
**Current state:** Has `signInWithEmailLink()` that does Supabase `signUp`/`signInWithPassword` with a hardcoded `mockPassword123!`. Also has `setUserRole()` and `getUserRole()`.

**What needs to change:**
- Add `signInWithGoogle()` function that calls `supabase.auth.signInWithOAuth({ provider: 'google' })`
- Modify `onAuthStateChange` handling to support new Google users (users who have no role yet)
- `setUserRole()` is already correctly implemented -- upserts user row + user_roles junction

**Code to reuse:**
- `setUserRole()` (lines 31-71) -- already handles upserting users and roles
- `getUserRole()` (lines 79-105) -- already handles role lookup from user_roles junction table
- `signOut()` (lines 276-299) -- already handles dual sign-out

**Relevant snippet (setUserRole):**
```typescript
export async function setUserRole(uid: string, email: string, role: UserRole): Promise<void> {
  // Upserts user row, deletes existing roles, inserts new role
  await supabase.from('users').upsert({ id: uid, email, name: email.split('@')[0], updated_at: ... });
  await supabase.from('user_roles').delete().eq('user_id', uid);
  await supabase.from('user_roles').insert({ user_id: uid, role_name: role });
}
```

#### 2. `src/config/authContext.tsx` (302 lines)
**Current state:** `AuthProvider` listens to `onAuthStateChange` but guards against overwriting mock auth when `mockAuthUser` exists in localStorage. For non-mock users, it calls `getUserRole(session.user.id)` and sets the user/role state.

**What needs to change:**
- When `onAuthStateChange` fires for a Google OAuth user, the user may not have a role yet
- Currently, if `getUserRole()` returns null, the user is set to `null` (line 176-182) and they see the sign-in page again
- We need a NEW state: "authenticated but no role" -- show the "No onboarding assigned yet" screen instead of sign-in
- This means the `AuthUser` type needs an optional/nullable role, OR we assign a default role like `'employee'` to new Google users

**Critical decision point:** What role should new Google OAuth users get?
- Option A: Auto-assign `'employee'` role immediately upon first Google sign-in
- Option B: Leave role as `null` -- requires changing `AuthUser.role` from required to optional
- Option C: Create a new role like `'unassigned'` or `'pending'`

**Relevant snippet (onAuthStateChange handler):**
```typescript
if (session?.user?.email) {
  const userRole = await getUserRole(session.user.id);
  if (userRole) {
    setUser({ uid: session.user.id, email: session.user.email, role: userRole });
    setRole(userRole);
  } else {
    // Currently: clears user state, shows sign-in page
    // Needed: create user row, show "no onboarding assigned" screen
    setUser(null);
    setRole(null);
  }
}
```

#### 3. `src/config/authTypes.ts` (40 lines)
**Current state:** `UserRole = string`, `AuthUser = { uid, email, role }` where role is required.

**What needs to change:**
- If we go with Option B (null role), change `AuthUser.role` to `UserRole | null`
- If we go with Option A (auto-assign employee), no changes needed
- `hasManagerAccess()` already handles `null` correctly: `return role != null && role !== 'employee'`

#### 4. `src/views/SignInView.tsx` (283 lines)
**Current state:** Email input form + quick-login buttons for dev-auth mode. Shows test account reference.

**What needs to change:**
- Add a "Sign in with Google" button (primary CTA in production mode)
- When `VITE_USE_DEV_AUTH` is NOT set, show only the Google button
- When `VITE_USE_DEV_AUTH` IS set, show both Google button AND dev-auth quick-login buttons
- Google sign-in calls `supabase.auth.signInWithOAuth({ provider: 'google' })` which redirects to Google, then back to the app
- After redirect, `onAuthStateChange` fires automatically and handles session

**Google sign-in is a redirect flow, not an in-page flow:**
```typescript
async function handleGoogleSignIn() {
  const { error } = await supabase.auth.signInWithOAuth({
    provider: 'google',
    options: {
      redirectTo: window.location.origin, // http://localhost:5173
    },
  });
  if (error) setError(error.message);
  // No need to handle success -- page will redirect to Google then back
}
```

#### 5. `src/components/manager/NewHiresPanel.tsx` (337 lines)
**Current state:** Read-only table with Name, Email, Department, Role, Status, Progress, Start Date, Actions (delete only) columns.

**What needs to change:**
- Add an "Edit" button next to the existing "Delete" button in the Actions column
- The Edit button opens a modal to assign/change role + template for the hire
- New Google users will appear here because `createOnboardingRunFromTemplate()` creates instances, BUT we have a conceptual gap: new Google users do NOT have onboarding instances yet (they just signed in with Google, no manager has assigned them anything)

**IMPORTANT CONCEPTUAL GAP:** The New Hires table shows `onboarding_instances`, not `users`. A new Google user who just signed in will have a row in the `users` table but NOT in `onboarding_instances`. They will NOT appear in NewHiresPanel unless we either:
- (A) Create a "placeholder" onboarding instance with no template when a Google user first signs in
- (B) Change NewHiresPanel to also show users who have no onboarding instance (query users table, cross-reference with instances)
- (C) Add a separate "Unassigned Users" section in the manager dashboard

This is a significant design decision that needs user input.

#### 6. `src/components/OnboardingHub.tsx` (295 lines)
**Current state:** For non-manager users without an onboarding instance, shows "No onboarding assigned yet" card (lines 217-233).

**What needs to change:**
- This already handles the "no template assigned" case correctly
- The message "Your manager will set up your onboarding. Check back soon!" is perfect for the Google OAuth flow
- No changes needed IF we correctly handle the auth state for users with no role/template

#### 7. `src/config/supabase.ts` (49 lines)
**Current state:** Creates Supabase client with default options.

**What may need to change:**
- For OAuth callback handling, we may need to configure `auth.flowType` or `auth.detectSessionInUrl`
- By default, `@supabase/supabase-js` v2 auto-detects tokens in URL hash via `detectSessionInUrl: true`
- Likely no changes needed -- the default behavior handles OAuth callbacks

### Code to Reuse
- `src/services/authService.ts: setUserRole()` -- reuse for initial role assignment
- `src/services/authService.ts: getUserRole()` -- reuse for role lookup
- `src/services/authService.ts: signOut()` -- already handles Supabase sign-out
- `src/config/authContext.tsx: onAuthStateChange handler` -- extend for Google OAuth
- `src/components/OnboardingHub.tsx: "No onboarding assigned yet" card` -- already exists
- `src/services/supabase/userService.ts: createUser()` -- for auto-creating user row on first Google sign-in
- `src/components/modals/CreateOnboardingModal.tsx` -- could be adapted into an "Edit Hire" modal

### Code to Create
- Google sign-in function in `authService.ts`
- "Sign in with Google" button in `SignInView.tsx`
- Edit button + EditHireModal in NewHiresPanel or ManagerView
- Auto-user-creation logic in `authContext.tsx` or `authService.ts`

### Patterns to Follow
- Dual-track auth: real Supabase session + localStorage mock coexist
- Server-first operations with optimistic updates in Zustand store
- Modal pattern: ModalWrapper + form state + submit handler
- Toast notifications for success/error
- Fire-and-forget activity logging

## Constraints

### Performance
- No specific targets; standard SPA behavior
- OAuth redirect flow adds one full page reload (unavoidable)

### Platform
- Supabase project ref: `ecnshfhpgwjxvuybewth`
- Google Cloud Console: OAuth 2.0 credentials needed (client ID + client secret)
- Supabase Dashboard: Google provider must be enabled (Authentication > Providers > Google)
- Redirect URL must be configured in both Google Console and Supabase Dashboard

### Dependencies
- `@supabase/supabase-js` -- already installed, supports `signInWithOAuth`
- No new npm packages needed
- Server-side: Google OAuth provider setup in Supabase Dashboard
- Server-side: Google Cloud Console OAuth credentials

## Risk Assessment

### Technical Risks
| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Google OAuth callback URL mismatch | High | Medium | Document exact URLs to configure in both Google Console and Supabase Dashboard |
| New user auto-creation fails (FK constraint on users.created_by) | High | Medium | Set `created_by` to `null` for self-registered users (already handled in userService) |
| `onAuthStateChange` fires before user row exists in DB | High | High | Create user row INSIDE the onAuthStateChange handler before setting state |
| Users table unique email constraint violation on re-login | Medium | Medium | Use `upsert` instead of `insert` for user creation |
| Dev-auth mode breaks when Google OAuth code is added | Medium | Low | Keep dev-auth path completely separate with `VITE_USE_DEV_AUTH` guard |
| Existing tests break due to auth changes | High | Medium | All tests mock the supabase service layer; auth changes shouldn't affect them IF we don't change AuthUser type |
| New Google users invisible to manager (not in New Hires table) | High | High | Design decision needed: placeholder instance vs. separate users query |

### Complexity
- **Level:** Complex
- **Rationale:** This feature touches the entire auth stack (service, context, UI), requires server-side configuration (Supabase + Google Console), introduces a new user lifecycle state (authenticated but unassigned), and requires a design decision about how unassigned users appear in the manager dashboard.

## Open Questions

- [x] Q1: What role should new Google OAuth users get upon first sign-in?
  - **Resolution:** No role at all. Leave role as `null` (unassigned). Requires changing `AuthUser.role` from required to optional (`UserRole | null`). User is authenticated but has no role until a manager assigns one.
  - **Impact:** `hasManagerAccess()` already handles null correctly. Need to ensure "No onboarding assigned yet" screen shows for null-role users too (not just employees).

- [x] Q2: How should unassigned Google users appear in the Manager's New Hires table?
  - **Resolution:** Separate "Unassigned" section above the New Hires table. Query the `users` table for users who have no role and no onboarding instance. Display them in a distinct section so the manager can clearly see who needs to be set up. Manager clicks Edit to assign role + department + template.

- [x] Q3: What should the Edit modal include?
  - **Resolution:** Role + Template + Department. Three fields. Name/email come from Google profile and are read-only. Department is needed since Google only provides name/email.

- [x] Q4: Should the email-based sign-in form be removed or kept alongside Google OAuth?
  - **Resolution:** Keep both options. Production mode shows Google sign-in button AND the email form. Dev-auth mode additionally shows quick-login buttons.

- [x] Q5: Has the Google OAuth provider been configured in the Supabase Dashboard and Google Cloud Console?
  - **Resolution:** Not yet. Code will be built first. Server-side setup (Google Cloud Console + Supabase Dashboard) is a manual step that happens after implementation. Testing will require the config to be in place.

- [x] Q6: Does the `users` table handle the case where a Google OAuth user's Supabase Auth UUID is used as the `id`?
  - Resolution: YES. The `users` table PK is `UUID PRIMARY KEY DEFAULT gen_random_uuid()`. When creating a user from Google OAuth, we can use `supabase.auth.getUser()` to get the UUID from the Supabase Auth session and use that as the `users.id`. The `setUserRole()` function already does this via `upsert`.

- [x] Q7: Will new Google users break the `onboarding_instances.employee_email` lookup in `useEmployeeOnboarding`?
  - Resolution: NO. `useEmployeeOnboarding` filters instances by `employeeEmail`. A new Google user with no instance simply gets `null` back, which correctly triggers the "No onboarding assigned yet" screen (already handled in `OnboardingHub.tsx` lines 217-233).

## Recommended Approach

### Implementation Strategy

**Phase 1: Auth Layer (backend-first)**
1. Add `signInWithGoogle()` to `authService.ts`
2. Modify `onAuthStateChange` in `authContext.tsx` to handle Google OAuth users:
   - If session exists but no user row in DB: create user row with `'employee'` role
   - If session exists and user row exists: load role as normal
3. Ensure `signOut()` handles Google OAuth sessions (already does via `supabase.auth.signOut()`)

**Phase 2: Sign-In UI**
4. Add "Sign in with Google" button to `SignInView.tsx`
5. Conditionally show dev-auth controls only when `VITE_USE_DEV_AUTH=true`
6. Remove email form in production mode (or keep it as secondary option)

**Phase 3: Manager Edit Flow**
7. Create `EditHireModal` component with Role + Template selectors
8. Add Edit button to NewHiresPanel Actions column
9. Wire Edit modal to update the onboarding instance (assign template, change role)
10. When a template is assigned to an empty instance, populate steps from the template

**Phase 4: New User Auto-Instance (if placeholder approach chosen)**
11. After creating user row for new Google user, create a placeholder onboarding instance
12. The placeholder has: `employeeName` from Google profile, `employeeEmail` from Google profile, `role: 'employee'`, `department: 'Unassigned'`, `templateId: ''`, `steps: []`, `progress: 0`, `status: 'active'`

### Order of Work
1. Auth service + context changes (sign-in, user creation, role resolution)
2. SignInView UI (Google button)
3. EditHireModal component
4. NewHiresPanel Edit button wiring
5. Placeholder instance creation for new Google users
6. Tests

### What to Defer
- Granular RLS policies (currently permissive "allow all" -- production hardening is a separate feature)
- Email confirmation flow (Supabase Auth email confirmation should be DISABLED for this to work smoothly)
- Admin user management via Google OAuth (admins/managers are hard-seeded, not self-serve)
- Password reset / account recovery (not needed with OAuth)

## Server-Side Setup Required

### Supabase Dashboard Configuration
1. Go to Authentication > Providers > Google
2. Enable the Google provider
3. Enter Google OAuth Client ID and Client Secret
4. Set Site URL to `http://localhost:5173` (dev) / production URL
5. Add `http://localhost:5173` to Redirect URLs

### Google Cloud Console Configuration
1. Create or select a project in Google Cloud Console
2. Go to APIs & Services > Credentials
3. Create OAuth 2.0 Client ID (Web application)
4. Add Authorized JavaScript origins: `http://localhost:5173`
5. Add Authorized redirect URIs: `https://ecnshfhpgwjxvuybewth.supabase.co/auth/v1/callback`
6. Copy Client ID and Client Secret to Supabase Dashboard

### Environment Variables
No new env vars needed. The existing `VITE_SUPABASE_URL` and `VITE_SUPABASE_ANON_KEY` are sufficient -- the Google OAuth configuration lives in the Supabase Dashboard, not in the app's env.

## File Impact Summary

| File | Action | Lines Changed (est.) |
|------|--------|---------------------|
| `src/services/authService.ts` | Modify | +30 (add signInWithGoogle, modify user creation logic) |
| `src/config/authContext.tsx` | Modify | +40 (handle Google OAuth in onAuthStateChange, auto-create user) |
| `src/config/authTypes.ts` | No change | 0 (if using Option A: auto-assign employee role) |
| `src/views/SignInView.tsx` | Modify | +30/-20 (add Google button, conditionally hide email form) |
| `src/components/manager/NewHiresPanel.tsx` | Modify | +20 (add Edit button to Actions column) |
| `src/components/modals/EditHireModal.tsx` | **Create** | +200 (new modal with Role + Template selectors) |
| `src/views/ManagerView.tsx` | Modify | +30 (wire EditHireModal state and handlers) |
| `src/services/supabase/instanceService.ts` | Modify | +30 (add updateInstanceTemplate function) |
| Tests | Create/Modify | +50 (auth service tests, EditHireModal tests) |

## Next Step

**Questions Q1-Q5 need user input before proceeding to /plan.**

Key decisions:
1. Q1: Role for new Google users (recommend: `'employee'`)
2. Q2: How unassigned users appear in manager dashboard (recommend: placeholder instance)
3. Q3: Edit modal design (recommend: new EditHireModal)
4. Q4: Email form fate in production (recommend: remove, Google-only)
5. Q5: Server-side config status (required for testing)

Once resolved, run `/plan google-auth` to create the implementation plan.
