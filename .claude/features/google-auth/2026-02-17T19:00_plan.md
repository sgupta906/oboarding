# Plan: google-auth

## Metadata
- **Feature:** google-auth
- **Created:** 2026-02-17T19:00
- **Status:** plan-complete
- **Based-on:** 2026-02-17T18:00_research.md

## Architecture Overview

This feature adds Google OAuth sign-in via Supabase's built-in OAuth provider, introduces a "no role" user state for new Google users, adds an "Unassigned Users" section to the manager dashboard, and provides an "Assign Role" modal for managers to set up new Google users with a role, department, and onboarding template.

```
                          +------------------+
                          |   Google OAuth   |
                          |  (Supabase)      |
                          +--------+---------+
                                   |
                    onAuthStateChange fires
                                   |
                          +--------v---------+
                          |  authContext.tsx  |
                          |  (AuthProvider)  |
                          +--------+---------+
                                   |
                    +--------------+--------------+
                    |              |               |
              has role?      no role?        mock auth?
                    |              |               |
              +-----v----+  +-----v------+  +-----v-----+
              | Normal    |  | "unassigned"|  | Dev-auth  |
              | routing   |  | state       |  | bypass    |
              +-----------+  +------+------+  +-----------+
                                    |
                          +---------v----------+
                          | Employee sees:     |
                          | "No onboarding     |
                          |  assigned yet"     |
                          +--------------------+

Manager Dashboard (New Hires tab):

  +------------------------------------------------+
  | Unassigned Users (new section)                 |
  | +--------------------------------------------+ |
  | | Name | Email | Signed Up | Actions         | |
  | | Jane | jane@ | 2m ago   | [Assign Role]   | |
  | +--------------------------------------------+ |
  +------------------------------------------------+
  | New Hires (existing table)                     |
  | +--------------------------------------------+ |
  | | Name | Email | Dept | Role | Status | ...  | |
  | +--------------------------------------------+ |
  +------------------------------------------------+
```

## Tech Stack Summary

- **Auth:** `supabase.auth.signInWithOAuth({ provider: 'google' })` -- zero new dependencies
- **State:** Existing Zustand store (UsersSlice) + AuthContext
- **UI:** Tailwind CSS, Lucide React icons
- **Testing:** Vitest + React Testing Library (mocked Supabase)
- **No new npm packages required**

## Design Decisions

### D1: AuthUser.role becomes optional (`UserRole | null`)

**Rationale:** New Google OAuth users have no role until a manager assigns one. The `AuthUser` interface currently requires `role: UserRole`. We change it to `role: UserRole | null` so authenticated-but-unassigned users are represented accurately.

**Impact:** `hasManagerAccess(role)` already handles `null` correctly (returns `false`). The `OnboardingHub` already shows "No onboarding assigned yet" when an employee has no instance. The key change is in `authContext.tsx` where `getUserRole()` returning `null` currently clears the user -- instead, we keep the user authenticated with `role: null`.

### D2: Auto-create user row on first Google sign-in

**Rationale:** When `onAuthStateChange` fires for a Google user, we need a row in the `users` table so managers can see the user. We upsert a user row using the Supabase Auth UUID as the `id` and the Google email/name.

**Flow:**
1. Google OAuth redirects back to app
2. `onAuthStateChange` fires with session
3. `getUserRole()` returns `null` (new user, no row in `users` or `user_roles`)
4. We call `ensureUserExists()` to upsert a user row (no role)
5. Set `AuthUser = { uid, email, role: null }`
6. User sees "No onboarding assigned yet"

### D3: Unassigned Users section in NewHiresPanel

**Rationale:** New Google users exist in the `users` table but have no `user_roles` entry and no `onboarding_instances` entry. The NewHiresPanel currently only shows `onboarding_instances`. We add a separate "Unassigned Users" section at the top of NewHiresPanel that queries `users` where the user has no roles.

**Query approach:** Use the existing `useUsers()` hook which already subscribes to the users table. Filter client-side for users with empty `roles` array.

### D4: AssignRoleModal -- new modal for unassigned users

**Rationale:** Unlike `EditHireModal` (which edits an existing `OnboardingInstance`), `AssignRoleModal` operates on a `User` who has no instance yet. It:
1. Shows name/email (read-only from Google profile)
2. Lets manager select Role + Department + Template
3. On submit: updates user role via `setUserRole()`, creates onboarding instance via `createOnboardingRunFromTemplate()`

This is a new modal rather than reusing EditHireModal because the data model is different (User vs OnboardingInstance).

### D5: Keep email form alongside Google OAuth

**Rationale:** The research resolved Q4 as "keep both". In production mode, show the Google sign-in button prominently AND the existing email form below it. In dev-auth mode, additionally show the quick-login buttons. This preserves the ability to sign in with test accounts while adding Google OAuth.

### D6: Dev-auth mode is fully preserved

**Rationale:** The `VITE_USE_DEV_AUTH=true` flag, localStorage `mockAuthUser`, and the `authStorageChange` custom event system all remain unchanged. The Google OAuth code only activates when NOT in dev-auth mode (or when the user explicitly clicks "Sign in with Google" even in dev-auth mode).

## File Structure

### New Files

| File | Purpose | Est. Lines |
|------|---------|-----------|
| `src/components/modals/AssignRoleModal.tsx` | Modal for assigning role + dept + template to an unassigned Google user | ~250 |
| `src/components/modals/AssignRoleModal.test.tsx` | Tests for AssignRoleModal | ~180 |
| `src/components/manager/UnassignedUsersSection.tsx` | Table of users with no roles, shown in NewHiresPanel | ~150 |
| `src/components/manager/UnassignedUsersSection.test.tsx` | Tests for UnassignedUsersSection | ~120 |
| `src/views/SignInView.test.tsx` | Tests for SignInView (Google button, dev-auth, email form) | ~150 |

### Modified Files

| File | Changes | Est. Lines Changed |
|------|---------|-------------------|
| `src/config/authTypes.ts` | `AuthUser.role` becomes `UserRole \| null`, update `loadMockAuthFromStorage` type validation | +5/-2 |
| `src/config/authContext.tsx` | Handle Google OAuth users in `onAuthStateChange` (auto-create user row, set role=null) | +25/-5 |
| `src/services/authService.ts` | Add `signInWithGoogle()` function, add `ensureUserExists()` helper | +35 |
| `src/services/authService.test.ts` | Tests for `signInWithGoogle()` and `ensureUserExists()` | +40 |
| `src/views/SignInView.tsx` | Add "Sign in with Google" button, restructure layout | +40/-10 |
| `src/components/manager/NewHiresPanel.tsx` | Import and render `UnassignedUsersSection` above existing table | +15 |
| `src/components/manager/NewHiresPanel.test.tsx` | Tests for unassigned users section rendering | +20 |
| `src/components/modals/index.ts` | Export `AssignRoleModal` | +1 |
| `src/config/authContext.test.tsx` | Tests for Google OAuth user handling (role=null, auto-create) | +30 |

## Component Architecture

```
App.tsx
  AuthProvider (modified: handles role=null)
    AppContent
      SignInView (modified: Google button + email form)
        [Google Sign-In Button] -- new
        [Email Form] -- existing
        [Dev Auth Buttons] -- existing (when VITE_USE_DEV_AUTH=true)
      NavBar -- unchanged
      OnboardingHub -- unchanged (already handles no-instance employees)
        ManagerView
          NewHiresPanel (modified: renders UnassignedUsersSection)
            UnassignedUsersSection -- new
              AssignRoleModal -- new
            [Existing onboarding instances table]
```

### State Management

**AuthContext changes:**
- `AuthUser.role` becomes `UserRole | null`
- `onAuthStateChange` handler gains a new branch: if session exists but `getUserRole()` returns `null`, call `ensureUserExists()` and set user with `role: null`
- `loadMockAuthFromStorage()` accepts `role: null` as valid (for Google OAuth users who signed in but have no role yet -- though in practice mock auth always has a role)

**Zustand store -- no changes needed:**
- `UsersSlice` already tracks all users from the `users` table
- `InstancesSlice` already tracks all onboarding instances
- Filtering for "unassigned users" (users with empty `roles` array) is done client-side in `UnassignedUsersSection`

## Data Flow: Google OAuth Sign-In

```
1. User clicks "Sign in with Google"
2. signInWithGoogle() calls supabase.auth.signInWithOAuth({ provider: 'google' })
3. Browser redirects to Google consent screen
4. User authorizes, Google redirects to Supabase callback URL
5. Supabase creates auth.users entry, redirects to app URL with tokens in hash
6. supabase-js auto-detects tokens, creates session
7. onAuthStateChange fires with SIGNED_IN event + session
8. AuthProvider checks: mockAuthUser in localStorage? NO
9. AuthProvider calls getUserRole(session.user.id)
10. getUserRole returns null (new user, no users row yet)
11. AuthProvider calls ensureUserExists(uid, email, name)
    - Upserts users row (id=uid, email, name from Google)
    - Does NOT insert user_roles (no role yet)
12. AuthProvider sets user = { uid, email, role: null }
13. App routes to OnboardingHub
14. OnboardingHub: !isManager && !employeeInstance => "No onboarding assigned yet"
```

## Data Flow: Manager Assigns Role to Unassigned User

```
1. Manager navigates to New Hires tab
2. NewHiresPanel renders UnassignedUsersSection
3. UnassignedUsersSection filters useUsers() for users with empty roles[]
4. Manager clicks "Assign Role" on an unassigned user
5. AssignRoleModal opens with:
   - Name (read-only, from users table)
   - Email (read-only, from users table)
   - Role selector (from useRoles)
   - Department text input
   - Template selector (from useTemplates)
6. Manager fills Role + Department + Template, clicks Submit
7. AssignRoleModal:
   a. Calls setUserRole(user.id, user.email, selectedRole) -- updates users.user_roles
   b. Calls createOnboardingRunFromTemplate({ employeeName, employeeEmail, role, department, templateId })
   c. On success: closes modal, shows success toast
8. Zustand store automatically picks up changes via Realtime subscriptions:
   - Users subscription fires (user now has a role, disappears from unassigned)
   - Instances subscription fires (new instance appears in New Hires table)
```

## Testing Strategy

### Unit Tests (~18 new tests)

| Test File | Count | What's Tested |
|-----------|-------|---------------|
| `src/services/authService.test.ts` | +5 | `signInWithGoogle()`: calls OAuth, handles errors, passes redirectTo; `ensureUserExists()`: upserts correctly, handles existing users |
| `src/config/authContext.test.tsx` | +4 | Google OAuth user with no role gets `role: null`, auto-creates user row, authenticated-but-no-role state |
| `src/config/authTypes.test.ts` | +1 | `hasManagerAccess(null)` returns false (already tested but verify) |
| `src/views/SignInView.test.tsx` | +4 | Google button renders, calls signInWithGoogle, email form still works, dev-auth buttons show when VITE_USE_DEV_AUTH |
| `src/components/manager/UnassignedUsersSection.test.tsx` | +4 | Renders unassigned users, hides when none, "Assign Role" button opens modal |

### Integration Tests (~8 new tests)

| Test File | Count | What's Tested |
|-----------|-------|---------------|
| `src/components/modals/AssignRoleModal.test.tsx` | +6 | Form validation, submit flow (setUserRole + createOnboardingRunFromTemplate), error handling, role/template selectors, read-only name/email |
| `src/components/manager/NewHiresPanel.test.tsx` | +2 | UnassignedUsersSection renders above existing table, unassigned users hidden when all have roles |

### E2E Testing (via Playwright, during /test phase)

| Scenario | Steps |
|----------|-------|
| Google OAuth button visibility | Navigate to sign-in, verify Google button visible |
| Dev-auth mode coexistence | With VITE_USE_DEV_AUTH=true, verify Google + dev-auth buttons visible |
| Unassigned user flow (simulated) | Sign in as manager, verify unassigned users section |

**Total new tests: ~26**

## Implementation Notes

### Patterns to Follow

1. **Modal pattern:** Use `ModalWrapper` for AssignRoleModal, match `EditHireModal` patterns (form state, validation, useEffect reset on open, error display)
2. **Service pattern:** `signInWithGoogle()` follows the same style as `signInWithEmailLink()` -- async function, error throwing, console logging
3. **Component pattern:** `UnassignedUsersSection` follows `NewHiresPanel` patterns (table layout, loading/empty states, Tailwind dark mode)
4. **Test pattern:** Use `vi.hoisted()` + `vi.mock()` for Supabase mocks, `renderHook` for context tests, `render` + `screen` for component tests
5. **Toast notifications:** Use `useToast()` for success/error feedback after assignment

### Key Risk: onAuthStateChange Race Condition

When a Google user signs in for the first time, `onAuthStateChange` fires but the user row doesn't exist in the `users` table yet. We must handle this:

1. `getUserRole(uid)` returns `null` (user not found)
2. We detect this is a Google OAuth session (not a mock auth user)
3. We call `ensureUserExists()` to create the user row
4. We set `role: null` in AuthContext

The `ensureUserExists()` function uses `upsert` to be idempotent -- calling it multiple times for the same user is safe.

### Key Risk: AuthUser.role Type Change

Changing `AuthUser.role` from `UserRole` (string) to `UserRole | null` could break code that assumes role is always truthy. We need to audit all usages:

- `hasManagerAccess(role)` -- already handles null
- `App.tsx: hasManagerAccess(role)` -- already handles null
- `OnboardingHub.tsx: hasManagerAccess(role)` -- already handles null
- `NavBar.tsx: hasManagerAccess(role)` -- already handles null
- `loadMockAuthFromStorage()` -- validation check `!mockUser.role` would reject role=null; need to allow it

The biggest risk is `loadMockAuthFromStorage()` which currently validates `!mockUser.role` and returns null. For Google OAuth users, role IS null, but they don't go through loadMockAuthFromStorage -- they go through onAuthStateChange. So this validation can stay as-is for mock auth (which always has a role).

### Non-Goals

- **RLS policy changes:** Current permissive "allow all" policies are unchanged. Auth-scoped RLS is a separate feature.
- **Email confirmation:** Supabase email confirmation should be disabled for smooth OAuth flow. This is server-side config, not code.
- **Admin/Manager self-registration:** Only employees can self-register via Google OAuth. Managers/admins are hard-seeded.
- **Password-based auth removal:** The existing email+password signUp/signInWithPassword code in `signInWithEmailLink()` stays for backward compatibility with dev-auth mode.
- **Mobile responsive design:** The app is desktop-only (per bug #29 resolution).
- **Google profile picture/avatar:** Not extracting or displaying Google profile photos.
