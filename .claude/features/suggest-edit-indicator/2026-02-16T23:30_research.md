# Research: suggest-edit-indicator

## Metadata
- **Feature:** suggest-edit-indicator
- **Created:** 2026-02-16T23:30
- **Status:** research-complete
- **Researcher:** research-agent

## Feature Context

### Description
Add a visual indicator (amber/yellow badge) on employee step cards when the employee has submitted a suggestion ("Feedback Sent") for that step. Currently, after submitting a suggestion via the SuggestEditModal, the step card looks identical -- there is no visual feedback that a suggestion is pending.

### Where It Fits
This is a UX enhancement for the Employee View. It affects the data flow from OnboardingHub down through EmployeeView -> StepTimeline -> StepCard. It requires reading from the Zustand suggestions slice (already fully implemented) and passing derived state down to step cards.

### Dependencies on Other Features
- **zustand-activities (slice 4)** -- COMPLETE. The SuggestionsSlice is fully implemented in the Zustand store. `useSuggestions` hook is available.
- **zustand-cleanup (slice 5)** -- COMPLETE. OnboardingHub is the "thin router" pattern.
- No blocking dependencies.

## Requirements

### Functional Requirements
- [x] FR1: Steps with pending suggestions show an amber "Feedback Sent" badge next to the step title
- [x] FR2: Steps with pending suggestions have an amber ring highlight (additive, not overriding status borders)
- [x] FR3: The badge only appears for suggestions with status `'pending'` (not `'reviewed'` or `'implemented'`)
- [x] FR4: The indicator only shows suggestions for the current employee's onboarding instance (filtered by `instanceId`)
- [x] FR5: After submitting a suggestion, a success toast "Suggestion submitted!" appears
- [x] FR6: The badge is visible alongside existing status badges (STUCK, Completed checkmark) without conflict

### Technical Requirements
- [x] TR1: `hasPendingSuggestion?: boolean` added to `StepCardProps` interface in `src/types/index.ts`
- [x] TR2: `useSuggestions(!isManager)` hook used in OnboardingHub to access suggestions from the Zustand store
- [x] TR3: `Set<number>` of stepIds with pending suggestions computed, filtered by `instanceId === employeeInstance.id`
- [x] TR4: `stepsWithPendingSuggestions: Set<number>` prop threaded through EmployeeView -> StepTimeline -> StepCard
- [x] TR5: StepCard renders amber Badge ("Feedback Sent") with MessageSquare icon when `hasPendingSuggestion` is true
- [x] TR6: Amber ring (`ring-2 ring-amber-200 dark:ring-amber-800`) added conditionally to pending steps with suggestions
- [x] TR7: Success toast added after createSuggestion succeeds in OnboardingHub.handleSuggestEdit
- [x] TR8: All new code has dark mode support (`dark:` Tailwind classes)
- [x] TR9: Unit tests added for the visual indicator (9 new tests total)

### Code Examples / References

**Existing badge pattern in StepCard (stuck badge):**
```tsx
{isStuck && (
  <Badge
    color="red"
    className="inline-flex items-center gap-1 animate-pulse"
  >
    <AlertTriangle size={14} className="flex-shrink-0" />
    STUCK
  </Badge>
)}
```

**Existing border color map in StepCard:**
```tsx
const borderColorMap = {
  stuck: 'border-l-rose-500 ring-2 ring-rose-100 dark:ring-rose-900 bg-rose-50/30 dark:bg-rose-950/20',
  completed: 'border-l-emerald-500 bg-emerald-50/20 dark:bg-emerald-950/20',
  pending: 'border-l-brand-500',
};
```

**Badge component already supports amber color:**
```tsx
amber: 'bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300',
```

**Suggestion type already has instanceId:**
```tsx
export interface Suggestion {
  id: number | string;
  stepId: number;
  user: string;
  text: string;
  status: SuggestionStatus; // 'pending' | 'reviewed' | 'implemented'
  createdAt?: number;
  instanceId?: string;
}
```

### Warnings/Critical Notes
> The `handleSuggestEdit` in OnboardingHub already calls `createSuggestion` with `instanceId: employeeInstance.id`, so the data in the suggestions table already tracks which instance each suggestion belongs to. The filtering will work.

> The border color in StepCard is keyed by `step.status` (pending/completed/stuck). The suggestion indicator is orthogonal -- a step could be pending AND have a suggestion, or stuck AND have a suggestion. The border color logic needs careful handling to avoid overriding the stuck/completed border. Recommendation: only apply amber border when step is in `pending` status (not stuck or completed), OR use a subtler ring/shadow instead of replacing the border.

> Currently OnboardingHub does NOT call `useSuggestions()`. The suggestions subscription is only started in ManagerView. To show suggestions in the employee view, we need to add `useSuggestions()` to OnboardingHub -- but only for employees (or when the employee view is active). The hook accepts an `enabled` parameter for conditional subscription.

## Existing Code Analysis

### Project State
- Project exists: YES
- Relevant existing files identified and analyzed

### Code to Reuse
- `src/components/ui/Badge.tsx` -- Already supports `amber` color variant. Reuse directly.
- `src/hooks/useSuggestions.ts` -- Thin wrapper over Zustand SuggestionsSlice with `enabled` parameter. Use in OnboardingHub.
- `src/store/useOnboardingStore.ts` -- SuggestionsSlice is fully implemented with ref-counted subscription.
- `src/context/ToastContext.tsx` -- Toast system already imported in OnboardingHub. Just need to add success toast call.
- `lucide-react` -- `MessageSquare` icon available for the badge (consistent with "Suggest Edit" action using `Edit3`).

### Code to Modify

| File | What Changes |
|------|-------------|
| `src/types/index.ts` | Add `hasPendingSuggestion?: boolean` to `StepCardProps` |
| `src/components/OnboardingHub.tsx` | Import `useSuggestions`, compute `stepsWithPendingSuggestions` Set, pass down to EmployeeView, add success toast |
| `src/views/EmployeeView.tsx` | Add `stepsWithPendingSuggestions?: Set<number>` to `EmployeeViewProps`, forward to StepTimeline |
| `src/components/onboarding/StepTimeline.tsx` | Add `stepsWithPendingSuggestions?: Set<number>` to `StepTimelineProps`, forward to StepCard as `hasPendingSuggestion` |
| `src/components/onboarding/StepCard.tsx` | Accept `hasPendingSuggestion` prop, render amber Badge + amber ring styling |

### Patterns to Follow
1. **Prop threading pattern** -- Same as `readOnly` and `loadingStepIds` which are threaded OnboardingHub -> EmployeeView -> StepTimeline -> StepCard
2. **Badge rendering pattern** -- Same as the STUCK badge (inline-flex with icon + text inside Badge component)
3. **Border/ring color pattern** -- StepCard uses `borderColorMap` keyed by status. Suggestion indicator should be additive (ring or shadow), not replace the status border.
4. **Conditional hook pattern** -- `useSuggestions(enabled)` where `enabled = !isManager` (only employees need this subscription in OnboardingHub)
5. **Toast pattern** -- `showToast('message', 'success')` after successful operations (already used for errors, just change type)
6. **Test pattern** -- Lazy import with `vi.mock` for service dependencies. StepTimeline tests mock StepCard. EmployeeView tests use test-utils render.

## Constraints

### Performance
- Suggestion filtering happens in OnboardingHub render (useMemo recommended). Suggestions array is typically small (<50 items per app instance).
- Adding `useSuggestions()` in OnboardingHub for employees adds one Supabase Realtime subscription. This is fine -- managers already have this subscription in ManagerView. The ref-counted subscription means if both views are active they share one connection.

### Platform
- All Tailwind classes must include `dark:` variants for dark mode support
- Badge component already handles dark mode internally via colorMap

### Dependencies
- `lucide-react` -- MessageSquare icon (already a project dependency)
- No new npm dependencies needed

## Risk Assessment

### Technical Risks
| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Border color conflict between status and suggestion indicator | Medium | Medium | Use additive amber ring/shadow instead of replacing border-l color. Only override border when status is `pending`. |
| Suggestions not yet loaded when step cards render | Low | Low | `useSuggestions` returns empty array while loading -- Set will be empty, no badges shown. They appear once data loads. |
| Manager viewing employee view should NOT see employee's suggestion badges | Low | Low | Filter suggestions by `instanceId === viewingInstance.id`. When manager views via EmployeeSelector, viewingInstance changes, so the set updates correctly. |
| MemoizedEmployeeView stale props | Low | Low | The `stepsWithPendingSuggestions` Set reference changes when suggestions change, which breaks memo equality -- this is desired behavior. |

### Complexity
- **Level:** Simple
- **Rationale:** This is a pure UI enhancement with well-established prop-threading patterns already in use. No new state management, no new hooks, no new services. The data (suggestions with instanceId) already exists in the Zustand store. We just need to read it and derive a Set, then render a badge conditionally.

## Open Questions

- [x] Q1: Should the amber border override the status border (pending/stuck/completed)?
  - Resolution: No. The suggestion indicator should be additive. Use a subtle amber ring (`ring-2 ring-amber-200 dark:ring-amber-800`) when the step has a pending suggestion AND is in `pending` status. Do NOT override the stuck (red) or completed (green) borders. The amber Badge text is visible regardless of border color.

- [x] Q2: Should `useSuggestions()` be called in OnboardingHub even for managers?
  - Resolution: No. Use `useSuggestions(!isManager)` to only subscribe for employees. Managers already have suggestions via ManagerView. The employee view for managers (via EmployeeSelector) could optionally show suggestions too, but that adds complexity for little value. Defer that.

- [x] Q3: Should a success toast be added after suggestion submission?
  - Resolution: Yes. Currently `handleSuggestEdit` only shows error toasts. Adding `showToast('Suggestion submitted!', 'success')` after `setActiveModal(null)` is a trivial 1-line addition that provides immediate feedback.

- [x] Q4: What icon should the "Feedback Sent" badge use?
  - Resolution: Use `MessageSquare` from lucide-react. It conveys "feedback/message sent" clearly and is visually distinct from AlertTriangle (stuck) and CheckCircle (completed).

- [x] Q5: Should the badge say "Feedback Sent" or "Suggestion Pending"?
  - Resolution: "Feedback Sent" -- it matches the user's perspective (they sent feedback). "Suggestion Pending" sounds more like a manager's view.

## Recommended Approach

### Implementation Strategy

**Direct prop threading (same pattern as readOnly/loadingStepIds):**

1. Add `useSuggestions(!isManager)` in OnboardingHub
2. Compute `stepsWithPendingSuggestions = useMemo(() => new Set(suggestions.filter(s => s.status === 'pending' && s.instanceId === employeeInstance?.id).map(s => s.stepId)), [suggestions, employeeInstance?.id])`
3. Thread the Set down: OnboardingHub -> EmployeeView -> StepTimeline -> StepCard
4. In StepCard, check `hasPendingSuggestion` and render amber Badge + optional amber ring

**Why not use the store directly in StepCard?** The StepCard is a presentational component that receives data via props. The existing pattern (readOnly, isLoading, step data) all come via props. Using the store directly would break this pattern and make testing harder.

### Order of Work
1. **Types** -- Add `hasPendingSuggestion` to `StepCardProps` in `src/types/index.ts`
2. **StepCard** -- Add amber Badge rendering + ring styling (visual change)
3. **StepTimeline** -- Add `stepsWithPendingSuggestions` prop, forward to StepCard
4. **EmployeeView** -- Add `stepsWithPendingSuggestions` prop, forward to StepTimeline
5. **OnboardingHub** -- Add `useSuggestions`, compute Set, pass to EmployeeView, add success toast
6. **Tests** -- Add tests for StepCard (badge rendering), StepTimeline (prop forwarding), EmployeeView (prop forwarding)

### What to Defer
- **Manager's employee view showing suggestion badges** -- Adds complexity (need to subscribe to suggestions for the selected instance). Defer to a separate enhancement.
- **Badge click-to-view suggestion detail** -- Out of scope. Just a visual indicator for now.
- **Animated badge appearance** -- Can add later with `animate-in` if desired.

## Files Summary

| File | Path | Role |
|------|------|------|
| Types | `/home/sanjay/Workspace/onboarding/src/types/index.ts` | Add `hasPendingSuggestion` to StepCardProps |
| StepCard | `/home/sanjay/Workspace/onboarding/src/components/onboarding/StepCard.tsx` | Render amber badge + ring |
| StepTimeline | `/home/sanjay/Workspace/onboarding/src/components/onboarding/StepTimeline.tsx` | Thread prop to StepCard |
| EmployeeView | `/home/sanjay/Workspace/onboarding/src/views/EmployeeView.tsx` | Thread prop to StepTimeline |
| OnboardingHub | `/home/sanjay/Workspace/onboarding/src/components/OnboardingHub.tsx` | Add useSuggestions, compute Set, pass down, success toast |
| Badge | `/home/sanjay/Workspace/onboarding/src/components/ui/Badge.tsx` | No changes needed (amber already supported) |
| useSuggestions | `/home/sanjay/Workspace/onboarding/src/hooks/useSuggestions.ts` | No changes needed (already has enabled param) |
| Store | `/home/sanjay/Workspace/onboarding/src/store/useOnboardingStore.ts` | No changes needed (SuggestionsSlice complete) |
| StepTimeline test | `/home/sanjay/Workspace/onboarding/src/components/onboarding/StepTimeline.test.tsx` | Add test for prop forwarding |
| EmployeeView test | `/home/sanjay/Workspace/onboarding/src/views/EmployeeView.test.tsx` | Add test for suggestion badge |

## Next Step

**All questions resolved.** Run `/plan suggest-edit-indicator` to create the implementation plan.
