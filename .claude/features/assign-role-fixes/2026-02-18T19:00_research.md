# Research: Assign Role Fixes (two bugs)

**Feature:** `assign-role-fixes`
**Date:** 2026-02-18
**Status:** research-complete

## Bug 1: Assigning role to unassigned user upserts into users table

**Root cause:** `handleAssignSubmit` calls `setUserRole()` which upserts into `users` table (authService.ts:39-44). This is wrong — the user already exists from Google OAuth `ensureUserExists()`. The upsert also overwrites the Google display name with `email.split('@')[0]`.

**Fix:** Replace `setUserRole()` with the store's `_editUser()` action, which calls `updateUser()` from userService. `updateUser()` correctly handles `user_roles` delete+insert without touching the `users` row name. This also fixes the UI update issue (see Bug 2).

## Bug 2: UI doesn't update after assigning role

**Root cause:** Two missing optimistic updates:
1. `createOnboardingRunFromTemplate` return value is discarded — `_addInstance` never called
2. User's roles not updated in Zustand store after role assignment — user stays in "Unassigned" list

**Fix:**
1. Capture return value, call `_addInstance(newInstance)`
2. Use store's `_editUser()` which updates both DB and local state
