# Research: slim-modals

## Metadata
- **Feature:** slim-modals
- **Created:** 2026-02-14T12:00
- **Status:** research-complete
- **Researcher:** research-agent

## Feature Context

The codebase has 3 pairs of Create/Edit modals that share 80%+ identical code. The goal is to merge each pair into a single unified component using a `mode: 'create' | 'edit'` pattern, cutting ~1,200 lines without losing any functionality.

Additionally, `CreateOnboardingModal` (501 lines, standalone) should be reviewed for trim opportunities.

### Where It Fits
- This is the first of 3 "fat-trim" features (slim-modals, slim-services, slim-tests)
- No features depend on this one completing first
- The `performance-loading` feature recently refactored modals to accept `roles` as props -- this must be preserved

## Requirements

### Functional Requirements
- [ ] FR1: Merge `CreateRoleModal` + `EditRoleModal` into a single `RoleModal` component
- [ ] FR2: Merge `CreateUserModal` + `EditUserModal` into a single `UserModal` component
- [ ] FR3: Merge `CreateTemplateModal` + `EditTemplateModal` into a single `TemplateModal` component
- [ ] FR4: All existing validation rules must be preserved
- [ ] FR5: All existing form fields must be preserved
- [ ] FR6: Edit-mode-specific features (pre-fill, read-only fields, delete, metadata display, change detection) must be preserved
- [ ] FR7: Create-mode-specific features (empty form, form hints, intro sections) must be preserved
- [ ] FR8: Update all parent components to use unified modals
- [ ] FR9: Update barrel exports (`index.ts` files) for both `modals/` and `templates/`
- [ ] FR10: Review `CreateOnboardingModal` for trim opportunities (standalone, no edit pair)

### Technical Requirements
- [ ] TR1: Use `mode: 'create' | 'edit'` prop pattern (not over-engineered abstractions)
- [ ] TR2: Keep the `roles` / `rolesLoading` prop pattern from `performance-loading`
- [ ] TR3: Maintain existing dark mode support in all modals
- [ ] TR4: Maintain existing accessibility (ARIA labels, `aria-required`, `aria-invalid`, `aria-describedby`)
- [ ] TR5: Update or merge test files for unified components
- [ ] TR6: All existing tests must pass (with updated imports/usage)

### Constraints
- Must not break existing functionality
- Must not undo the `performance-loading` refactoring (roles/templates passed as props)
- Keep it simple -- `mode` prop, not a generic modal factory

## Existing Code Analysis

### Project State
- Project exists: YES
- Total modal source lines: 2,579 (7 files)
- Total modal test lines: 3,412 (7 test files)
- Grand total: 5,991 lines for modals + tests

### Line Counts (Source)

| File | Lines |
|------|-------|
| `CreateRoleModal.tsx` | 292 |
| `EditRoleModal.tsx` | 279 |
| `CreateUserModal.tsx` | 311 |
| `EditUserModal.tsx` | 316 |
| `CreateTemplateModal.tsx` | 410 |
| `EditTemplateModal.tsx` | 470 |
| `CreateOnboardingModal.tsx` | 501 |
| **Total** | **2,579** |

### Line Counts (Tests)

| File | Lines |
|------|-------|
| `CreateRoleModal.test.tsx` | 498 |
| `EditRoleModal.test.tsx` | 724 |
| `CreateUserModal.test.tsx` | 309 |
| `CreateTemplateModal.test.tsx` | 352 |
| `EditTemplateModal.test.tsx` | 352 |
| `CreateOnboardingModal.test.tsx` | 836 |
| `ModalScrolling.test.tsx` | 341 |
| **Total** | **3,412** |

---

## Detailed Modal Pair Analysis

### Pair 1: Role Modals (571 lines -> ~200 lines)

#### CreateRoleModal (292 lines)
**Props:**
```ts
interface CreateRoleModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (name: string, description?: string) => Promise<void>;
  isSubmitting?: boolean;
  error?: string | null;
}
```

**Form Fields:**
1. Role Name (text input, required) -- with real-time validation, character counter, success/error icons
2. Description (textarea, optional) -- with character counter, validation for max length

**Validation:**
- Name: required, min 2 chars (`MIN_ROLE_NAME_LENGTH`), max 50 chars (`MAX_ROLE_NAME_LENGTH`), pattern (`ROLE_NAME_PATTERN`)
- Description: optional, max 500 chars
- Uses `useCallback`/`useMemo` for validation state
- `touched` state per field for blur-based validation

**Unique Features:**
- Form hint tip at bottom ("Role names should be descriptive...")
- Resets form to empty on close
- Submit sends `(name, description?)` -- two separate args

**Footer:** Cancel + Create Role (with CheckCircle icon)

#### EditRoleModal (279 lines)
**Props:**
```ts
interface EditRoleModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (description?: string) => Promise<void>;
  isSubmitting?: boolean;
  error?: string | null;
  currentRole: CustomRole;
}
```

**Form Fields:**
1. Role Name (text input, **read-only/disabled**) -- shows current name, cannot be edited
2. Description (textarea, editable) -- pre-filled with `currentRole.description`

**Validation:**
- Description only: max 500 chars
- Same `useCallback`/`useMemo` pattern, just no name validation

**Unique Features:**
- Title: `Edit Role: ${currentRole.name}` (dynamic)
- Name field is disabled with "(read-only)" label and explanation text
- **Metadata section** at bottom: Created date, Last updated date, Created by
- **Delete button** in footer (left side, currently disabled -- "use delete in role list")
- **Change detection**: `hasChanges` state, "You have unsaved changes" indicator
- Submit button disabled when no changes
- Resets form to `currentRole` data on close
- Submit sends `(description?)` -- only description, no name
- Missing dark mode classes in error section and some labels (bug/inconsistency)

#### Shared Code Between Role Modals
- `ModalWrapper` usage with `size="md"`
- Description textarea field (identical JSX structure, validation, character counter)
- Error message display block (slightly different -- Create has dark mode classes, Edit does not)
- Cancel/Submit button pair (same styling, different labels)
- Loading spinner pattern
- `handleClose` pattern (reset + onClose)
- `handleSubmit` pattern (preventDefault, validate, submit, catch)

#### Key Differences
| Aspect | Create | Edit |
|--------|--------|------|
| Title | "Create New Role" | `Edit Role: ${name}` |
| Name field | Editable with validation | Read-only/disabled |
| Description field | Empty initially | Pre-filled from `currentRole` |
| onSubmit signature | `(name, description?)` | `(description?)` |
| Footer layout | Right-aligned only | `justify-between` (delete left, actions right) |
| Delete button | No | Yes (disabled) |
| Metadata section | No | Yes (created, updated, createdBy) |
| Change detection | No | Yes (`hasChanges`) |
| Form hint | Yes (tip box) | No |
| Submit label | "Create Role" | "Update Role" |
| Loading label | "Creating..." | "Updating..." |

#### Unified Interface Design
```ts
interface RoleModalProps {
  mode: 'create' | 'edit';
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (name: string, description?: string) => Promise<void>;
  isSubmitting?: boolean;
  error?: string | null;
  currentRole?: CustomRole; // Required when mode === 'edit'
}
```
- In edit mode: name field read-only, submit sends `(currentRole.name, description)`
- Parent handler for edit can just ignore the name arg (or unified handler extracts description)

---

### Pair 2: User Modals (627 lines -> ~350 lines)

#### CreateUserModal (311 lines)
**Props:**
```ts
interface CreateUserModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (data: UserFormData) => Promise<void>;
  isSubmitting?: boolean;
  error?: string | null;
  roles?: CustomRole[];
  rolesLoading?: boolean;
}
```

**Form Fields:**
1. Email (email input, required)
2. Full Name (text input, required)
3. System Roles (checkbox list from `roles` prop, required -- at least 1)
4. Profiles (checkbox list, hardcoded: Engineering/Sales/Product/HR/All, optional)

**Validation:**
- Email: required, regex format check
- Name: required, min 2 chars
- Roles: at least one selected
- Uses `FieldErrors` object pattern, `hasAttemptedSubmit` flag

**Unique Features:**
- Intro section (amber box): "Add a manager, admin, or contractor..."
- Roles explanation text
- Profile explanation text
- Resets to empty on close

**Footer:** Cancel + Create User (no icon on submit button)

#### EditUserModal (316 lines)
**Props:**
```ts
interface EditUserModalProps {
  isOpen: boolean;
  user: User | null;
  onClose: () => void;
  onSubmit: (data: Partial<UserFormData>) => Promise<void>;
  isSubmitting?: boolean;
  error?: string | null;
  roles?: CustomRole[];
  rolesLoading?: boolean;
}
```

**Form Fields:** Same 4 fields as Create, all editable

**Validation:** Identical validation logic

**Unique Features:**
- Title: `Edit User: ${user.name}` (dynamic)
- `useEffect` to pre-fill form from `user` prop when modal opens
- Early return `if (!user) return null`
- Resets to `user` data on close (not empty)
- onSubmit sends `Partial<UserFormData>` (not full `UserFormData`)
- No intro section

**Footer:** Cancel + Save Changes (no icon on submit button)

#### Shared Code Between User Modals
- **Email field** -- identical JSX, validation, error display
- **Name field** -- identical JSX, validation, error display
- **Roles checkbox list** -- identical rendering, loading state, empty state
- **Profiles checkbox list** -- identical rendering with hardcoded values
- **validateForm()** -- identical logic
- **handleRoleChange / handleProfileChange** -- identical toggle functions
- **Error display** -- identical pattern
- **Cancel/Submit buttons** -- same styling
- **Loading spinner** -- same pattern

#### Key Differences
| Aspect | Create | Edit |
|--------|--------|------|
| Title | "Add System User" | `Edit User: ${user.name}` |
| Extra prop | -- | `user: User \| null` |
| onSubmit type | `UserFormData` | `Partial<UserFormData>` |
| Intro section | Yes (amber box) | No |
| Pre-fill | No | Yes (useEffect from `user`) |
| Reset on close | To empty | To `user` data |
| Early return | No | `if (!user) return null` |
| Submit label | "Create User" | "Save Changes" |
| Loading label | "Creating..." | "Saving..." |
| Roles description | Has extra explanation text | Does not |

#### Unified Interface Design
```ts
interface UserModalProps {
  mode: 'create' | 'edit';
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (data: UserFormData) => Promise<void>;
  isSubmitting?: boolean;
  error?: string | null;
  roles?: CustomRole[];
  rolesLoading?: boolean;
  user?: User | null; // Required when mode === 'edit'
}
```
- In edit mode: pre-fill from `user`, no intro section
- In create mode: empty form, show intro section
- Parent handler for edit can cast `UserFormData` to `Partial<UserFormData>` if needed (or unify the submit type)

---

### Pair 3: Template Modals (880 lines -> ~480 lines)

#### CreateTemplateModal (410 lines)
**Props:**
```ts
interface CreateTemplateModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (template: Omit<Template, 'id' | 'createdAt'>) => void;
  isSubmitting?: boolean;
  error?: string | null;
  roles?: CustomRole[];
  rolesLoading?: boolean;
}
```

**Local Types:**
```ts
interface TemplateStep {
  title: string;
  description: string;
  owner: string;
  expert: string;
}
```

**Form Fields:**
1. Template Name (text input, required)
2. Applicable Roles (checkbox list from `roles` prop, required)
3. Status (radio: Draft/Published, default Draft)
4. Onboarding Steps (dynamic list with add/remove):
   - Each step has: Title, Description, Owner, Expert
   - Remove button per step (when >1 step)
   - Add Step button

**Validation:**
- Template name required
- At least one role selected
- At least one step with title AND description
- All filled steps must have both title and description
- Uses `string[]` for validation errors, displayed as bulleted list

**Unique Features:**
- Starts with 1 empty step
- Steps don't have `id` field
- Submit builds `Omit<Template, 'id' | 'createdAt'>` from form data
- Step id assigned as `index + 1`

**Footer:** Cancel + Save Template (no icon)

#### EditTemplateModal (470 lines)
**Props:**
```ts
interface EditTemplateModalProps {
  isOpen: boolean;
  template: Template | null;
  onClose: () => void;
  onSubmit: (id: string, template: Partial<Template>) => void;
  onDelete: (id: string, templateName: string) => void;
  isSubmitting?: boolean;
  error?: string | null;
  roles?: CustomRole[];
  rolesLoading?: boolean;
}
```

**Local Types:**
```ts
interface TemplateStep {
  id?: number; // Optional -- existing steps have id, new ones don't
  title: string;
  description: string;
  owner: string;
  expert: string;
}
```

**Form Fields:** Same 4 sections as Create, all editable

**Validation:** Nearly identical (but checks `steps.length === 0` instead of filtering for valid steps)

**Unique Features:**
- Title: `Edit Template: ${template.name}` (dynamic)
- `useEffect` to pre-fill from `template` prop
- Early return `if (!template) return null`
- **Delete functionality**: Delete button in footer, opens `DeleteConfirmDialog`, has `isDeleting` state
- Steps have optional `id` field preserved from template data
- `handleStepChange` uses `Omit<TemplateStep, 'id'>` for field type
- Submit sends `(template.id, updates)` -- id + partial update
- Steps area has `max-h-96 overflow-y-auto` (scroll for many steps, not in Create)
- Renders `<DeleteConfirmDialog>` as sibling to `<ModalWrapper>` (wrapped in Fragment)
- Step input bg colors: `dark:bg-slate-800` (Edit) vs `dark:bg-slate-600` (Create) -- minor inconsistency

**Footer:** Delete Template (left) + Cancel + Save Changes (right) -- `justify-between`

#### Shared Code Between Template Modals
- **Template Name input** -- identical JSX (different id: `template-name` vs `edit-template-name`)
- **Roles checkbox list** -- identical rendering with fieldset/legend
- **Status radio buttons** -- identical (different `name` attr: `status` vs `edit-status`)
- **Steps editor** -- nearly identical step card UI (title, description, owner, expert, remove button, add step button)
- **Error display** -- identical pattern (bulleted validation errors)
- **validateForm()** -- very similar logic
- **handleAddStep / handleRemoveStep / handleStepChange / handleRoleToggle** -- identical functions
- **resetForm** -- same pattern
- **handleClose** -- same pattern
- **Loading spinner / submit button** -- same pattern

#### Key Differences
| Aspect | Create | Edit |
|--------|--------|------|
| Title | "Create New Template" | `Edit Template: ${name}` |
| Extra props | -- | `template`, `onDelete` |
| onSubmit type | `Omit<Template, 'id'\|'createdAt'>` | `(id, Partial<Template>)` |
| Pre-fill | No | Yes (useEffect) |
| Initial steps | 1 empty step | Loaded from template |
| TemplateStep type | No `id` field | Has optional `id` |
| Delete functionality | No | Yes (button + dialog) |
| Footer layout | Right-aligned | `justify-between` |
| Submit label | "Save Template" | "Save Changes" |
| Steps scroll | No | `max-h-96 overflow-y-auto` |
| Early return | No | `if (!template) return null` |
| Validation | Filters for "valid" steps | Checks `steps.length` |

#### Unified Interface Design
```ts
interface TemplateModalProps {
  mode: 'create' | 'edit';
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (template: Omit<Template, 'id' | 'createdAt'>, id?: string) => void;
  onDelete?: (id: string, templateName: string) => void; // Only for edit mode
  isSubmitting?: boolean;
  error?: string | null;
  roles?: CustomRole[];
  rolesLoading?: boolean;
  template?: Template | null; // Required when mode === 'edit'
}
```

---

### Standalone: CreateOnboardingModal (501 lines)

**Props:**
```ts
interface CreateOnboardingModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (data: OnboardingFormData) => Promise<void>;
  isSubmitting?: boolean;
  error?: string | null;
  roles?: CustomRole[];
  rolesLoading?: boolean;
  templates?: Template[];
  templatesLoading?: boolean;
}
```

**Form Fields:**
1. Employee Name (text input, required)
2. Employee Email (email input, required)
3. Role (select dropdown from `roles` prop, required)
4. Department (text input, required)
5. Template (select dropdown from `templates` prop, required)
6. Start Date (date input, optional)

**Plus a Template Preview section** when template is selected.

**Assessment:** This is a standalone create-only modal. There is no `EditOnboardingModal`. The file is 501 lines, which is long, but it has no duplicate pair. The length comes from:
- 6 form fields with validation + error display
- Template preview section
- Loading/empty states for templates
- Intro section
- Detailed accessibility attributes

**Trim Opportunities:**
- The validation boilerplate (FieldErrors pattern, hasAttemptedSubmit) is repeated from User modals -- could extract a shared hook or pattern, but that's beyond the scope of "slim-modals" (more of a utility extraction)
- The form field rendering is straightforward with no easy deduplication
- **Recommendation:** Leave `CreateOnboardingModal` as-is for this feature. It has no pair, and the complexity is inherent to its 6 fields + preview. Any trimming would be marginal.

---

## Parent Component Usage

### RoleManagementPanel (`src/components/manager/RoleManagementPanel.tsx`)
```tsx
// Create modal usage
<CreateRoleModal
  isOpen={isCreateModalOpen}
  onClose={() => { setIsCreateModalOpen(false); setModalError(null); }}
  onSubmit={handleCreateRoleSubmit}
  isSubmitting={isCreateSubmitting}
  error={modalError}
/>

// Edit modal usage (conditional render)
{selectedRoleForEdit && (
  <EditRoleModal
    isOpen={isEditModalOpen}
    onClose={() => { setIsEditModalOpen(false); setSelectedRoleForEdit(null); setModalError(null); }}
    onSubmit={handleEditRoleSubmit}
    isSubmitting={isEditSubmitting}
    error={modalError}
    currentRole={selectedRoleForEdit}
  />
)}
```
- Has separate state: `isCreateModalOpen`, `isEditModalOpen`, `selectedRoleForEdit`, `isCreateSubmitting`, `isEditSubmitting`
- Create handler: `handleCreateRoleSubmit(name, description)` -- calls `createRole(name, description)`
- Edit handler: `handleEditRoleSubmit(description)` -- calls `updateRole(id, { description })`
- After unification: Could use single `isModalOpen` + `modalMode` + `selectedRole` state

### UsersPanel (`src/components/manager/UsersPanel.tsx`)
```tsx
// Create modal
<CreateUserModal
  isOpen={showCreateModal}
  onClose={handleCloseCreateModal}
  onSubmit={handleCreateUser}
  isSubmitting={isSubmitting}
  error={submitError}
  roles={roles}
  rolesLoading={rolesLoading}
/>

// Edit modal
<EditUserModal
  isOpen={showEditModal}
  user={editingUser}
  onClose={handleCloseEditModal}
  onSubmit={handleEditUser}
  isSubmitting={isSubmitting}
  error={submitError}
  roles={roles}
  rolesLoading={rolesLoading}
/>
```
- Has separate state: `showCreateModal`, `showEditModal`, `editingUser`
- Shares `isSubmitting` and `submitError` between both modals
- Create handler: `handleCreateUser(data: UserFormData)` -- calls `createNewUser(data, userId)`
- Edit handler: `handleEditUser(data: Partial<UserFormData>)` -- calls `editUser(id, data)`
- After unification: single `showModal` boolean + `modalMode` + `editingUser`

### TemplatesView (`src/views/TemplatesView.tsx`)
```tsx
// Create modal
<CreateTemplateModal
  isOpen={createModalOpen}
  onClose={() => { setCreateModalOpen(false); setCreateError(null); }}
  onSubmit={handleCreateTemplate}
  isSubmitting={isCreating}
  error={createError}
  roles={roles}
  rolesLoading={rolesLoading}
/>

// Edit modal
<EditTemplateModal
  isOpen={editModalOpen}
  template={selectedTemplate}
  onClose={() => { setEditModalOpen(false); setSelectedTemplate(null); setEditError(null); }}
  onSubmit={handleEditTemplate}
  onDelete={handleDeleteTemplate}
  isSubmitting={isEditing || isDeleting}
  error={editError}
  roles={roles}
  rolesLoading={rolesLoading}
/>
```
- Has separate state: `createModalOpen`, `editModalOpen`, `selectedTemplate`, `isCreating`, `isEditing`, `isDeleting`, `createError`, `editError`
- Create handler: `handleCreateTemplate(template: Omit<Template, 'id' | 'createdAt'>)` -- calls `create(template)`
- Edit handler: `handleEditTemplate(id, updates)` -- calls `update(id, updates)`
- Delete handler: `handleDeleteTemplate(id, name)` -- calls `remove(id)`
- After unification: Could consolidate some state, but the separate error handling per mode is useful

### ManagerView (`src/views/ManagerView.tsx`)
```tsx
<CreateOnboardingModal
  isOpen={isCreateOnboardingOpen}
  onClose={handleCloseCreateOnboarding}
  onSubmit={handleSubmitOnboarding}
  isSubmitting={isCreating}
  error={creationError}
  roles={roles}
  rolesLoading={rolesLoading}
  templates={templates}
  templatesLoading={templatesLoading}
/>
```
- Standalone usage, no changes needed for this feature.

---

## Barrel Export Files

### `src/components/modals/index.ts` (current)
```ts
export { SuggestEditModal } from './SuggestEditModal';
export { ReportStuckModal } from './ReportStuckModal';
export { CreateOnboardingModal } from './CreateOnboardingModal';
export { CreateRoleModal } from './CreateRoleModal';
export { EditRoleModal } from './EditRoleModal';
export { CreateUserModal } from './CreateUserModal';
export { EditUserModal } from './EditUserModal';
export type { OnboardingFormData } from './CreateOnboardingModal';
```

After: Replace 4 exports (CreateRole, EditRole, CreateUser, EditUser) with 2 (RoleModal, UserModal).

### `src/components/templates/index.ts` (current)
```ts
export { CreateTemplateModal } from './CreateTemplateModal';
export { EditTemplateModal } from './EditTemplateModal';
export { DeleteConfirmDialog } from './DeleteConfirmDialog';
```

After: Replace 2 exports (CreateTemplate, EditTemplate) with 1 (TemplateModal). Keep DeleteConfirmDialog.

---

## Test Files Analysis

### Tests That Need Updating

| Test File | Lines | Tests | Action |
|-----------|-------|-------|--------|
| `CreateRoleModal.test.tsx` | 498 | 20 | Merge into `RoleModal.test.tsx` |
| `EditRoleModal.test.tsx` | 724 | 25 | Merge into `RoleModal.test.tsx` |
| `CreateUserModal.test.tsx` | 309 | 12 | Merge into `UserModal.test.tsx` |
| `CreateTemplateModal.test.tsx` | 352 | 13 | Merge into `TemplateModal.test.tsx` |
| `EditTemplateModal.test.tsx` | 352 | 12 | Merge into `TemplateModal.test.tsx` |
| `CreateOnboardingModal.test.tsx` | 836 | 22 | No change (standalone) |
| `ModalScrolling.test.tsx` | 341 | ? | Check if it references old modal names |

**Note:** There is no `EditUserModal.test.tsx` -- the EditUserModal has no dedicated test file.

All tests will need their imports and component usage updated to pass `mode` prop. The test structure (describe blocks) can largely remain the same, just with `mode='create'` or `mode='edit'` variations.

---

## Risk Assessment

### Technical Risks

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Breaking onSubmit signature compatibility | High | Medium | Design unified handler that works for both modes; update parent handlers |
| Dark mode inconsistencies in EditRoleModal getting carried forward | Low | High | Fix them during merge -- add missing `dark:` classes |
| Test regressions from merged components | Medium | Medium | Run full test suite after each modal merge |
| EditTemplateModal's DeleteConfirmDialog integration breaking | Medium | Low | Keep `onDelete` prop optional, only used in edit mode |
| Step editor inconsistencies between Create/Edit template modals | Low | Medium | Use Edit version's styling (more complete dark mode) as canonical |

### Complexity
- **Level:** Medium
- **Rationale:** The modals are structurally very similar, making the merge straightforward. The main complexity comes from:
  1. Different `onSubmit` signatures between Create and Edit modes
  2. EditRoleModal has a very different form (name is read-only, no name validation)
  3. Template modal has delete functionality only in edit mode
  4. Updating 3 parent components and their state management
  5. Merging 5 test files while preserving all test cases

---

## Open Questions

- [x] Q1: Should the unified onSubmit signature change or should parent components adapt?
  - Resolution: Parent components should adapt. The unified modal can have a single onSubmit signature per modal type, and parent handlers adjust accordingly. This keeps the modal API clean.

- [x] Q2: Should we fix dark mode bugs in EditRoleModal during the merge?
  - Resolution: Yes. The merge is the natural time to fix inconsistencies. EditRoleModal is missing `dark:` classes in several places (error display, labels). Use CreateRoleModal's more complete dark mode as the canonical version.

- [x] Q3: What about the disabled delete button in EditRoleModal?
  - Resolution: Keep it as-is. Delete for roles is handled via the parent's `DeleteConfirmationDialog`, not through the edit modal. The disabled button in the edit modal footer is just an indicator.

- [x] Q4: Should CreateOnboardingModal be trimmed?
  - Resolution: No. It has no pair, no duplicate code, and its 501 lines are inherent complexity from 6 fields + preview. Leave it for this feature.

- [x] Q5: How to handle the different TemplateStep types (with/without `id`)?
  - Resolution: Use the Edit version's type (`id?: number`) which is a superset. In create mode, steps won't have ids, which the optional `id` handles.

---

## Recommended Approach

### Implementation Strategy

Use a simple `mode: 'create' | 'edit'` prop pattern for each unified modal. Each unified modal encapsulates the mode-specific differences internally via conditional rendering and logic branching.

### Order of Work

1. **RoleModal** (simplest pair, least shared fields, best for proving the pattern)
   - Merge CreateRoleModal + EditRoleModal into `RoleModal.tsx`
   - Fix dark mode inconsistencies
   - Update `RoleManagementPanel.tsx` to use `RoleModal`
   - Merge test files into `RoleModal.test.tsx`
   - Delete old files: `CreateRoleModal.tsx`, `EditRoleModal.tsx`
   - Update barrel export

2. **UserModal** (medium complexity, 4 shared fields, identical validation)
   - Merge CreateUserModal + EditUserModal into `UserModal.tsx`
   - Update `UsersPanel.tsx` to use `UserModal`
   - Merge test files into `UserModal.test.tsx`
   - Delete old files
   - Update barrel export

3. **TemplateModal** (most complex, has step editor + delete functionality)
   - Merge CreateTemplateModal + EditTemplateModal into `TemplateModal.tsx`
   - Keep `DeleteConfirmDialog.tsx` as separate component (it's small and focused)
   - Update `TemplatesView.tsx` to use `TemplateModal`
   - Merge test files into `TemplateModal.test.tsx`
   - Delete old files
   - Update barrel export

4. **CreateOnboardingModal** -- review only, likely no changes needed

5. **Final cleanup** -- verify all tests pass, verify no broken imports

### Estimated Line Savings

| Component | Before | After (est.) | Savings |
|-----------|--------|-------------|---------|
| RoleModal | 571 | ~200 | ~370 |
| UserModal | 627 | ~350 | ~280 |
| TemplateModal | 880 | ~480 | ~400 |
| **Total** | **2,078** | **~1,030** | **~1,050** |

The test files will also shrink since shared test setup and assertions can be deduplicated, but that is secondary.

### What to Defer
- **CreateOnboardingModal trimming** -- no pair, minimal opportunity
- **Shared validation hook extraction** -- useful but belongs in a later feature
- **ModalScrolling.test.tsx updates** -- only update if it directly imports the old modal names

---

## Files to Create/Modify/Delete

### Create
- `src/components/modals/RoleModal.tsx` (unified)
- `src/components/modals/UserModal.tsx` (unified)
- `src/components/templates/TemplateModal.tsx` (unified)
- `src/components/modals/RoleModal.test.tsx` (merged tests)
- `src/components/modals/UserModal.test.tsx` (merged tests)
- `src/components/templates/TemplateModal.test.tsx` (merged tests)

### Modify
- `src/components/manager/RoleManagementPanel.tsx` (use RoleModal)
- `src/components/manager/UsersPanel.tsx` (use UserModal)
- `src/views/TemplatesView.tsx` (use TemplateModal)
- `src/components/modals/index.ts` (update exports)
- `src/components/templates/index.ts` (update exports)

### Delete
- `src/components/modals/CreateRoleModal.tsx`
- `src/components/modals/EditRoleModal.tsx`
- `src/components/modals/CreateUserModal.tsx`
- `src/components/modals/EditUserModal.tsx`
- `src/components/templates/CreateTemplateModal.tsx`
- `src/components/templates/EditTemplateModal.tsx`
- `src/components/modals/CreateRoleModal.test.tsx`
- `src/components/modals/EditRoleModal.test.tsx`
- `src/components/modals/CreateUserModal.test.tsx`
- `src/components/templates/CreateTemplateModal.test.tsx`
- `src/components/templates/EditTemplateModal.test.tsx`

---

## Next Step

**All questions resolved.**
Run `/plan slim-modals` to create implementation plan.
