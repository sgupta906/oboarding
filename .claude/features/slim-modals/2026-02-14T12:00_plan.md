# Plan: slim-modals

## Metadata
- **Feature:** slim-modals
- **Created:** 2026-02-14T12:00
- **Status:** plan-complete
- **Based-on:** 2026-02-14T12:00_research.md
- **Planner:** plan-agent

## Goal

Merge 3 pairs of Create/Edit modals into unified components using a `mode: 'create' | 'edit'` prop pattern. Target: eliminate ~1,050 lines of duplicated modal source code without losing any existing functionality.

---

## Architecture Overview

```
BEFORE                                   AFTER
======                                   =====

src/components/modals/                   src/components/modals/
  CreateRoleModal.tsx (292)                 RoleModal.tsx (~200)
  EditRoleModal.tsx   (279)                 RoleModal.test.tsx (merged)
  CreateRoleModal.test.tsx (498)            UserModal.tsx (~350)
  EditRoleModal.test.tsx   (724)            UserModal.test.tsx (merged)
  CreateUserModal.tsx (311)                 CreateOnboardingModal.tsx (unchanged)
  EditUserModal.tsx   (316)                 CreateOnboardingModal.test.tsx (unchanged)
  CreateUserModal.test.tsx (309)            SuggestEditModal.tsx (unchanged)
  CreateOnboardingModal.tsx (501)           ReportStuckModal.tsx (unchanged)
  ...                                      index.ts (updated exports)

src/components/templates/                src/components/templates/
  CreateTemplateModal.tsx (410)             TemplateModal.tsx (~480)
  EditTemplateModal.tsx   (470)             TemplateModal.test.tsx (merged)
  CreateTemplateModal.test.tsx (352)        DeleteConfirmDialog.tsx (unchanged)
  EditTemplateModal.test.tsx   (352)        ModalScrolling.test.tsx (updated import)
  ModalScrolling.test.tsx (341)             index.ts (updated exports)
  DeleteConfirmDialog.tsx
  index.ts
```

### Data Flow (unchanged)

```
Parent Component (state owner)
  |
  +-- mode: 'create' | 'edit'
  +-- isOpen, onClose, onSubmit, isSubmitting, error
  +-- entity data (edit mode only: currentRole / user / template)
  +-- optional: roles, rolesLoading, onDelete
  |
  v
Unified Modal Component
  |
  +-- Internal form state (useState)
  +-- Validation logic
  +-- Conditional rendering per mode
  +-- Calls onSubmit with form data
```

## Tech Stack (no changes)

- React 18 + TypeScript
- Tailwind CSS 3 (dark mode classes)
- Lucide React (icons)
- ModalWrapper (existing shared UI primitive)
- Vitest + React Testing Library (tests)

---

## File Structure

### New Files (6)

| File | Purpose | Est. Lines |
|------|---------|------------|
| `src/components/modals/RoleModal.tsx` | Unified create/edit role modal | ~200 |
| `src/components/modals/RoleModal.test.tsx` | Merged role modal tests | ~700 |
| `src/components/modals/UserModal.tsx` | Unified create/edit user modal | ~350 |
| `src/components/modals/UserModal.test.tsx` | Merged user modal tests | ~350 |
| `src/components/templates/TemplateModal.tsx` | Unified create/edit template modal | ~480 |
| `src/components/templates/TemplateModal.test.tsx` | Merged template modal tests | ~450 |

### Modified Files (5)

| File | Change |
|------|--------|
| `src/components/manager/RoleManagementPanel.tsx` | Replace CreateRoleModal + EditRoleModal imports/usage with RoleModal |
| `src/components/manager/UsersPanel.tsx` | Replace CreateUserModal + EditUserModal imports/usage with UserModal |
| `src/views/TemplatesView.tsx` | Replace CreateTemplateModal + EditTemplateModal imports/usage with TemplateModal |
| `src/components/modals/index.ts` | Remove 4 old exports, add 2 new exports (RoleModal, UserModal) |
| `src/components/templates/index.ts` | Remove 2 old exports, add 1 new export (TemplateModal) |

### Deleted Files (11)

| File | Lines Removed |
|------|--------------|
| `src/components/modals/CreateRoleModal.tsx` | 292 |
| `src/components/modals/EditRoleModal.tsx` | 279 |
| `src/components/modals/CreateRoleModal.test.tsx` | 498 |
| `src/components/modals/EditRoleModal.test.tsx` | 724 |
| `src/components/modals/CreateUserModal.tsx` | 311 |
| `src/components/modals/EditUserModal.tsx` | 316 |
| `src/components/modals/CreateUserModal.test.tsx` | 309 |
| `src/components/templates/CreateTemplateModal.tsx` | 410 |
| `src/components/templates/EditTemplateModal.tsx` | 470 |
| `src/components/templates/CreateTemplateModal.test.tsx` | 352 |
| `src/components/templates/EditTemplateModal.test.tsx` | 352 |

### Unchanged Files

| File | Why |
|------|-----|
| `src/components/modals/CreateOnboardingModal.tsx` | Standalone, no pair |
| `src/components/modals/CreateOnboardingModal.test.tsx` | No changes needed |
| `src/components/templates/DeleteConfirmDialog.tsx` | Separate concern, used by TemplateModal |
| `src/components/templates/ModalScrolling.test.tsx` | Update import only if it references old names |

---

## Component Architecture

### RoleModal (~200 lines)

```
RoleModal
  Props:
    mode: 'create' | 'edit'
    isOpen: boolean
    onClose: () => void
    onSubmit: (name: string, description?: string) => Promise<void>
    isSubmitting?: boolean
    error?: string | null
    currentRole?: CustomRole          // Required when mode === 'edit'

  Internal State:
    name: string                      // Editable in create, read-only in edit
    description: string               // Editable in both
    touched: { name, description }    // Blur-based validation
    hasChanges: boolean               // Edit mode only (derived)

  Mode Differences:
    CREATE                            EDIT
    - Title: "Create New Role"        - Title: "Edit Role: {name}"
    - Name field: editable            - Name field: disabled/read-only
    - Name validation: yes            - Name validation: no
    - Form hint (blue tip box)        - Metadata section (dates, creator)
    - Footer: Cancel | Create Role    - Footer: Delete(disabled) | Cancel | Update Role
    - No change detection             - hasChanges gate on submit
    - Reset to empty on close         - Reset to currentRole on close
    - Submit: (name, desc?)           - Submit: (currentRole.name, desc?)

  Dark Mode Fixes (during merge):
    - Add dark: classes to error section (missing in EditRoleModal)
    - Add dark: classes to labels and read-only input
    - Add dark: classes to metadata section
    - Add dark: classes to cancel button
    - Standardize description textarea dark mode classes
```

### UserModal (~350 lines)

```
UserModal
  Props:
    mode: 'create' | 'edit'
    isOpen: boolean
    onClose: () => void
    onSubmit: (data: UserFormData) => Promise<void>
    isSubmitting?: boolean
    error?: string | null
    roles?: CustomRole[]
    rolesLoading?: boolean
    user?: User | null                // Required when mode === 'edit'

  Internal State:
    email, name: string
    selectedRoles: string[]
    selectedProfiles: string[]
    fieldErrors: FieldErrors
    hasAttemptedSubmit: boolean

  Mode Differences:
    CREATE                            EDIT
    - Title: "Add System User"        - Title: "Edit User: {name}"
    - Intro section (amber box)       - No intro section
    - Roles label: "System Roles"     - Roles label: "Roles"
    - Roles description text          - No roles description
    - Empty form                      - Pre-filled from user (useEffect)
    - Reset to empty on close         - Reset to user data on close
    - Submit label: "Create User"     - Submit label: "Save Changes"
    - Loading: "Creating..."          - Loading: "Saving..."
    - Guard: none                     - Guard: if (!user) return null

  Dark Mode Fixes (during merge):
    - Add dark: classes to all labels (missing in both Create and Edit)
    - Add dark: classes to all input fields
    - Add dark: classes to error displays
    - Add dark: classes to checkbox label text
    - Add dark: classes to intro section
```

### TemplateModal (~480 lines)

```
TemplateModal
  Props:
    mode: 'create' | 'edit'
    isOpen: boolean
    onClose: () => void
    onSubmit: (template: Omit<Template, 'id' | 'createdAt'>, id?: string) => void
    onDelete?: (id: string, templateName: string) => void
    isSubmitting?: boolean
    error?: string | null
    roles?: CustomRole[]
    rolesLoading?: boolean
    template?: Template | null        // Required when mode === 'edit'

  Internal State:
    templateName: string
    selectedRoles: string[]
    status: 'Draft' | 'Published'
    steps: TemplateStep[]             // With optional id for edit
    validationErrors: string[]
    deleteDialogOpen: boolean         // Edit mode only
    isDeleting: boolean               // Edit mode only

  Local Type:
    interface TemplateStep {
      id?: number                     // Present for existing steps in edit
      title: string
      description: string
      owner: string
      expert: string
    }

  Mode Differences:
    CREATE                            EDIT
    - Title: "Create New Template"    - Title: "Edit Template: {name}"
    - Initial: 1 empty step           - Pre-filled from template (useEffect)
    - No delete button                - Delete button + DeleteConfirmDialog
    - Footer: Cancel | Save Template  - Footer: Delete | Cancel | Save Changes
    - No scroll on steps              - max-h-96 overflow-y-auto on steps
    - Validation: filter valid steps  - Validation: check steps.length
    - Step bg: dark:bg-slate-600      - Step bg: dark:bg-slate-800 (use 800)
    - Guard: none                     - Guard: if (!template) return null
    - onSubmit(template)              - onSubmit(template, template.id)
    - Wraps in ModalWrapper only      - Wraps in Fragment + ModalWrapper + DeleteConfirmDialog

  Step bg standardization:
    - Use dark:bg-slate-800 for step inputs (Edit version, more readable)
```

---

## Parent Component Changes

### RoleManagementPanel.tsx

Current state variables:
```ts
isCreateModalOpen, isEditModalOpen, selectedRoleForEdit,
isCreateSubmitting, isEditSubmitting, modalError
```

After unification -- can simplify but the parent handlers have different signatures (`handleCreateRoleSubmit(name, desc?)` vs `handleEditRoleSubmit(desc?)`). The simplest approach is to keep the two handlers and two modal render sites, just using `RoleModal` for both:

```tsx
<RoleModal
  mode="create"
  isOpen={isCreateModalOpen}
  onClose={...}
  onSubmit={handleCreateRoleSubmit}
  isSubmitting={isCreateSubmitting}
  error={modalError}
/>
{selectedRoleForEdit && (
  <RoleModal
    mode="edit"
    isOpen={isEditModalOpen}
    onClose={...}
    onSubmit={handleEditRoleSubmit}
    isSubmitting={isEditSubmitting}
    error={modalError}
    currentRole={selectedRoleForEdit}
  />
)}
```

The `handleEditRoleSubmit` needs to change from `(description?) => ...` to `(name, description?) => ...` since the unified modal always passes both args. The handler just ignores the name.

### UsersPanel.tsx

Similar pattern. Keep two render sites with `mode="create"` and `mode="edit"`. The `handleEditUser` signature changes from `Partial<UserFormData>` to `UserFormData` (the unified modal always sends full data).

### TemplatesView.tsx

Keep two render sites. The `handleCreateTemplate` and `handleEditTemplate` handlers need adjustment for the unified `onSubmit` signature: `(template, id?) => void`. When `id` is present, it is an edit. When absent, it is a create.

---

## Testing Strategy

### Unit Tests

| Test File | Tests (est.) | Covers |
|-----------|-------------|--------|
| `RoleModal.test.tsx` | ~45 | Create mode rendering, edit mode rendering, name validation, description validation, form submission, pre-fill, read-only name, metadata display, change detection, dark mode, error display |
| `UserModal.test.tsx` | ~20 | Create mode rendering, edit mode rendering, email/name/role validation, intro section presence/absence, pre-fill, submission, roles loading |
| `TemplateModal.test.tsx` | ~30 | Create mode rendering, edit mode rendering, template name, roles, status, steps CRUD, validation, delete flow, scroll behavior, pre-fill |

Total: ~95 tests across 3 files (merging from ~82 existing tests across 5 files + adding mode-specific coverage).

### Integration Tests

- Verify parent components correctly render unified modals in both modes
- Verify onSubmit handlers receive correct data shape
- Not adding new integration test files -- existing parent component usage is tested implicitly

### E2E Verification (Playwright)

After implementation:
1. Open Roles tab, create a role, verify success
2. Edit the role, verify pre-fill and save
3. Open Users tab, create a user, verify success
4. Edit the user, verify pre-fill and save
5. Open Templates page, create a template with steps, verify
6. Edit the template, verify pre-fill and save
7. Delete a template via edit modal
8. Verify all above in dark mode

---

## Implementation Notes

### Design Decisions

1. **Simple mode prop, not a factory.** Each unified modal is a single component with `if (mode === 'create')` branches. No generic modal builder, no higher-order components.

2. **Unified onSubmit signature per modal.** Each modal sends all form data regardless of mode. Parent handlers adapt. This keeps the modal API clean and the parent responsible for knowing what to do with the data.

3. **Keep two render sites in parents.** Rather than merging `isCreateModalOpen` and `isEditModalOpen` into a single `modalMode` state in parents, we keep the existing state pattern with two `<RoleModal>` renders. This minimizes parent refactoring and avoids bugs from shared state.

4. **Fix dark mode during merge.** EditRoleModal and both User modals are missing `dark:` classes in several places. Since we are rewriting the JSX, we apply dark mode classes consistently using CreateRoleModal and CreateTemplateModal as the canonical reference (they have the most complete dark mode).

5. **Step input background standardization.** CreateTemplateModal uses `dark:bg-slate-600` for step inputs; EditTemplateModal uses `dark:bg-slate-800`. We standardize on `dark:bg-slate-800` (better contrast, matches Edit version).

6. **TemplateStep type uses optional id.** `id?: number` handles both create (no id) and edit (preserved id) seamlessly.

### Patterns

- **Mode guard:** Edit mode components that require entity data (e.g., `user`, `template`) have an early `if (mode === 'edit' && !entity) return null` guard.
- **Pre-fill via useEffect:** Edit mode uses `useEffect` to populate form state when the entity prop changes and modal opens.
- **Reset on close:** Create mode resets to empty; edit mode resets to entity data.
- **Consistent field IDs:** Use `role-name`, `role-description`, `user-email`, `user-name`, `template-name`, etc. (no `edit-` prefix needed since there is only one component now).

### Trade-offs

| Decision | Pro | Con |
|----------|-----|-----|
| Single component per pair | ~50% less code, single source of truth | Slightly longer files with conditionals |
| Parent adapts to unified onSubmit | Clean modal API | Minor parent handler changes |
| Two render sites in parents | Minimal parent refactoring | Could be even simpler with single render |
| Fix dark mode during merge | Better UX, natural time to fix | Slightly more work per modal |

---

## Non-Goals

- **Do not create a generic modal factory.** This is a simple merge, not an abstraction layer.
- **Do not refactor CreateOnboardingModal.** It has no pair and its complexity is inherent.
- **Do not extract shared validation hooks.** That belongs in a future feature (e.g., `slim-services` or a dedicated validation utility).
- **Do not change the ModalWrapper component.** It works fine as-is.
- **Do not change database schema or services.** This is purely a UI refactor.
- **Do not add new features to the modals.** Only merge and fix dark mode bugs.
- **Do not consolidate parent state management.** Keep `isCreateModalOpen` / `isEditModalOpen` separate in parents to minimize risk.

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Breaking existing form behavior | High | Low | Keep exact same validation logic; run full test suite after each modal |
| onSubmit signature mismatch | Medium | Medium | Update parent handlers to match new unified signature; test both modes |
| Dark mode regression | Low | Low | Use CreateRoleModal/CreateTemplateModal as canonical reference |
| Test flakiness (EditRoleModal timeout issue) | Low | Medium | Known pre-existing issue with userEvent typing; keep test structure similar |
| Missing import updates | Medium | Low | Grep for all old component names after deletion |

---

## Estimated Line Savings

| Component | Before (src) | After (src) | Savings |
|-----------|-------------|-------------|---------|
| Role modals | 571 | ~200 | ~371 |
| User modals | 627 | ~350 | ~277 |
| Template modals | 880 | ~480 | ~400 |
| **Total Source** | **2,078** | **~1,030** | **~1,048** |
| Tests (estimated) | 2,235 | ~1,500 | ~735 |
| **Grand Total** | **4,313** | **~2,530** | **~1,783** |
