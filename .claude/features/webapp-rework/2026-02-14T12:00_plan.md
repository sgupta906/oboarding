# Plan: webapp-rework

## Metadata
- **Feature:** webapp-rework
- **Created:** 2026-02-14T12:00
- **Status:** plan-complete
- **Based On:** `.claude/features/webapp-rework/2026-02-14T12:00_research.md`
- **Planner:** plan-agent

---

## Architecture Overview

This rework modifies existing components across 4 independent phases. No new services, hooks, or routing changes are required. The changes are scoped to: (1) fixing data flow bugs in the role creation chain, (2) fixing the NavBar rendering logic in App.tsx, (3) adding dark mode Tailwind classes to ~15 components, (4) replacing indigo/violet brand colors with ShyftSolutions palette.

### Component Hierarchy (Affected Areas)

```
App.tsx (AuthProvider > DarkModeProvider > AppContent)
  |
  +-- NavBar.tsx .................... [MODIFY: brand colors, always render for auth users]
  +-- OnboardingHub.tsx ............ [MODIFY: employee empty state with NavBar]
  |     +-- ManagerView.tsx ........ [MODIFY: pass auth userId, dark mode, brand colors]
  |     |     +-- ManagerDashboardHeader.tsx .. [MODIFY: dark mode text, brand colors]
  |     |     +-- KPISection.tsx .............. [MODIFY: (uses KPICard)]
  |     |     |     +-- KPICard.tsx ........... [MODIFY: dark mode color maps]
  |     |     +-- SuggestionsSection.tsx ...... [MODIFY: dark mode text, brand colors]
  |     |     |     +-- SuggestionCard.tsx .... [inherits Card fix]
  |     |     +-- ActivitySection.tsx ......... [MODIFY: dark mode text, brand colors]
  |     |     |     +-- ActivityFeed.tsx ...... [MODIFY: dark mode bg, brand colors]
  |     |     +-- RoleManagementPanel.tsx ..... [MODIFY: userId prop, dark mode, brand]
  |     |     +-- UsersPanel.tsx .............. [MODIFY: userId prop]
  |     +-- EmployeeView.tsx ....... [MODIFY: brand colors]
  |
  +-- SignInView.tsx ............... [MODIFY: labels, brand colors]
  +-- SignOutView.tsx .............. [MODIFY: brand colors]
  +-- TemplatesView.tsx ............ [MODIFY: brand colors]
  |
  +-- UI Primitives:
        +-- Card.tsx ............... [MODIFY: add dark mode base classes]
        +-- ModalWrapper.tsx ....... [MODIFY: add dark mode base classes]
        +-- ProgressBar.tsx ........ [MODIFY: brand colors]
```

### Data Flow Fix (Role Creation UUID Bug)

```
BEFORE (broken):
  ManagerView: userId="system"
    -> RoleManagementPanel: userId="system" (default prop)
      -> useRoles("system")
        -> createCustomRole(name, desc, "system")
          -> roleService.createRole(name, desc, "system")
            -> INSERT INTO roles(created_by: "system") --> FAILS: not a UUID

AFTER (fixed):
  App.tsx: useAuth().user.uid  (real UUID or mock "test-test-manager")
    -> OnboardingHub: passes auth context
      -> ManagerView: inherits auth via useAuth() in child
        -> RoleManagementPanel: userId={user.uid}   (from useAuth)
          -> useRoles(userId)
            -> createCustomRole(name, desc, userId | null)
              -> roleService.createRole(name, desc, userId | null)
                -> INSERT INTO roles(created_by: userId) --> OK (UUID or null)
```

### View Initialization Fix

```
BEFORE:
  useState(getInitialView)  --> role is null at mount --> returns 'employee'
  role resolves to 'manager' --> currentView stays 'employee' (never updates)

AFTER:
  useState(getInitialView)  --> role is null at mount --> returns 'employee'
  useEffect([role]) fires   --> role = 'manager' --> setCurrentView('manager')
  ref tracks "hasSetInitial" --> prevents re-triggering on role changes
```

---

## Tech Stack Summary

No changes to the tech stack. All modifications use existing patterns:

| Layer | Technology | Changes |
|-------|-----------|---------|
| Framework | React 18 + TypeScript | No changes |
| Styling | Tailwind CSS 3 | Add dark: variants, update color palette in config |
| Backend | Supabase | Make `created_by` nullable in roleService |
| Testing | Vitest + RTL | Update test expectations for null createdBy |
| Build | Vite 7 | No changes |

---

## File Structure

### Files to Modify (25 files)

#### Phase 1: Core Bug Fixes (P1)

| File | Line(s) | Change |
|------|---------|--------|
| `src/views/ManagerView.tsx` | 191, 198 | Remove `userId="system"`, pass real auth user ID via useAuth |
| `src/components/manager/RoleManagementPanel.tsx` | 33, 38, 76 | Change default `userId` to accept `null`, use `useAuth()` internally |
| `src/components/manager/UsersPanel.tsx` | 24 | Accept userId from useAuth, remove "system" dependency |
| `src/hooks/useRoles.ts` | 44, 89 | Change default userId from 'system' to undefined, make optional |
| `src/services/roleClient.ts` | 180-209, 306 | Make `createdBy` parameter `string \| null`, remove 'system' validation |
| `src/services/supabase/roleService.ts` | 103-117 | Make `createdBy` parameter `string \| null`, pass null to DB |
| `src/App.tsx` | 23, 92-99 | Add useEffect for view init, always render NavBar for auth users |
| `src/components/OnboardingHub.tsx` | 212-217 | Replace bare "no onboarding" div with proper UI + sign-out |

#### Phase 2: Dark Mode (P2)

| File | Line(s) | Change |
|------|---------|--------|
| `src/components/ui/Card.tsx` | 26 | Add `dark:bg-slate-800 dark:border-slate-700` |
| `src/components/ui/ModalWrapper.tsx` | 72, 78-79, 99 | Add dark mode classes to modal container, header, footer |
| `src/components/manager/KPICard.tsx` | 11-27 | Add dark mode variants to colorBgMap, colorTextMap, colorIconBgMap |
| `src/components/manager/ActivityFeed.tsx` | 54, 73, 78, 81, 95, 99, 110, 126 | Add dark mode to header bg, item bg, text colors |
| `src/components/manager/SuggestionsSection.tsx` | 41, 44, 53, 57-61 | Add dark mode to heading text, empty state |
| `src/components/manager/ActivitySection.tsx` | 24 | Add dark mode to heading text |
| `src/components/manager/ManagerDashboardHeader.tsx` | 24 | Add dark mode to heading text |
| `src/components/manager/RoleManagementPanel.tsx` | 147-148, 193, 210-214, 245-268, 319, 321 | Add dark mode to all bg-white, text-slate-900 instances |
| `src/views/ManagerView.tsx` | 111, 152-154, 190, 197 | Add dark mode to tab bar, tab wrappers, success toast |
| `src/components/manager/SuggestionCard.tsx` | 59, 67, 72-74 | Add dark mode to pending indicator, text colors |

#### Phase 3: UX Polish (P3)

| File | Line(s) | Change |
|------|---------|--------|
| `src/views/SignInView.tsx` | 215-228, 241 | Fix "Emulator Mode" label to "Dev Mode", fix "Send Sign-In Link" button text |
| `src/components/OnboardingHub.tsx` | 212-217 | Improve employee empty state with helpful messaging (combined with P1 fix) |

#### Phase 4: Branding (P4)

| File | Change |
|------|--------|
| `tailwind.config.js` | Replace `brand` color palette with ShyftSolutions blue; update `gradient-brand` |
| `src/index.css` | Update `.gradient-header` from brand-600/violet-500 to new brand colors |
| `index.html` | Update `<title>` to "OnboardHub" (already correct, just verify) |
| `src/components/ui/NavBar.tsx` | Replace `bg-indigo-600` logo, `text-indigo-600` text with brand colors |
| `src/views/SignInView.tsx` | Replace indigo-600 references with brand colors |
| `src/views/SignOutView.tsx` | Replace indigo-600 references with brand colors |
| `src/views/ManagerView.tsx` | Replace indigo-600 tab highlights with brand colors |
| `src/components/manager/RoleManagementPanel.tsx` | Replace indigo-600 buttons/links with brand colors |
| `src/components/manager/ActivityFeed.tsx` | Replace indigo avatar gradient with brand colors |
| `src/components/manager/ActivitySection.tsx` | Replace indigo icon color with brand |
| `src/components/manager/SuggestionsSection.tsx` | Replace indigo icon color with brand |
| `src/components/manager/ManagerDashboardHeader.tsx` | Replace indigo-600 button with brand |
| `src/components/manager/UsersPanel.tsx` | Replace indigo-600 references with brand |
| `src/views/EmployeeView.tsx` | Replace indigo-600 references with brand |
| `src/components/onboarding/WelcomeHeader.tsx` | Replace indigo/violet gradient with brand |
| `src/components/onboarding/StepCard.tsx` | Replace indigo references with brand |
| `src/components/onboarding/ActionBar.tsx` | Replace indigo references with brand |
| `src/components/ui/ProgressBar.tsx` | Replace indigo references with brand |
| `src/components/modals/CreateRoleModal.tsx` | Replace indigo references with brand |
| `src/components/modals/EditRoleModal.tsx` | Replace indigo references with brand |
| `src/components/modals/CreateOnboardingModal.tsx` | Replace indigo references with brand |
| `src/components/modals/CreateUserModal.tsx` | Replace indigo references with brand |
| `src/components/modals/EditUserModal.tsx` | Replace indigo references with brand |
| `src/components/modals/ReportStuckModal.tsx` | Replace indigo references with brand |
| `src/components/modals/SuggestEditModal.tsx` | Replace indigo references with brand |
| `src/components/templates/CreateTemplateModal.tsx` | Replace indigo references with brand |
| `src/components/templates/EditTemplateModal.tsx` | Replace indigo references with brand |
| `src/views/TemplatesView.tsx` | Replace indigo references with brand |

### New Files

None. All changes modify existing files.

### Files NOT to Modify

- `src/config/supabase.ts` -- Proxy pattern must not change
- `src/services/supabase/mappers.ts` -- No changes needed
- `src/types/database.types.ts` -- No schema changes
- `src/types/index.ts` -- No type changes needed
- `src/test/setup.ts` -- No changes unless tests break
- `src/main.tsx` -- No changes
- `src/vite-env.d.ts` -- No changes

---

## Data Model Changes

### roleService.ts: Make `createdBy` Nullable

The `created_by` column in the `roles` table already supports NULL (it has `ON DELETE SET NULL` in the migration). The code change is:

```typescript
// BEFORE
export async function createRole(
  name: string,
  description: string | undefined,
  createdBy: string          // Required string
): Promise<CustomRole>

// AFTER
export async function createRole(
  name: string,
  description: string | undefined,
  createdBy: string | null   // Nullable
): Promise<CustomRole>
```

No database migration needed. The column already allows NULL.

---

## Component Architecture

### NavBar Rendering Logic (Revised)

```
App.tsx AppContent:
  if (loading) -> spinner
  if (sign-out route) -> SignOutView
  if (!authenticated) -> SignInView
  if (authenticated):
    ALWAYS render NavBar (with role-based features inside NavBar)
    Render route content (OnboardingHub, TemplatesView)
```

The NavBar component already handles role-based feature visibility internally (it shows "Employee View Only" badge for non-managers). The fix is in App.tsx where the NavBar rendering is gated behind `canAccessTemplates`.

### Employee Empty State (Revised)

```
OnboardingHub.tsx:
  if (!isManager && !employeeInstance):
    Render:
      - NavBar is already rendered by App.tsx (after fix)
      - Centered card with:
        - Icon (user silhouette)
        - "No onboarding assigned yet"
        - "Contact your manager to get started"
        - Sign-out button (backup, since NavBar also has one)
```

### Manager View Initialization (Revised)

```
App.tsx AppContent:
  const [currentView, setCurrentView] = useState(getInitialView);
  const hasSetInitialView = useRef(false);

  useEffect(() => {
    if (!hasSetInitialView.current && role !== null) {
      hasSetInitialView.current = true;
      if (role === 'manager' || role === 'admin') {
        setCurrentView('manager');
      }
    }
  }, [role]);
```

---

## Testing Strategy

### Unit Tests (Vitest + RTL)

The 650 existing tests must continue passing. Changes that could affect tests:

1. **roleClient.ts changes** -- `createCustomRole` signature changes (createdBy becomes `string | null`). Tests in `roleClient.test.ts` may need updated mock expectations.
2. **Card.tsx changes** -- Adding dark mode classes won't break RTL tests (they don't assert on specific CSS classes).
3. **App.tsx changes** -- The NavBar rendering change could affect `App.test.tsx` if it exists. Tests typically mock useAuth.
4. **Branding color changes** -- Tests don't assert on color classes, so these are safe.

**Estimated test impact:** 0-5 tests may need minor adjustments.

### Visual Verification (Playwright MCP)

After each phase, verify with Playwright MCP:

| Phase | Verification Steps |
|-------|-------------------|
| P1: Bug Fixes | Sign in as Manager, create a role, verify success. Sign in as Employee, verify NavBar visible with sign-out. Sign in as Manager, verify Manager View is default. |
| P2: Dark Mode | Toggle dark mode on each page: Dashboard, Roles, Users, Templates. Verify all cards/modals adapt. |
| P3: UX Polish | Verify "Dev Mode" label on sign-in. Verify employee empty state messaging. |
| P4: Branding | Verify blue (#1C7CD6) replaced indigo-600 everywhere. Check logo, buttons, tabs, gradients. |

### Build Verification

After all changes:
```bash
npx vitest run    # All 650 tests pass
npx tsc -b        # Zero TypeScript errors
npx vite build    # Production build succeeds
```

---

## Implementation Notes

### Key Decisions

1. **userId threading strategy:** Rather than threading userId through props from ManagerView to RoleManagementPanel, have RoleManagementPanel and UsersPanel call `useAuth()` directly. This is simpler, reduces prop drilling, and ensures the correct auth user is always used. The `userId` prop on these components can be removed entirely.

2. **NavBar for employees:** Always render NavBar in App.tsx for ALL authenticated users, not just managers. The NavBar component already handles role-based visibility internally (shows "Employee View Only" badge).

3. **Dark mode approach:** Fix Card.tsx and ModalWrapper.tsx as base components first, then add dark mode to individual components that use hardcoded light-only styles. This gives maximum coverage with minimum changes.

4. **Brand color strategy:** Replace the `brand` color palette in `tailwind.config.js` with ShyftSolutions blue (#1C7CD6) as the primary. Then do a find-and-replace of `indigo-600` with `brand-600` across all component files. Since many files already use `brand-` prefix (via the index.css utility classes), this reduces the total number of changes.

### Patterns Used

- **useAuth() hook** -- Access auth context for user ID (already exists in codebase)
- **Tailwind dark: prefix** -- Standard dark mode styling (already used in some components)
- **useRef for one-time effects** -- Prevent re-triggering of view initialization

### Trade-offs

1. **Removing userId prop vs keeping it:** Removing it simplifies the API but means tests that render RoleManagementPanel need to wrap it in AuthProvider. Since tests already mock the Supabase layer, this is acceptable.

2. **Global Card dark mode vs per-component:** Adding dark mode to Card.tsx base classes means ALL cards get dark mode. This is the right approach since no card should remain white in dark mode.

3. **Brand color granularity:** Using a single `brand` palette (ShyftSolutions blue) rather than separate `ss-primary-blue`, `ss-primary-green` etc. keeps the Tailwind config simpler. Green and orange are only used for status/semantic colors, not brand identity.

---

## Non-Goals (Explicitly NOT Doing)

- **Template step editor UX** -- Deferred to future iteration (drag-and-drop, bulk add)
- **Proper RLS policies** -- Keeping permissive `USING(true)` for now
- **Real E2E Playwright tests** -- Separate feature after rework
- **WebSocket/Realtime error handling** -- Lower priority
- **New npm dependencies** -- Zero additions
- **Service layer changes** -- Only roleService.ts parameter type change
- **Database migrations** -- Column already supports NULL
- **React Router** -- Keeping hash-based routing
- **Favicon change** -- User has not provided a custom favicon file

---

## Risk Mitigations

| Risk | Mitigation |
|------|-----------|
| roleClient test failures from nullable createdBy | Run tests after each file change; update mock expectations |
| Dark mode class additions break CSS specificity | Card.tsx uses template string concatenation, not `cn()` utility; ensure dark classes don't conflict with passed className |
| View initialization useEffect causes flicker | Use ref to track first-time initialization; only trigger once |
| Branding find-replace misses some files | Use grep to find ALL indigo-600 references before and after; verify count drops to zero |
| Brand color palette insufficient for all use cases | Generate full 50-950 shade scale from #1C7CD6 base for the brand palette |
