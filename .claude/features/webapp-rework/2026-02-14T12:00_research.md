# Research: webapp-rework

## Metadata
- **Feature:** webapp-rework
- **Created:** 2026-02-14T12:00
- **Status:** research-complete
- **Researcher:** research-agent

## Feature Context

The Firebase-to-Supabase migration is 100% complete (5 features, all committed to `origin/main`). However, the webapp has critical bugs that prevent basic usage, broken dark mode on several pages, poor UX on first-run, leftover Firebase-era labels, and needs rebranding from "OnboardHub" to ShyftSolutions.io. This rework fixes all bugs, applies consistent dark mode, improves the first-run experience, and rebrands the application.

### Dependencies
- All migration features are complete and merged.
- Supabase instance is live at `https://ecnshfhpgwjxvuybewth.supabase.co` (us-west-2).
- 650 unit tests exist but mock everything -- they will NOT catch real bugs.

---

## Requirements

### Functional Requirements

#### Critical Bugs (App broken, core flows blocked)
- [ ] FR1: Fix role creation UUID error -- the string `"system"` is passed as `created_by` but the column is `UUID REFERENCES users(id)`. (Source: BUG-1)
- [ ] FR2: Fix employee view missing navbar -- employee users see a blank page with no sign-out button and are trapped. (Source: BUG-2)
- [ ] FR3: Unblock circular dependency -- roles must be creatable so templates, users, and new hires can be created. (Source: BUG-3)

#### UX Bugs (App works but experience is bad)
- [ ] FR4: Manager should land on "Manager View" by default after login, not "Employee View". (Source: UX-1)
- [ ] FR5: Employee empty state needs navbar, sign-out button, and helpful messaging. (Source: UX-2)
- [ ] FR6: Manager dashboard first-run should show a "Getting Started" guide (Roles -> Templates -> New Hires). (Source: UX-3)
- [ ] FR7: New Hire modal should show a clear "set up prerequisites first" message when roles/templates are missing, not a half-usable form. (Source: UX-4)
- [ ] FR8: Sign-in page "Emulator Mode" label should be updated (Firebase leftover). (Source: UX-5)

#### Visual / Dark Mode Bugs
- [ ] FR9: Fix dashboard KPI cards, Documentation Feedback card, and Live Activity card to respect dark mode. (Source: DARK-1)
- [ ] FR10: Fix Users page cards/banners to respect dark mode. (Source: DARK-2)
- [ ] FR11: Fix Manager View tab bar border to respect dark mode. (Source: DARK-3)
- [ ] FR12: Fix `Card` component to include `dark:bg-slate-800 dark:border-slate-700` by default. (Source: DARK-1/2/3)
- [ ] FR13: Fix ManagerView roles tab and users tab wrappers (hardcoded `bg-white`). (Source: DARK-3)

#### Branding
- [ ] FR14: Rebrand from "OnboardHub" to ShyftSolutions.io brand identity (name, logo, colors).
- [ ] FR15: Update `<title>` in `index.html`.
- [ ] FR16: Update favicon to match ShyftSolutions brand.
- [ ] FR17: Update tailwind.config.js brand colors to match ShyftSolutions palette (green, blue, orange).

#### Minor Issues
- [ ] FR18: Fix or gracefully handle 400 error on `GET /roles` (RLS issue with anon key). (Source: MINOR-1)
- [ ] FR19: Gracefully handle WebSocket/Realtime connection warnings. (Source: MINOR-2)
- [ ] FR20: "Send Sign-In Link" button label should clarify it does not actually send emails. (Source: MINOR-3)

### Technical Requirements
- [ ] TR1: All 650 existing tests must continue to pass (`npx vitest run`).
- [ ] TR2: Zero TypeScript errors (`npx tsc -b`).
- [ ] TR3: Preserve the service layer architecture (8 modular Supabase services).
- [ ] TR4: Preserve the lazy-init Supabase client (Proxy pattern).
- [ ] TR5: Preserve the hash-based routing pattern.

### Constraints
- No external routing library (hash-based routing only).
- No new npm dependencies unless absolutely necessary.
- Supabase migrations must be compatible with the existing 7 applied migrations.
- Dark mode uses Tailwind `class` strategy (set on `<html>` element).

---

## Existing Code Analysis

### Root Cause Analysis: Each Bug

#### BUG-1: Role Creation UUID Error (CRITICAL)

**Chain of calls:**
1. `ManagerView.tsx` line 191: `<RoleManagementPanel userId="system" />`
2. `RoleManagementPanel.tsx` line 33: `userId = 'system'` (default prop)
3. `RoleManagementPanel.tsx` line 76: `const newRole = await createRole(name, description, userId);`
4. `useRoles.ts` line 89: `createdBy: string = userId` (defaults to `'system'`)
5. `roleClient.ts` line 209: `return dbCreateRole(name.trim(), description, createdBy);`
6. `roleService.ts` line 117: `created_by: createdBy` -- inserts `"system"` into a UUID column
7. Database: `roles.created_by UUID REFERENCES users(id)` -- rejects `"system"`

**Root cause:** The string `"system"` is hardcoded as `userId` in `ManagerView.tsx` line 191 and as a default in `RoleManagementPanel` (line 33), `useRoles` (line 44), and `seedDefaultRoles` (line 306 of roleClient.ts). The `roles.created_by` column requires a valid UUID.

**Fix strategy:**
- Get the actual authenticated user's UID from `useAuth()` and pass it through the component chain.
- For `seedDefaultRoles`, allow `created_by` to be `null` (the column already has `ON DELETE SET NULL`).
- In `roleService.ts`, make `createdBy` optional and pass `null` when no real user ID is available.

**Files to modify:**
- `/workspaces/onboarding/src/views/ManagerView.tsx` (lines 191, 197)
- `/workspaces/onboarding/src/components/manager/RoleManagementPanel.tsx` (line 33, 38, 76)
- `/workspaces/onboarding/src/components/manager/UsersPanel.tsx` (line 24)
- `/workspaces/onboarding/src/hooks/useRoles.ts` (line 44, 89)
- `/workspaces/onboarding/src/services/roleClient.ts` (line 306)
- `/workspaces/onboarding/src/services/supabase/roleService.ts` (line 103-117)

---

#### BUG-2: Employee View Missing Navbar (CRITICAL)

**Chain of calls:**
1. `App.tsx` lines 92-99: When `!canAccessTemplates` (i.e., employee role), the NavBar is NOT rendered.
2. `OnboardingHub.tsx` lines 212-218: When `!isManager && !employeeInstance`, returns a bare `<div>` with text, no NavBar.

**Root cause (two separate issues):**

**Issue A:** `App.tsx` line 94: `{canAccessTemplates && ( <NavBar ... /> )}` -- Only managers/admins get the NavBar. Employees get none.

**Issue B:** `OnboardingHub.tsx` lines 212-217: The "no onboarding assigned" early return renders a completely bare page with no header, no sign-out, no navigation.

**Fix strategy:**
- For employees without onboarding: render the `EmployeeHeader` component (already exists in `EmployeeView.tsx` lines 26-65) with sign-out button AND a friendly empty state message.
- Alternatively, always render the NavBar for all authenticated users (with different feature access based on role) -- this would be the more robust fix.
- The `OnboardingHub.tsx` "no onboarding" early return must include navigation chrome.

**Files to modify:**
- `/workspaces/onboarding/src/App.tsx` (lines 92-99)
- `/workspaces/onboarding/src/components/OnboardingHub.tsx` (lines 212-218)

---

#### UX-1: Manager Lands on Employee View (UX BUG)

**Root cause:** `App.tsx` lines 19-23:
```tsx
const getInitialView = (): 'employee' | 'manager' => {
  return role === 'manager' || role === 'admin' ? 'manager' : 'employee';
};
const [currentView, setCurrentView] = useState<'employee' | 'manager'>(getInitialView);
```

`useState` initializer runs ONCE on mount. At mount time, `role` is still `null` (loading from auth), so `getInitialView()` returns `'employee'`. By the time `role` becomes `'manager'`, `currentView` is already `'employee'` and never updates.

**Fix strategy:** Add a `useEffect` that updates `currentView` when `role` changes from `null` to a real value:
```tsx
useEffect(() => {
  if (role === 'manager' || role === 'admin') {
    setCurrentView('manager');
  }
}, [role]);
```
This should only run on first role resolution, not on every render. Use a ref to track if it has already set the initial view.

**Files to modify:**
- `/workspaces/onboarding/src/App.tsx` (add useEffect after line 23)

---

#### DARK-1/2/3: Dark Mode Broken on Multiple Pages

**Root cause: `Card` component (`src/components/ui/Card.tsx`):**
Line 26: `className={`bg-white rounded-xl border border-slate-200 shadow-sm ${className}`}`

The Card component hardcodes `bg-white` and `border-slate-200` with NO dark mode variants. Every component that uses `<Card>` inherits this problem. The `index.css` file actually defines a `.card` utility class (line 72-73) with `dark:bg-slate-800 dark:border-slate-700`, but the `Card` React component does NOT use this CSS class.

**Additionally, hardcoded `bg-white` in these files:**

1. **`ManagerView.tsx`** lines 190, 196: Roles and Users tab wrappers:
   ```tsx
   <div className="bg-white rounded-lg border border-slate-200 p-6">
   ```

2. **`KPICard.tsx`** lines 12-15: `colorBgMap` uses `bg-emerald-50`, `bg-rose-50`, `bg-amber-50` with NO dark variants.

3. **`ActivityFeed.tsx`** lines 73, 95-99: Collapsable header uses `bg-slate-50`, items use `hover:bg-slate-50` -- no dark variants.

4. **`SuggestionCard.tsx`** line 51: Uses `Card` (inherits white bg).

5. **`SuggestionsSection.tsx`** line 41: Section title uses `text-slate-900` -- no dark variant.

6. **`ActivitySection.tsx`** line 24: Title uses `text-slate-900` -- no dark variant.

7. **`ManagerDashboardHeader.tsx`** line 24: Title uses `text-slate-900` -- no dark variant.

8. **`RoleManagementPanel.tsx`** - Multiple hardcoded `bg-white`, `text-slate-900` without dark variants (lines 147, 148, 213, 247, 252, 267, 272, 275, 319, 321).

9. **`ManagerView.tsx`** line 111: Tab bar uses `border-slate-200` -- no dark variant.

**Fix strategy:**
- Fix `Card.tsx` to include `dark:bg-slate-800 dark:border-slate-700` in base classes.
- Fix `KPICard.tsx` colorBgMap to include dark mode variants.
- Fix `ManagerView.tsx` tab wrappers with dark classes.
- Fix `ActivityFeed.tsx` header and item backgrounds.
- Fix all `text-slate-900` headings to include `dark:text-white` or `dark:text-slate-50`.
- Fix `RoleManagementPanel.tsx` hardcoded white backgrounds and text colors.
- Fix `ModalWrapper.tsx` line 72: `bg-white` -- add dark variant for modal backgrounds.

**Files to modify:**
- `/workspaces/onboarding/src/components/ui/Card.tsx` (line 26)
- `/workspaces/onboarding/src/components/manager/KPICard.tsx` (lines 11-27)
- `/workspaces/onboarding/src/components/manager/ActivityFeed.tsx` (lines 73, 78, 81, 95-99, 110)
- `/workspaces/onboarding/src/components/manager/SuggestionsSection.tsx` (line 41, 44)
- `/workspaces/onboarding/src/components/manager/ActivitySection.tsx` (line 24)
- `/workspaces/onboarding/src/components/manager/ManagerDashboardHeader.tsx` (line 24)
- `/workspaces/onboarding/src/components/manager/RoleManagementPanel.tsx` (many lines)
- `/workspaces/onboarding/src/views/ManagerView.tsx` (lines 111, 190, 196)
- `/workspaces/onboarding/src/components/ui/ModalWrapper.tsx` (line 72)

---

#### MINOR-1: RLS 400 Error on Roles Fetch

**Root cause:** The RLS policies in `00005_enable_rls.sql` use `FOR ALL USING (true) WITH CHECK (true)` which should allow all operations. However, when the Supabase client uses the **anonymous key** and no user is authenticated via Supabase Auth (the app falls back to localStorage mock auth), the anonymous role may still be blocked by default Supabase settings.

The RLS policies look correct (permit all), so this is likely a Supabase project setting issue where the anonymous key doesn't have the proper role grants. This is NOT a code bug -- it requires a Supabase dashboard check or SQL grant.

**Fix strategy:**
- Verify Supabase dashboard settings: ensure `anon` role has `SELECT` on all tables.
- OR: add explicit `GRANT SELECT ON ALL TABLES IN SCHEMA public TO anon;` in a new migration.
- The code should also handle 400 errors gracefully rather than showing console errors.

**Files to modify:**
- New migration SQL file OR Supabase dashboard configuration.
- Error handling in service files to gracefully handle RLS errors.

---

#### UX-5: "Emulator Mode" Label

**Root cause:** `SignInView.tsx` line 241:
```tsx
Quick Login (Emulator Mode):
```
This is a leftover from the Firebase era.

**Fix:** Change to "Quick Login (Dev Mode):" or similar.

**File:** `/workspaces/onboarding/src/views/SignInView.tsx` (line 241)

---

#### UX-6: Template Step Editor UX

The `CreateTemplateModal.tsx` adds steps one at a time with "Add Step" button. No bulk add, no reorder, no drag-and-drop. This is a known UX limitation but lower priority than critical bugs.

**Deferred:** This can be addressed in a later iteration.

---

### Branding Analysis: ShyftSolutions.io

**Current branding:**
- App name: "OnboardHub" (displayed as "Onboard" + "Hub" in indigo)
- Logo: ChevronRight icon in indigo-600 background
- Primary color: indigo-600 (`#4f46e5`) -- used everywhere for CTAs, accents, branding
- Gradient: indigo-600 to violet-500
- Title: `<title>OnboardingHub</title>` in `index.html`
- Favicon: default Vite SVG (`/vite.svg`)

**ShyftSolutions brand colors (extracted from shyftsolutions.io CSS):**
- `ss-primary-blue`: `#1C7CD6` / rgb(28, 124, 214) -- main CTA, nav, links
- `ss-primary-green`: `#37B24D` / rgb(55, 178, 77) -- success, blog cards
- `ss-primary-orange`: `#F76707` / rgb(247, 103, 7) -- accents, borders
- `ss-accent-blue`: `#329AF0` / rgb(50, 154, 240) -- hover states
- `ss-dark-gray`: `#212529` / rgb(33, 37, 41) -- body text
- `ss-white`: `#F8F9FA` / rgb(248, 249, 250) -- backgrounds
- `ss-off-white`: `#E9ECEF` / rgb(233, 236, 239) -- borders, subtle bg
- `ss-light-gray`: `#E5E6E8` / rgb(229, 230, 232) -- dividers

**Files containing "OnboardHub" branding that need updating:**
1. `/workspaces/onboarding/index.html` -- `<title>OnboardingHub</title>` (line 6)
2. `/workspaces/onboarding/src/components/ui/NavBar.tsx` -- Logo text "OnboardHub" (lines 49-51)
3. `/workspaces/onboarding/src/views/SignInView.tsx` -- Logo text "OnboardHub" (lines 143-145)
4. `/workspaces/onboarding/src/views/SignOutView.tsx` -- Logo text "OnboardHub" (lines 57-59)
5. `/workspaces/onboarding/tailwind.config.js` -- brand color definitions (lines 16-28)
6. `/workspaces/onboarding/src/index.css` -- gradient definitions (line 99)

**RESOLVED:** Exact hex values extracted from shyftsolutions.io CSS (see above). App name stays "OnboardHub".

---

## Constraints

### Performance
- No specific performance targets. Standard SPA.

### Platform
- React 18 + TypeScript + Vite 7 + Tailwind CSS 3
- Supabase backend (Postgres, Auth, Realtime)
- Hash-based routing (no React Router)

### Testing
- 650 existing tests must pass (Vitest + RTL + jsdom)
- Tests mock the entire Supabase layer -- they will NOT catch real Supabase bugs
- Tests will catch React component rendering regressions

### Dependencies
- No new npm packages should be added unless strictly necessary
- Existing: @supabase/supabase-js, lucide-react, tailwindcss, vitest, etc.

---

## Risk Assessment

### Technical Risks

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| UUID fix breaks role creation tests | Medium | High | Tests mock Supabase -- update test expectations for null/UUID createdBy |
| Dark mode changes break existing test snapshots | Low | Medium | Tests use RTL (no visual snapshots) -- class changes won't break tests |
| Branding color changes affect test assertions | Low | Low | Tests don't assert on specific colors |
| RLS grant migration conflicts with existing 7 migrations | Medium | Low | Use migration number 00008 to avoid conflicts |
| `useEffect` for view initialization causes flickering | Low | Medium | Use a ref to track initialization; only run once |
| Employee NavBar changes break employee view layout | Medium | Medium | Test employee flow manually with Playwright after changes |

### Complexity Assessment
- **Level:** Medium
- **Rationale:**
  - The UUID bug fix requires threading auth user ID through multiple component layers (5+ files).
  - Dark mode requires touching 10+ component files but each change is mechanical (add `dark:` variants).
  - The view initialization bug is a one-line useEffect fix but must be tested carefully.
  - Branding changes are find-and-replace across a handful of files.
  - RLS fix may require Supabase dashboard access or a new migration.

---

## Open Questions

- [x] Q1: What are the exact hex values for ShyftSolutions brand colors (green, blue, orange)?
  - **RESOLVED:** Extracted from shyftsolutions.io CSS: blue=#1C7CD6, green=#37B24D, orange=#F76707, accent-blue=#329AF0
  - Status: RESOLVED

- [x] Q2: Should the app name change from "OnboardHub" to something else?
  - **RESOLVED:** User said keep it as "OnboardHub". Rebrand colors/theme to ShyftSolutions palette only.
  - Status: RESOLVED

- [x] Q3: Should RLS policies be tightened (role-based) or kept permissive?
  - Recommendation: Keep permissive for now (`USING (true)`) since the app uses mock auth. The 400 error is likely an anon role grant issue, not an RLS policy issue. Fix with a GRANT statement.
  - Status: RESOLVED (keep permissive, add GRANT)

- [x] Q4: Is the template step editor UX improvement (drag-and-drop, bulk add) in scope?
  - Recommendation: Defer to a future iteration. Focus on critical bugs and dark mode first.
  - Status: RESOLVED (deferred)

- [x] Q5: Should modals also get dark mode styling?
  - Recommendation: Yes, for consistency. `ModalWrapper.tsx` has hardcoded `bg-white` on the modal container. Add `dark:bg-slate-800 dark:border-slate-700` and fix the header/footer sections.
  - Status: RESOLVED (include in dark mode fixes)

---

## Recommended Approach

### Implementation Strategy

Split the work into 4 phases, each independently testable:

**Phase 1: Unblock Core Flow** (CRITICAL -- do first)
1. Fix UUID bug: Thread real user UID from `useAuth()` through ManagerView -> RoleManagementPanel -> useRoles -> roleClient -> roleService. Allow `null` for `created_by`.
2. Fix employee view: Always render a NavBar for authenticated users (employees get a simplified version with sign-out).
3. Fix manager default view: Add `useEffect` in App.tsx to set `currentView` to `'manager'` when role resolves.

**Phase 2: Dark Mode Consistency**
1. Fix `Card.tsx` to include dark mode base classes.
2. Fix `KPICard.tsx` color maps with dark variants.
3. Fix `ManagerView.tsx` tab wrappers, tab bar border.
4. Fix `ActivityFeed.tsx` backgrounds and text colors.
5. Fix `SuggestionsSection.tsx`, `ActivitySection.tsx`, `ManagerDashboardHeader.tsx` text colors.
6. Fix `RoleManagementPanel.tsx` all hardcoded white/light backgrounds.
7. Fix `ModalWrapper.tsx` modal background.

**Phase 3: UX Improvements**
1. Improve employee empty state with helpful messaging.
2. Add "Getting Started" guide to manager dashboard first-run.
3. Improve New Hire modal when prerequisites missing.
4. Fix "Emulator Mode" label on sign-in page.
5. Fix "Send Sign-In Link" button label.

**Phase 4: Branding** (colors resolved)
1. Update tailwind.config.js: replace indigo-600 palette with ShyftSolutions palette (blue=#1C7CD6, green=#37B24D, orange=#F76707).
2. Update all indigo-600/violet-500 references in components to use new brand colors.
3. Update gradient definitions in index.css to match ShyftSolutions palette.
4. Keep app name "OnboardHub" but use ShyftSolutions color scheme.

### Order of Work
1. Phase 1 first (unblocks all usage)
2. Phase 2 second (visual consistency)
3. Phase 3 third (UX polish)
4. Phase 4 last (needs user input on colors/name)

### What to Defer
- Template step editor UX improvements (drag-and-drop, bulk add) -- do in a future feature
- Proper RLS policies with role-based access -- do when moving to production auth
- Real E2E Playwright tests -- do as a separate feature after the rework
- WebSocket/Realtime error handling -- lower priority, handle gracefully with try/catch

---

## File Change Summary

### Files to Modify (estimated ~25 files)

| File | Change Type | Priority |
|------|-------------|----------|
| `src/views/ManagerView.tsx` | UUID fix + dark mode | P1 |
| `src/components/manager/RoleManagementPanel.tsx` | UUID fix + dark mode | P1 |
| `src/components/manager/UsersPanel.tsx` | UUID fix | P1 |
| `src/hooks/useRoles.ts` | UUID fix | P1 |
| `src/services/roleClient.ts` | UUID fix (null createdBy) | P1 |
| `src/services/supabase/roleService.ts` | UUID fix (optional createdBy) | P1 |
| `src/App.tsx` | View init fix + employee NavBar | P1 |
| `src/components/OnboardingHub.tsx` | Employee empty state | P1 |
| `src/components/ui/Card.tsx` | Dark mode base classes | P2 |
| `src/components/ui/ModalWrapper.tsx` | Dark mode | P2 |
| `src/components/manager/KPICard.tsx` | Dark mode color maps | P2 |
| `src/components/manager/KPISection.tsx` | Dark mode text | P2 |
| `src/components/manager/ActivityFeed.tsx` | Dark mode | P2 |
| `src/components/manager/SuggestionsSection.tsx` | Dark mode text | P2 |
| `src/components/manager/SuggestionCard.tsx` | Dark mode (inherits Card fix) | P2 |
| `src/components/manager/ActivitySection.tsx` | Dark mode text | P2 |
| `src/components/manager/ManagerDashboardHeader.tsx` | Dark mode text | P2 |
| `src/views/SignInView.tsx` | Emulator label + branding | P3 |
| `src/components/modals/CreateOnboardingModal.tsx` | Prerequisites UX | P3 |
| `src/components/ui/NavBar.tsx` | Branding | P4 |
| `src/views/SignOutView.tsx` | Branding | P4 |
| `index.html` | Title + favicon | P4 |
| `tailwind.config.js` | Brand colors | P4 |
| `src/index.css` | Gradient definitions | P4 |

### Files NOT to Modify
- Test files (*.test.ts, *.test.tsx) -- only if tests break due to code changes
- `src/config/supabase.ts` -- Proxy pattern must not change
- `src/services/supabase/mappers.ts` -- No changes needed
- `src/types/database.types.ts` -- No schema changes needed for bug fixes

---

## Next Step

**All open questions resolved.** ShyftSolutions brand colors extracted from their website. App name stays "OnboardHub".

All 4 phases are ready to proceed.

Run `/plan webapp-rework` to create the implementation plan.
