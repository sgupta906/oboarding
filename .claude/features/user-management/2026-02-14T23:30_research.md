# Research: user-management

## Metadata
- **Feature:** user-management
- **Created:** 2026-02-14T23:30
- **Status:** research-complete
- **Researcher:** research-agent

## Feature Context

The user wants two capabilities added to the OnboardingHub manager dashboard:

1. **See a list of all users that are onboarding** -- a consolidated view showing which employees currently have active onboarding instances, their progress, status, and related metadata.
2. **Delete onboarding users** -- the ability to remove users (and their associated onboarding data) from the system.

### Where it fits in the project

The manager dashboard already has a three-tab layout: **Dashboard**, **Roles**, and **Users**. The Users tab (`UsersPanel`) already exists and provides full CRUD (create, read, edit, delete) for system users. However, it does NOT show onboarding status, progress, or instance data alongside each user. Additionally, when deleting a user who is currently onboarding, there is no handling for their associated `onboarding_instances` records.

### Dependencies on other features

No upstream feature dependencies. The data layer (`userService.ts`, `instanceService.ts`), hooks (`useUsers.ts`, `useOnboardingInstances.ts`), and UI components (`UsersPanel.tsx`, `UserModal.tsx`, `DeleteConfirmationDialog.tsx`) all already exist.

---

## Requirements

### Functional Requirements
- [ ] FR1: Display a list of all onboarding users in the manager's Users tab, showing: name, email, role, onboarding status (active/completed/on_hold), progress percentage, and start date (source: user request)
- [ ] FR2: Allow managers to filter/distinguish between users who are actively onboarding vs. all system users (source: user request -- "users that are onboarding")
- [ ] FR3: Allow managers to delete a user, which should also clean up their onboarding instance(s), associated instance steps, suggestions, and auth credentials (source: user request)
- [ ] FR4: Show a confirmation dialog before deleting a user that warns about the consequences (losing onboarding data) (source: established pattern in RoleManagementPanel and existing UsersPanel)
- [ ] FR5: Log deletion activity to the activity feed (source: established pattern in UsersPanel)

### Technical Requirements
- [ ] TR1: Join user data with onboarding instance data to show onboarding status/progress in the user list
- [ ] TR2: Delete operation must handle cascading cleanup: user row -> CASCADE deletes user_roles, user_profiles; separately delete associated onboarding_instances (which CASCADE deletes instance_steps)
- [ ] TR3: Delete operation must also clean up suggestions linked to the user's onboarding instances
- [ ] TR4: Delete operation must remove auth credentials from localStorage (already handled by existing `deleteUser`)
- [ ] TR5: Use optimistic updates for delete operations (follow existing pattern in `useUsers.ts`)
- [ ] TR6: Use existing `DeleteConfirmationDialog` component for delete confirmation (already wired up in UsersPanel)

### Code Examples / References

**Existing delete flow (already works for user row + junction tables):**
```typescript
// src/services/supabase/userService.ts lines 384-401
export async function deleteUser(userId: string): Promise<void> {
  const user = await getUser(userId);
  if (!user) return;
  const { error } = await supabase.from('users').delete().eq('id', userId);
  if (error) throw new Error(`Failed to delete user ${userId}: ${error.message}`);
  removeUserFromAuthCredentials(user.email);
}
```

**Existing UsersPanel already has delete with confirmation:**
```typescript
// src/components/manager/UsersPanel.tsx lines 132-171
// handleDeleteUser -> sets userToDelete -> DeleteConfirmationDialog -> handleConfirmDeleteUser -> removeUser
```

### Warnings/Critical Notes

> **CASCADE behavior:** Deleting a `users` row automatically cascades to `user_roles` and `user_profiles` junction tables (via ON DELETE CASCADE). However, `onboarding_instances` does NOT have a foreign key to `users` -- it only stores `employee_email` as a TEXT field. This means deleting a user does NOT automatically delete their onboarding instances. The delete flow must explicitly handle this.

> **`created_by` references:** The `users.created_by` column is a self-referencing FK with `ON DELETE SET NULL`. Other tables (`roles`, `profiles`, `profile_templates`, `activities`) also have `created_by UUID REFERENCES users(id) ON DELETE SET NULL`. This means deleting a user will set those `created_by` fields to NULL but will NOT cascade-delete those records. This is safe behavior.

---

## Existing Code Analysis

### Project State
- Project exists: YES
- All relevant files for this feature already exist

### Code to Reuse (already fully functional)

| File | What can be reused |
|------|-------------------|
| `src/services/supabase/userService.ts` | `deleteUser()` already deletes user + junction tables + auth credentials. `listUsers`, `getUser`, `subscribeToUsers` all work. |
| `src/services/supabase/instanceService.ts` | `listOnboardingInstances()` to fetch all instances; no `deleteOnboardingInstance()` exists yet (see "Code to Modify"). |
| `src/hooks/useUsers.ts` | `removeUser()` already calls `deleteUser()` with optimistic update (removes from local state). |
| `src/hooks/useOnboardingInstances.ts` | Provides `instances` list via subscription. |
| `src/components/manager/UsersPanel.tsx` | Already has full user list with edit/delete buttons and `DeleteConfirmationDialog`. Already separates employees from admins/managers. |
| `src/components/modals/UserModal.tsx` | Create/edit modal with validation -- fully functional. |
| `src/components/ui/DeleteConfirmationDialog.tsx` | Reusable confirmation dialog -- already used in UsersPanel. |
| `src/types/index.ts` | `User`, `UserFormData`, `OnboardingInstance` types -- all defined. |

### Code to Modify

| File | What needs changing |
|------|-------------------|
| `src/components/manager/UsersPanel.tsx` | **Primary changes:** (1) Add onboarding instance data to user list -- show status, progress, start date for each user who is onboarding. (2) Enhance the delete flow to also delete associated onboarding instances before deleting the user. (3) Add filtering capability to show only onboarding users. |
| `src/services/supabase/userService.ts` | **Enhance `deleteUser()`**: Before deleting the user row, query `onboarding_instances` by `employee_email` and delete those instances (which cascades to `instance_steps`). Also delete any `suggestions` linked to those instances. |
| `src/hooks/useUsers.ts` | Possibly enhance to accept onboarding instances or merge data. Alternatively, the component can combine data from `useUsers` + `useOnboardingInstances` directly. |

### New Code Needed

| What | Description |
|------|-------------|
| `deleteOnboardingInstance()` in instanceService.ts | A function to delete an onboarding instance by ID. The CRUD factory's `remove` is not currently exported for instances. |
| Enhanced delete confirmation message | The delete confirmation should warn that onboarding data will also be deleted. |

### Patterns to Follow

1. **Tab pattern**: The manager view uses a tab bar with `activeTab` state (`'dashboard' | 'roles' | 'users'`). The Users tab renders `<UsersPanel />` inside a card wrapper. No changes needed to the tab structure.

2. **Table pattern**: `UsersPanel` already uses a `renderUserTable()` function that renders `<table>` elements with headers and rows. Add columns for onboarding data.

3. **Delete pattern**: Both `RoleManagementPanel` and `UsersPanel` use `DeleteConfirmationDialog` with a state variable (`userToDelete` / `deleteConfirmation`) to track what's being deleted. Follow the same pattern.

4. **Hook pattern**: Hooks use `useState` + `useEffect` with subscription setup. The `useUsers` hook already follows this. The `useOnboardingInstances` hook also exists and can be composed.

5. **Service pattern**: Services use the CRUD factory for `list`/`get`/`remove`/`subscribe` and have hand-written custom operations for `create`/`update`.

6. **Activity logging**: All CRUD operations in UsersPanel already log to the activity feed via `logActivity()`. Follow the same pattern.

---

## Constraints

### Performance
- `listUsers` and `listOnboardingInstances` both have a default limit of 200 rows from the CRUD factory. This is sufficient for the expected user base.
- Joining user data with instance data is done client-side (in the component). No server-side join is needed since both datasets are already loaded via subscriptions.

### Platform
- No new environment variables or platform configuration needed.
- RLS policies are currently permissive ("allow all") -- no restrictions on delete operations.

### Dependencies
- No new npm packages needed.
- All required UI components (DeleteConfirmationDialog, ModalWrapper, etc.) already exist.

### Database Foreign Key Cascade Map

When deleting a user (by `users.id`):

```
users (DELETE)
  -> user_roles (CASCADE DELETE via user_id FK)
  -> user_profiles (CASCADE DELETE via user_id FK)
  -> roles.created_by (SET NULL)
  -> profiles.created_by (SET NULL)
  -> profile_templates.created_by (SET NULL)
  -> activities.user_id (SET NULL)
  -> users.created_by (SET NULL - self-ref)
```

Separately, must handle (NO automatic cascade from user deletion):

```
onboarding_instances (manually query by employee_email, then DELETE)
  -> instance_steps (CASCADE DELETE via instance_id FK)
  -> suggestions.instance_id (SET NULL via instance_id FK)
  -> instance_profiles (CASCADE DELETE via instance_id FK)
  -> instance_template_refs (CASCADE DELETE via instance_id FK)
```

---

## Risk Assessment

### Technical Risks

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Deleting a user's onboarding instances orphans suggestions | Low | Medium | Query and delete suggestions by instance_id before deleting instances, or accept that suggestions.instance_id will be SET NULL (current FK behavior). SET NULL is acceptable since the suggestion text remains visible. |
| User has multiple onboarding instances | Low | Low | Query ALL instances by employee_email, not just the first. The delete function should handle this case. |
| Race condition: user deleted while onboarding instance subscription is active | Low | Low | Optimistic update removes user from UI immediately; subscription will eventually sync. Realtime subscription will fire and update the instance list. |
| Deleting the currently-signed-in user | Medium | Low | Check if the user being deleted is the current user and prevent self-deletion, or at minimum warn about it. |

### Complexity
- **Level:** Simple to Medium
- **Rationale:** The vast majority of the infrastructure already exists. The UsersPanel already has full CRUD with delete confirmation. The main work is: (1) enriching the user list with onboarding instance data (a client-side join), (2) enhancing the delete function to also clean up onboarding instances, and (3) adding a filter toggle. No new components or hooks are needed from scratch.

---

## Open Questions

All questions have been resolved through code analysis:

- [x] Q1: Does `onboarding_instances` have a FK to `users`?
  - Resolution: NO. `onboarding_instances` stores `employee_email` as TEXT and `template_id` as a FK to `templates`. There is no FK from instances to users. Deletion must query by email.

- [x] Q2: Does `deleteUser` already handle onboarding instance cleanup?
  - Resolution: NO. The current `deleteUser()` only deletes the user row (which cascades to `user_roles` and `user_profiles`) and removes auth credentials. It does not touch `onboarding_instances`.

- [x] Q3: Is there an existing `deleteOnboardingInstance` function?
  - Resolution: NO. The instance CRUD factory exposes `list`, `get`, and `subscribe` but NOT `remove`. The `crud.remove` is created by the factory but not exported. Either export it or write a custom delete.

- [x] Q4: What does the existing UsersPanel show?
  - Resolution: It shows ALL users split into two tables: "Employees" and "Administrators & Managers". It shows name, email, roles, profiles, and edit/delete actions. It does NOT show onboarding status or progress.

- [x] Q5: Can the delete confirmation dialog be enhanced with custom warning text?
  - Resolution: YES. `DeleteConfirmationDialog` accepts a `message` prop that can be customized. The UsersPanel already passes a custom message.

---

## Recommended Approach

### Implementation Strategy

Since most infrastructure already exists, this is primarily an enhancement to existing files rather than building new features from scratch.

**Phase 1: Enhance the delete flow in `userService.ts`**

Modify `deleteUser()` to also delete associated onboarding instances before deleting the user:

```typescript
export async function deleteUser(userId: string): Promise<void> {
  const user = await getUser(userId);
  if (!user) return;

  // Delete associated onboarding instances (by email, since no FK to users)
  const { data: instances } = await supabase
    .from('onboarding_instances')
    .select('id')
    .eq('employee_email', user.email.toLowerCase());

  if (instances && instances.length > 0) {
    const instanceIds = instances.map(i => i.id);
    await supabase.from('onboarding_instances').delete().in('id', instanceIds);
    // CASCADE handles instance_steps, instance_profiles, instance_template_refs
    // suggestions.instance_id gets SET NULL
  }

  // Delete user row (CASCADE handles user_roles, user_profiles)
  const { error } = await supabase.from('users').delete().eq('id', userId);
  if (error) throw new Error(`Failed to delete user ${userId}: ${error.message}`);

  removeUserFromAuthCredentials(user.email);
}
```

**Phase 2: Enrich UsersPanel with onboarding data**

In `UsersPanel.tsx`, import `useOnboardingInstances` and cross-reference users with their instances to display onboarding status and progress. Add new columns to the employee table.

**Phase 3: Add filtering**

Add a toggle or filter to show "All users" vs "Currently onboarding" in the employees section.

**Phase 4: Enhance delete confirmation message**

When deleting a user who has active onboarding instances, enhance the confirmation message to warn that their onboarding data will also be deleted.

### Order of Work

1. **Service layer**: Enhance `deleteUser()` in `userService.ts` to clean up onboarding instances
2. **Component layer**: Enhance `UsersPanel.tsx` to show onboarding status/progress alongside users, using data from `useOnboardingInstances`
3. **Component layer**: Add filtering capability (onboarding users vs all users)
4. **Component layer**: Enhance delete confirmation message for users with active onboarding
5. **Tests**: Add/update tests for the enhanced delete flow and the enriched user list

### What to Defer
- Self-deletion prevention (checking if the user being deleted is the currently-signed-in user) -- nice to have but not critical for MVP
- Bulk delete -- not requested
- Export/report of onboarding users -- not requested

---

## Files Analyzed

| File Path | Purpose |
|-----------|---------|
| `/home/sanjay/Workspace/onboarding/CLAUDE.md` | Project conventions and architecture |
| `/home/sanjay/Workspace/onboarding/src/services/supabase/userService.ts` | User CRUD operations including `deleteUser()` |
| `/home/sanjay/Workspace/onboarding/src/services/supabase/instanceService.ts` | Onboarding instance CRUD operations |
| `/home/sanjay/Workspace/onboarding/src/services/supabase/profileService.ts` | Profile CRUD (reference pattern) |
| `/home/sanjay/Workspace/onboarding/src/services/supabase/index.ts` | Barrel exports for all services |
| `/home/sanjay/Workspace/onboarding/src/services/supabase/crudFactory.ts` | Generic CRUD factory pattern |
| `/home/sanjay/Workspace/onboarding/src/services/supabase/mappers.ts` | DB row to app type mappers |
| `/home/sanjay/Workspace/onboarding/src/types/index.ts` | App-level type definitions (User, OnboardingInstance, etc.) |
| `/home/sanjay/Workspace/onboarding/src/types/database.types.ts` | Supabase DB types for all 16 tables |
| `/home/sanjay/Workspace/onboarding/src/hooks/useUsers.ts` | User management hook with CRUD |
| `/home/sanjay/Workspace/onboarding/src/hooks/useUsers.test.ts` | Tests for useUsers hook |
| `/home/sanjay/Workspace/onboarding/src/hooks/index.ts` | Hook barrel exports |
| `/home/sanjay/Workspace/onboarding/src/components/manager/UsersPanel.tsx` | User administration panel (primary file to modify) |
| `/home/sanjay/Workspace/onboarding/src/components/manager/RoleManagementPanel.tsx` | Role management panel (reference pattern) |
| `/home/sanjay/Workspace/onboarding/src/components/manager/KPISection.tsx` | KPI display (reference for onboarding instance usage) |
| `/home/sanjay/Workspace/onboarding/src/components/modals/UserModal.tsx` | User create/edit modal |
| `/home/sanjay/Workspace/onboarding/src/components/modals/UserModal.test.tsx` | Tests for UserModal |
| `/home/sanjay/Workspace/onboarding/src/components/ui/DeleteConfirmationDialog.tsx` | Reusable delete confirmation dialog |
| `/home/sanjay/Workspace/onboarding/src/components/OnboardingHub.tsx` | Main app container |
| `/home/sanjay/Workspace/onboarding/src/views/ManagerView.tsx` | Manager dashboard with tab layout |
| `/home/sanjay/Workspace/onboarding/supabase/migrations/00001_create_core_tables.sql` | Core table definitions including users, onboarding_instances |
| `/home/sanjay/Workspace/onboarding/supabase/migrations/00002_create_step_tables.sql` | Step child table definitions |
| `/home/sanjay/Workspace/onboarding/supabase/migrations/00003_create_junction_tables.sql` | Junction table definitions with CASCADE behavior |
| `/home/sanjay/Workspace/onboarding/supabase/migrations/00005_enable_rls.sql` | RLS policies (currently permissive) |

---

## Next Step

**All questions resolved. Status: research-complete.**

Run `/plan user-management` to create the implementation plan.
