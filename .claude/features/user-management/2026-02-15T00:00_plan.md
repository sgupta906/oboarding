# Plan: user-management

## Metadata
- **Feature:** user-management
- **Created:** 2026-02-15T00:00
- **Status:** plan-complete
- **Based on:** 2026-02-14T23:30_research.md

---

## Architecture Overview

This feature enhances the existing UsersPanel to show onboarding status alongside users and ensures that deleting a user also cleans up their onboarding instances. It is an enhancement to existing files, not a greenfield build.

### Data Flow

```
                     +-----------------+
                     |  ManagerView    |
                     |  (tabs)         |
                     +-------+---------+
                             |
                   activeTab === 'users'
                             |
                     +-------v---------+
                     |  UsersPanel     |  <-- Enhanced
                     |                 |
                     | useUsers()      |  (existing: user CRUD)
                     | useOnboarding   |  (NEW: import for instance data)
                     |  Instances()    |
                     +---+-------+-----+
                         |       |
              client-side join   |
              (email match)      |
                         |       |
           +-------------+       +-------------+
           |                                   |
   +-------v--------+              +-----------v-----------+
   | userService.ts  |              | instanceService.ts   |
   | deleteUser()    | <-- Enhanced | (no changes needed)  |
   | - query instances|             | listOnboardingInstances|
   |   by email      |             | subscribeToOnboarding  |
   | - delete them   |             |   Instances            |
   | - then delete   |             +-----------------------+
   |   user row      |
   +-----------------+
```

### Component Hierarchy (UsersPanel - changes only)

```
UsersPanel
  |-- [NEW] useOnboardingInstances() hook import
  |-- [NEW] filter state: 'all' | 'onboarding'
  |-- [ENHANCED] renderUserTable()
  |     |-- [NEW] Status column (for employees table)
  |     |-- [NEW] Progress column (for employees table)
  |     |-- [NEW] Start Date column (for employees table)
  |-- [ENHANCED] DeleteConfirmationDialog
  |     |-- [ENHANCED] message prop (warns about onboarding data)
  |-- (all existing: UserModal create/edit, header, etc. - unchanged)
```

---

## Tech Stack Summary

No new dependencies. All work uses existing tools:

| Layer | Technology | Notes |
|-------|-----------|-------|
| Service | `userService.ts` | Enhance `deleteUser()` to clean up instances |
| Hook | `useOnboardingInstances` | Already exists, just import in UsersPanel |
| Component | `UsersPanel.tsx` | Primary UI changes |
| UI | `DeleteConfirmationDialog` | Already exists, just pass different message |
| Testing | Vitest + RTL | Test enhanced delete flow |

---

## File Structure

### Files to Modify

| File | Location | Changes |
|------|----------|---------|
| `src/services/supabase/userService.ts` | Lines 384-401 (`deleteUser`) | Add instance cleanup before user deletion: query `onboarding_instances` by `employee_email`, delete matching rows, then proceed with existing user deletion |
| `src/components/manager/UsersPanel.tsx` | Lines 1-403 (entire file) | (1) Import `useOnboardingInstances`, (2) Add filter state, (3) Build email-to-instance lookup map, (4) Add columns to employee table, (5) Enhance delete confirmation message |

### Files to Create (Tests Only)

| File | Purpose |
|------|---------|
| `src/services/supabase/userService.test.ts` | Tests for enhanced `deleteUser()` covering instance cleanup |
| `src/components/manager/UsersPanel.test.tsx` | Tests for onboarding data display, filtering, and enhanced delete message |

### Files NOT Changed

| File | Reason |
|------|--------|
| `src/hooks/useUsers.ts` | No changes needed -- it already calls `deleteUser()` which we enhance at the service layer |
| `src/hooks/useOnboardingInstances.ts` | No changes needed -- already returns all instances |
| `src/services/supabase/instanceService.ts` | No changes needed -- we delete instances directly in `userService.ts` via Supabase client, no need for a separate export |
| `src/services/supabase/index.ts` | No new exports needed |
| `src/types/index.ts` | No new types needed |
| `src/views/ManagerView.tsx` | No changes needed -- UsersPanel is self-contained |

---

## Data Model

### No Schema Changes

No database migrations needed. The `onboarding_instances` table already has `employee_email` as a TEXT field which is used for the join and cleanup.

### Cascade Behavior (Reference)

When `deleteUser()` is enhanced:

```
1. Query onboarding_instances WHERE employee_email = user.email
2. DELETE matching onboarding_instances rows
   -> CASCADE deletes: instance_steps, instance_profiles, instance_template_refs
   -> SET NULL on: suggestions.instance_id
3. DELETE users row (existing behavior)
   -> CASCADE deletes: user_roles, user_profiles
   -> SET NULL on: roles.created_by, profiles.created_by, etc.
4. Remove auth credentials (existing behavior)
```

---

## Component Architecture

### UsersPanel State Changes

New state additions:
```typescript
// Filter state for employee table
const [filter, setFilter] = useState<'all' | 'onboarding'>('all');

// Import onboarding instances hook
const { data: instances } = useOnboardingInstances();
```

### Client-Side Join Strategy

Build a lookup map from email to onboarding instance(s):

```typescript
const instancesByEmail = useMemo(() => {
  const map = new Map<string, OnboardingInstance[]>();
  for (const inst of instances) {
    const email = inst.employeeEmail.toLowerCase();
    const existing = map.get(email) || [];
    existing.push(inst);
    map.set(email, existing);
  }
  return map;
}, [instances]);
```

This avoids N+1 lookups and recomputes only when instances change.

### Employee Table Enhancement

The employee table currently has 5 columns: Name, Email, Roles, Profiles, Actions.

Enhanced to 7 columns for employees: Name, Email, Roles, Status, Progress, Start Date, Actions.

- **Status**: Badge showing "Active", "Completed", "On Hold", or "No onboarding" (muted)
- **Progress**: Percentage text or small progress bar
- **Start Date**: Formatted date or dash

The "Profiles" column is removed from the employee table to make room (profiles are less useful here; roles already convey the key info). Admin/Manager table remains unchanged.

### Filter Toggle

A simple button group above the employee table:

```
[All Employees] [Currently Onboarding]
```

When "Currently Onboarding" is selected, filter `employeeUsers` to only those whose email appears in `instancesByEmail` with at least one `status === 'active'` instance.

### Enhanced Delete Confirmation

When deleting a user who has onboarding instances:

```
"Are you sure you want to delete {name}? This will also permanently delete
their onboarding data ({N} onboarding instance(s) and all associated steps).
This action cannot be undone."
```

When deleting a user with no instances, use the existing message.

---

## Testing Strategy

### Unit Tests: `userService.test.ts` (NEW - ~5 tests)

| Test | Description |
|------|-------------|
| deleteUser cleans up onboarding instances before deleting user | Mock Supabase to return instances for email, verify delete called on instances then user |
| deleteUser handles user with no onboarding instances | Verify no instance delete attempt when query returns empty |
| deleteUser handles user with multiple instances | Verify all instances deleted |
| deleteUser is idempotent for missing user | Verify early return when getUser returns null |
| deleteUser propagates instance delete errors | Verify error thrown when instance delete fails |

### Component Tests: `UsersPanel.test.tsx` (NEW - ~6 tests)

| Test | Description |
|------|-------------|
| renders onboarding status column for employees | Verify status badges appear for users with instances |
| renders progress column for employees | Verify progress percentage displayed |
| shows "No onboarding" for users without instances | Verify muted text for non-onboarding users |
| filter toggle shows only onboarding users | Click filter, verify only users with active instances shown |
| delete confirmation warns about onboarding data | Verify enhanced message when user has instances |
| delete confirmation uses standard message for non-onboarding user | Verify original message when user has no instances |

### Test Counts
- **Unit tests (service):** 5 new tests
- **Component tests (UI):** 6 new tests
- **Total new tests:** 11
- **No integration or E2E tests needed** -- the service test validates the DB interaction pattern, and the component test validates the UI behavior

---

## Implementation Notes

### Key Decisions

1. **Client-side join over server-side**: Both datasets (users and instances) are already loaded via subscriptions. A client-side `Map` lookup by email is O(n) to build and O(1) per user -- no performance concern for <200 users.

2. **Instance deletion in userService, not instanceService**: The cleanup logic is specific to the user-deletion use case. Adding a generic `deleteOnboardingInstancesByEmail()` to instanceService would be a premature abstraction. Direct Supabase queries in `deleteUser()` are simpler and keep the change localized.

3. **Suggestions get SET NULL, not deleted**: The FK on `suggestions.instance_id` is already `ON DELETE SET NULL`. This is acceptable -- the suggestion text remains visible in the manager dashboard; it just loses its instance reference. No extra cleanup needed.

4. **No self-deletion prevention**: Checking if the user being deleted is the currently signed-in user is a nice-to-have but out of scope. The research explicitly recommended deferring this.

5. **Profiles column replaced by onboarding columns**: In the employee table, the Profiles column carries less signal than onboarding status/progress. Removing it makes room without widening the table excessively. The Admin/Manager table keeps all existing columns unchanged.

### Patterns Followed

- **Service pattern**: Direct Supabase queries in `deleteUser()` matching existing style (no ORM, explicit `.from().select().eq()` chains)
- **Hook composition**: UsersPanel composes `useUsers()` + `useOnboardingInstances()` directly, matching how KPISection already uses onboarding instance data
- **Delete confirmation pattern**: Same `DeleteConfirmationDialog` with customized `message` prop, matching RoleManagementPanel
- **Filter pattern**: Simple state toggle with `useMemo` filtering, matching `RoleManagementPanel`'s search/filter approach

---

## Non-Goals

- **Bulk delete**: Not requested, not implemented
- **Self-deletion prevention**: Deferred per research recommendation
- **Export/report of onboarding users**: Not requested
- **Server-side join or view**: Client-side join is sufficient for current scale
- **New hooks or services**: Everything composes from existing infrastructure
- **Database migrations**: No schema changes needed
- **Changes to ManagerView or tab structure**: UsersPanel is self-contained

---

## Next Step

Run `/implement user-management` to begin implementation following `tasks.md`.
