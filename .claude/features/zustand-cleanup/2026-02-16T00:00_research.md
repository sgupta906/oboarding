# Research: zustand-cleanup

## Metadata
- **Feature:** zustand-cleanup
- **Created:** 2026-02-16T00:00
- **Status:** research-complete
- **Researcher:** research-agent
- **Pipeline position:** Slice 5 of 5 (final Zustand migration slice)

## Feature Context

This is the final cleanup pass of the 5-slice Zustand migration. Slices 1-4 are complete:

| Slice | What Migrated | Status |
|-------|---------------|--------|
| 1 (zustand-store) | instances: useOnboardingInstances + useEmployeeOnboarding | Complete |
| 2 (zustand-steps) | steps: useSteps | Complete |
| 3 (zustand-users) | users: useUsers | Complete |
| 4 (zustand-activities) | activities + suggestions: useActivities + useSuggestions | Complete |

All 5 migrated hooks already read from the Zustand store. They are thin wrappers that:
1. Select state from `useOnboardingStore`
2. Start/stop ref-counted subscriptions via `useEffect`
3. Expose stable callback references via `useCallback`

The goal of this slice is to:
1. Slim OnboardingHub (the "god component") down to a thin router
2. Remove or simplify redundant aggregation (useManagerData)
3. Eliminate prop drilling where components can read the store directly
4. Clean up exports and barrel files

**Critical constraint:** The app MUST remain fully functional. This is cleanup, not a rewrite.

## Requirements

### Functional Requirements
- [ ] FR1: All existing functionality must continue to work identically (source: STATUS.md constraint)
- [ ] FR2: OnboardingHub should become a thin router -- orchestrate views, not manage data (source: STATUS.md roadmap)
- [ ] FR3: Components that already use hooks from the store should not receive redundant props (source: prop drilling elimination goal)
- [ ] FR4: All 412 tests must continue passing (source: baseline test run)
- [ ] FR5: No new Zustand store slices or subscriptions -- this is cleanup only (source: scope constraint)

### Technical Requirements
- [ ] TR1: Net line reduction -- remove dead code, slim god component
- [ ] TR2: Maintain the same public hook API for non-migrated hooks (useTemplates, useRoles, useCreateOnboarding, useDarkMode)
- [ ] TR3: Update barrel exports (hooks/index.ts) to reflect any removed hooks
- [ ] TR4: Update test files for changed/removed hooks
- [ ] TR5: No breaking changes to component props interfaces that are still needed

### Constraints
- Conservative approach: only change what clearly benefits
- App must be functional after every individual change
- Zustand store itself is stable -- no store changes needed

## Existing Code Analysis

### Project State
- Project exists: YES
- All 5 Zustand slices are complete and working
- 412 tests passing across 28 test files
- OnboardingHub is 343 lines -- goal is to shrink significantly

### Hook Classification

**Migrated hooks (thin wrappers over Zustand store -- candidates for keep/simplify/remove):**

| Hook | File | Lines | Consumers | Verdict |
|------|------|-------|-----------|---------|
| `useOnboardingInstances` | `src/hooks/useOnboardingInstances.ts` | 43 | NewHiresPanel, useManagerData | **KEEP** -- useful convenience wrapper with `enabled` param |
| `useEmployeeOnboarding` | `src/hooks/useEmployeeOnboarding.ts` | 47 | OnboardingHub | **KEEP** -- contains email-matching derivation logic |
| `useSteps` | `src/hooks/useSteps.ts` | 65 | OnboardingHub (x2) | **KEEP** -- contains subscription lifecycle + updateStatus callback |
| `useUsers` | `src/hooks/useUsers.ts` | 67 | UsersPanel | **KEEP** -- contains 5 useCallback wrappers for CRUD |
| `useActivities` | `src/hooks/useActivities.ts` | 43 | useManagerData | **KEEP** -- useful convenience wrapper with `enabled` param |
| `useSuggestions` | `src/hooks/useSuggestions.ts` | 87 | useManagerData | **KEEP** -- contains 3 useCallback wrappers for optimistic ops |

**Verdict: Keep ALL migrated hooks.** They are already thin (43-87 lines each). They provide:
- Subscription lifecycle management (useEffect + cleanup)
- Stable callback references (useCallback wrappers)
- Conditional enabling (enabled param)
- Nice return-type interfaces

Removing them would push this boilerplate into every consumer. Not worth it.

**Aggregator hook:**

| Hook | File | Lines | Consumers | Verdict |
|------|------|-------|-----------|---------|
| `useManagerData` | `src/hooks/useManagerData.ts` | 95 | OnboardingHub | **REMOVE** -- can be inlined |

`useManagerData` aggregates `useSuggestions`, `useActivities`, and `useOnboardingInstances` with a timeout fallback. Now that all three read from the shared Zustand store (instant data from store state, no per-hook fetch), the timeout fallback is far less useful. The aggregation just passes through to three hooks.

**Recommendation:** Remove `useManagerData`. OnboardingHub can call the three hooks directly. The timeout logic can be simplified or removed since the store provides instant state.

**Non-migrated hooks (NOT part of Zustand migration -- do not touch):**

| Hook | File | Lines | Notes |
|------|------|-------|-------|
| `useTemplates` | `src/hooks/useTemplates.ts` | 117 | Own subscription, not in store |
| `useRoles` | `src/hooks/useRoles.ts` | 152 | Own subscription, not in store |
| `useCreateOnboarding` | `src/hooks/useCreateOnboarding.ts` | 121 | Mutation hook, stateless |
| `useDarkMode` | `src/hooks/useDarkMode.ts` | 53 | UI state, not data |

### OnboardingHub Analysis (343 lines)

Current responsibilities:
1. **Auth + role check** (lines 41-43) -- Must stay
2. **Employee data hooks** (lines 46-53) -- Must stay (useEmployeeOnboarding + useSteps)
3. **Manager data hook** (lines 55-66) -- Can be simplified by inlining
4. **Selected instance state** (lines 69-80) -- Must stay (manager viewing employee)
5. **Selected instance steps** (lines 78-79) -- Must stay
6. **Modal state** (lines 82-83) -- Must stay
7. **Derived manager data** (lines 85-95) -- Can move to ManagerView or be computed inline
8. **Loading state tracking** (lines 98-99) -- Can be simplified
9. **handleStatusChange** (lines 101-125) -- Must stay (employee action)
10. **handleSuggestEditOpen/handleReportStuckOpen** (lines 127-133) -- Must stay (modal openers)
11. **handleSuggestEdit** (lines 135-157) -- Must stay (modal submission)
12. **handleReportStuck** (lines 159-175) -- Must stay (modal submission)
13. **handleApproveSuggestion** (lines 177-197) -- CAN MOVE to ManagerView
14. **handleRejectSuggestion** (lines 199-219) -- CAN MOVE to ManagerView
15. **Rendering** (lines 221-343) -- Can be simplified

**Key insight: The suggestion approve/reject handlers (lines 177-219) are pure manager-side operations. They use `suggestionsOptimistic` from `useManagerData` and `updateSuggestionStatus`/`deleteSuggestion` from services. These can move to ManagerView, which already has access to all needed data.**

**Key insight: The derived data (`managerSteps`, `stuckEmployeeNames`) are computed from `onboardingInstances` which ManagerView already receives. These computations can move to ManagerView or KPISection directly.**

### Prop Drilling Analysis

**Current flow through OnboardingHub:**

```
OnboardingHub
  --> useManagerData() --> { suggestions, activities, onboardingInstances, suggestionsOptimistic }
  --> Computes: managerSteps, stuckEmployeeNames
  --> Wraps: handleApproveSuggestion, handleRejectSuggestion (using suggestionsOptimistic)
  --> MemoizedManagerView receives ALL of these as props:
      - steps={managerSteps}
      - suggestions={suggestions}
      - activities={activities}
      - stuckEmployeeNames={stuckEmployeeNames}
      - onboardingInstances={onboardingInstances}
      - onApproveSuggestion={handleApproveSuggestion}
      - onRejectSuggestion={handleRejectSuggestion}
      - loadingSuggestionIds={loadingSuggestionIds}
```

**What ManagerView could get from the store directly:**
- `suggestions` -- via `useSuggestions()`
- `activities` -- via `useActivities()`
- `onboardingInstances` -- via `useOnboardingInstances()`
- `managerSteps` -- derived from instances (compute inside ManagerView)
- `stuckEmployeeNames` -- derived from instances (compute inside ManagerView)
- `handleApproveSuggestion` / `handleRejectSuggestion` -- using optimistic ops from `useSuggestions()`

**ManagerView can become fully self-contained for data**, similar to how `NewHiresPanel` and `UsersPanel` already are.

**EmployeeSelector** currently receives `instances` as a prop from OnboardingHub. However, since it is used specifically for the manager-viewing-employee scenario in OnboardingHub, and the selection state (`selectedInstanceId`) lives in OnboardingHub, this is appropriate and should stay as props.

### What Can Move

| What | From | To | Benefit |
|------|------|----|---------|
| `suggestions` data | OnboardingHub prop | ManagerView via `useSuggestions()` | Eliminates prop drilling |
| `activities` data | OnboardingHub prop | ManagerView via `useActivities()` | Eliminates prop drilling |
| `onboardingInstances` for dashboard | OnboardingHub prop | ManagerView via `useOnboardingInstances()` | Eliminates prop drilling |
| `managerSteps` computation | OnboardingHub | ManagerView | Moves derived data closer to consumer |
| `stuckEmployeeNames` computation | OnboardingHub | ManagerView | Moves derived data closer to consumer |
| `handleApproveSuggestion` | OnboardingHub | ManagerView | Handler moves to where data lives |
| `handleRejectSuggestion` | OnboardingHub | ManagerView | Handler moves to where data lives |
| `loadingSuggestionIds` state | OnboardingHub | ManagerView | Local state moves with handlers |
| `useManagerData` hook | OnboardingHub | REMOVED | Aggregator no longer needed |
| `isDashboardLoading` check | OnboardingHub | ManagerView | ManagerView owns its loading |

### What Stays in OnboardingHub

| What | Why |
|------|-----|
| Auth/role check | Router needs to know employee vs manager |
| `useEmployeeOnboarding` | Employee-specific instance lookup |
| `useSteps` (for employee) | Employee step data + updateStatus |
| `selectedInstanceId` state | Manager-viewing-employee selection |
| `useSteps` (for selected instance) | Steps for selected employee |
| `useOnboardingInstances` (for EmployeeSelector) | Manager needs instance list for dropdown |
| Modal state (activeModal, isSubmittingModal) | Employee modals (suggest edit, report stuck) |
| Employee event handlers | handleStatusChange, handleSuggestEdit, handleReportStuck |
| Rendering logic | Conditional view switching |

### Estimated OnboardingHub After Cleanup

Current: 343 lines
Removing: ~100 lines (useManagerData call, manager data computations, suggestion handlers, loadingSuggestionIds state, related rendering conditionals)
Estimated after: ~220-240 lines

### Test Files That Need Updates

| Test File | Lines | What Changes | Effort |
|-----------|-------|-------------|--------|
| `src/components/manager/NewHiresPanel.test.tsx` | 229 | Mock path may change if import changes | Low |
| `src/views/EmployeeView.test.tsx` | 187 | No changes needed (pure props-based) | None |
| `src/components/manager/UsersPanel.test.tsx` | ~300 | No changes needed (self-contained) | None |
| `src/hooks/useOnboardingInstances.test.ts` | 147 | No changes (hook is kept) | None |
| `src/hooks/useEmployeeOnboarding.test.ts` | 162 | No changes (hook is kept) | None |
| `src/hooks/useSteps.test.ts` | 103 | No changes (hook is kept) | None |
| `src/hooks/useUsers.test.ts` | ~300 | No changes (hook is kept) | None |
| `src/hooks/useSuggestions.test.ts` | 80 | No changes (hook is kept) | None |
| `src/store/useOnboardingStore.test.ts` | ~1100 | No changes (store unchanged) | None |

**New tests needed:**
- ManagerView integration test (verify it uses hooks directly and renders correctly)
- Test that ManagerView handles suggestion approve/reject with optimistic updates

**Tests to remove:**
- None of the existing hook tests need removal since all hooks are kept

### Code to Modify

| File | What Changes |
|------|-------------|
| `src/components/OnboardingHub.tsx` | Remove useManagerData, manager data computations, suggestion handlers. Keep employee logic and view routing. |
| `src/views/ManagerView.tsx` | Add hooks (useSuggestions, useActivities, useOnboardingInstances). Move suggestion handlers in. Compute managerSteps/stuckEmployeeNames locally. Remove props that are now hooked. |
| `src/hooks/useManagerData.ts` | **DELETE** -- no longer needed |
| `src/hooks/index.ts` | Remove useManagerData export |
| `src/types/index.ts` | Simplify ManagerViewProps (remove drilled data props) |

### Code to Delete

| File | Reason |
|------|--------|
| `src/hooks/useManagerData.ts` | Aggregator hook replaced by direct store access in ManagerView |

### Patterns to Follow

- Self-contained panels: Follow the pattern established by `NewHiresPanel` and `UsersPanel` -- components call hooks directly instead of receiving data via props
- Thin wrappers kept: All migrated hooks stay as convenience wrappers (consistent with slices 1-4 pattern)
- Fire-and-forget logging: `logActivity({...}).catch(console.warn)` pattern is used throughout
- Memoized views: `React.memo` is used on ManagerView and EmployeeView from OnboardingHub
- Toast notifications: `useToast()` for error feedback

## Risk Assessment

### Technical Risks

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Breaking ManagerView by changing its props interface | High | Low | Incremental change: add hooks first, then remove props, verify tests at each step |
| Double subscriptions if both OnboardingHub and ManagerView subscribe to instances | Medium | Medium | OnboardingHub already subscribes for EmployeeSelector. Ref-counting in the store prevents duplicate Supabase subscriptions. Two React useEffect calls share one underlying subscription. |
| React.memo on ManagerView stops working when it has internal hooks | Low | High | Expected behavior -- memo becomes less useful when component has its own state/hooks. Since ManagerView is only rendered when `isManager && currentView === 'manager'`, and it was only memoized to prevent prop-change re-renders, this is acceptable. Can remove the memo wrapper. |
| OnboardingHub loading state changes when useManagerData's timeout is removed | Medium | Medium | The timeout was a workaround for slow initial loads. With the store, data arrives faster since it may already be populated from other consumers. If needed, add a simple loading check in ManagerView. |
| Test failures from changed mocks/imports | Medium | Low | Keep all hooks, only remove useManagerData. Test impact is minimal. |

### Complexity
- **Level:** Medium
- **Rationale:** The changes are straightforward refactoring (move code from A to B, delete aggregator), but touching two central components (OnboardingHub, ManagerView) requires careful attention to not break prop flows. The ref-counted subscription model means we don't need to worry about duplicate subscriptions.

## Open Questions

All questions are resolved -- no user input needed.

- [x] Q1: Should migrated hooks be deleted since components could use the store directly?
  - Resolution: NO. Keep all 6 migrated hooks. They provide useful encapsulation (subscription lifecycle, stable callbacks, conditional enabling). Removing them pushes boilerplate into consumers with no net benefit.

- [x] Q2: Should useManagerData be kept?
  - Resolution: NO. Remove it. Its value was aggregating three hooks with a timeout. Now that all three read from the shared store (instant state), the aggregation adds complexity without benefit. ManagerView can call the three hooks directly.

- [x] Q3: Will removing React.memo from ManagerView cause performance issues?
  - Resolution: Unlikely. ManagerView only renders when the manager tab is active. The memo was primarily to prevent re-renders from OnboardingHub prop changes. With ManagerView owning its own data, there are fewer external re-render triggers. If performance issues arise, we can add memo back with a custom comparator.

- [x] Q4: Can EmployeeSelector get instances from the store directly?
  - Resolution: Keep it as props. EmployeeSelector is a presentational component that receives instances, selectedId, and onSelect. The selection state lives in OnboardingHub (it needs it for routing to the right employee view). Passing via props is correct here.

- [x] Q5: Should suggestion approve/reject move to ManagerView or to a dedicated hook?
  - Resolution: Move to ManagerView directly. The handlers are short (~20 lines each) and tightly coupled to the ManagerView UI (loadingSuggestionIds state, toast feedback). A dedicated hook would be over-engineering for two functions.

## Recommended Approach

### Implementation Strategy

**Conservative refactor in two phases:**

**Phase 1: Make ManagerView self-contained (main change)**
1. Add hooks to ManagerView: `useSuggestions()`, `useActivities()`, `useOnboardingInstances()`
2. Move `managerSteps` and `stuckEmployeeNames` computations into ManagerView
3. Move `handleApproveSuggestion`, `handleRejectSuggestion`, and `loadingSuggestionIds` state into ManagerView
4. Import `useToast` in ManagerView for error feedback
5. Simplify ManagerView props interface (remove data props, keep only what's needed from parent)
6. Update `src/types/index.ts` to simplify or remove `ManagerViewProps` if it lived there

**Phase 2: Slim OnboardingHub**
1. Remove `useManagerData` import and call
2. Remove `suggestionsOptimistic`, `suggestions`, `activities` destructuring
3. Remove `managerSteps`, `stuckEmployeeNames` useMemo blocks
4. Remove `loadingSuggestionIds` state
5. Remove `handleApproveSuggestion`, `handleRejectSuggestion` functions
6. Keep `useOnboardingInstances` for EmployeeSelector (needed for manager-viewing-employee)
7. Simplify ManagerView rendering (no more isDashboardLoading conditional -- ManagerView handles its own loading)
8. Remove `React.memo` wrapper from ManagerView (it owns its own state now)

**Phase 3: Cleanup**
1. Delete `src/hooks/useManagerData.ts`
2. Remove `useManagerData` from `src/hooks/index.ts` barrel export
3. Update/add tests for ManagerView
4. Run full test suite to verify

### Order of Work
1. Modify ManagerView to be self-contained (add hooks, move handlers)
2. Modify OnboardingHub to remove manager data management
3. Delete useManagerData hook and update barrel export
4. Update types if needed
5. Add/update ManagerView tests
6. Full test suite verification
7. TypeScript type check
8. Manual verification (build succeeds)

### What to Defer
- **Do NOT** remove or refactor the 6 migrated wrapper hooks -- they provide value
- **Do NOT** refactor non-migrated hooks (useTemplates, useRoles, useCreateOnboarding, useDarkMode)
- **Do NOT** change the Zustand store itself
- **Do NOT** change self-contained components (NewHiresPanel, UsersPanel, RoleManagementPanel)
- **Do NOT** change EmployeeView (pure props-based, no changes needed)

### Estimated Impact
- **Files modified:** 4 (OnboardingHub.tsx, ManagerView.tsx, hooks/index.ts, types/index.ts)
- **Files deleted:** 1 (hooks/useManagerData.ts)
- **Net line change:** ~-50 to -80 lines (OnboardingHub shrinks ~100 lines, ManagerView grows ~50 lines, useManagerData deleted -95 lines)
- **Test impact:** Minimal -- add ManagerView tests, no existing tests broken

## Next Step

**All questions resolved.** Status: `research-complete`.

Run `/plan zustand-cleanup` to create the implementation plan.
