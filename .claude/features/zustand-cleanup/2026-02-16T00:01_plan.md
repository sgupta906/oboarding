# Plan: zustand-cleanup

## Metadata
- **Feature:** zustand-cleanup
- **Created:** 2026-02-16T00:01
- **Status:** plan-complete
- **Based on:** 2026-02-16T00:00_research.md
- **Pipeline position:** Slice 5 of 5 (final Zustand migration cleanup)

## Feature Summary

Final cleanup pass for the 5-slice Zustand migration. Makes ManagerView self-contained (calls hooks directly instead of receiving data via props), removes the `useManagerData` aggregator hook, and slims OnboardingHub from a god component (~343 lines) down to a thin router (~220 lines).

## Architecture Overview

### Before (Current)

```
OnboardingHub (343 lines, god component)
  |
  +-- useManagerData() --> aggregates useSuggestions + useActivities + useOnboardingInstances
  |     |                  + timeout fallback logic
  |     +-- Returns: suggestions, activities, onboardingInstances, isDashboardLoading,
  |                  areInstancesLoading, suggestionsOptimistic
  |
  +-- Computes: managerSteps, stuckEmployeeNames (useMemo)
  +-- State: loadingSuggestionIds (useState)
  +-- Handlers: handleApproveSuggestion, handleRejectSuggestion
  |
  +-- MemoizedManagerView (receives ALL data as props)
       |
       +-- KPISection(steps, suggestions, stuckEmployeeNames, onboardingInstances)
       +-- SuggestionsSection(suggestions, steps, onApprove, onReject, loadingSuggestionIds)
       +-- ActivitySection(activities)
```

### After (Target)

```
OnboardingHub (~220 lines, thin router)
  |
  +-- useEmployeeOnboarding() --> employee instance
  +-- useSteps() --> employee steps + updateStatus
  +-- useOnboardingInstances() --> instances for EmployeeSelector
  +-- State: selectedInstanceId, activeModal, isSubmittingModal, loadingStepIds
  +-- Handlers: handleStatusChange, handleSuggestEdit*, handleReportStuck*
  |
  +-- EmployeeSelector(instances, selectedId, onSelect, isLoading)  [props: correct]
  +-- EmployeeView(steps, ...)  [props: correct]
  +-- ManagerView (self-contained, no data props)

ManagerView (~290 lines, self-contained)
  |
  +-- useSuggestions() --> suggestions + optimistic ops
  +-- useActivities() --> activities
  +-- useOnboardingInstances() --> onboardingInstances
  +-- Computes: managerSteps, stuckEmployeeNames (useMemo)
  +-- State: loadingSuggestionIds (useState)
  +-- Handlers: handleApproveSuggestion, handleRejectSuggestion
  |
  +-- KPISection(steps, suggestions, stuckEmployeeNames, onboardingInstances)
  +-- SuggestionsSection(suggestions, steps, onApprove, onReject, loadingSuggestionIds)
  +-- ActivitySection(activities)
```

### Data Flow Diagram

```
Zustand Store (useOnboardingStore)
  |
  |-- instances -----> useOnboardingInstances() --+--> OnboardingHub (EmployeeSelector)
  |                                               |
  |                                               +--> ManagerView (KPIs, derived data)
  |
  |-- suggestions ---> useSuggestions() -----------> ManagerView (SuggestionsSection, KPIs)
  |
  |-- activities ----> useActivities() ------------> ManagerView (ActivitySection)
  |
  |-- steps ---------> useSteps() -----------------> OnboardingHub (EmployeeView)
  |
  (ref-counted subscriptions -- no duplicates)
```

## Tech Stack (unchanged)

- React 18 + TypeScript
- Zustand (already installed, store unchanged)
- Vite 7, Tailwind CSS 3, Vitest + RTL

## File Structure

### Files to Modify

| # | File | Lines (before) | Lines (after) | What Changes |
|---|------|---------------|---------------|-------------|
| 1 | `src/views/ManagerView.tsx` | 241 | ~290 | Add hooks (useSuggestions, useActivities, useOnboardingInstances). Move suggestion handlers, loadingSuggestionIds state, managerSteps/stuckEmployeeNames computations. Remove data props from interface. Remove React.memo from OnboardingHub. |
| 2 | `src/components/OnboardingHub.tsx` | 343 | ~220 | Remove useManagerData import/call. Remove manager data computations (managerSteps, stuckEmployeeNames). Remove suggestion handlers and loadingSuggestionIds. Simplify ManagerView rendering (no isDashboardLoading, no data props). Remove MemoizedManagerView wrapper. |
| 3 | `src/hooks/index.ts` | 11 | 10 | Remove `useManagerData` export line. |
| 4 | `src/types/index.ts` | 377 | 377 | No changes needed -- ManagerViewProps is defined locally in ManagerView.tsx, not here. |

### Files to Delete

| # | File | Lines | Reason |
|---|------|-------|--------|
| 1 | `src/hooks/useManagerData.ts` | 95 | Aggregator hook replaced by direct hook calls in ManagerView. |

### Files to Create

| # | File | Purpose |
|---|------|---------|
| 1 | `src/views/ManagerView.test.tsx` | Integration tests for self-contained ManagerView (hooks, handlers, rendering). |

### Files NOT Changing (explicitly)

- `src/store/useOnboardingStore.ts` -- store is stable, no changes
- `src/hooks/useOnboardingInstances.ts` -- kept as-is
- `src/hooks/useActivities.ts` -- kept as-is
- `src/hooks/useSuggestions.ts` -- kept as-is
- `src/hooks/useSteps.ts` -- kept as-is
- `src/hooks/useEmployeeOnboarding.ts` -- kept as-is
- `src/hooks/useUsers.ts` -- kept as-is
- `src/components/manager/NewHiresPanel.tsx` -- self-contained, no changes
- `src/components/manager/UsersPanel.tsx` -- self-contained, no changes
- `src/views/EmployeeView.tsx` -- pure props-based, no changes
- All existing test files -- they test unchanged hooks/components

## Component Architecture

### ManagerView (after refactor)

```
ManagerView (self-contained)
  |
  +-- Hooks:
  |   +-- useSuggestions()           --> { data, isLoading, optimisticUpdateStatus, optimisticRemove, rollback }
  |   +-- useActivities()            --> { data, isLoading }
  |   +-- useOnboardingInstances()   --> { data, isLoading }
  |   +-- useCreateOnboarding()      --> (already present)
  |   +-- useRoles()                 --> (already present)
  |   +-- useTemplates()             --> (already present)
  |
  +-- State:
  |   +-- isCreateOnboardingOpen     (already present)
  |   +-- successMessage             (already present)
  |   +-- activeTab                  (already present)
  |   +-- loadingSuggestionIds       (NEW -- moved from OnboardingHub)
  |
  +-- Derived (useMemo):
  |   +-- managerSteps               (NEW -- flatMap instance.steps)
  |   +-- stuckEmployeeNames         (NEW -- filter instances with stuck steps)
  |   +-- isDashboardLoading         (NEW -- simplified: any hook isLoading)
  |
  +-- Handlers:
  |   +-- handleApproveSuggestion    (NEW -- moved from OnboardingHub)
  |   +-- handleRejectSuggestion     (NEW -- moved from OnboardingHub)
  |   +-- handleOpenCreateOnboarding (already present)
  |   +-- handleCloseCreateOnboarding (already present)
  |   +-- handleSubmitOnboarding     (already present)
  |
  +-- Rendering:
      +-- ManagerDashboardHeader
      +-- Tab navigation
      +-- Dashboard tab: KPISection, SuggestionsSection, ActivitySection
      +-- Roles tab: RoleManagementPanel
      +-- New Hires tab: NewHiresPanel
      +-- Users tab: UsersPanel
      +-- CreateOnboardingModal
```

### OnboardingHub (after refactor)

```
OnboardingHub (thin router)
  |
  +-- Hooks:
  |   +-- useAuth()                  --> { user, role }
  |   +-- useToast()                 --> { showToast }
  |   +-- useEmployeeOnboarding()    --> { instance, isLoading }
  |   +-- useSteps() x2              --> employee steps + selected instance steps
  |   +-- useOnboardingInstances()   --> instances for EmployeeSelector
  |
  +-- State:
  |   +-- selectedInstanceId         (manager viewing employee)
  |   +-- activeModal                (edit/stuck modal state)
  |   +-- isSubmittingModal
  |   +-- loadingStepIds
  |
  +-- Handlers:
  |   +-- handleStatusChange         (employee step status)
  |   +-- handleSuggestEditOpen      (modal opener)
  |   +-- handleReportStuckOpen      (modal opener)
  |   +-- handleSuggestEdit          (modal submission)
  |   +-- handleReportStuck          (modal submission)
  |   +-- handleSelectEmployee       (manager selects employee)
  |
  +-- Rendering:
      +-- Loading state (employee)
      +-- No-instance state (employee)
      +-- EmployeeSelector (manager viewing employee tab)
      +-- EmployeeView
      +-- ManagerView (no data props, self-contained)
      +-- SuggestEditModal, ReportStuckModal
```

### State Management

No changes to the Zustand store. The store provides:
- `instances` -- shared via ref-counted subscription (OnboardingHub + ManagerView both subscribe; same underlying Supabase channel)
- `suggestions` -- ManagerView subscribes directly
- `activities` -- ManagerView subscribes directly
- `steps` -- OnboardingHub subscribes per instanceId
- `users` -- UsersPanel subscribes directly

The `useManagerData` timeout fallback is intentionally dropped. With the Zustand store, data arrives instantly from store state if another consumer already populated it. The simple `isLoading` check in ManagerView is sufficient.

## ManagerView Props Interface (after refactor)

```typescript
// Before (all data drilled from OnboardingHub):
interface ManagerViewProps {
  steps: Step[];
  suggestions: Suggestion[];
  activities?: Activity[];
  stuckEmployeeNames?: string[];
  onboardingInstances?: OnboardingInstance[];
  onApproveSuggestion?: (id: number | string) => void;
  onRejectSuggestion?: (id: number | string) => void;
  onOnboardingCreated?: (employeeName: string) => void;
  onRefreshInstances?: () => void;
  loadingSuggestionIds?: Set<number | string>;
}

// After (self-contained, no data props):
// No props interface needed -- ManagerView takes no props.
// All data comes from hooks. All handlers are internal.
```

## OnboardingHub Rendering (after refactor)

```tsx
// ManagerView rendering simplifies from:
{isManager && currentView === 'manager' && !isDashboardLoading && (
  <MemoizedManagerView
    steps={managerSteps}
    suggestions={suggestions}
    activities={activities}
    stuckEmployeeNames={stuckEmployeeNames}
    onboardingInstances={onboardingInstances}
    onApproveSuggestion={handleApproveSuggestion}
    onRejectSuggestion={handleRejectSuggestion}
    loadingSuggestionIds={loadingSuggestionIds}
  />
)}
{isManager && currentView === 'manager' && isDashboardLoading && (
  <div>Loading dashboard...</div>
)}

// To:
{isManager && currentView === 'manager' && (
  <ManagerView />
)}
```

## Testing Strategy

### Existing Tests (unchanged, must continue passing)

All 412 existing tests remain unchanged. Key test files:
- `src/store/useOnboardingStore.test.ts` (~1100 lines) -- store is unchanged
- `src/hooks/useSuggestions.test.ts` (80 lines) -- hook is unchanged
- `src/hooks/useOnboardingInstances.test.ts` (147 lines) -- hook is unchanged
- `src/hooks/useEmployeeOnboarding.test.ts` (162 lines) -- hook is unchanged
- `src/hooks/useSteps.test.ts` (103 lines) -- hook is unchanged
- `src/hooks/useUsers.test.ts` (~300 lines) -- hook is unchanged
- `src/views/EmployeeView.test.tsx` (187 lines) -- no changes
- `src/components/manager/NewHiresPanel.test.tsx` (229 lines) -- no changes
- `src/components/manager/UsersPanel.test.tsx` (~300 lines) -- no changes

### New Tests

| File | Test Count | Description |
|------|-----------|-------------|
| `src/views/ManagerView.test.tsx` | ~12-15 | Integration tests for self-contained ManagerView |

**ManagerView.test.tsx test cases:**

1. **Rendering**: Renders dashboard tab by default with KPIs, suggestions, activities
2. **Hook integration**: Calls useSuggestions(), useActivities(), useOnboardingInstances() on mount
3. **Derived data**: Computes managerSteps from instances.flatMap(i => i.steps)
4. **Derived data**: Computes stuckEmployeeNames from instances with stuck steps
5. **Approve suggestion**: handleApproveSuggestion calls optimistic update + updateSuggestionStatus service
6. **Approve suggestion error**: Rolls back on server error, shows toast
7. **Reject suggestion**: handleRejectSuggestion calls optimistic remove + deleteSuggestion service
8. **Reject suggestion error**: Rolls back on server error, shows toast
9. **Loading state**: Shows loading indicator when hooks are loading
10. **Tab switching**: Dashboard/Roles/New Hires/Users tabs render correct content
11. **Loading suggestion IDs**: Tracks per-suggestion loading state during approve/reject
12. **Activity logging**: Approve/reject log activities via fire-and-forget pattern

### Test Execution Plan

1. Write ManagerView tests first (TDD)
2. Modify ManagerView to be self-contained (tests should pass)
3. Modify OnboardingHub to remove manager data management
4. Delete useManagerData, update barrel
5. Run full suite: `npx vitest run` -- all 412+ tests must pass
6. Run TypeScript check: `npx tsc -b`
7. Run build: `npx vite build`

## Implementation Notes

### Key Decisions

1. **Keep all 6 migrated hooks** -- They provide subscription lifecycle, stable callbacks, and conditional enabling. Removing them pushes boilerplate into consumers.

2. **Remove `useManagerData`** -- Its aggregation + timeout fallback adds complexity without benefit now that the Zustand store provides instant shared state.

3. **Remove `React.memo` wrapper on ManagerView** -- Since ManagerView now has internal hooks and state, memo is ineffective (it re-renders on internal state changes anyway). The memo was only useful when all data came via props.

4. **Keep `useOnboardingInstances` in OnboardingHub** -- EmployeeSelector still needs instances passed as props (it is a presentational component; selection state lives in OnboardingHub).

5. **ManagerView handles its own loading** -- Instead of OnboardingHub's `isDashboardLoading` with timeout, ManagerView uses a simple loading check: `suggestionsLoading || activitiesLoading || instancesLoading`.

6. **`onOnboardingCreated` and `onRefreshInstances` callbacks removed** -- These were never actually needed because:
   - `onOnboardingCreated` was never passed from OnboardingHub
   - `onRefreshInstances` is unnecessary with realtime subscriptions (the store auto-updates)

### Patterns Followed

- **Self-contained panels**: ManagerView follows the pattern of NewHiresPanel and UsersPanel -- calls hooks directly
- **Fire-and-forget logging**: `logActivity({...}).catch(console.warn)` pattern
- **Toast notifications**: `useToast()` for error feedback
- **Optimistic updates**: useSuggestions provides optimistic ops with snapshot rollback

### Risk Mitigations

1. **Double subscriptions**: OnboardingHub and ManagerView both call `useOnboardingInstances()`. The store's ref-counting ensures only one Supabase subscription. Two React useEffect calls share one underlying channel.

2. **Loading flash**: When switching to manager tab, data may already be in the store from OnboardingHub's instance subscription. The `isLoading` flag is false when store already has data, so no flash.

3. **Incremental safety**: Phase 1 (ManagerView self-contained) and Phase 2 (slim OnboardingHub) can be tested independently. If Phase 1 works, Phase 2 is just removing dead code.

## Non-Goals

- **Do NOT** refactor KPISection, SuggestionsSection, or ActivitySection to use hooks directly. They are presentational components that receive props. This is correct.
- **Do NOT** change the Zustand store.
- **Do NOT** remove or refactor non-migrated hooks (useTemplates, useRoles, useCreateOnboarding, useDarkMode).
- **Do NOT** move EmployeeSelector to use hooks directly (selection state lives in OnboardingHub).
- **Do NOT** add new Zustand slices or subscriptions.
- **Do NOT** refactor EmployeeView (pure props-based, works correctly).

## Estimated Impact

- **Files modified:** 3 (OnboardingHub.tsx, ManagerView.tsx, hooks/index.ts)
- **Files deleted:** 1 (hooks/useManagerData.ts)
- **Files created:** 1 (views/ManagerView.test.tsx)
- **Net line change:** ~-70 to -90 lines (OnboardingHub -120, ManagerView +50, useManagerData -95, new tests +150, barrel -1)
- **Test count:** 412 existing + ~12-15 new = ~424-427 total
